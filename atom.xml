<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>é›ªå±±ä¸Šçš„è’²å…¬è‹±</title>
  
  <subtitle>JinFeng&#39;s Blog</subtitle>
  <link href="https://xssdpgy.github.io/atom.xml" rel="self"/>
  
  <link href="https://xssdpgy.github.io/"/>
  <updated>2023-03-02T15:53:11.943Z</updated>
  <id>https://xssdpgy.github.io/</id>
  
  <author>
    <name>Zang JinFeng</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ç®—æ³•è®°å½•ï¼ˆä¸€ï¼‰â€”â€”å•é“¾è¡¨è§£é¢˜æŠ€å·§</title>
    <link href="https://xssdpgy.github.io/2023/03/02/%E7%AE%97%E6%B3%95%E8%AE%B0%E5%BD%95%EF%BC%88%E4%B8%80%EF%BC%89%E2%80%94%E2%80%94%E5%8D%95%E9%93%BE%E8%A1%A8%E8%A7%A3%E9%A2%98%E6%8A%80%E5%B7%A7/"/>
    <id>https://xssdpgy.github.io/2023/03/02/%E7%AE%97%E6%B3%95%E8%AE%B0%E5%BD%95%EF%BC%88%E4%B8%80%EF%BC%89%E2%80%94%E2%80%94%E5%8D%95%E9%93%BE%E8%A1%A8%E8%A7%A3%E9%A2%98%E6%8A%80%E5%B7%A7/</id>
    <published>2023-03-02T14:40:02.000Z</published>
    <updated>2023-03-02T15:53:11.943Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h2><ul><li><a href="https://leetcode.cn/problems/linked-list-cycle">141. ç¯å½¢é“¾è¡¨ ğŸŸ¢</a></li><li><a href="https://leetcode.cn/problems/linked-list-cycle-ii/">142. ç¯å½¢é“¾è¡¨ IIğŸŸ </a></li><li><a href="https://leetcode.cn/problems/intersection-of-two-linked-lists">160. ç›¸äº¤é“¾è¡¨ ğŸŸ¢</a></li><li><a href="https://leetcode.cn/problems/remove-nth-node-from-end-of-list">19. åˆ é™¤é“¾è¡¨çš„å€’æ•°ç¬¬ N ä¸ªç»“ç‚¹ ğŸŸ </a></li><li><a href="https://leetcode.cn/problems/merge-two-sorted-lists">21. åˆå¹¶ä¸¤ä¸ªæœ‰åºé“¾è¡¨ ğŸŸ¢</a></li><li><a href="https://leetcode.cn/problems/merge-k-sorted-lists">23. åˆå¹¶Kä¸ªå‡åºé“¾è¡¨ ğŸ”´</a></li><li><a href="https://leetcode.cn/problems/partition-list">86. åˆ†éš”é“¾è¡¨ ğŸŸ </a></li><li><a href="https://leetcode.cn/problems/middle-of-the-linked-list">876. é“¾è¡¨çš„ä¸­é—´ç»“ç‚¹ ğŸŸ¢</a></li><li><a href="https://leetcode.cn/problems/lian-biao-zhong-dao-shu-di-kge-jie-dian-lcof">å‰‘æŒ‡ Offer 22. é“¾è¡¨ä¸­å€’æ•°ç¬¬kä¸ªèŠ‚ç‚¹ ğŸŸ¢</a></li><li><a href="https://leetcode.cn/problems/he-bing-liang-ge-pai-xu-de-lian-biao-lcof">å‰‘æŒ‡ Offer 25. åˆå¹¶ä¸¤ä¸ªæ’åºçš„é“¾è¡¨ ğŸŸ¢</a></li><li><a href="https://leetcode.cn/problems/liang-ge-lian-biao-de-di-yi-ge-gong-gong-jie-dian-lcof">å‰‘æŒ‡ Offer 52. ä¸¤ä¸ªé“¾è¡¨çš„ç¬¬ä¸€ä¸ªå…¬å…±èŠ‚ç‚¹ ğŸŸ¢</a></li><li><a href="https://leetcode.cn/problems/SLwz0R">å‰‘æŒ‡ Offer II 021. åˆ é™¤é“¾è¡¨çš„å€’æ•°ç¬¬ n ä¸ªç»“ç‚¹ ğŸŸ </a></li><li><a href="https://leetcode.cn/problems/c32eOV">å‰‘æŒ‡ Offer II 022. é“¾è¡¨ä¸­ç¯çš„å…¥å£èŠ‚ç‚¹ ğŸŸ </a></li><li><a href="https://leetcode.cn/problems/3u1WK4">å‰‘æŒ‡ Offer II 023. ä¸¤ä¸ªé“¾è¡¨çš„ç¬¬ä¸€ä¸ªé‡åˆèŠ‚ç‚¹ ğŸŸ¢</a></li><li><a href="https://leetcode.cn/problems/vvXgSW">å‰‘æŒ‡ Offer II 078. åˆå¹¶æ’åºé“¾è¡¨ ğŸ”´</a></li></ul><h2 id="å•é“¾è¡¨çš„æ•°æ®ç»“æ„"><a href="#å•é“¾è¡¨çš„æ•°æ®ç»“æ„" class="headerlink" title="å•é“¾è¡¨çš„æ•°æ®ç»“æ„"></a>å•é“¾è¡¨çš„æ•°æ®ç»“æ„</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Definition for singly-linked list.</span></span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">ListNode</span> &#123;</span><br><span class="line">      <span class="type">int</span> val;</span><br><span class="line">      ListNode next;</span><br><span class="line">      ListNode(<span class="type">int</span> x) &#123;</span><br><span class="line">          val = x;</span><br><span class="line">          next = <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h2 id="141-ç¯å½¢é“¾è¡¨"><a href="#141-ç¯å½¢é“¾è¡¨" class="headerlink" title="141 ç¯å½¢é“¾è¡¨"></a>141 ç¯å½¢é“¾è¡¨</h2><p>é¢˜ç›®ï¼š<a href="https://leetcode.cn/problems/linked-list-cycle">141. ç¯å½¢é“¾è¡¨ ğŸŸ¢</a></p><p>æ€è·¯ï¼šåˆ¤æ–­é“¾è¡¨ä¸­æ˜¯å¦å­˜åœ¨ç¯ï¼Œä½¿ç”¨åŒæŒ‡é’ˆï¼Œå¿«æ…¢æŒ‡é’ˆï¼Œç›¸äº¤å³ä¸ºå­˜åœ¨ç¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasCycle</span><span class="params">(ListNode head)</span> &#123;</span><br><span class="line">    ListNode slow,fast;</span><br><span class="line">    slow = head;</span><br><span class="line">    fast = head;</span><br><span class="line">    <span class="keyword">while</span>(fast!=<span class="literal">null</span>&amp;&amp;fast.next!=<span class="literal">null</span>)&#123;</span><br><span class="line">        slow = slow.next;</span><br><span class="line">        fast = fast.next.next;</span><br><span class="line">        <span class="comment">//å¿«æ…¢æŒ‡é’ˆç›¸äº¤å³ä¸ºå­˜åœ¨ç¯</span></span><br><span class="line">        <span class="keyword">if</span>(slow==fast)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="142-ç¯å½¢é“¾è¡¨äºŒ"><a href="#142-ç¯å½¢é“¾è¡¨äºŒ" class="headerlink" title="142 ç¯å½¢é“¾è¡¨äºŒ"></a>142 ç¯å½¢é“¾è¡¨äºŒ</h2><p>é¢˜ç›®ï¼š<a href="https://leetcode.cn/problems/linked-list-cycle-ii/">142. ç¯å½¢é“¾è¡¨ IIğŸŸ </a></p><p>æ€è·¯ï¼šåŸºäº <a href="https://leetcode.cn/problems/linked-list-cycle">141. ç¯å½¢é“¾è¡¨</a> çš„è§£æ³•ï¼Œç›´è§‚åœ°æ¥è¯´å°±æ˜¯å½“å¿«æ…¢æŒ‡é’ˆç›¸é‡æ—¶ï¼Œè®©å…¶ä¸­ä»»ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘å¤´èŠ‚ç‚¹ï¼Œç„¶åè®©å®ƒä¿©ä»¥ç›¸åŒé€Ÿåº¦å‰è¿›ï¼Œå†æ¬¡ç›¸é‡æ—¶æ‰€åœ¨çš„èŠ‚ç‚¹ä½ç½®å°±æ˜¯ç¯å¼€å§‹çš„ä½ç½®ã€‚</p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20230302231644713.png" alt="image-20230302231644713"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ListNode <span class="title function_">detectCycle</span><span class="params">(ListNode head)</span> &#123;</span><br><span class="line">        ListNode fast,slow;</span><br><span class="line">        fast = head;</span><br><span class="line">        slow = head;</span><br><span class="line">        <span class="keyword">while</span>(fast !=<span class="literal">null</span>&amp;&amp;fast.next!=<span class="literal">null</span>)&#123;</span><br><span class="line">            slow = slow.next;</span><br><span class="line">            fast = fast.next.next;</span><br><span class="line">            <span class="comment">//å¿«æ…¢æŒ‡é’ˆç›¸äº¤ï¼Œä¸­æ–­å‰è¿›</span></span><br><span class="line">            <span class="keyword">if</span>(slow == fast)&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¿«æŒ‡é’ˆnextèŠ‚ç‚¹ä¸ºç©ºçš„è¯ï¼Œè¯´æ˜é“¾è¡¨æ— ç¯</span></span><br><span class="line">        <span class="keyword">if</span>(fast==<span class="literal">null</span>||fast.next==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ­¤æ—¶æ…¢æŒ‡é’ˆé‡æ–°æŒ‡å‘å¤´èŠ‚ç‚¹</span></span><br><span class="line">        slow = head;</span><br><span class="line">        <span class="comment">//å¿«æ…¢æŒ‡é’ˆåŒæ­¥å‰è¿›ï¼Œç­‰å¾…ç›¸äº¤ç‚¹å³ä¸ºç¯çš„å…¥å£</span></span><br><span class="line">        <span class="keyword">while</span>(slow!=fast)&#123;</span><br><span class="line">            slow = slow.next;</span><br><span class="line">            fast = fast.next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> slow;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="160-ç›¸äº¤é“¾è¡¨"><a href="#160-ç›¸äº¤é“¾è¡¨" class="headerlink" title="160 ç›¸äº¤é“¾è¡¨"></a>160 ç›¸äº¤é“¾è¡¨</h2><p>é¢˜ç›®ï¼š<a href="https://leetcode.cn/problems/intersection-of-two-linked-lists">160. ç›¸äº¤é“¾è¡¨ ğŸŸ¢</a></p><p>æ€è·¯ï¼šéš¾ç‚¹åœ¨äºé“¾è¡¨é•¿åº¦ä¸åŒï¼Œå› æ­¤åˆ°è¾¾ç›¸äº¤èŠ‚ç‚¹çš„æ­¥æ•°ä¹Ÿä¸åŒï¼Œå› æ­¤é€šè¿‡æ‹¼æ¥ï¼Œè®© <code>p1</code> éå†å®Œé“¾è¡¨ <code>A</code> ä¹‹åå¼€å§‹éå†é“¾è¡¨ <code>B</code>ï¼Œè®© <code>p2</code> éå†å®Œé“¾è¡¨ <code>B</code> ä¹‹åå¼€å§‹éå†é“¾è¡¨ <code>A</code>ï¼Œè¿™æ ·ç›¸å½“äºã€Œé€»è¾‘ä¸Šã€ä¸¤æ¡é“¾è¡¨æ¥åœ¨äº†ä¸€èµ·ï¼Œä»¥è®© <code>p1</code> å’Œ <code>p2</code> åŒæ—¶è¿›å…¥ç›¸äº¤èŠ‚ç‚¹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ListNode <span class="title function_">getIntersectionNode</span><span class="params">(ListNode headA, ListNode headB)</span> &#123;</span><br><span class="line">    <span class="type">ListNode</span> <span class="variable">p1</span> <span class="operator">=</span> headA,p2 = headB;</span><br><span class="line">    <span class="keyword">while</span>(p1!=p2)&#123;</span><br><span class="line">        <span class="keyword">if</span>(p1==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//p1åˆ°å°½å¤´ï¼ŒæŒ‡é’ˆè½¬å‘headB</span></span><br><span class="line">            p1 = headB;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            p1 = p1.next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(p2==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//p2åˆ°å°½å¤´ï¼ŒæŒ‡é’ˆè½¬å‘headA</span></span><br><span class="line">            p2 = headA;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            p2 = p2.next;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//p1==p2å³ä¸ºç›¸äº¤èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">return</span> p1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;ç›®å½•&quot;&gt;&lt;a href=&quot;#ç›®å½•&quot; class=&quot;headerlink&quot; title=&quot;ç›®å½•&quot;&gt;&lt;/a&gt;ç›®å½•&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://leetcode.cn/problems/linked-list-cycle&quot;&gt;141. ç¯å½¢é“¾è¡¨ ğŸŸ¢&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://leetcode.cn/problems/linked-list-cycle-ii/&quot;&gt;142. ç¯å½¢é“¾è¡¨ IIğŸŸ &lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://leetcode.cn/problems/intersection-of-two-linked-lists&quot;&gt;160. ç›¸äº¤é“¾è¡¨ ğŸŸ¢&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://leetcode.cn/problems/remove-nth-node-from-end-of-list&quot;&gt;19. åˆ é™¤é“¾è¡¨çš„å€’æ•°ç¬¬ N ä¸ªç»“ç‚¹ ğŸŸ &lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://leetcode.cn/problems/merge-two-sorted-lists&quot;&gt;21. åˆå¹¶ä¸¤ä¸ªæœ‰åºé“¾è¡¨ ğŸŸ¢&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://leetcode.cn/problems/merge-k-sorted-lists&quot;&gt;23. åˆå¹¶Kä¸ªå‡åºé“¾è¡¨ ğŸ”´&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://leetcode.cn/problems/partition-list&quot;&gt;86. åˆ†éš”é“¾è¡¨ ğŸŸ &lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://leetcode.cn/problems/middle-of-the-linked-list&quot;&gt;876. é“¾è¡¨çš„ä¸­é—´ç»“ç‚¹ ğŸŸ¢&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://leetcode.cn/problems/lian-biao-zhong-dao-shu-di-kge-jie-dian-lcof&quot;&gt;å‰‘æŒ‡ Offer 22. é“¾è¡¨ä¸­å€’æ•°ç¬¬kä¸ªèŠ‚ç‚¹ ğŸŸ¢&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://leetcode.cn/problems/he-bing-liang-ge-pai-xu-de-lian-biao-lcof&quot;&gt;å‰‘æŒ‡ Offer 25. åˆå¹¶ä¸¤ä¸ªæ’åºçš„é“¾è¡¨ ğŸŸ¢&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://leetcode.cn/problems/liang-ge-lian-biao-de-di-yi-ge-gong-gong-jie-dian-lcof&quot;&gt;å‰‘æŒ‡ Offer 52. ä¸¤ä¸ªé“¾è¡¨çš„ç¬¬ä¸€ä¸ªå…¬å…±èŠ‚ç‚¹ ğŸŸ¢&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://leetcode.cn/problems/SLwz0R&quot;&gt;å‰‘æŒ‡ Offer II 021. åˆ é™¤é“¾è¡¨çš„å€’æ•°ç¬¬ n ä¸ªç»“ç‚¹ ğŸŸ &lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://leetcode.cn/problems/c32eOV&quot;&gt;å‰‘æŒ‡ Offer II 022. é“¾è¡¨ä¸­ç¯çš„å…¥å£èŠ‚ç‚¹ ğŸŸ &lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://leetcode.cn/problems/3u1WK4&quot;&gt;å‰‘æŒ‡ Offer II 023. ä¸¤ä¸ªé“¾è¡¨çš„ç¬¬ä¸€ä¸ªé‡åˆèŠ‚ç‚¹ ğŸŸ¢&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://leetcode.cn/problems/vvXgSW&quot;&gt;å‰‘æŒ‡ Offer II 078. åˆå¹¶æ’åºé“¾è¡¨ ğŸ”´&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;å•é“¾è¡¨çš„æ•°æ®ç»“æ„&quot;&gt;&lt;a href=&quot;#å•é“¾è¡¨çš„æ•°æ®ç»“æ„&quot; class=&quot;headerlink&quot; title=&quot;å•é“¾è¡¨çš„æ•°æ®ç»“æ„&quot;&gt;&lt;/a&gt;å•é“¾è¡¨çš„æ•°æ®ç»“æ„&lt;/h2&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Definition for singly-linked list.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;ListNode&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; val;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      ListNode next;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      ListNode(&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; x) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          val = x;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          next = &lt;span class=&quot;literal&quot;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h2 id=&quot;141-ç¯å½¢é“¾è¡¨&quot;&gt;&lt;a href=&quot;#141-ç¯å½¢é“¾è¡¨&quot; class=&quot;headerlink&quot; title=&quot;141 ç¯å½¢é“¾è¡¨&quot;&gt;&lt;/a&gt;141 ç¯å½¢é“¾è¡¨&lt;/h2&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://xssdpgy.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="ç®—æ³•" scheme="https://xssdpgy.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
    <category term="é“¾è¡¨" scheme="https://xssdpgy.github.io/tags/%E9%93%BE%E8%A1%A8/"/>
    
  </entry>
  
  <entry>
    <title>Javaçš„7ç§é˜»å¡é˜Ÿåˆ—åŠå…¶å®ç°åŸç†</title>
    <link href="https://xssdpgy.github.io/2023/02/27/Java%E7%9A%847%E7%A7%8D%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97%E5%8F%8A%E5%85%B6%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/"/>
    <id>https://xssdpgy.github.io/2023/02/27/Java%E7%9A%847%E7%A7%8D%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97%E5%8F%8A%E5%85%B6%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/</id>
    <published>2023-02-27T14:50:55.000Z</published>
    <updated>2023-02-28T14:16:22.373Z</updated>
    
    <content type="html"><![CDATA[<h1 id="é˜Ÿåˆ—å’Œé˜»å¡é˜Ÿåˆ—"><a href="#é˜Ÿåˆ—å’Œé˜»å¡é˜Ÿåˆ—" class="headerlink" title="é˜Ÿåˆ—å’Œé˜»å¡é˜Ÿåˆ—"></a>é˜Ÿåˆ—å’Œé˜»å¡é˜Ÿåˆ—</h1><h2 id="é˜Ÿåˆ—"><a href="#é˜Ÿåˆ—" class="headerlink" title="é˜Ÿåˆ—"></a>é˜Ÿåˆ—</h2><p>é˜Ÿåˆ—ï¼ˆ<code>Queue</code>ï¼‰æ˜¯ä¸€ç§ç»å¸¸ä½¿ç”¨çš„é›†åˆã€‚<code>Queue</code> å®é™…ä¸Šæ˜¯å®ç°äº†ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼šFirst In First Outï¼‰çš„æœ‰åºè¡¨ã€‚å’Œ Listã€Set ä¸€æ ·éƒ½ç»§æ‰¿è‡ª Collectionã€‚å®ƒå’Œ <code>List</code> çš„åŒºåˆ«åœ¨äºï¼Œ<code>List</code>å¯ä»¥åœ¨ä»»æ„ä½ç½®æ·»åŠ å’Œåˆ é™¤å…ƒç´ ï¼Œè€Œ<code>Queue</code> åªæœ‰ä¸¤ä¸ªæ“ä½œï¼š</p><ul><li>æŠŠå…ƒç´ æ·»åŠ åˆ°é˜Ÿåˆ—æœ«å°¾ï¼›</li><li>ä»é˜Ÿåˆ—å¤´éƒ¨å–å‡ºå…ƒç´ ã€‚</li></ul><span id="more"></span><p>è¶…å¸‚çš„æ”¶é“¶å°å°±æ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼š</p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/qdn5n1vv5d.jpeg"></p><p>æˆ‘ä»¬å¸¸ç”¨çš„ LinkedList å°±å¯ä»¥å½“é˜Ÿåˆ—ä½¿ç”¨ï¼Œå®ç°äº† Dequeue æ¥å£ï¼Œè¿˜æœ‰ ConcurrentLinkedQueueï¼Œä»–ä»¬éƒ½å±äºéé˜»å¡é˜Ÿåˆ—ã€‚</p><h2 id="é˜»å¡é˜Ÿåˆ—"><a href="#é˜»å¡é˜Ÿåˆ—" class="headerlink" title="é˜»å¡é˜Ÿåˆ—"></a>é˜»å¡é˜Ÿåˆ—</h2><p>é˜»å¡é˜Ÿåˆ—ï¼Œé¡¾åæ€ä¹‰ï¼Œé¦–å…ˆå®ƒæ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œè€Œä¸€ä¸ªé˜»å¡é˜Ÿåˆ—åœ¨æ•°æ®ç»“æ„ä¸­æ‰€èµ·çš„ä½œç”¨å¤§è‡´å¦‚ä¸‹ï¼š</p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/r2azmfcxl0.jpeg"></p><p>çº¿ç¨‹ 1 å¾€é˜»å¡é˜Ÿåˆ—ä¸­æ·»åŠ å…ƒç´ ï¼Œè€Œçº¿ç¨‹ 2 ä»é˜»å¡é˜Ÿåˆ—ä¸­ç§»é™¤å…ƒç´ </p><ul><li>å½“é˜»å¡é˜Ÿåˆ—æ˜¯ç©ºæ—¶ï¼Œä»é˜Ÿåˆ—ä¸­è·å–å…ƒç´ çš„æ“ä½œå°†ä¼šè¢«é˜»å¡ã€‚</li><li>å½“é˜»å¡é˜Ÿåˆ—æ˜¯æ»¡æ—¶ï¼Œä»é˜Ÿåˆ—ä¸­æ·»åŠ å…ƒç´ çš„æ“ä½œå°†ä¼šè¢«é˜»å¡ã€‚</li></ul><p>è¯•å›¾ä»ç©ºçš„é˜»å¡é˜Ÿåˆ—ä¸­è·å–å…ƒç´ çš„çº¿ç¨‹å°†ä¼šé˜»å¡ï¼Œç›´åˆ°å…¶ä»–çš„çº¿ç¨‹å¾€ç©ºçš„é˜Ÿåˆ—æ’å…¥æ–°çš„å…ƒç´ ï¼ŒåŒæ ·ï¼Œè¯•å›¾å¾€å·²æ»¡çš„é˜»å¡é˜Ÿåˆ—æ·»åŠ æ–°å…ƒç´ çš„çº¿ç¨‹åŒæ ·ä¹Ÿä¼šé˜»å¡ï¼Œç›´åˆ°å…¶ä»–çš„çº¿ç¨‹ä»åˆ—ä¸­ç§»é™¤ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ æˆ–è€…å®Œå…¨æ¸…ç©ºé˜Ÿåˆ—åç»§ç»­æ–°å¢ã€‚</p><blockquote><p>ç±»ä¼¼æˆ‘ä»¬å»æµ·åº•ææ’é˜Ÿï¼Œæµ·åº•æçˆ†æ»¡æƒ…å†µä¸‹ï¼Œé˜»å¡é˜Ÿåˆ—ç›¸å½“äºç”¨é¤åŒºï¼Œç”¨é¤åŒºæ»¡äº†çš„è¯ï¼Œå°±é˜»å¡åœ¨å€™å®¢åŒºç­‰ç€ï¼Œå¯ä»¥ç”¨é¤çš„è¯ put ä¸€æ³¢å»ç”¨é¤ï¼Œåƒå®Œå°± take å‡ºå»ã€‚</p></blockquote><h1 id="ä¸ºä»€ä¹ˆè¦ç”¨é˜»å¡é˜Ÿåˆ—"><a href="#ä¸ºä»€ä¹ˆè¦ç”¨é˜»å¡é˜Ÿåˆ—" class="headerlink" title="ä¸ºä»€ä¹ˆè¦ç”¨é˜»å¡é˜Ÿåˆ—"></a>ä¸ºä»€ä¹ˆè¦ç”¨é˜»å¡é˜Ÿåˆ—</h1><p>åœ¨å¤šçº¿ç¨‹é¢†åŸŸï¼šæ‰€è°“é˜»å¡ï¼Œæ˜¯æŒ‡åœ¨æŸäº›æƒ…å†µä¸‹ä¼šæŒ‚èµ·çº¿ç¨‹ï¼ˆå³é˜»å¡ï¼‰ï¼Œä¸€æ—¦æ¡ä»¶æ»¡è¶³ï¼Œè¢«æŒ‚èµ·çš„çº¿ç¨‹åˆä¼šè‡ªåŠ¨è¢«å”¤é†’ã€‚</p><p><strong>é‚£ä¸ºä»€ä¹ˆéœ€è¦ BlockingQueue å‘¢</strong></p><p>å¥½å¤„æ˜¯æˆ‘ä»¬ä¸éœ€è¦å…³å¿ƒä»€ä¹ˆæ—¶å€™éœ€è¦é˜»å¡çº¿ç¨‹ï¼Œä»€ä¹ˆæ—¶å€™éœ€è¦å”¤é†’çº¿ç¨‹ï¼Œå› ä¸ºè¿™äº› BlockingQueue éƒ½åŒ…åŠäº†ã€‚</p><p>åœ¨ concurrent åŒ…å‘å¸ƒä»¥å‰ï¼Œå¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬æ¯ä¸ªç¨‹åºå‘˜éƒ½å¿…é¡»è‡ªå·±å»å®ç°è¿™äº›ç»†èŠ‚ï¼Œå°¤å…¶è¿˜è¦å…¼é¡¾æ•ˆç‡å’Œçº¿ç¨‹å®‰å…¨ï¼Œè¿™ä¼šç»™æˆ‘ä»¬çš„ç¨‹åºå¸¦æ¥ä¸å°çš„å¤æ‚æ€§ã€‚ç°åœ¨æœ‰äº†é˜»å¡é˜Ÿåˆ—ï¼Œæˆ‘ä»¬çš„æ“ä½œå°±ä»æ‰‹åŠ¨æŒ¡æ¢æˆäº†è‡ªåŠ¨æŒ¡ã€‚</p><h2 id="Javaé‡Œçš„é˜»å¡é˜Ÿåˆ—"><a href="#Javaé‡Œçš„é˜»å¡é˜Ÿåˆ—" class="headerlink" title="Javaé‡Œçš„é˜»å¡é˜Ÿåˆ—"></a>Javaé‡Œçš„é˜»å¡é˜Ÿåˆ—</h2><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/vzgecykzwz.jpeg" alt="img"></p><p>Collectionçš„å­ç±»é™¤äº†æˆ‘ä»¬ç†Ÿæ‚‰çš„ List å’Œ Setï¼Œè¿˜æœ‰ä¸€ä¸ª Queueï¼Œé˜»å¡é˜Ÿåˆ— BlockingQueue ç»§æ‰¿è‡ª Queueã€‚</p><p>BlockingQueue æ˜¯ä¸ªæ¥å£ï¼Œéœ€è¦ä½¿ç”¨å®ƒçš„å®ç°ä¹‹ä¸€æ¥ä½¿ç”¨ BlockingQueueï¼Œ<code>java.util.concurrent</code> åŒ…ä¸‹å…·æœ‰ä»¥ä¸‹ BlockingQueue æ¥å£çš„å®ç°ç±»ï¼š</p><p>JDK æä¾›äº† 7 ä¸ªé˜»å¡é˜Ÿåˆ—ã€‚åˆ†åˆ«æ˜¯ï¼š</p><ul><li>ArrayBlockingQueue ï¼šä¸€ä¸ªç”±æ•°ç»„ç»“æ„ç»„æˆçš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—</li><li>LinkedBlockingQueue ï¼šä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—</li><li>PriorityBlockingQueue ï¼šä¸€ä¸ªæ”¯æŒä¼˜å…ˆçº§æ’åºçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—</li><li>DelayQueueï¼šä¸€ä¸ªä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—</li><li>SynchronousQueueï¼šä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—</li><li>LinkedTransferQueueï¼šä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ï¼ˆå®ç°äº†ç»§æ‰¿äº BlockingQueue çš„ TransferQueueï¼‰</li><li>LinkedBlockingDequeï¼šä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„åŒå‘é˜»å¡é˜Ÿåˆ—</li></ul><h2 id="BlockingQueueæ ¸å¿ƒæ–¹æ³•"><a href="#BlockingQueueæ ¸å¿ƒæ–¹æ³•" class="headerlink" title="BlockingQueueæ ¸å¿ƒæ–¹æ³•"></a>BlockingQueueæ ¸å¿ƒæ–¹æ³•</h2><p>ç›¸æ¯” Queue æ¥å£ï¼ŒBlockingQueue æœ‰å››ç§å½¢å¼çš„ APIã€‚</p><table><thead><tr><th align="left">æ–¹æ³•ç±»å‹</th><th align="left">æŠ›å‡ºå¼‚å¸¸</th><th align="left">è¿”å›ç‰¹æ®Šå€¼</th><th align="left">ä¸€ç›´é˜»å¡</th><th align="left">è¶…æ—¶é€€å‡º</th></tr></thead><tbody><tr><td align="left">æ’å…¥</td><td align="left">add(e)</td><td align="left">offer(e)</td><td align="left">put(e)</td><td align="left">offer(e,time,unit)</td></tr><tr><td align="left">ç§»é™¤ï¼ˆå–å‡ºï¼‰</td><td align="left">remove()</td><td align="left">poll()</td><td align="left">take()</td><td align="left">poll(time,unit)</td></tr><tr><td align="left">æ£€æŸ¥</td><td align="left">element()</td><td align="left">peek()</td><td align="left">ä¸å¯ç”¨</td><td align="left">ä¸å¯ç”¨</td></tr></tbody></table><p>ä»¥ ArrayBlockingQueue ä¸ºä¾‹æ¥çœ‹ä¸‹ Java é˜»å¡é˜Ÿåˆ—æä¾›çš„å¸¸ç”¨æ–¹æ³•</p><ul><li>æŠ›å‡ºå¼‚å¸¸ï¼š</li><li>å½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œå†å¾€é˜Ÿåˆ—é‡Œ add æ’å…¥å…ƒç´ ä¼šæŠ›å‡º <code>java.lang.IllegalStateException: Queue full</code> å¼‚å¸¸ï¼›</li><li>å½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œä»é˜Ÿåˆ—é‡Œ remove ç§»é™¤å…ƒç´ æ—¶ä¼šæŠ›å‡º <code>NoSuchElementException</code> å¼‚å¸¸ ã€‚</li><li>element()ï¼Œè¿”å›é˜Ÿåˆ—å¤´éƒ¨çš„å…ƒç´ ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™æŠ›å‡ºä¸€ä¸ª <code>NoSuchElementException</code> å¼‚å¸¸</li></ul><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/tfke4xk80a.png"></p><ul><li>è¿”å›ç‰¹æ®Šå€¼ï¼š</li><li>offer()ï¼Œæ’å…¥æ–¹æ³•ï¼ŒæˆåŠŸè¿”å› trueï¼Œå¤±è´¥è¿”å› falseï¼›</li><li>poll()ï¼Œç§»é™¤æ–¹æ³•ï¼ŒæˆåŠŸè¿”å›å‡ºé˜Ÿåˆ—çš„å…ƒç´ ï¼Œé˜Ÿåˆ—é‡Œæ²¡æœ‰åˆ™è¿”å› null</li><li>peek() ï¼Œè¿”å›é˜Ÿåˆ—å¤´éƒ¨çš„å…ƒç´ ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™è¿”å› null</li></ul><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/lnfymgac35.png"></p><ul><li>ä¸€ç›´é˜»å¡ï¼š</li><li>å½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œå¦‚æœç”Ÿäº§çº¿ç¨‹ç»§ç»­å¾€é˜Ÿåˆ—é‡Œ put å…ƒç´ ï¼Œé˜Ÿåˆ—ä¼šä¸€ç›´é˜»å¡ç”Ÿäº§çº¿ç¨‹ï¼Œç›´åˆ°æ‹¿åˆ°æ•°æ®ï¼Œæˆ–è€…å“åº”ä¸­æ–­é€€å‡ºï¼›</li><li>å½“é˜»å¡é˜Ÿåˆ—ç©ºæ—¶ï¼Œæ¶ˆè´¹çº¿ç¨‹è¯•å›¾ä»é˜Ÿåˆ—é‡Œ take å…ƒç´ ï¼Œé˜Ÿåˆ—ä¹Ÿä¼šä¸€ç›´é˜»å¡æ¶ˆè´¹çº¿ç¨‹ï¼Œç›´åˆ°é˜Ÿåˆ—å¯ç”¨ã€‚</li></ul><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/ztrwqquuix.png"></p><ul><li>è¶…æ—¶é€€å‡ºï¼š</li><li>å½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œé˜Ÿåˆ—ä¼šé˜»å¡ç”Ÿäº§çº¿ç¨‹ä¸€å®šæ—¶é—´ï¼Œå¦‚æœè¶…è¿‡ä¸€å®šçš„æ—¶é—´ï¼Œç”Ÿäº§çº¿ç¨‹å°±ä¼šé€€å‡ºï¼Œè¿”å› false</li><li>å½“é˜»å¡é˜Ÿåˆ—ç©ºæ—¶ï¼Œé˜Ÿåˆ—ä¼šé˜»å¡æ¶ˆè´¹çº¿ç¨‹ä¸€å®šæ—¶é—´ï¼Œå¦‚æœè¶…è¿‡ä¸€å®šçš„æ—¶é—´ï¼Œæ¶ˆè´¹çº¿ç¨‹ä¼šé€€å‡ºï¼Œè¿”å› null</li></ul><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/n7m9mhh1b1.png"></p><h1 id="BlockingQueue-å®ç°ç±»"><a href="#BlockingQueue-å®ç°ç±»" class="headerlink" title="BlockingQueue å®ç°ç±»"></a>BlockingQueue å®ç°ç±»</h1><p>é€ä¸ªåˆ†æä¸‹è¿™ 7 ä¸ªé˜»å¡é˜Ÿåˆ—ï¼Œå¸¸ç”¨çš„å‡ ä¸ªé¡ºä¾¿æ¢ç©¶ä¸‹æºç ã€‚</p><h2 id="ArrayBlockingQueue"><a href="#ArrayBlockingQueue" class="headerlink" title="ArrayBlockingQueue"></a>ArrayBlockingQueue</h2><p>ArrayBlockingQueueï¼Œä¸€ä¸ªç”±<strong>æ•°ç»„</strong>å®ç°çš„<strong>æœ‰ç•Œ</strong>é˜»å¡é˜Ÿåˆ—ã€‚è¯¥é˜Ÿåˆ—é‡‡ç”¨å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„åŸåˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åºæ·»åŠ çš„ã€‚</p><p>ArrayBlockingQueue ä¸º<strong>æœ‰ç•Œä¸”å›ºå®š</strong>ï¼Œå…¶å¤§å°åœ¨æ„é€ æ—¶ç”±æ„é€ å‡½æ•°æ¥å†³å®šï¼Œç¡®è®¤ä¹‹åå°±ä¸èƒ½å†æ”¹å˜äº†ã€‚</p><p>ArrayBlockingQueue æ”¯æŒå¯¹ç­‰å¾…çš„ç”Ÿäº§è€…çº¿ç¨‹å’Œä½¿ç”¨è€…çº¿ç¨‹è¿›è¡Œæ’åºçš„å¯é€‰å…¬å¹³ç­–ç•¥ï¼Œä½†æ˜¯åœ¨é»˜è®¤æƒ…å†µä¸‹ä¸ä¿è¯çº¿ç¨‹å…¬å¹³çš„è®¿é—®ï¼Œåœ¨æ„é€ æ—¶å¯ä»¥é€‰æ‹©å…¬å¹³ç­–ç•¥ï¼ˆ<code>fair = true</code>ï¼‰ã€‚å…¬å¹³æ€§é€šå¸¸ä¼šé™ä½ååé‡ï¼Œä½†æ˜¯å‡å°‘äº†å¯å˜æ€§å’Œé¿å…äº†â€œä¸å¹³è¡¡æ€§â€ã€‚ï¼ˆArrayBlockingQueue å†…éƒ¨çš„é˜»å¡é˜Ÿåˆ—æ˜¯é€šè¿‡ ReentrantLock å’Œ Condition æ¡ä»¶é˜Ÿåˆ—å®ç°çš„ï¼Œ æ‰€ä»¥ ArrayBlockingQueue ä¸­çš„å…ƒç´ å­˜åœ¨å…¬å¹³å’Œéå…¬å¹³è®¿é—®çš„åŒºåˆ«ï¼‰</p><p>æ‰€è°“å…¬å¹³è®¿é—®é˜Ÿåˆ—æ˜¯æŒ‡é˜»å¡çš„æ‰€æœ‰ç”Ÿäº§è€…çº¿ç¨‹æˆ–æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œå½“é˜Ÿåˆ—å¯ç”¨æ—¶ï¼Œå¯ä»¥æŒ‰ç…§é˜»å¡çš„å…ˆåé¡ºåºè®¿é—®é˜Ÿåˆ—ï¼Œå³å…ˆé˜»å¡çš„ç”Ÿäº§è€…çº¿ç¨‹ï¼Œå¯ä»¥å…ˆå¾€é˜Ÿåˆ—é‡Œæ’å…¥å…ƒç´ ï¼Œå…ˆé˜»å¡çš„æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œå¯ä»¥å…ˆä»é˜Ÿåˆ—é‡Œè·å–å…ƒç´ ï¼Œå¯ä»¥ä¿è¯å…ˆè¿›å…ˆå‡ºï¼Œé¿å…é¥¥é¥¿ç°è±¡ã€‚</p><p><strong>æºç è§£è¯»</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ArrayBlockingQueue</span>&lt;E&gt; <span class="keyword">extends</span> <span class="title class_">AbstractQueue</span>&lt;E&gt;</span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">BlockingQueue</span>&lt;E&gt;, java.io.Serializable &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€šè¿‡æ•°ç»„æ¥å®ç°çš„é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">final</span> Object[] items;</span><br><span class="line">    <span class="comment">//è®°å½•é˜Ÿé¦–å…ƒç´ çš„ä¸‹æ ‡</span></span><br><span class="line">    <span class="type">int</span> takeIndex;</span><br><span class="line">    <span class="comment">//è®°å½•é˜Ÿå°¾å…ƒç´ çš„ä¸‹æ ‡</span></span><br><span class="line">    <span class="type">int</span> putIndex;</span><br><span class="line">    <span class="comment">//é˜Ÿåˆ—ä¸­çš„å…ƒç´ ä¸ªæ•°</span></span><br><span class="line">    <span class="type">int</span> count;</span><br><span class="line">    <span class="comment">//é€šè¿‡ReentrantLockæ¥å®ç°åŒæ­¥</span></span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock;</span><br><span class="line">    <span class="comment">//æœ‰2ä¸ªæ¡ä»¶å¯¹è±¡ï¼Œåˆ†åˆ«è¡¨ç¤ºé˜Ÿåˆ—ä¸ä¸ºç©ºå’Œé˜Ÿåˆ—ä¸æ»¡çš„æƒ…å†µ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Condition notEmpty;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Condition notFull;</span><br><span class="line">    <span class="comment">//è¿­ä»£å™¨</span></span><br><span class="line">    <span class="keyword">transient</span> Itrs itrs;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//offeræ–¹æ³•ç”¨äºå‘é˜Ÿåˆ—ä¸­æ·»åŠ æ•°æ®</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(E e)</span> &#123;</span><br><span class="line">        <span class="comment">// å¯ä»¥çœ‹å‡ºæ·»åŠ çš„æ•°æ®ä¸æ”¯æŒnullå€¼</span></span><br><span class="line">        checkNotNull(e);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="built_in">this</span>.lock;</span><br><span class="line">        <span class="comment">//é€šè¿‡é‡å…¥é”æ¥å®ç°åŒæ­¥</span></span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">//å¦‚æœé˜Ÿåˆ—å·²ç»æ»¡äº†çš„è¯ç›´æ¥å°±è¿”å›falseï¼Œä¸ä¼šé˜»å¡è°ƒç”¨è¿™ä¸ªofferæ–¹æ³•çš„çº¿ç¨‹</span></span><br><span class="line">            <span class="keyword">if</span> (count == items.length)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">//å¦‚æœé˜Ÿåˆ—æ²¡æœ‰æ»¡ï¼Œå°±è°ƒç”¨enqueueæ–¹æ³•å°†å…ƒç´ æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­</span></span><br><span class="line">                enqueue(e);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¤šäº†ä¸ªç­‰å¾…æ—¶é—´çš„ offeræ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(E e, <span class="type">long</span> timeout, TimeUnit unit)</span></span><br><span class="line">        <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        checkNotNull(e);</span><br><span class="line">        <span class="type">long</span> <span class="variable">nanos</span> <span class="operator">=</span> unit.toNanos(timeout);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="built_in">this</span>.lock;</span><br><span class="line">        <span class="comment">//è·å–å¯ä¸­æ–­é”</span></span><br><span class="line">        lock.lockInterruptibly();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (count == items.length) &#123;</span><br><span class="line">                <span class="keyword">if</span> (nanos &lt;= <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                <span class="comment">//ç­‰å¾…è®¾ç½®çš„æ—¶é—´</span></span><br><span class="line">                nanos = notFull.awaitNanos(nanos);</span><br><span class="line">            &#125;</span><br><span class="line">           <span class="comment">//å¦‚æœç­‰å¾…æ—¶é—´è¿‡äº†ï¼Œé˜Ÿåˆ—æœ‰ç©ºé—´çš„è¯å°±ä¼šè°ƒç”¨enqueueæ–¹æ³•å°†å…ƒç´ æ·»åŠ åˆ°é˜Ÿåˆ—</span></span><br><span class="line">            enqueue(e);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†æ•°æ®æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­çš„å…·ä½“æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">enqueue</span><span class="params">(E x)</span> &#123;</span><br><span class="line">        <span class="comment">// assert lock.getHoldCount() == 1;</span></span><br><span class="line">        <span class="comment">// assert items[putIndex] == null;</span></span><br><span class="line">        <span class="keyword">final</span> Object[] items = <span class="built_in">this</span>.items;</span><br><span class="line">        items[putIndex] = x;</span><br><span class="line">       <span class="comment">//é€šè¿‡å¾ªç¯æ•°ç»„å®ç°çš„é˜Ÿåˆ—ï¼Œå½“æ•°ç»„æ»¡äº†æ—¶ä¸‹æ ‡å°±å˜æˆ0äº†</span></span><br><span class="line">        <span class="keyword">if</span> (++putIndex == items.length)</span><br><span class="line">            putIndex = <span class="number">0</span>;</span><br><span class="line">        count++;</span><br><span class="line">       <span class="comment">//æ¿€æ´»å› ä¸ºnotEmptyæ¡ä»¶è€Œé˜»å¡çš„çº¿ç¨‹ï¼Œæ¯”å¦‚è°ƒç”¨takeæ–¹æ³•çš„çº¿ç¨‹</span></span><br><span class="line">        notEmpty.signal();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†æ•°æ®ä»é˜Ÿåˆ—ä¸­å–å‡ºçš„æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">private</span> E <span class="title function_">dequeue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// assert lock.getHoldCount() == 1;</span></span><br><span class="line">        <span class="comment">// assert items[takeIndex] != null;</span></span><br><span class="line">        <span class="keyword">final</span> Object[] items = <span class="built_in">this</span>.items;</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        <span class="type">E</span> <span class="variable">x</span> <span class="operator">=</span> (E) items[takeIndex];</span><br><span class="line">        <span class="comment">//å°†å¯¹åº”çš„æ•°ç»„ä¸‹æ ‡ä½ç½®è®¾ç½®ä¸ºnullé‡Šæ”¾èµ„æº</span></span><br><span class="line">        items[takeIndex] = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (++takeIndex == items.length)</span><br><span class="line">            takeIndex = <span class="number">0</span>;</span><br><span class="line">        count--;</span><br><span class="line">        <span class="keyword">if</span> (itrs != <span class="literal">null</span>)</span><br><span class="line">            itrs.elementDequeued();</span><br><span class="line">       <span class="comment">//æ¿€æ´»å› ä¸ºnotFullæ¡ä»¶è€Œé˜»å¡çš„çº¿ç¨‹ï¼Œæ¯”å¦‚è°ƒç”¨putæ–¹æ³•çš„çº¿ç¨‹</span></span><br><span class="line">        notFull.signal();</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//putæ–¹æ³•å’Œofferæ–¹æ³•ä¸ä¸€æ ·çš„åœ°æ–¹åœ¨äºï¼Œå¦‚æœé˜Ÿåˆ—æ˜¯æ»¡çš„è¯ï¼Œå®ƒå°±ä¼šæŠŠè°ƒç”¨putæ–¹æ³•çš„çº¿ç¨‹é˜»å¡ï¼Œç›´åˆ°é˜Ÿåˆ—é‡Œæœ‰ç©ºé—´</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(E e)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        checkNotNull(e);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="built_in">this</span>.lock;</span><br><span class="line">       <span class="comment">//å› ä¸ºåé¢è°ƒç”¨äº†æ¡ä»¶å˜é‡çš„await()æ–¹æ³•ï¼Œè€Œawait()æ–¹æ³•ä¼šåœ¨ä¸­æ–­æ ‡å¿—è®¾ç½®åæŠ›å‡ºInterruptedExceptionå¼‚å¸¸åé€€å‡ºï¼Œ</span></span><br><span class="line">      <span class="comment">// æ‰€ä»¥åœ¨åŠ é”æ—¶å€™å…ˆçœ‹ä¸­æ–­æ ‡å¿—æ˜¯ä¸æ˜¯è¢«è®¾ç½®äº†ï¼Œå¦‚æœè®¾ç½®äº†ç›´æ¥æŠ›å‡ºInterruptedExceptionå¼‚å¸¸ï¼Œå°±ä¸ç”¨å†å»è·å–é”äº†</span></span><br><span class="line">        lock.lockInterruptibly();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (count == items.length)</span><br><span class="line">                <span class="comment">//å¦‚æœé˜Ÿåˆ—æ»¡çš„è¯å°±é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°notFullçš„signalæ–¹æ³•è¢«è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯é˜Ÿåˆ—é‡Œæœ‰ç©ºé—´äº†</span></span><br><span class="line">                notFull.await();</span><br><span class="line">           <span class="comment">//é˜Ÿåˆ—é‡Œæœ‰ç©ºé—´äº†æ‰§è¡Œæ·»åŠ æ“ä½œ</span></span><br><span class="line">            enqueue(e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//pollæ–¹æ³•ç”¨äºä»é˜Ÿåˆ—ä¸­å–æ•°æ®ï¼Œä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">public</span> E <span class="title function_">poll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="built_in">this</span>.lock;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœé˜Ÿåˆ—ä¸ºç©ºçš„è¯ä¼šç›´æ¥è¿”å›nullï¼Œå¦åˆ™è°ƒç”¨dequeueæ–¹æ³•å–æ•°æ®</span></span><br><span class="line">            <span class="keyword">return</span> (count == <span class="number">0</span>) ? <span class="literal">null</span> : dequeue();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æœ‰ç­‰å¾…æ—¶é—´çš„ poll é‡è½½æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> E <span class="title function_">poll</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">nanos</span> <span class="operator">=</span> unit.toNanos(timeout);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="built_in">this</span>.lock;</span><br><span class="line">        lock.lockInterruptibly();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (nanos &lt;= <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                nanos = notEmpty.awaitNanos(nanos);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> dequeue();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//takeæ–¹æ³•ä¹Ÿæ˜¯ç”¨äºå–é˜Ÿåˆ—ä¸­çš„æ•°æ®ï¼Œä½†æ˜¯å’Œpollæ–¹æ³•ä¸åŒçš„æ˜¯å®ƒæœ‰å¯èƒ½ä¼šé˜»å¡å½“å‰çš„çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">public</span> E <span class="title function_">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="built_in">this</span>.lock;</span><br><span class="line">        lock.lockInterruptibly();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//å½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œå°±ä¼šé˜»å¡å½“å‰çº¿ç¨‹</span></span><br><span class="line">            <span class="keyword">while</span> (count == <span class="number">0</span>)</span><br><span class="line">                notEmpty.await();</span><br><span class="line">            <span class="comment">//ç›´åˆ°é˜Ÿåˆ—ä¸­æœ‰æ•°æ®äº†ï¼Œè°ƒç”¨dequeueæ–¹æ³•å°†æ•°æ®è¿”å›</span></span><br><span class="line">            <span class="keyword">return</span> dequeue();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¿”å›é˜Ÿé¦–å…ƒç´ </span></span><br><span class="line">    <span class="keyword">public</span> E <span class="title function_">peek</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="built_in">this</span>.lock;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> itemAt(takeIndex); <span class="comment">// null when queue is empty</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è·å–é˜Ÿåˆ—çš„å…ƒç´ ä¸ªæ•°ï¼ŒåŠ äº†é”ï¼Œæ‰€ä»¥ç»“æœæ˜¯å‡†ç¡®çš„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">size</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="built_in">this</span>.lock;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> count;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¿”å›é˜Ÿåˆ—å‰©ä½™ç©ºé—´ï¼Œè¿˜èƒ½åŠ å‡ ä¸ªå…ƒç´ </span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">remainingCapacity</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="built_in">this</span>.lock;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> items.length - count;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ¤æ–­é˜Ÿåˆ—ä¸­æ˜¯å¦å­˜åœ¨å½“å‰å…ƒç´ o</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">contains</span><span class="params">(Object o)</span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¿”å›ä¸€ä¸ªæŒ‰æ­£ç¡®é¡ºåºï¼ŒåŒ…å«é˜Ÿåˆ—ä¸­æ‰€æœ‰å…ƒç´ çš„æ•°ç»„</span></span><br><span class="line"><span class="keyword">public</span> Object[] toArray()&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªåŠ¨æ¸…ç©ºé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å…ƒç´ </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç§»é™¤é˜Ÿåˆ—ä¸­æ‰€æœ‰å¯ç”¨å…ƒç´ ï¼Œå¹¶å°†ä»–ä»¬åŠ å…¥åˆ°ç»™å®šçš„ Collection ä¸­    </span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">drainTo</span><span class="params">(Collection&lt;? <span class="built_in">super</span> E&gt; c)</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿”å›æ­¤é˜Ÿåˆ—ä¸­æŒ‰æ­£ç¡®é¡ºåºè¿›è¡Œè¿­ä»£çš„ï¼ŒåŒ…å«æ‰€æœ‰å…ƒç´ çš„è¿­ä»£å™¨</span></span><br><span class="line"><span class="keyword">public</span> Iterator&lt;E&gt; <span class="title function_">iterator</span><span class="params">()</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="LinkedBlockingQueue"><a href="#LinkedBlockingQueue" class="headerlink" title="LinkedBlockingQueue"></a>LinkedBlockingQueue</h2><p>LinkedBlockingQueue æ˜¯ä¸€ä¸ªç”¨å•å‘é“¾è¡¨å®ç°çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚æ­¤é˜Ÿåˆ—çš„é»˜è®¤å’Œæœ€å¤§é•¿åº¦ä¸º <code>Integer.MAX_VALUE</code>ã€‚æ­¤é˜Ÿåˆ—æŒ‰ç…§å…ˆè¿›å…ˆå‡ºçš„åŸåˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚</p><p>å¦‚æœä¸æ˜¯ç‰¹æ®Šä¸šåŠ¡ï¼ŒLinkedBlockingQueue ä½¿ç”¨æ—¶ï¼Œåˆ‡è®°è¦å®šä¹‰å®¹é‡ <code>new LinkedBlockingQueue(capacity)</code></p><p>ï¼Œé˜²æ­¢è¿‡åº¦è†¨èƒ€ã€‚</p><p><strong>æºç è§£è¯»</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LinkedBlockingQueue</span>&lt;E&gt; <span class="keyword">extends</span> <span class="title class_">AbstractQueue</span>&lt;E&gt;</span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">BlockingQueue</span>&lt;E&gt;, java.io.Serializable &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">6903933977591709194L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŸºäºé“¾è¡¨å®ç°ï¼Œè‚¯å®šè¦æœ‰ç»“ç‚¹ç±»ï¼Œå…¸å‹çš„å•é“¾è¡¨ç»“æ„</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;E&gt; &#123;</span><br><span class="line">        E item;</span><br><span class="line">        Node&lt;E&gt; next;</span><br><span class="line">        Node(E x) &#123; item = x; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®¹é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> capacity;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å½“å‰é˜Ÿåˆ—å…ƒç´ æ•°é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">count</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤´èŠ‚ç‚¹ï¼Œä¸å­˜æ•°æ®</span></span><br><span class="line">    <span class="keyword">transient</span> Node&lt;E&gt; head;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// å°¾èŠ‚ç‚¹ï¼Œä¾¿äºå…¥é˜Ÿ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Node&lt;E&gt; last;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// takeé”ï¼Œå‡ºé˜Ÿé”ï¼Œåªæœ‰takeï¼Œpollæ–¹æ³•ä¼šæŒæœ‰</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">takeLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‡ºé˜Ÿç­‰å¾…æ¡ä»¶</span></span><br><span class="line"><span class="comment">// å½“é˜Ÿåˆ—æ— å…ƒç´ æ—¶ï¼Œtakeé”ä¼šé˜»å¡åœ¨notEmptyæ¡ä»¶ä¸Šï¼Œç­‰å¾…å…¶å®ƒçº¿ç¨‹å”¤é†’</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Condition</span> <span class="variable">notEmpty</span> <span class="operator">=</span> takeLock.newCondition();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…¥é˜Ÿé”ï¼Œåªæœ‰putï¼Œofferä¼šæŒæœ‰</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">putLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…¥é˜Ÿç­‰å¾…æ¡ä»¶</span></span><br><span class="line">  <span class="comment">// å½“é˜Ÿåˆ—æ»¡äº†æ—¶ï¼Œputé”ä¼šä¼šé˜»å¡åœ¨notFullä¸Šï¼Œç­‰å¾…å…¶å®ƒçº¿ç¨‹å”¤é†’</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Condition</span> <span class="variable">notFull</span> <span class="operator">=</span> putLock.newCondition();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åŒæ ·æä¾›ä¸‰ä¸ªæ„é€ å™¨</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LinkedBlockingQueue</span><span class="params">(<span class="type">int</span> capacity)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (capacity &lt;= <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">       <span class="comment">// åˆå§‹åŒ–headå’ŒlastæŒ‡é’ˆä¸ºç©ºå€¼èŠ‚ç‚¹</span></span><br><span class="line">        <span class="built_in">this</span>.capacity = capacity;</span><br><span class="line">        last = head = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;E&gt;(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LinkedBlockingQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæ²¡ä¼ å®¹é‡ï¼Œå°±ä½¿ç”¨æœ€å¤§intå€¼åˆå§‹åŒ–å…¶å®¹é‡</span></span><br><span class="line">        <span class="built_in">this</span>(Integer.MAX_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LinkedBlockingQueue</span><span class="params">(Collection&lt;? extends E&gt; c)</span> &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å…¥é˜Ÿ</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(E e)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// ä¸å…è®¸nullå…ƒç´ </span></span><br><span class="line">        <span class="keyword">if</span> (e == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">        <span class="comment">//è§„å®šç»™å½“å‰putæ–¹æ³•é¢„ç•™ä¸€ä¸ªæœ¬åœ°å˜é‡</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="comment">// æ–°å»ºä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        Node&lt;E&gt; node = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;E&gt;(e);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">putLock</span> <span class="operator">=</span> <span class="built_in">this</span>.putLock;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">count</span> <span class="operator">=</span> <span class="built_in">this</span>.count;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨puté”åŠ é”</span></span><br><span class="line">        putLock.lockInterruptibly();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">// å¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œå°±é˜»å¡åœ¨notFullæ¡ä»¶ä¸Š</span></span><br><span class="line">        <span class="comment">// ç­‰å¾…è¢«å…¶å®ƒçº¿ç¨‹å”¤é†’</span></span><br><span class="line">            <span class="keyword">while</span> (count.get() == capacity) &#123;</span><br><span class="line">                notFull.await();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// é˜Ÿåˆ—ä¸æ»¡äº†ï¼Œå°±å…¥é˜Ÿ</span></span><br><span class="line">            enqueue(node);</span><br><span class="line">            <span class="comment">// é˜Ÿåˆ—é•¿åº¦åŠ 1</span></span><br><span class="line">            c = count.getAndIncrement();</span><br><span class="line">            <span class="comment">// å¦‚æœç°é˜Ÿåˆ—é•¿åº¦å°äºå®¹é‡</span></span><br><span class="line">        <span class="comment">// å°±å†å”¤é†’ä¸€ä¸ªé˜»å¡åœ¨notFullæ¡ä»¶ä¸Šçš„çº¿ç¨‹</span></span><br><span class="line">            <span class="comment">// è¿™é‡Œä¸ºå•¥è¦å”¤é†’ä¸€ä¸‹å‘¢ï¼Ÿ</span></span><br><span class="line">            <span class="comment">// å› ä¸ºå¯èƒ½æœ‰å¾ˆå¤šçº¿ç¨‹é˜»å¡åœ¨notFullè¿™ä¸ªæ¡ä»¶ä¸Šçš„</span></span><br><span class="line">            <span class="comment">// è€Œå–å…ƒç´ æ—¶åªæœ‰å–ä¹‹å‰é˜Ÿåˆ—æ˜¯æ»¡çš„æ‰ä¼šå”¤é†’notFull</span></span><br><span class="line">            <span class="comment">// ä¸ºä»€ä¹ˆé˜Ÿåˆ—æ»¡çš„æ‰å”¤é†’notFullå‘¢ï¼Ÿ</span></span><br><span class="line">            <span class="comment">// å› ä¸ºå”¤é†’æ˜¯éœ€è¦åŠ putLockçš„ï¼Œè¿™æ˜¯ä¸ºäº†å‡å°‘é”çš„æ¬¡æ•°</span></span><br><span class="line">            <span class="comment">// æ‰€ä»¥ï¼Œè¿™é‡Œç´¢æ€§åœ¨æ”¾å®Œå…ƒç´ å°±æ£€æµ‹ä¸€ä¸‹ï¼Œæœªæ»¡å°±å”¤é†’å…¶å®ƒnotFullä¸Šçš„çº¿ç¨‹</span></span><br><span class="line">            <span class="comment">// è¯´ç™½äº†ï¼Œè¿™ä¹Ÿæ˜¯é”åˆ†ç¦»å¸¦æ¥çš„ä»£ä»·</span></span><br><span class="line">            <span class="keyword">if</span> (c + <span class="number">1</span> &lt; capacity)</span><br><span class="line">                notFull.signal();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">            putLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœåŸé˜Ÿåˆ—é•¿åº¦ä¸º0ï¼Œç°åœ¨åŠ äº†ä¸€ä¸ªå…ƒç´ åç«‹å³å”¤é†’notEmptyæ¡ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>)</span><br><span class="line">            signalNotEmpty();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">signalNotEmpty</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">takeLock</span> <span class="operator">=</span> <span class="built_in">this</span>.takeLock;</span><br><span class="line">        <span class="comment">// åŠ takeé”</span></span><br><span class="line">        takeLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// å”¤é†’notEmptyæ¡ä»¶</span></span><br><span class="line">            notEmpty.signal();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            takeLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">signalNotFull</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">putLock</span> <span class="operator">=</span> <span class="built_in">this</span>.putLock;</span><br><span class="line">        putLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            notFull.signal();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            putLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">enqueue</span><span class="params">(Node&lt;E&gt; node)</span> &#123;</span><br><span class="line">        <span class="comment">// ç›´æ¥åŠ åˆ°laståé¢</span></span><br><span class="line">        last = last.next = node;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(E e)</span> &#123;</span><br><span class="line"><span class="comment">//ç”¨å¸¦è¿‡æœŸæ—¶é—´çš„è¯´æ˜</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(E e, <span class="type">long</span> timeout, TimeUnit unit)</span></span><br><span class="line">        <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (e == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">        <span class="comment">//è½¬æ¢ä¸ºçº³ç§’</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">nanos</span> <span class="operator">=</span> unit.toNanos(timeout);</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">putLock</span> <span class="operator">=</span> <span class="built_in">this</span>.putLock;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">count</span> <span class="operator">=</span> <span class="built_in">this</span>.count;</span><br><span class="line">        <span class="comment">//è·å–å…¥é˜Ÿé”ï¼Œæ”¯æŒç­‰å¾…é”çš„è¿‡ç¨‹ä¸­è¢«ä¸­æ–­</span></span><br><span class="line">        putLock.lockInterruptibly();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//é˜Ÿåˆ—æ»¡äº†ï¼Œå†çœ‹çœ‹æœ‰æ²¡æœ‰è¶…æ—¶</span></span><br><span class="line">            <span class="keyword">while</span> (count.get() == capacity) &#123;</span><br><span class="line">                <span class="keyword">if</span> (nanos &lt;= <span class="number">0</span>)</span><br><span class="line">                    <span class="comment">//ç­‰å¾…æ—¶é—´è¶…æ—¶</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                <span class="comment">//è¿›è¡Œç­‰å¾…ï¼ŒawaitNanos(long nanos)æ˜¯AQSä¸­çš„æ–¹æ³•</span></span><br><span class="line">                <span class="comment">//åœ¨ç­‰å¾…è¿‡ç¨‹ä¸­ï¼Œå¦‚æœè¢«å”¤é†’æˆ–è¶…æ—¶ï¼Œåˆ™ç»§ç»­å½“å‰å¾ªç¯</span></span><br><span class="line">                <span class="comment">//å¦‚æœè¢«ä¸­æ–­ï¼Œåˆ™æŠ›å‡ºä¸­æ–­å¼‚å¸¸</span></span><br><span class="line">                nanos = notFull.awaitNanos(nanos);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//è¿›å…¥é˜Ÿå°¾</span></span><br><span class="line">            enqueue(<span class="keyword">new</span> <span class="title class_">Node</span>&lt;E&gt;(e));</span><br><span class="line">            c = count.getAndIncrement();</span><br><span class="line">            <span class="comment">//è¯´æ˜å½“å‰å…ƒç´ åé¢è¿˜èƒ½å†æ’å…¥ä¸€ä¸ª</span></span><br><span class="line">            <span class="comment">//å°±å”¤é†’ä¸€ä¸ªå…¥é˜Ÿæ¡ä»¶é˜Ÿåˆ—ä¸­é˜»å¡çš„çº¿ç¨‹</span></span><br><span class="line">            <span class="keyword">if</span> (c + <span class="number">1</span> &lt; capacity)</span><br><span class="line">                notFull.signal();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            putLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//èŠ‚ç‚¹æ•°é‡ä¸º0ï¼Œè¯´æ˜é˜Ÿåˆ—æ˜¯ç©ºçš„</span></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>)</span><br><span class="line">            <span class="comment">//å”¤é†’ä¸€ä¸ªå‡ºé˜Ÿæ¡ä»¶é˜Ÿåˆ—é˜»å¡çš„çº¿ç¨‹</span></span><br><span class="line">            signalNotEmpty();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> E <span class="title function_">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        E x;</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">count</span> <span class="operator">=</span> <span class="built_in">this</span>.count;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">takeLock</span> <span class="operator">=</span> <span class="built_in">this</span>.takeLock;</span><br><span class="line">        takeLock.lockInterruptibly();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœé˜Ÿåˆ—æ— å…ƒç´ ï¼Œåˆ™é˜»å¡åœ¨notEmptyæ¡ä»¶ä¸Š</span></span><br><span class="line">            <span class="keyword">while</span> (count.get() == <span class="number">0</span>) &#123;</span><br><span class="line">                notEmpty.await();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¦åˆ™ï¼Œå‡ºé˜Ÿ</span></span><br><span class="line">            x = dequeue();</span><br><span class="line">            <span class="comment">// è·å–å‡ºé˜Ÿå‰é˜Ÿåˆ—çš„é•¿åº¦</span></span><br><span class="line">            c = count.getAndDecrement();</span><br><span class="line">            <span class="comment">// å¦‚æœå–ä¹‹å‰é˜Ÿåˆ—é•¿åº¦å¤§äº1ï¼Œåˆ™å”¤é†’notEmpty</span></span><br><span class="line">            <span class="keyword">if</span> (c &gt; <span class="number">1</span>)</span><br><span class="line">                notEmpty.signal();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            takeLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœå–ä¹‹å‰é˜Ÿåˆ—é•¿åº¦ç­‰äºå®¹é‡</span></span><br><span class="line">     <span class="comment">// åˆ™å”¤é†’notFull</span></span><br><span class="line">        <span class="keyword">if</span> (c == capacity)</span><br><span class="line">            signalNotFull();</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> E <span class="title function_">dequeue</span><span class="params">()</span> &#123;</span><br><span class="line">        Node&lt;E&gt; h = head;</span><br><span class="line">        Node&lt;E&gt; first = h.next;</span><br><span class="line">        h.next = h; <span class="comment">// help GC</span></span><br><span class="line">        head = first;</span><br><span class="line">        <span class="type">E</span> <span class="variable">x</span> <span class="operator">=</span> first.item;</span><br><span class="line">        first.item = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> E <span class="title function_">poll</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">E</span> <span class="variable">x</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="type">long</span> <span class="variable">nanos</span> <span class="operator">=</span> unit.toNanos(timeout);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">count</span> <span class="operator">=</span> <span class="built_in">this</span>.count;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">takeLock</span> <span class="operator">=</span> <span class="built_in">this</span>.takeLock;</span><br><span class="line">        takeLock.lockInterruptibly();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (count.get() == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//é˜Ÿåˆ—ä¸ºç©ºä¸”å·²ç»è¶…æ—¶ï¼Œç›´æ¥è¿”å›ç©º</span></span><br><span class="line">                <span class="keyword">if</span> (nanos &lt;= <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="comment">//ç­‰å¾…è¿‡ç¨‹ä¸­å¯èƒ½è¢«å”¤é†’ï¼Œè¶…æ—¶ï¼Œä¸­æ–­</span></span><br><span class="line">                nanos = notEmpty.awaitNanos(nanos);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//è¿›è¡Œå‡ºé˜Ÿæ“ä½œ</span></span><br><span class="line">            x = dequeue();</span><br><span class="line">            c = count.getAndDecrement();</span><br><span class="line">            <span class="keyword">if</span> (c &gt; <span class="number">1</span>)</span><br><span class="line">                notEmpty.signal();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            takeLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœå‡ºé˜Ÿå‰ï¼Œé˜Ÿåˆ—æ˜¯æ»¡çš„ï¼Œåˆ™å”¤é†’ä¸€ä¸ªè¢«take()é˜»å¡çš„çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">if</span> (c == capacity)</span><br><span class="line">            signalNotFull();</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> E <span class="title function_">poll</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> E <span class="title function_">peek</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (count.get() == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">takeLock</span> <span class="operator">=</span> <span class="built_in">this</span>.takeLock;</span><br><span class="line">        takeLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Node&lt;E&gt; first = head.next;</span><br><span class="line">            <span class="keyword">if</span> (first == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> first.item;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            takeLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">unlink</span><span class="params">(Node&lt;E&gt; p, Node&lt;E&gt; trail)</span> &#123;</span><br><span class="line">        <span class="comment">// assert isFullyLocked();</span></span><br><span class="line">        <span class="comment">// p.next is not changed, to allow iterators that are</span></span><br><span class="line">        <span class="comment">// traversing p to maintain their weak-consistency guarantee.</span></span><br><span class="line">        p.item = <span class="literal">null</span>;</span><br><span class="line">        trail.next = p.next;</span><br><span class="line">        <span class="keyword">if</span> (last == p)</span><br><span class="line">            last = trail;</span><br><span class="line">        <span class="keyword">if</span> (count.getAndDecrement() == capacity)</span><br><span class="line">            notFull.signal();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">remove</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        fullyLock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (Node&lt;E&gt; trail = head, p = trail.next;</span><br><span class="line">                 p != <span class="literal">null</span>;</span><br><span class="line">                 trail = p, p = p.next) &#123;</span><br><span class="line">                <span class="keyword">if</span> (o.equals(p.item)) &#123;</span><br><span class="line">                    unlink(p, trail);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            fullyUnlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">contains</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">LBQSpliterator</span>&lt;E&gt; <span class="keyword">implements</span> <span class="title class_">Spliterator</span>&lt;E&gt; &#123;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> <strong>LinkedBlockingQueue ä¸ ArrayBlockingQueueå¯¹æ¯”</strong></p><ul><li>ArrayBlockingQueue å…¥é˜Ÿå‡ºé˜Ÿé‡‡ç”¨ä¸€æŠŠé”ï¼Œå¯¼è‡´å…¥é˜Ÿå‡ºé˜Ÿç›¸äº’é˜»å¡ï¼Œæ•ˆç‡ä½ä¸‹ï¼›</li><li>LinkedBlockingQueue å…¥é˜Ÿå‡ºé˜Ÿé‡‡ç”¨ä¸¤æŠŠé”ï¼Œå…¥é˜Ÿå‡ºé˜Ÿäº’ä¸å¹²æ‰°ï¼Œæ•ˆç‡è¾ƒé«˜ï¼›</li><li>äºŒè€…éƒ½æ˜¯æœ‰ç•Œé˜Ÿåˆ—ï¼Œå¦‚æœé•¿åº¦ç›¸ç­‰ä¸”å‡ºé˜Ÿé€Ÿåº¦è·Ÿä¸ä¸Šå…¥é˜Ÿé€Ÿåº¦ï¼Œéƒ½ä¼šå¯¼è‡´å¤§é‡çº¿ç¨‹é˜»å¡ï¼›</li><li>LinkedBlockingQueue å¦‚æœåˆå§‹åŒ–ä¸ä¼ å…¥åˆå§‹å®¹é‡ï¼Œåˆ™ä½¿ç”¨æœ€å¤§ int å€¼ï¼Œå¦‚æœå‡ºé˜Ÿé€Ÿåº¦è·Ÿä¸ä¸Šå…¥é˜Ÿé€Ÿåº¦ï¼Œä¼šå¯¼è‡´é˜Ÿåˆ—ç‰¹åˆ«é•¿ï¼Œå ç”¨å¤§é‡å†…å­˜ï¼›</li></ul><h2 id="PriorityBlockingQueue"><a href="#PriorityBlockingQueue" class="headerlink" title="PriorityBlockingQueue"></a>PriorityBlockingQueue</h2><p>PriorityBlockingQueue æ˜¯ä¸€ä¸ªæ”¯æŒä¼˜å…ˆçº§çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚(è™½è¯´æ˜¯æ— ç•Œé˜Ÿåˆ—ï¼Œä½†æ˜¯ç”±äºèµ„æºè€—å°½çš„è¯ï¼Œä¹Ÿä¼šOutOfMemoryErrorï¼Œæ— æ³•æ·»åŠ å…ƒç´ )</p><p>é»˜è®¤æƒ…å†µä¸‹å…ƒç´ é‡‡ç”¨è‡ªç„¶é¡ºåºå‡åºæ’åˆ—ã€‚ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ç±»å®ç° <code>compareTo()</code> æ–¹æ³•æ¥æŒ‡å®šå…ƒç´ æ’åºè§„åˆ™ï¼Œæˆ–è€…åˆå§‹åŒ– PriorityBlockingQueue æ—¶ï¼ŒæŒ‡å®šæ„é€ å‚æ•° Comparator æ¥å¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚ä½†éœ€è¦æ³¨æ„çš„æ˜¯ä¸èƒ½ä¿è¯åŒä¼˜å…ˆçº§å…ƒç´ çš„é¡ºåºã€‚PriorityBlockingQueue æ˜¯åŸºäº<strong>æœ€å°äºŒå‰å †</strong>å®ç°ï¼Œä½¿ç”¨åŸºäº CAS å®ç°çš„è‡ªæ—‹é”æ¥æ§åˆ¶é˜Ÿåˆ—çš„åŠ¨æ€æ‰©å®¹ï¼Œä¿è¯äº†æ‰©å®¹æ“ä½œä¸ä¼šé˜»å¡ take æ“ä½œçš„æ‰§è¡Œã€‚</p><h2 id="DelayQueue"><a href="#DelayQueue" class="headerlink" title="DelayQueue"></a>DelayQueue</h2><p>DelayQueue æ˜¯ä¸€ä¸ªä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°çš„å»¶è¿Ÿæ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚</p><p>é˜Ÿåˆ—ä½¿ç”¨ PriorityQueue æ¥å®ç°ã€‚é˜Ÿåˆ—ä¸­çš„å…ƒç´ å¿…é¡»å®ç° Delayed æ¥å£ï¼Œåœ¨åˆ›å»ºå…ƒç´ æ—¶å¯ä»¥æŒ‡å®šå¤šä¹…æ‰èƒ½ä»é˜Ÿåˆ—ä¸­è·å–å½“å‰å…ƒç´ ã€‚åªæœ‰åœ¨å»¶è¿ŸæœŸæ»¡æ—¶æ‰èƒ½ä»é˜Ÿåˆ—ä¸­æå–å…ƒç´ ã€‚æˆ‘ä»¬å¯ä»¥å°† DelayQueue è¿ç”¨åœ¨ä»¥ä¸‹åº”ç”¨åœºæ™¯ï¼š</p><ul><li>ç¼“å­˜ç³»ç»Ÿçš„è®¾è®¡ï¼šå¯ä»¥ç”¨ DelayQueue ä¿å­˜ç¼“å­˜å…ƒç´ çš„æœ‰æ•ˆæœŸï¼Œä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹å¾ªç¯æŸ¥è¯¢ DelayQueueï¼Œä¸€æ—¦èƒ½ä» DelayQueue ä¸­è·å–å…ƒç´ æ—¶ï¼Œè¡¨ç¤ºç¼“å­˜æœ‰æ•ˆæœŸåˆ°äº†ã€‚</li><li>å®šæ—¶ä»»åŠ¡è°ƒåº¦ã€‚ä½¿ç”¨ DelayQueue ä¿å­˜å½“å¤©å°†ä¼šæ‰§è¡Œçš„ä»»åŠ¡å’Œæ‰§è¡Œæ—¶é—´ï¼Œä¸€æ—¦ä» DelayQueue ä¸­è·å–åˆ°ä»»åŠ¡å°±å¼€å§‹æ‰§è¡Œï¼Œä»æ¯”å¦‚ Timer å°±æ˜¯ä½¿ç”¨ DelayQueue å®ç°çš„ã€‚</li></ul><h2 id="SynchronousQueue"><a href="#SynchronousQueue" class="headerlink" title="SynchronousQueue"></a>SynchronousQueue</h2><p>SynchronousQueue æ˜¯ä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ï¼Œä¹Ÿå³æ˜¯å•ä¸ªå…ƒç´ çš„é˜Ÿåˆ—ã€‚</p><p>æ¯ä¸€ä¸ª put æ“ä½œå¿…é¡»ç­‰å¾…ä¸€ä¸ª take æ“ä½œï¼Œå¦åˆ™ä¸èƒ½ç»§ç»­æ·»åŠ å…ƒç´ ã€‚SynchronousQueue å¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªä¼ çƒæ‰‹ï¼Œè´Ÿè´£æŠŠç”Ÿäº§è€…çº¿ç¨‹å¤„ç†çš„æ•°æ®ç›´æ¥ä¼ é€’ç»™æ¶ˆè´¹è€…çº¿ç¨‹ã€‚é˜Ÿåˆ—æœ¬èº«å¹¶ä¸å­˜å‚¨ä»»ä½•å…ƒç´ ï¼Œéå¸¸é€‚åˆäºä¼ é€’æ€§åœºæ™¯, æ¯”å¦‚åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ä½¿ç”¨çš„æ•°æ®ï¼Œä¼ é€’ç»™å¦å¤–ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼ŒSynchronousQueue çš„ååé‡é«˜äº LinkedBlockingQueue å’Œ ArrayBlockingQueueã€‚</p><p> <strong>Coding</strong></p><p>synchronousQueue æ˜¯ä¸€ä¸ªæ²¡æœ‰æ•°æ®ç¼“å†²çš„é˜»å¡é˜Ÿåˆ—ï¼Œç”Ÿäº§è€…çº¿ç¨‹å¯¹å…¶çš„æ’å…¥æ“ä½œ put() å¿…é¡»ç­‰å¾…æ¶ˆè´¹è€…çš„ç§»é™¤æ“ä½œ take()ï¼Œåè¿‡æ¥ä¹Ÿä¸€æ ·ã€‚</p><p>å¯¹åº” peek, contains, clear, isEmpty â€¦ ç­‰æ–¹æ³•å…¶å®æ˜¯æ— æ•ˆçš„ã€‚</p><p>ä½†æ˜¯ poll() å’Œ offer() å°±ä¸ä¼šé˜»å¡ï¼Œä¸¾ä¾‹æ¥è¯´å°±æ˜¯ offer çš„æ—¶å€™å¦‚æœæœ‰æ¶ˆè´¹è€…åœ¨ç­‰å¾…é‚£ä¹ˆå°±ä¼šç«‹é©¬æ»¡è¶³è¿”å› trueï¼Œå¦‚æœæ²¡æœ‰å°±ä¼šè¿”å› falseï¼Œä¸ä¼šç­‰å¾…æ¶ˆè´¹è€…åˆ°æ¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SynchronousQueueDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        BlockingQueue&lt;String&gt; queue = <span class="keyword">new</span> <span class="title class_">SynchronousQueue</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">      <span class="comment">//System.out.println(queue.offer(&quot;aaa&quot;));   //false</span></span><br><span class="line">        <span class="comment">//System.out.println(queue.poll());         //null</span></span><br><span class="line"></span><br><span class="line">        System.out.println(queue.add(<span class="string">&quot;bbb&quot;</span>));      <span class="comment">//IllegalStateException: Queue full</span></span><br><span class="line">      </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Thread 1 put a&quot;</span>);</span><br><span class="line">                queue.put(<span class="string">&quot;a&quot;</span>);</span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">&quot;Thread 1 put b&quot;</span>);</span><br><span class="line">                queue.put(<span class="string">&quot;b&quot;</span>);</span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">&quot;Thread 1 put c&quot;</span>);</span><br><span class="line">                queue.put(<span class="string">&quot;c&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;Thread 2 get:&quot;</span>+queue.take());</span><br><span class="line"></span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;Thread 2 get:&quot;</span>+queue.take());</span><br><span class="line"></span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;Thread 2 get:&quot;</span>+queue.take());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Thread <span class="number">1</span> put a</span><br><span class="line">Thread <span class="number">2</span> get:a</span><br><span class="line">Thread <span class="number">1</span> put b</span><br><span class="line">Thread <span class="number">2</span> get:b</span><br><span class="line">Thread <span class="number">1</span> put c</span><br><span class="line">Thread <span class="number">2</span> get:c</span><br></pre></td></tr></table></figure><p><strong>æºç è§£è¯»</strong></p><p>ä¸åƒArrayBlockingQueueã€LinkedBlockingDequeä¹‹ç±»çš„é˜»å¡é˜Ÿåˆ—ä¾èµ–AQSå®ç°å¹¶å‘æ“ä½œï¼ŒSynchronousQueueç›´æ¥ä½¿ç”¨CASå®ç°çº¿ç¨‹çš„å®‰å…¨è®¿é—®ã€‚</p><p>synchronousQueue æä¾›äº†ä¸¤ä¸ªæ„é€ å™¨ï¼ˆå…¬å¹³ä¸å¦ï¼‰ï¼Œå†…éƒ¨æ˜¯é€šè¿‡ Transferer æ¥å®ç°çš„ï¼Œå…·ä½“åˆ†ä¸ºä¸¤ä¸ªTransfererï¼Œåˆ†åˆ«æ˜¯ TransferStack å’Œ TransferQueueã€‚</p><p>TransferStackï¼šéå…¬å¹³ç«äº‰æ¨¡å¼ä½¿ç”¨çš„æ•°æ®ç»“æ„æ˜¯åè¿›å…ˆå‡ºæ ˆ(LIFO Stack)</p><p>TransferQueueï¼šå…¬å¹³ç«äº‰æ¨¡å¼åˆ™ä½¿ç”¨å…ˆè¿›å…ˆå‡ºé˜Ÿåˆ—ï¼ˆFIFO Queueï¼‰</p><p>æ€§èƒ½ä¸Šä¸¤è€…æ˜¯ç›¸å½“çš„ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒFIFO é€šå¸¸å¯ä»¥æ”¯æŒæ›´å¤§çš„ååé‡ï¼Œä½† LIFO å¯ä»¥æ›´å¤§ç¨‹åº¦çš„ä¿æŒçº¿ç¨‹çš„æœ¬åœ°åŒ–ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Transferer&lt;E&gt; transferer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">SynchronousQueue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">SynchronousQueue</span><span class="params">(<span class="type">boolean</span> fair)</span> &#123;</span><br><span class="line">    transferer = fair ? <span class="keyword">new</span> <span class="title class_">TransferQueue</span>&lt;E&gt;() : <span class="keyword">new</span> <span class="title class_">TransferStack</span>&lt;E&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ†æ TransferQueue çš„å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ„é€ å‡½æ•°ä¸­ä¼šåˆå§‹åŒ–ä¸€ä¸ªå‡ºé˜Ÿçš„èŠ‚ç‚¹ï¼Œå¹¶ä¸”é¦–å°¾éƒ½æŒ‡å‘è¿™ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">TransferQueue() &#123;</span><br><span class="line">    <span class="type">QNode</span> <span class="variable">h</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QNode</span>(<span class="literal">null</span>, <span class="literal">false</span>); <span class="comment">// initialize to dummy node.</span></span><br><span class="line">    head = h;</span><br><span class="line">    tail = h;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//é˜Ÿåˆ—èŠ‚ç‚¹,</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">QNode</span> &#123;</span><br><span class="line">  <span class="keyword">volatile</span> QNode next;          <span class="comment">// next node in queue</span></span><br><span class="line">  <span class="keyword">volatile</span> Object item;         <span class="comment">// CAS&#x27;ed to or from null</span></span><br><span class="line">  <span class="keyword">volatile</span> Thread waiter;       <span class="comment">// to control park/unpark</span></span><br><span class="line">  <span class="keyword">final</span> <span class="type">boolean</span> isData;</span><br><span class="line"></span><br><span class="line">  QNode(Object item, <span class="type">boolean</span> isData) &#123;</span><br><span class="line">    <span class="built_in">this</span>.item = item;</span><br><span class="line">    <span class="built_in">this</span>.isData = isData;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// è®¾ç½®nextå’Œitemçš„å€¼ï¼Œç”¨äºè¿›è¡Œå¹¶å‘æ›´æ–°, cas æ— é”æ“ä½œ</span></span><br><span class="line">  <span class="type">boolean</span> <span class="title function_">casNext</span><span class="params">(QNode cmp, QNode val)</span> &#123;</span><br><span class="line">    <span class="type">return</span> <span class="variable">next</span> <span class="operator">=</span>= cmp &amp;&amp;</span><br><span class="line">      UNSAFE.compareAndSwapObject(<span class="built_in">this</span>, nextOffset, cmp, val);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">boolean</span> <span class="title function_">casItem</span><span class="params">(Object cmp, Object val)</span> &#123;</span><br><span class="line">    <span class="type">return</span> <span class="variable">item</span> <span class="operator">=</span>= cmp &amp;&amp;</span><br><span class="line">      UNSAFE.compareAndSwapObject(<span class="built_in">this</span>, itemOffset, cmp, val);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">tryCancel</span><span class="params">(Object cmp)</span> &#123;</span><br><span class="line">    UNSAFE.compareAndSwapObject(<span class="built_in">this</span>, itemOffset, cmp, <span class="built_in">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">boolean</span> <span class="title function_">isCancelled</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">return</span> <span class="variable">item</span> <span class="operator">=</span>= <span class="built_in">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">boolean</span> <span class="title function_">isOffList</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">return</span> <span class="variable">next</span> <span class="operator">=</span>= <span class="built_in">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Unsafe mechanics</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> sun.misc.Unsafe UNSAFE;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> itemOffset;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> nextOffset;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      UNSAFE = sun.misc.Unsafe.getUnsafe();</span><br><span class="line">      Class&lt;?&gt; k = QNode.class;</span><br><span class="line">      itemOffset = UNSAFE.objectFieldOffset</span><br><span class="line">        (k.getDeclaredField(<span class="string">&quot;item&quot;</span>));</span><br><span class="line">      nextOffset = UNSAFE.objectFieldOffset</span><br><span class="line">        (k.getDeclaredField(<span class="string">&quot;next&quot;</span>));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä» <code>put()</code> æ–¹æ³•å’Œ <code>take()</code> æ–¹æ³•å¯ä»¥çœ‹å‡ºæœ€ç»ˆè°ƒç”¨çš„éƒ½æ˜¯ TransferQueue çš„ <code>transfer()</code> æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(E e)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="keyword">if</span> (e == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="keyword">if</span> (transferer.transfer(e, <span class="literal">false</span>, <span class="number">0</span>) == <span class="literal">null</span>) &#123;</span><br><span class="line">        Thread.interrupted();</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> E <span class="title function_">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">  <span class="type">E</span> <span class="variable">e</span> <span class="operator">=</span> transferer.transfer(<span class="literal">null</span>, <span class="literal">false</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (e != <span class="literal">null</span>)</span><br><span class="line">    <span class="keyword">return</span> e;</span><br><span class="line">  Thread.interrupted();</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//transferæ–¹æ³•ç”¨äºæäº¤æ•°æ®æˆ–è€…æ˜¯è·å–æ•°æ®</span></span><br><span class="line">E <span class="title function_">transfer</span><span class="params">(E e, <span class="type">boolean</span> timed, <span class="type">long</span> nanos)</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">QNode</span> <span class="variable">s</span> <span class="operator">=</span> <span class="literal">null</span>; <span class="comment">// constructed/reused as needed</span></span><br><span class="line">  <span class="comment">//å¦‚æœeä¸ä¸ºnullï¼Œå°±è¯´æ˜æ˜¯æ·»åŠ æ•°æ®çš„å…¥é˜Ÿæ“ä½œ</span></span><br><span class="line">  <span class="type">boolean</span> <span class="variable">isData</span> <span class="operator">=</span> (e != <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="type">QNode</span> <span class="variable">t</span> <span class="operator">=</span> tail;</span><br><span class="line">    <span class="type">QNode</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">    <span class="keyword">if</span> (t == <span class="literal">null</span> || h == <span class="literal">null</span>)         <span class="comment">// saw uninitialized value</span></span><br><span class="line">      <span class="keyword">continue</span>;                       <span class="comment">// spin</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¦‚æœå½“å‰æ“ä½œå’Œ tail èŠ‚ç‚¹çš„æ“ä½œæ˜¯ä¸€æ ·çš„ï¼›æˆ–è€…å¤´å°¾ç›¸åŒï¼ˆè¡¨æ˜é˜Ÿåˆ—ä¸­å•¥éƒ½æ²¡æœ‰ï¼‰ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (h == t || t.isData == isData) &#123; <span class="comment">// empty or same-mode</span></span><br><span class="line">      <span class="type">QNode</span> <span class="variable">tn</span> <span class="operator">=</span> t.next;</span><br><span class="line">      <span class="comment">// å¦‚æœ t å’Œ tail ä¸ä¸€æ ·ï¼Œè¯´æ˜ï¼Œtail è¢«å…¶ä»–çš„çº¿ç¨‹æ”¹äº†ï¼Œé‡æ¥</span></span><br><span class="line">      <span class="keyword">if</span> (t != tail)                  <span class="comment">// inconsistent read</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      <span class="comment">// å¦‚æœ tail çš„ next ä¸æ˜¯ç©ºã€‚å°±éœ€è¦å°† next è¿½åŠ åˆ° tail åé¢äº†</span></span><br><span class="line">      <span class="keyword">if</span> (tn != <span class="literal">null</span>) &#123;               <span class="comment">// lagging tail</span></span><br><span class="line">        <span class="comment">// ä½¿ç”¨ CAS å°† tail.next å˜æˆ tail,</span></span><br><span class="line">        advanceTail(t, tn);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// æ—¶é—´åˆ°äº†ï¼Œä¸ç­‰å¾…ï¼Œè¿”å› nullï¼Œæ’å…¥å¤±è´¥ï¼Œè·å–ä¹Ÿæ˜¯å¤±è´¥çš„</span></span><br><span class="line">      <span class="keyword">if</span> (timed &amp;&amp; nanos &lt;= <span class="number">0</span>)        <span class="comment">// can&#x27;t wait</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">if</span> (s == <span class="literal">null</span>)</span><br><span class="line">        s = <span class="keyword">new</span> <span class="title class_">QNode</span>(e, isData);</span><br><span class="line">      <span class="keyword">if</span> (!t.casNext(<span class="literal">null</span>, s))        <span class="comment">// failed to link in</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">      advanceTail(t, s);              <span class="comment">// swing tail and wait</span></span><br><span class="line">      <span class="type">Object</span> <span class="variable">x</span> <span class="operator">=</span> awaitFulfill(s, e, timed, nanos);</span><br><span class="line">      <span class="keyword">if</span> (x == s) &#123;                   <span class="comment">// wait was cancelled</span></span><br><span class="line">        clean(t, s);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!s.isOffList()) &#123;           <span class="comment">// not already unlinked</span></span><br><span class="line">        advanceHead(t, s);          <span class="comment">// unlink if head</span></span><br><span class="line">        <span class="keyword">if</span> (x != <span class="literal">null</span>)              <span class="comment">// and forget fields</span></span><br><span class="line">          s.item = s;</span><br><span class="line">        s.waiter = <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> (x != <span class="literal">null</span>) ? (E)x : e;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;                            <span class="comment">// complementary-mode</span></span><br><span class="line">      <span class="type">QNode</span> <span class="variable">m</span> <span class="operator">=</span> h.next;               <span class="comment">// node to fulfill</span></span><br><span class="line">      <span class="keyword">if</span> (t != tail || m == <span class="literal">null</span> || h != head)</span><br><span class="line">        <span class="keyword">continue</span>;                   <span class="comment">// inconsistent read</span></span><br><span class="line"></span><br><span class="line">      <span class="type">Object</span> <span class="variable">x</span> <span class="operator">=</span> m.item;</span><br><span class="line">      <span class="keyword">if</span> (isData == (x != <span class="literal">null</span>) ||    <span class="comment">// m already fulfilled</span></span><br><span class="line">          x == m ||                   <span class="comment">// m cancelled</span></span><br><span class="line">          !m.casItem(x, e)) &#123;         <span class="comment">// lost CAS</span></span><br><span class="line">        advanceHead(h, m);          <span class="comment">// dequeue and retry</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      advanceHead(h, m);              <span class="comment">// successfully fulfilled</span></span><br><span class="line">      LockSupport.unpark(m.waiter);</span><br><span class="line">      <span class="keyword">return</span> (x != <span class="literal">null</span>) ? (E)x : e;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="LinkedTransferQueue"><a href="#LinkedTransferQueue" class="headerlink" title="LinkedTransferQueue"></a>LinkedTransferQueue</h2><p>LinkedTransferQueue æ˜¯ä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æ— ç•Œé˜»å¡ TransferQueue é˜Ÿåˆ—ã€‚</p><p>LinkedTransferQueueé‡‡ç”¨ä¸€ç§é¢„å æ¨¡å¼ã€‚æ„æ€å°±æ˜¯æ¶ˆè´¹è€…çº¿ç¨‹å–å…ƒç´ æ—¶ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œåˆ™ç›´æ¥å–èµ°æ•°æ®ï¼Œè‹¥é˜Ÿåˆ—ä¸ºç©ºï¼Œé‚£å°±ç”Ÿæˆä¸€ä¸ªèŠ‚ç‚¹ï¼ˆèŠ‚ç‚¹å…ƒç´ ä¸ºnullï¼‰å…¥é˜Ÿï¼Œç„¶åæ¶ˆè´¹è€…çº¿ç¨‹è¢«ç­‰å¾…åœ¨è¿™ä¸ªèŠ‚ç‚¹ä¸Šï¼Œåé¢ç”Ÿäº§è€…çº¿ç¨‹å…¥é˜Ÿæ—¶å‘ç°æœ‰ä¸€ä¸ªå…ƒç´ ä¸ºnullçš„èŠ‚ç‚¹ï¼Œç”Ÿäº§è€…çº¿ç¨‹å°±ä¸å…¥é˜Ÿäº†ï¼Œç›´æ¥å°±å°†å…ƒç´ å¡«å……åˆ°è¯¥èŠ‚ç‚¹ï¼Œå¹¶å”¤é†’è¯¥èŠ‚ç‚¹ç­‰å¾…çš„çº¿ç¨‹ï¼Œè¢«å”¤é†’çš„æ¶ˆè´¹è€…çº¿ç¨‹å–èµ°å…ƒç´ ï¼Œä»è°ƒç”¨çš„æ–¹æ³•è¿”å›ã€‚æˆ‘ä»¬ç§°è¿™ç§èŠ‚ç‚¹æ“ä½œä¸ºâ€œåŒ¹é…â€æ–¹å¼ã€‚</p><p>é˜Ÿåˆ—å®ç°äº† TransferQueue æ¥å£é‡å†™äº† tryTransfer å’Œ transfer æ–¹æ³•ï¼Œè¿™ç»„æ–¹æ³•å’Œ SynchronousQueue å…¬å¹³æ¨¡å¼çš„é˜Ÿåˆ—ç±»ä¼¼ï¼Œå…·æœ‰åŒ¹é…çš„åŠŸèƒ½</p><h2 id="LinkedBlockingDeque"><a href="#LinkedBlockingDeque" class="headerlink" title="LinkedBlockingDeque"></a>LinkedBlockingDeque</h2><p>LinkedBlockingDeque æ˜¯ä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„åŒå‘é˜»å¡é˜Ÿåˆ—ã€‚</p><p>æ‰€è°“åŒå‘é˜Ÿåˆ—æŒ‡çš„ä½ å¯ä»¥ä»é˜Ÿåˆ—çš„ä¸¤ç«¯æ’å…¥å’Œç§»å‡ºå…ƒç´ ã€‚åŒç«¯é˜Ÿåˆ—å› ä¸ºå¤šäº†ä¸€ä¸ªæ“ä½œé˜Ÿåˆ—çš„å…¥å£ï¼Œåœ¨å¤šçº¿ç¨‹åŒæ—¶å…¥é˜Ÿæ—¶ï¼Œä¹Ÿå°±å‡å°‘äº†ä¸€åŠçš„ç«äº‰ã€‚ç›¸æ¯”å…¶ä»–çš„é˜»å¡é˜Ÿåˆ—ï¼ŒLinkedBlockingDeque å¤šäº† addFirstï¼ŒaddLastï¼ŒofferFirstï¼ŒofferLastï¼ŒpeekFirstï¼ŒpeekLast ç­‰æ–¹æ³•ï¼Œä»¥ First å•è¯ç»“å°¾çš„æ–¹æ³•ï¼Œè¡¨ç¤ºæ’å…¥ï¼Œè·å–ï¼ˆpeekï¼‰æˆ–ç§»é™¤åŒç«¯é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚ä»¥ Last å•è¯ç»“å°¾çš„æ–¹æ³•ï¼Œè¡¨ç¤ºæ’å…¥ï¼Œè·å–æˆ–ç§»é™¤åŒç«¯é˜Ÿåˆ—çš„æœ€åä¸€ä¸ªå…ƒç´ ã€‚å¦å¤–æ’å…¥æ–¹æ³• add ç­‰åŒäº addLastï¼Œç§»é™¤æ–¹æ³• remove ç­‰æ•ˆäº removeFirstã€‚</p><p>åœ¨åˆå§‹åŒ– LinkedBlockingDeque æ—¶å¯ä»¥è®¾ç½®å®¹é‡é˜²æ­¢å…¶è¿‡æ¸¡è†¨èƒ€ï¼Œé»˜è®¤å®¹é‡ä¹Ÿæ˜¯ Integer.MAX_VALUEã€‚å¦å¤–åŒå‘é˜»å¡é˜Ÿåˆ—å¯ä»¥è¿ç”¨åœ¨â€œå·¥ä½œçªƒå–â€æ¨¡å¼ä¸­ã€‚</p><h1 id="é˜»å¡é˜Ÿåˆ—ä½¿ç”¨åœºæ™¯"><a href="#é˜»å¡é˜Ÿåˆ—ä½¿ç”¨åœºæ™¯" class="headerlink" title="é˜»å¡é˜Ÿåˆ—ä½¿ç”¨åœºæ™¯"></a>é˜»å¡é˜Ÿåˆ—ä½¿ç”¨åœºæ™¯</h1><p>æˆ‘ä»¬å¸¸ç”¨çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼å°±å¯ä»¥åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ï¼›</p><p>çº¿ç¨‹æ± ä¸­æ´»è·ƒçº¿ç¨‹æ•°è¾¾åˆ° corePoolSize æ—¶ï¼Œçº¿ç¨‹æ± å°†ä¼šå°†åç»­çš„ task æäº¤åˆ° BlockingQueue ä¸­ï¼›</p><h2 id="ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼"><a href="#ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼" class="headerlink" title="ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼"></a>ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼</h2><p>JDK APIæ–‡æ¡£çš„ BlockingQueue ç»™å‡ºäº†ä¸€ä¸ªå…¸å‹çš„åº”ç”¨</p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/je73vyt2gq.jpeg"></p><blockquote><p>é¢è¯•é¢˜ï¼šä¸€ä¸ªåˆå§‹å€¼ä¸º 0 çš„å˜é‡ï¼Œä¸¤ä¸ªçº¿ç¨‹å¯¹é½äº¤æ›¿æ“ä½œï¼Œä¸€ä¸ª+1ï¼Œä¸€ä¸ª-1ï¼Œ5 è½®</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProdCounsume_TraditionDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">ShareData</span> <span class="variable">shareData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShareData</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt;= <span class="number">5</span>; i++) &#123;</span><br><span class="line">                shareData.increment();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;T1&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt;= <span class="number">5</span>; i++) &#123;</span><br><span class="line">                shareData.decrement();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;T1&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//çº¿ç¨‹æ“ä½œèµ„æºç±»</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ShareData</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Condition</span> <span class="variable">condition</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (num != <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//ç­‰å¾…ï¼Œä¸èƒ½ç”Ÿäº§</span></span><br><span class="line">                condition.await();</span><br><span class="line">            &#125;</span><br><span class="line">                <span class="comment">//å¹²æ´»</span></span><br><span class="line">                num++;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">&quot;\t&quot;</span> + num);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//å”¤é†’</span></span><br><span class="line">                condition.signal();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">decrement</span><span class="params">()</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (num == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//ç­‰å¾…ï¼Œä¸èƒ½ç”Ÿäº§</span></span><br><span class="line">                condition.await();</span><br><span class="line">            &#125;</span><br><span class="line">                <span class="comment">//å¹²æ´»</span></span><br><span class="line">                num--;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">&quot;\t&quot;</span> + num);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//å”¤é†’</span></span><br><span class="line">                condition.signal();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="çº¿ç¨‹æ± "><a href="#çº¿ç¨‹æ± " class="headerlink" title="çº¿ç¨‹æ± "></a>çº¿ç¨‹æ± </h2><p>çº¿ç¨‹æ± çš„æ ¸å¿ƒæ–¹æ³• ThreadPoolExecutorï¼Œç”¨ BlockingQueue å­˜æ”¾ä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ—ï¼Œè¢«æäº¤ä½†å°šæœªè¢«æ‰§è¡Œçš„ä»»åŠ¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ThreadPoolExecutor</span><span class="params">(<span class="type">int</span> corePoolSize,</span></span><br><span class="line"><span class="params">                          <span class="type">int</span> maximumPoolSize,</span></span><br><span class="line"><span class="params">                          <span class="type">long</span> keepAliveTime,</span></span><br><span class="line"><span class="params">                          TimeUnit unit,</span></span><br><span class="line"><span class="params">                          BlockingQueue&lt;Runnable&gt; workQueue,</span></span><br><span class="line"><span class="params">                          ThreadFactory threadFactory,</span></span><br><span class="line"><span class="params">                          RejectedExecutionHandler handler)</span></span><br></pre></td></tr></table></figure><p>çº¿ç¨‹æ± åœ¨å†…éƒ¨å®é™…ä¹Ÿæ˜¯æ„å»ºäº†ä¸€ä¸ªç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼Œå°†çº¿ç¨‹å’Œä»»åŠ¡ä¸¤è€…è§£è€¦ï¼Œå¹¶ä¸ç›´æ¥å…³è”ï¼Œä»è€Œè‰¯å¥½çš„ç¼“å†²ä»»åŠ¡ï¼Œå¤ç”¨çº¿ç¨‹ã€‚</p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/68wfrtnmnf.jpeg"></p><p>ä¸åŒçš„çº¿ç¨‹æ± å®ç°ç”¨çš„æ˜¯ä¸åŒçš„é˜»å¡é˜Ÿåˆ—ï¼ŒnewFixedThreadPool å’Œ newSingleThreadExecutor ç”¨çš„æ˜¯LinkedBlockingQueueï¼ŒnewCachedThreadPool ç”¨çš„æ˜¯ SynchronousQueueã€‚</p><p>å‚è€ƒï¼š</p><p><a href="https://cloud.tencent.com/developer/article/1706970">Java 7 ç§é˜»å¡é˜Ÿåˆ—è¯¦è§£ - è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒº-è…¾è®¯äº‘ (tencent.com)</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;é˜Ÿåˆ—å’Œé˜»å¡é˜Ÿåˆ—&quot;&gt;&lt;a href=&quot;#é˜Ÿåˆ—å’Œé˜»å¡é˜Ÿåˆ—&quot; class=&quot;headerlink&quot; title=&quot;é˜Ÿåˆ—å’Œé˜»å¡é˜Ÿåˆ—&quot;&gt;&lt;/a&gt;é˜Ÿåˆ—å’Œé˜»å¡é˜Ÿåˆ—&lt;/h1&gt;&lt;h2 id=&quot;é˜Ÿåˆ—&quot;&gt;&lt;a href=&quot;#é˜Ÿåˆ—&quot; class=&quot;headerlink&quot; title=&quot;é˜Ÿåˆ—&quot;&gt;&lt;/a&gt;é˜Ÿåˆ—&lt;/h2&gt;&lt;p&gt;é˜Ÿåˆ—ï¼ˆ&lt;code&gt;Queue&lt;/code&gt;ï¼‰æ˜¯ä¸€ç§ç»å¸¸ä½¿ç”¨çš„é›†åˆã€‚&lt;code&gt;Queue&lt;/code&gt; å®é™…ä¸Šæ˜¯å®ç°äº†ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼šFirst In First Outï¼‰çš„æœ‰åºè¡¨ã€‚å’Œ Listã€Set ä¸€æ ·éƒ½ç»§æ‰¿è‡ª Collectionã€‚å®ƒå’Œ &lt;code&gt;List&lt;/code&gt; çš„åŒºåˆ«åœ¨äºï¼Œ&lt;code&gt;List&lt;/code&gt;å¯ä»¥åœ¨ä»»æ„ä½ç½®æ·»åŠ å’Œåˆ é™¤å…ƒç´ ï¼Œè€Œ&lt;code&gt;Queue&lt;/code&gt; åªæœ‰ä¸¤ä¸ªæ“ä½œï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æŠŠå…ƒç´ æ·»åŠ åˆ°é˜Ÿåˆ—æœ«å°¾ï¼›&lt;/li&gt;
&lt;li&gt;ä»é˜Ÿåˆ—å¤´éƒ¨å–å‡ºå…ƒç´ ã€‚&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://xssdpgy.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="é˜Ÿåˆ—" scheme="https://xssdpgy.github.io/tags/%E9%98%9F%E5%88%97/"/>
    
  </entry>
  
  <entry>
    <title>TimeLimiteræ¥å£è¶…æ—¶ä¸­æ–­å®ç°åˆ†æ</title>
    <link href="https://xssdpgy.github.io/2023/01/31/TimeLimiter%E6%8E%A5%E5%8F%A3%E8%B6%85%E6%97%B6%E4%B8%AD%E6%96%AD%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90/"/>
    <id>https://xssdpgy.github.io/2023/01/31/TimeLimiter%E6%8E%A5%E5%8F%A3%E8%B6%85%E6%97%B6%E4%B8%AD%E6%96%AD%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90/</id>
    <published>2023-01-31T10:04:32.000Z</published>
    <updated>2023-02-07T16:26:00.599Z</updated>
    
    <content type="html"><![CDATA[<h1 id="0-èƒŒæ™¯"><a href="#0-èƒŒæ™¯" class="headerlink" title="0.èƒŒæ™¯"></a>0.èƒŒæ™¯</h1><span id="more"></span><p>å‰æ®µæ—¶é—´ï¼Œå…¶ä»–ç»„åŒäº‹æ‰¾åˆ°æˆ‘ï¼Œè¯´è®©æˆ‘ååŠ©çœ‹ä¸€ä¸ªäº‹åŠ¡æœªå›æ»šé—®é¢˜ï¼Œåˆšå¼€å§‹ä»¥ä¸ºæ˜¯äº‹åŠ¡éš”ç¦»è®¾ç½®æ–¹é¢çš„åŸå› ï¼Œç»“æœåŸå› å¾ˆç®€å•ï¼Œå› ä¸ºè¦ç»™æ¥å£æ·»åŠ è¶…æ—¶ä¸­æ–­çš„åŠŸèƒ½ï¼Œä»–æ ¹æ®ç½‘ä¸Šæ–‡ç« ä½¿ç”¨<code>java.util.concurrent.Future#get(long, java.util.concurrent.TimeUnit)</code>æ¥å®ç°è¶…æ—¶ä¸­æ–­åŠŸèƒ½ï¼Œç»“æœè¶…æ—¶åŠŸèƒ½å®ç°äº†ï¼Œä½†æ˜¯è¶…æ—¶æŠ›å‡ºå¼‚å¸¸åæ¥å£äº‹åŠ¡æ²¡æœ‰å›æ»šï¼Œæˆ‘çœ‹äº†ä¸‹ä»£ç ï¼Œä¸»è¦åŸå› æ˜¯æ–¹æ³•ä¸­ä½¿ç”¨çš„æ˜¯å£°æ˜å¼äº‹åŠ¡ï¼Œå¯¹äºæ–°å¼•å…¥çš„å¼‚æ­¥ä»»åŠ¡æ¥è¯´äº‹åŠ¡ç®¡ç†ç²’åº¦å¤ªç²—ç³™ï¼Œä¸”æ•è·è¶…æ—¶å¼‚å¸¸åï¼Œä»»åŠ¡æœªæ‰‹åŠ¨å–æ¶ˆã€‚ä¸‹æ„è¯†å‡†å¤‡è°ƒæ•´ä¸ºç¼–ç¨‹å¼äº‹åŠ¡æ¥ä½¿äº‹åŠ¡ç®¡ç†ç»†åŒ–ï¼Œç»“æœåˆšè¦ä¸‹æ‰‹æ—¶æƒ³åˆ°ä¸æ˜¯æœ‰ç°æˆçš„è½®å­å˜›ï¼Œä¸‹é¢å°±è¯¥è½®å­â€”â€”guavaçš„<code>TimeLimiter</code>è¿›è¡Œç®€è¦ä»‹ç»ã€‚</p><h1 id="1-ä½¿ç”¨åœºæ™¯æè¿°"><a href="#1-ä½¿ç”¨åœºæ™¯æè¿°" class="headerlink" title="1.ä½¿ç”¨åœºæ™¯æè¿°"></a>1.ä½¿ç”¨åœºæ™¯æè¿°</h1><p>ç½‘ä¸Šæ‰¾äº†æ®µè¯æè¿°æ¥å£è¶…æ—¶ä¸­æ–­çš„éœ€æ±‚åœºæ™¯ï¼š</p><ul><li>å¦‚æœè°ƒç”¨æ–¹æ³•è¶…è¿‡1ç§’ï¼Œå°±åº”è¯¥åœæ­¢è°ƒç”¨ï¼Œä¸è¦ä¸€ç›´é˜»å¡ä¸‹å»ï¼Œé˜²æ­¢æŠŠæœ¬èº«çš„æœåŠ¡èµ„æºææŒ‚ã€‚</li><li>åœ¨ä¸å¯é¢„çŸ¥å¯èƒ½å‡ºç°æ­»é”&#x2F;æ­»å¾ªç¯çš„ä»£ç ï¼Œè¦åŠ ä¸Šæ—¶é—´çš„é˜€å€¼ï¼Œé¿å…é˜»å¡ã€‚</li></ul><h1 id="2-TimeLimiterå®ç°æ¥å£è¶…æ—¶ä¸­æ–­"><a href="#2-TimeLimiterå®ç°æ¥å£è¶…æ—¶ä¸­æ–­" class="headerlink" title="2.TimeLimiterå®ç°æ¥å£è¶…æ—¶ä¸­æ–­"></a>2.TimeLimiterå®ç°æ¥å£è¶…æ—¶ä¸­æ–­</h1><p>guavaå·¥å…·åŒ…é‡Œé¢åŒ…å«äº†è¶…æ—¶çš„æ§åˆ¶æ–¹æ³•ã€‚å³<code>TimeLimiter</code> æ¥å£ï¼Œå…¶æœ‰ä¸¤ä¸ªå®ç°ç±»ã€‚</p><ul><li><code>FakeTimeLimiter</code>, å¸¸ç”¨äºdebugè°ƒè¯•æ—¶ï¼Œé™åˆ¶æ—¶é—´è¶…æ—¶è°ƒè¯•ã€‚</li><li><code>SimpleTimeLimiter</code> å¸¸ç”¨äºæ­£å¼æ–¹æ³•ä¸­ï¼Œè°ƒç”¨æ–¹æ³•è¶…æ—¶ï¼Œå³æŠ›å‡ºå¼‚å¸¸ã€‚</li></ul><p>æˆ‘ä»¬åœ¨å®é™…å¼€å‘ä¸­ä¹Ÿæ˜¯ä½¿ç”¨<code>SimpleTimeLimiter</code>æ¥å®ç°è¶…æ—¶æ§åˆ¶åŠŸèƒ½ï¼Œå…¶æœ‰ä¸¤ç§å®ç°æ¨¡å¼ï¼šä»£ç†æ¨¡å¼ï¼Œå›è°ƒæ¨¡å¼ã€‚å®ç°å¾ˆç®€å•ï¼Œçœ‹ä»£ç å³å¯äº†è§£ã€‚</p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20230131162741208.png"></p><h1 id="3-SimpleTimeLimiter-çš„æºç å®ç°"><a href="#3-SimpleTimeLimiter-çš„æºç å®ç°" class="headerlink" title="3.SimpleTimeLimiter çš„æºç å®ç°"></a>3.SimpleTimeLimiter çš„æºç å®ç°</h1><h2 id="3-1-ä»£ç†æ¨¡å¼"><a href="#3-1-ä»£ç†æ¨¡å¼" class="headerlink" title="3.1 ä»£ç†æ¨¡å¼"></a>3.1 ä»£ç†æ¨¡å¼</h2><blockquote><p>com.google.common.util.concurrent.SimpleTimeLimiter#newProxy</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"> public &lt;T&gt; T newProxy(final T target, Class&lt;T&gt; interfaceType,</span><br><span class="line">     final long timeoutDuration, final TimeUnit timeoutUnit) &#123;</span><br><span class="line">   checkNotNull(target);</span><br><span class="line">   checkNotNull(interfaceType);</span><br><span class="line">   checkNotNull(timeoutUnit);</span><br><span class="line">   checkArgument(timeoutDuration &gt; 0, &quot;bad timeout: %s&quot;, timeoutDuration);</span><br><span class="line">   checkArgument(interfaceType.isInterface(),</span><br><span class="line">       &quot;interfaceType must be an interface type&quot;);</span><br><span class="line"></span><br><span class="line">   final Set&lt;Method&gt; interruptibleMethods</span><br><span class="line">       = findInterruptibleMethods(interfaceType);</span><br><span class="line"></span><br><span class="line">   InvocationHandler handler = new InvocationHandler() &#123;</span><br><span class="line">     @Override</span><br><span class="line">     public Object invoke(Object obj, final Method method, final Object[] args)</span><br><span class="line">         throws Throwable &#123;</span><br><span class="line">       Callable&lt;Object&gt; callable = new Callable&lt;Object&gt;() &#123;</span><br><span class="line">         @Override</span><br><span class="line">         public Object call() throws Exception &#123;</span><br><span class="line">           try &#123;</span><br><span class="line">             return method.invoke(target, args);</span><br><span class="line">           &#125; catch (InvocationTargetException e) &#123;</span><br><span class="line">             throwCause(e, false);</span><br><span class="line">             throw new AssertionError(&quot;can&#x27;t get here&quot;);</span><br><span class="line">           &#125;</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;;</span><br><span class="line">       return callWithTimeout(callable, timeoutDuration, timeoutUnit,</span><br><span class="line">           interruptibleMethods.contains(method));</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;;</span><br><span class="line">   return newProxy(interfaceType, handler);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h2 id="3-2-å›è°ƒæ¨¡å¼"><a href="#3-2-å›è°ƒæ¨¡å¼" class="headerlink" title="3.2 å›è°ƒæ¨¡å¼"></a>3.2 å›è°ƒæ¨¡å¼</h2><blockquote><p>com.google.common.util.concurrent.SimpleTimeLimiter#callWithTimeout</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">callWithTimeout</span><span class="params">(Callable&lt;T&gt; callable, <span class="type">long</span> timeoutDuration,</span></span><br><span class="line"><span class="params">     TimeUnit timeoutUnit, <span class="type">boolean</span> amInterruptible)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   checkNotNull(callable);</span><br><span class="line">   checkNotNull(timeoutUnit);</span><br><span class="line">   checkArgument(timeoutDuration &gt; <span class="number">0</span>, <span class="string">&quot;timeout must be positive: %s&quot;</span>,</span><br><span class="line">       timeoutDuration);</span><br><span class="line">   Future&lt;T&gt; future = executor.submit(callable);</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">     <span class="keyword">if</span> (amInterruptible) &#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">//å®é™…ä¹Ÿæ˜¯é€šè¿‡Future#get(long, java.util.concurrent.TimeUnit)å®ç°è¶…æ—¶</span></span><br><span class="line">         <span class="keyword">return</span> future.get(timeoutDuration, timeoutUnit);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">         future.cancel(<span class="literal">true</span>);</span><br><span class="line">         <span class="keyword">throw</span> e;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> Uninterruptibles.getUninterruptibly(future, </span><br><span class="line">           timeoutDuration, timeoutUnit);</span><br><span class="line">     &#125;</span><br><span class="line">   &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">     <span class="keyword">throw</span> throwCause(e, <span class="literal">true</span>);</span><br><span class="line">   &#125; <span class="keyword">catch</span> (TimeoutException e) &#123;</span><br><span class="line">     <span class="comment">//è¶…æ—¶å¼‚å¸¸å–æ¶ˆä»»åŠ¡å¹¶æŠ›å‡ºUncheckedTimeoutExceptionå¼‚å¸¸</span></span><br><span class="line">     future.cancel(<span class="literal">true</span>);</span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UncheckedTimeoutException</span>(e);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>ä»£ç†æ¨¡å¼ä¸»è¦é’ˆå¯¹ç±»ï¼Œå›è°ƒæ¨¡å¼å¯ä»¥é’ˆå¯¹æŸéƒ¨åˆ†ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°ä»£ç†æ¨¡å¼ä¹Ÿæ˜¯åŸºäºå›è°ƒæ¨¡å¼æ–¹æ³•åšäº†å±‚ä»£ç å°è£…ï¼Œè¶…æ—¶æ§åˆ¶çš„åº•å±‚å®ç°è¿˜æ˜¯åœ¨<code>SimpleTimeLimiter#callWithTimeout</code>ï¼Œå…¶åŸºäº<code>Future#get(long, java.util.concurrent.TimeUnit)</code>å®ç°è¶…æ—¶ï¼Œå› æ­¤<code>SimpleTimeLimiter</code>æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä½¿ç”¨äº†<code>JDK</code>ä¸­çš„<code>Future</code>å¯¹è±¡å®ç°äº†è¶…æ—¶ä¸­æ–­æ§åˆ¶ã€‚</p><p>ç»“åˆä»£ç†æ¨¡å¼è°ƒç”¨è¶…æ—¶é“¾è·¯å³å¾ˆæ¸…æ™°çš„å±•ç¤ºè¶…æ—¶ä¸­æ–­æ§åˆ¶å®ç°ï¼Œæ­¤æ—¶æ¥å£ä»æ—§ä½¿ç”¨å£°æ˜å¼äº‹åŠ¡ï¼Œè¶…æ—¶åäº‹åŠ¡æ­£å¸¸å›æ»šã€‚</p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20230131175009885.png"></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;0-èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#0-èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;0.èƒŒæ™¯&quot;&gt;&lt;/a&gt;0.èƒŒæ™¯&lt;/h1&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://xssdpgy.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="timeLimit" scheme="https://xssdpgy.github.io/tags/timeLimit/"/>
    
    <category term="æºç åˆ†æ" scheme="https://xssdpgy.github.io/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>Seataå®¢æˆ·ç«¯é›†æˆåŠAT&amp;TCCäº‹åŠ¡æ¨¡å¼æ¼”ç¤º</title>
    <link href="https://xssdpgy.github.io/2023/01/30/Seata%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%9B%86%E6%88%90%E5%8F%8AAT&amp;TCC%E4%BA%8B%E5%8A%A1%E6%A8%A1%E5%BC%8F%E6%BC%94%E7%A4%BA/"/>
    <id>https://xssdpgy.github.io/2023/01/30/Seata%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%9B%86%E6%88%90%E5%8F%8AAT&amp;TCC%E4%BA%8B%E5%8A%A1%E6%A8%A1%E5%BC%8F%E6%BC%94%E7%A4%BA/</id>
    <published>2023-01-30T02:54:43.000Z</published>
    <updated>2023-02-07T16:26:00.598Z</updated>
    
    <content type="html"><![CDATA[<h1 id="0-å‰è¨€"><a href="#0-å‰è¨€" class="headerlink" title="0.å‰è¨€"></a>0.å‰è¨€</h1><p>ç®€è¦è¯´ä¸‹èƒŒæ™¯ï¼Œå½“å‰ä½¿ç”¨seataæ˜¯åŸºäºå®˜æ–¹1.5.2ç‰ˆæœ¬å¼€å‘çš„ï¼Œæ‰€ä»¥é›†æˆè¿‡ç¨‹å¯ä¾›1.5.2åŠä¹‹åç‰ˆæœ¬çš„ä½¿ç”¨è€…å‚è€ƒï¼Œä¸ºåŒºåˆ«äºå®˜æ–¹ç‰ˆæœ¬ï¼Œå†…éƒ¨ç‰ˆæœ¬å·è®¾ç½®ä¸º1.5.2.2ã€‚è®¾è®¡demoæ¼”ç¤ºå…¨å±€äº‹åŠ¡ï¼Œæ‰§è¡Œæµç¨‹å¦‚ä¸‹ã€‚</p><p><strong>demoä¸šåŠ¡æµç¨‹è®¾è®¡</strong></p><span id="more"></span><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20230130143946011.png"></p><h1 id="1-Seataå®¢æˆ·ç«¯é›†æˆ"><a href="#1-Seataå®¢æˆ·ç«¯é›†æˆ" class="headerlink" title="1.Seataå®¢æˆ·ç«¯é›†æˆ"></a>1.Seataå®¢æˆ·ç«¯é›†æˆ</h1><h2 id="1-1-å¼•å…¥ä¾èµ–"><a href="#1-1-å¼•å…¥ä¾èµ–" class="headerlink" title="1.1 å¼•å…¥ä¾èµ–"></a>1.1 å¼•å…¥ä¾èµ–</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- springbooté¡¹ç›®ï¼Œå¼•å…¥seata-spring-boot-starterä¾èµ– --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- ä¸ºä¿è¯å¾®æœåŠ¡é—´xidé€ä¼ ï¼Œå¼•å…¥æ­¤ä¾èµ–ï¼ˆæ³¨æ„ï¼Œéœ€æ’é™¤å¼•å…¥å…¶ä»–ç‰ˆæœ¬seataä¾èµ–çš„å½±å“ï¼‰ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>é¡¹ç›®seataç›¸å…³ä¾èµ–ç‰ˆæœ¬ç»Ÿä¸€å¦‚ä¸‹ï¼š</p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20230130112554825.png"></p><h2 id="1-2-é…ç½®"><a href="#1-2-é…ç½®" class="headerlink" title="1.2 é…ç½®"></a>1.2 é…ç½®</h2><p>ä»¥fundpayæœåŠ¡ä¸ºä¾‹ï¼Œé…ç½®æ–‡ä»¶ä¸­æ–°å¢é…ç½®ï¼Œä¸»è¦ä¸ºseataå®¢æˆ·ç«¯æœåŠ¡é…ç½®æ³¨å†Œä¸­å¿ƒåŠ<code>vgroupMapping</code>è®¾ç½®ã€‚</p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20230130140625932.png"></p><p>ä¹‹åå¯å¯åŠ¨seata-serveræœåŠ¡ç«¯ï¼Œå†å¯åŠ¨fundpayå®¢æˆ·ç«¯æœåŠ¡æŸ¥çœ‹æ˜¯å¦æ­£å¸¸å¯åŠ¨åŠæ³¨å†Œã€‚å¦‚ä¸‹æ—¥å¿—å³ä¸ºå®¢æˆ·ç«¯æœåŠ¡å¯åŠ¨æˆåŠŸå¹¶æˆåŠŸæ³¨å†Œåˆ°seata-serveræœåŠ¡ç«¯æ—¶ï¼Œseata-serveræœåŠ¡ç«¯çš„è¾“å‡ºï¼ˆæ‰“å°å‰ä¸¤è¡Œæ—¥å¿—å³å¯è§†ä¸ºæˆåŠŸï¼‰ã€‚</p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20230130142552233.png"></p><p>å…¶ä»–å¾®æœåŠ¡æŒ‰æ­¤æ–¹å¼é›†æˆæ³¨å†Œã€‚</p><p><strong>é›†æˆæˆåŠŸåï¼ŒæœåŠ¡é—´æ‹“æ‰‘å¦‚ä¸‹</strong></p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/1001990-20221217231736846-2029982669.png"></p><h1 id="2-ATäº‹åŠ¡æ¨¡å¼å¼€å‘é…ç½®"><a href="#2-ATäº‹åŠ¡æ¨¡å¼å¼€å‘é…ç½®" class="headerlink" title="2.ATäº‹åŠ¡æ¨¡å¼å¼€å‘é…ç½®"></a>2.ATäº‹åŠ¡æ¨¡å¼å¼€å‘é…ç½®</h1><p>ATäº‹åŠ¡æ¨¡å¼ä»£ç ä¾µå…¥æ€§ä½ï¼Œå¯ä»¥åŸºæœ¬ä¿æŒä¹‹å‰çš„ä»£ç ç»“æ„ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåªéœ€è¦åœ¨å…¥å£ä¸šåŠ¡æ–¹æ³•å®ç°ä¸Šæ·»åŠ <code>@GlobalTransactional</code>æ³¨è§£å³å¯ã€‚</p><p>åŸå…ˆæ¥å£ä¸»è¦ä»£ç å®ç°å¦‚ä¸‹ï¼š</p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20230130165219550.png"></p><p>åœ¨<code>com.boss.fundpay.service.impl.PayServiceImpl#pay</code>ä¸šåŠ¡å®ç°æ–¹æ³•ä¸Šæ·»åŠ å…¨å±€äº‹åŠ¡æ³¨è§£ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@GlobalTransactional(rollbackFor = Exception.class,timeoutMills = 60000)</span></span><br><span class="line">    <span class="keyword">public</span> ApiResultDTO <span class="title function_">pay</span><span class="params">(PayInfoDto payInfo)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1.è®°å½•å½“å‰æ“ä½œ</span></span><br><span class="line">        <span class="type">PayLog</span> <span class="variable">payLog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PayLog</span>();</span><br><span class="line">        BeanUtil.copyProperties(payInfo,payLog);</span><br><span class="line"></span><br><span class="line">        payLog.setBgtId(IdUtil.simpleUUID());</span><br><span class="line">        <span class="type">String</span> <span class="variable">curDate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>).format(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        payLog.setPayTime(curDate);</span><br><span class="line">        payLogDao.insertPayLog(payLog);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">orderNo</span> <span class="operator">=</span> payInfo.getOrderNo();</span><br><span class="line">        <span class="type">String</span> <span class="variable">merchantId</span> <span class="operator">=</span> payInfo.getMerchantId();</span><br><span class="line">        <span class="comment">//2.è°ƒç”¨æµç¨‹å®¡æ ¸</span></span><br><span class="line">        <span class="type">RiskAuditReq</span> <span class="variable">riskAuditReq</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RiskAuditReq</span>();</span><br><span class="line">        riskAuditReq.setMerchantId(merchantId);</span><br><span class="line">        riskAuditReq.setOrderNo(orderNo);</span><br><span class="line">        <span class="type">ApiResultDTO</span> <span class="variable">workflowResult</span> <span class="operator">=</span> workflowFeignApi.riskAudit(riskAuditReq);</span><br><span class="line">        <span class="keyword">if</span>(Objects.isNull(workflowResult)||ApiResultDTO.hasError(workflowResult)</span><br><span class="line">                ||(!PASS.equals(workflowResult.getResult())))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//è·å–å•†æˆ·ä½™é¢</span></span><br><span class="line">        <span class="type">MerchantBanlanceRecord</span> <span class="variable">record</span> <span class="operator">=</span> merchantBalanceRecordDao.selectBalanceRecordById(merchantId);</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">balance</span> <span class="operator">=</span> record.getTotalBalance().add(payInfo.getTotalAmount());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.è°ƒç”¨è®°è´¦</span></span><br><span class="line">        <span class="type">IncreaseBillReq</span> <span class="variable">increaseBillReq</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IncreaseBillReq</span>();</span><br><span class="line">        increaseBillReq.setOrderNo(orderNo);</span><br><span class="line">        increaseBillReq.setAccountAmount(balance);</span><br><span class="line">        increaseBillReq.setMerchantId(merchantId);</span><br><span class="line">        <span class="type">ApiResultDTO</span> <span class="variable">accountResult</span> <span class="operator">=</span> accountFeignApi.increaseBill(increaseBillReq);</span><br><span class="line">        <span class="keyword">if</span>(Objects.isNull(accountResult)||ApiResultDTO.hasError(accountResult))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//4.å›å†™æœ¬åœ°è¡¨</span></span><br><span class="line">        record.setPayType(payLog.getPayType());</span><br><span class="line">        record.setPayTime(payLog.getPayTime());</span><br><span class="line">        record.setOrderNo(payLog.getOrderNo());</span><br><span class="line">        record.setTotalAmount(payLog.getTotalAmount());</span><br><span class="line">        record.setTotalBalance(balance);</span><br><span class="line">        merchantBalanceRecordDao.updateBalanceRecord(record);</span><br><span class="line"><span class="comment">//åˆ›é€ å¼‚å¸¸è§¦å‘å›æ»š</span></span><br><span class="line"><span class="comment">//        int a = RandomUtil.randomInt(10);</span></span><br><span class="line"><span class="comment">//        if(a==5)&#123;</span></span><br><span class="line"><span class="comment">//            int b=1/0;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">        <span class="comment">//å®Œæˆ</span></span><br><span class="line">        <span class="keyword">return</span> ApiResultDTO.success(<span class="string">&quot;æˆåŠŸäº† order=&quot;</span>+orderNo+<span class="string">&quot; ,merchantId=&quot;</span>+merchantId+<span class="string">&quot; ,balance=&quot;</span>+balance);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>åœ¨ATæ¨¡å¼ä¸‹ï¼ŒworkflowæœåŠ¡å’ŒaccountæœåŠ¡çš„ä»£ç é€»è¾‘ä¸éœ€è¦è°ƒæ•´ã€‚</p><h1 id="3-TCCäº‹åŠ¡æ¨¡å¼å¼€å‘é…ç½®"><a href="#3-TCCäº‹åŠ¡æ¨¡å¼å¼€å‘é…ç½®" class="headerlink" title="3.TCCäº‹åŠ¡æ¨¡å¼å¼€å‘é…ç½®"></a>3.TCCäº‹åŠ¡æ¨¡å¼å¼€å‘é…ç½®</h1><h2 id="3-1-ä¸¤é˜¶æ®µæäº¤å›é¡¾"><a href="#3-1-ä¸¤é˜¶æ®µæäº¤å›é¡¾" class="headerlink" title="3.1 ä¸¤é˜¶æ®µæäº¤å›é¡¾"></a>3.1 ä¸¤é˜¶æ®µæäº¤å›é¡¾</h2><p>å›é¡¾ä¸‹å®˜ç½‘æè¿°ï¼Œä¸€ä¸ªåˆ†å¸ƒå¼çš„å…¨å±€äº‹åŠ¡ï¼Œæ•´ä½“æ˜¯ <strong>ä¸¤é˜¶æ®µæäº¤</strong> çš„æ¨¡å‹ã€‚å…¨å±€äº‹åŠ¡æ˜¯ç”±è‹¥å¹²åˆ†æ”¯äº‹åŠ¡ç»„æˆçš„ï¼Œåˆ†æ”¯äº‹åŠ¡è¦æ»¡è¶³ <strong>ä¸¤é˜¶æ®µæäº¤</strong> çš„æ¨¡å‹è¦æ±‚ï¼Œå³éœ€è¦æ¯ä¸ªåˆ†æ”¯äº‹åŠ¡éƒ½å…·å¤‡è‡ªå·±çš„ï¼š</p><ul><li>ä¸€é˜¶æ®µ prepare è¡Œä¸º</li><li>äºŒé˜¶æ®µ commit æˆ– rollback è¡Œä¸º</li></ul><p>æ ¹æ®ä¸¤é˜¶æ®µè¡Œä¸ºæ¨¡å¼çš„ä¸åŒï¼Œå°†åˆ†æ”¯äº‹åŠ¡åˆ’åˆ†ä¸º <strong>Automatic (Branch) Transaction Mode</strong> å’Œ <strong>TCC (Branch) Transaction Mode</strong>ã€‚</p><p>AT æ¨¡å¼åŸºäº <strong>æ”¯æŒæœ¬åœ° ACID äº‹åŠ¡</strong> çš„ <strong>å…³ç³»å‹æ•°æ®åº“</strong>ï¼š</p><ul><li>ä¸€é˜¶æ®µ prepare è¡Œä¸ºï¼šåœ¨æœ¬åœ°äº‹åŠ¡ä¸­ï¼Œä¸€å¹¶æäº¤ä¸šåŠ¡æ•°æ®æ›´æ–°å’Œç›¸åº”å›æ»šæ—¥å¿—è®°å½•ã€‚</li><li>äºŒé˜¶æ®µ commit è¡Œä¸ºï¼šé©¬ä¸ŠæˆåŠŸç»“æŸï¼Œ<strong>è‡ªåŠ¨</strong> å¼‚æ­¥æ‰¹é‡æ¸…ç†å›æ»šæ—¥å¿—ã€‚</li><li>äºŒé˜¶æ®µ rollback è¡Œä¸ºï¼šé€šè¿‡å›æ»šæ—¥å¿—ï¼Œ<strong>è‡ªåŠ¨</strong> ç”Ÿæˆè¡¥å¿æ“ä½œï¼Œå®Œæˆæ•°æ®å›æ»šã€‚</li></ul><p>ç›¸åº”çš„ï¼ŒTCC æ¨¡å¼ï¼Œä¸ä¾èµ–äºåº•å±‚æ•°æ®èµ„æºçš„äº‹åŠ¡æ”¯æŒï¼š</p><ul><li>ä¸€é˜¶æ®µ prepare è¡Œä¸ºï¼šè°ƒç”¨ <strong>è‡ªå®šä¹‰</strong> çš„ prepare é€»è¾‘ã€‚</li><li>äºŒé˜¶æ®µ commit è¡Œä¸ºï¼šè°ƒç”¨ <strong>è‡ªå®šä¹‰</strong> çš„ commit é€»è¾‘ã€‚</li><li>äºŒé˜¶æ®µ rollback è¡Œä¸ºï¼šè°ƒç”¨ <strong>è‡ªå®šä¹‰</strong> çš„ rollback é€»è¾‘ã€‚</li></ul><p>æ€»ä¹‹ï¼ŒTCCäº‹åŠ¡æ¨¡å¼éœ€è¦å¯¹ä»£ç é€»è¾‘è¿›è¡Œé‡æ–°è®¾è®¡ï¼Œä¸»è¦æ˜¯éœ€è¦æŒ‰ç…§ <strong>ä¸¤é˜¶æ®µæäº¤</strong> çš„æ¨¡å‹è¦æ±‚ï¼Œå¼€å‘è‡ªå®šä¹‰çš„åˆ†æ”¯äº‹åŠ¡ï¼Œå°†å…¶çº³å…¥å…¨å±€äº‹åŠ¡çš„ç®¡ç†ä¸­ã€‚</p><h2 id="3-2-æ¥å£å®ç°æ–¹æ³•æ‹†åˆ†"><a href="#3-2-æ¥å£å®ç°æ–¹æ³•æ‹†åˆ†" class="headerlink" title="3.2 æ¥å£å®ç°æ–¹æ³•æ‹†åˆ†"></a>3.2 æ¥å£å®ç°æ–¹æ³•æ‹†åˆ†</h2><p>å¦‚ä¸‹é¢ç¤ºä¾‹ï¼Œ<code>pay</code>æ–¹æ³•éœ€è¦åœ¨æ¥å£å±‚æ‹†åˆ†å‡º<code>prepare</code>ã€<code>confirm</code>ã€<code>rollback</code>ä¸‰ä¸ªå­æ–¹æ³•ï¼Œå°†å¯¹åº”çš„ä»£ç é€»è¾‘æ‹†åˆ†åˆ°å¯¹åº”å­æ–¹æ³•å®ç°ä¸­ï¼Œå…¶ä»–æœåŠ¡ä¹ŸæŒ‰æ­¤æ¨¡å‹æ€æƒ³è¿›è¡Œä»£ç æ‹†åˆ†ã€‚</p><blockquote><p>fundpayå®ç°æ‹†åˆ†ç¤ºä¾‹ï¼ˆä»…æ‹†åˆ†fundpayè‡ªèº«çš„ä¸šåŠ¡DBæ“ä½œï¼Œæ¶‰åŠè¿œç¨‹è°ƒç”¨çš„ä¸éœ€è€ƒè™‘ï¼Œè¯¦æƒ…è§ä¸‹èŠ‚ï¼‰</p></blockquote><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20230130171659234.png"></p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20230130171801594.png"></p><blockquote><p>workflowå®ç°æ‹†åˆ†ç¤ºä¾‹</p></blockquote><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20230130171940504.png"></p><p>ä¸šåŠ¡å®ç°çš„ç²’åº¦æ‹†åˆ†éœ€è¦å¼€å‘äººå‘˜åˆç†æŠŠæ§</p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20230130172256066.png"></p><p>accountæœåŠ¡æ‹†åˆ†åŸºæœ¬ç›¸åŒï¼Œè¿™é‡Œçœç•¥ã€‚</p><h2 id="3-3-å…¥å£ä¸šåŠ¡æ–¹æ³•ç‹¬ç«‹"><a href="#3-3-å…¥å£ä¸šåŠ¡æ–¹æ³•ç‹¬ç«‹" class="headerlink" title="3.3 å…¥å£ä¸šåŠ¡æ–¹æ³•ç‹¬ç«‹"></a>3.3 å…¥å£ä¸šåŠ¡æ–¹æ³•ç‹¬ç«‹</h2><p>ä¸ŠèŠ‚æ˜¯å°†å„ä¸ªå¾®æœåŠ¡çš„ä¸šåŠ¡å®ç°ä»£ç æŒ‰ç…§ <strong>äºŒé˜¶æ®µæäº¤</strong> çš„æ€æƒ³è¿›è¡Œäº†æ‹†åˆ†ï¼Œå›åˆ°ä¸šåŠ¡å…¥å£æ–¹æ³•è¿™é‡Œï¼Œä¸å¯èƒ½ä¹Ÿä¸åº”è¯¥åœ¨fundpayæœåŠ¡æ‹†åˆ†åçš„äºŒé˜¶æ®µæ–¹æ³•ä¸­æ‰§è¡Œè¿œç¨‹è°ƒç”¨ï¼Œæ‰€ä»¥ç‹¬ç«‹å‡ºå•ç‹¬çš„å…¥å£æ–¹æ³•<code>Action</code>ï¼Œæ‰§è¡Œæ•´ä½“çš„ä¸šåŠ¡é€»è¾‘ï¼ˆå«æœåŠ¡é—´è¿œç¨‹è°ƒç”¨ï¼‰ï¼Œå°†å„åˆ†æ”¯äº‹åŠ¡çº³å…¥å…¨å±€äº‹åŠ¡çš„æ§åˆ¶ä¸­ã€‚</p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20230130174454286.png"></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;0-å‰è¨€&quot;&gt;&lt;a href=&quot;#0-å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;0.å‰è¨€&quot;&gt;&lt;/a&gt;0.å‰è¨€&lt;/h1&gt;&lt;p&gt;ç®€è¦è¯´ä¸‹èƒŒæ™¯ï¼Œå½“å‰ä½¿ç”¨seataæ˜¯åŸºäºå®˜æ–¹1.5.2ç‰ˆæœ¬å¼€å‘çš„ï¼Œæ‰€ä»¥é›†æˆè¿‡ç¨‹å¯ä¾›1.5.2åŠä¹‹åç‰ˆæœ¬çš„ä½¿ç”¨è€…å‚è€ƒï¼Œä¸ºåŒºåˆ«äºå®˜æ–¹ç‰ˆæœ¬ï¼Œå†…éƒ¨ç‰ˆæœ¬å·è®¾ç½®ä¸º1.5.2.2ã€‚è®¾è®¡demoæ¼”ç¤ºå…¨å±€äº‹åŠ¡ï¼Œæ‰§è¡Œæµç¨‹å¦‚ä¸‹ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;demoä¸šåŠ¡æµç¨‹è®¾è®¡&lt;/strong&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://xssdpgy.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="seata" scheme="https://xssdpgy.github.io/tags/seata/"/>
    
    <category term="åˆ†å¸ƒå¼äº‹åŠ¡" scheme="https://xssdpgy.github.io/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>Seataæºç ç»“æ„åŠäº‹åŠ¡æ¨¡å¼ä»‹ç»</title>
    <link href="https://xssdpgy.github.io/2023/01/30/Seata%E6%BA%90%E7%A0%81%E7%BB%93%E6%9E%84%E5%8F%8A%E4%BA%8B%E5%8A%A1%E6%A8%A1%E5%BC%8F%E4%BB%8B%E7%BB%8D/"/>
    <id>https://xssdpgy.github.io/2023/01/30/Seata%E6%BA%90%E7%A0%81%E7%BB%93%E6%9E%84%E5%8F%8A%E4%BA%8B%E5%8A%A1%E6%A8%A1%E5%BC%8F%E4%BB%8B%E7%BB%8D/</id>
    <published>2023-01-30T02:06:29.000Z</published>
    <updated>2023-02-07T16:26:00.599Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-Seataæ˜¯ä»€ä¹ˆ"><a href="#1-Seataæ˜¯ä»€ä¹ˆ" class="headerlink" title="1.Seataæ˜¯ä»€ä¹ˆ"></a>1.Seataæ˜¯ä»€ä¹ˆ</h1><p>Seata æ˜¯ä¸€æ¬¾å¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œè‡´åŠ›äºæä¾›é«˜æ€§èƒ½å’Œç®€å•æ˜“ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ã€‚Seata å°†ä¸ºç”¨æˆ·æä¾›äº† ATã€TCCã€SAGA å’Œ XA äº‹åŠ¡æ¨¡å¼ï¼Œä¸ºç”¨æˆ·æ‰“é€ ä¸€ç«™å¼çš„åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆã€‚</p><h1 id="2-Seataä½“ç³»ä¸­çš„ä¸‰ä¸ªç»„ä»¶"><a href="#2-Seataä½“ç³»ä¸­çš„ä¸‰ä¸ªç»„ä»¶" class="headerlink" title="2.Seataä½“ç³»ä¸­çš„ä¸‰ä¸ªç»„ä»¶"></a>2.Seataä½“ç³»ä¸­çš„ä¸‰ä¸ªç»„ä»¶</h1><span id="more"></span><h2 id="2-1-ä¸‰ä¸ªç»„ä»¶"><a href="#2-1-ä¸‰ä¸ªç»„ä»¶" class="headerlink" title="2.1 ä¸‰ä¸ªç»„ä»¶"></a>2.1 ä¸‰ä¸ªç»„ä»¶</h2><p>Seata å†…éƒ¨å®šä¹‰äº† 3ä¸ªæ¨¡å—æ¥å¤„ç†å…¨å±€äº‹åŠ¡å’Œåˆ†æ”¯äº‹åŠ¡çš„å…³ç³»å’Œå¤„ç†è¿‡ç¨‹ï¼Œè¿™ä¸‰ä¸ªç»„ä»¶åˆ†åˆ«æ˜¯ï¼š</p><p><strong>TC (Transaction Coordinator) - äº‹åŠ¡åè°ƒè€…</strong>ï¼šç»´æŠ¤å…¨å±€å’Œåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œé©±åŠ¨å…¨å±€äº‹åŠ¡æäº¤æˆ–å›æ»šã€‚</p><p><strong>TM (Transaction Manager) - äº‹åŠ¡ç®¡ç†å™¨</strong>ï¼šå®šä¹‰å…¨å±€äº‹åŠ¡çš„èŒƒå›´ï¼šå¼€å§‹å…¨å±€äº‹åŠ¡ã€æäº¤æˆ–å›æ»šå…¨å±€äº‹åŠ¡ã€‚</p><p><strong>RM (Resource Manager) - èµ„æºç®¡ç†å™¨</strong>ï¼šç®¡ç†åˆ†æ”¯äº‹åŠ¡å¤„ç†çš„èµ„æºï¼Œä¸TCäº¤è°ˆä»¥æ³¨å†Œåˆ†æ”¯äº‹åŠ¡å’ŒæŠ¥å‘Šåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œå¹¶é©±åŠ¨åˆ†æ”¯äº‹åŠ¡æäº¤æˆ–å›æ»šã€‚</p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/1460000038240947.png"></p><h2 id="2-2-æ‰§è¡Œæ­¥éª¤"><a href="#2-2-æ‰§è¡Œæ­¥éª¤" class="headerlink" title="2.2 æ‰§è¡Œæ­¥éª¤"></a>2.2 æ‰§è¡Œæ­¥éª¤</h2><p>æ•´ä¸ªå…¨å±€äº‹åŠ¡çš„æ‰§è¡Œæ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>TM å‘ TC ç”³è¯·å¼€å¯ä¸€ä¸ªå…¨å±€äº‹åŠ¡ï¼ŒTC åˆ›å»ºå…¨å±€äº‹åŠ¡åè¿”å›å…¨å±€å”¯ä¸€çš„ XIDï¼ŒXID ä¼šåœ¨å…¨å±€äº‹åŠ¡çš„ä¸Šä¸‹æ–‡ä¸­ä¼ æ’­ï¼›</li><li>RM å‘ TC æ³¨å†Œåˆ†æ”¯äº‹åŠ¡ï¼Œè¯¥åˆ†æ”¯äº‹åŠ¡å½’å±äºæ‹¥æœ‰ç›¸åŒ XID çš„å…¨å±€äº‹åŠ¡ï¼›</li><li>TM å‘ TC å‘èµ·å…¨å±€æäº¤æˆ–å›æ»šï¼›</li><li>TC è°ƒåº¦ XID ä¸‹çš„åˆ†æ”¯äº‹åŠ¡å®Œæˆæäº¤æˆ–è€…å›æ»šã€‚</li></ol><h1 id="3-Seataæºç ä½“ç³»"><a href="#3-Seataæºç ä½“ç³»" class="headerlink" title="3.Seataæºç ä½“ç³»"></a>3.Seataæºç ä½“ç³»</h1><p><strong>æ•´ä½“ç»“æ„</strong></p><blockquote><p>æºç åŸºæœ¬åŒå®˜æ–¹1.5.2-1.6.1ç‰ˆæœ¬ã€‚</p></blockquote><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20230129155651276.png"></p><h1 id="4-Seataäº‹åŠ¡æ¨¡å¼ä»‹ç»"><a href="#4-Seataäº‹åŠ¡æ¨¡å¼ä»‹ç»" class="headerlink" title="4.Seataäº‹åŠ¡æ¨¡å¼ä»‹ç»"></a>4.Seataäº‹åŠ¡æ¨¡å¼ä»‹ç»</h1><h2 id="4-1-Seata-AT-æ¨¡å¼"><a href="#4-1-Seata-AT-æ¨¡å¼" class="headerlink" title="4.1 Seata AT æ¨¡å¼"></a>4.1 Seata AT æ¨¡å¼</h2><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20230129171805523.png"></p><p>ä¸¤é˜¶æ®µæäº¤åè®®çš„æ¼”å˜ï¼š</p><p><strong>ä¸€é˜¶æ®µ</strong>ï¼šä¸šåŠ¡æ•°æ®å’Œå›æ»šæ—¥å¿—è®°å½•åœ¨åŒä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ä¸­æäº¤ï¼Œé‡Šæ”¾æœ¬åœ°é”å’Œè¿æ¥èµ„æºã€‚</p><p><strong>äºŒé˜¶æ®µ</strong>ï¼š</p><p>æäº¤å¼‚æ­¥åŒ–ï¼Œéå¸¸å¿«é€Ÿåœ°å®Œæˆã€‚</p><p>å›æ»šé€šè¿‡ä¸€é˜¶æ®µçš„å›æ»šæ—¥å¿—è¿›è¡Œåå‘è¡¥å¿ã€‚</p><h2 id="4-2-Seata-TCC-æ¨¡å¼"><a href="#4-2-Seata-TCC-æ¨¡å¼" class="headerlink" title="4.2 Seata TCC æ¨¡å¼"></a>4.2 Seata TCC æ¨¡å¼</h2><p>æ•´ä½“æ˜¯ä¸¤é˜¶æ®µæäº¤çš„æ¨¡å‹ã€‚</p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/seata_tcc-1.png"></p><p>å…¨å±€äº‹åŠ¡æ˜¯ç”±è‹¥å¹²åˆ†æ”¯äº‹åŠ¡ç»„æˆçš„ï¼Œåˆ†æ”¯äº‹åŠ¡è¦æ»¡è¶³ä¸¤é˜¶æ®µæäº¤çš„æ¨¡å‹è¦æ±‚ï¼Œå³éœ€è¦æ¯ä¸ªåˆ†æ”¯äº‹åŠ¡éƒ½å…·å¤‡è‡ªå·±çš„ï¼š</p><p><strong>ä¸€é˜¶æ®µ</strong> prepare è¡Œä¸º</p><p><strong>äºŒé˜¶æ®µ</strong> commit æˆ– rollback è¡Œä¸º</p><h2 id="4-3-Seata-Saga-æ¨¡å¼"><a href="#4-3-Seata-Saga-æ¨¡å¼" class="headerlink" title="4.3 Seata Saga æ¨¡å¼"></a>4.3 Seata Saga æ¨¡å¼</h2><p>ç›®å‰Seataæä¾›çš„Sagaæ¨¡å¼æ˜¯åŸºäºçŠ¶æ€æœºå¼•æ“æ¥å®ç°çš„ï¼Œæœºåˆ¶æ˜¯ï¼š</p><ul><li>é€šè¿‡çŠ¶æ€å›¾æ¥å®šä¹‰æœåŠ¡è°ƒç”¨çš„æµç¨‹å¹¶ç”Ÿæˆ json çŠ¶æ€è¯­è¨€å®šä¹‰æ–‡ä»¶ã€‚</li><li>çŠ¶æ€å›¾ä¸­ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥æ˜¯è°ƒç”¨ä¸€ä¸ªæœåŠ¡ï¼ŒèŠ‚ç‚¹å¯ä»¥é…ç½®å®ƒçš„è¡¥å¿èŠ‚ç‚¹ã€‚</li><li>çŠ¶æ€å›¾ json ç”±çŠ¶æ€æœºå¼•æ“é©±åŠ¨æ‰§è¡Œï¼Œå½“å‡ºç°å¼‚å¸¸æ—¶çŠ¶æ€å¼•æ“åå‘æ‰§è¡Œå·²æˆåŠŸèŠ‚ç‚¹å¯¹åº”çš„è¡¥å¿èŠ‚ç‚¹å°†äº‹åŠ¡å›æ»šã€‚</li><li>å¯ä»¥å®ç°æœåŠ¡ç¼–æ’éœ€æ±‚ï¼Œæ”¯æŒå•é¡¹é€‰æ‹©ã€å¹¶å‘ã€å­æµç¨‹ã€å‚æ•°è½¬æ¢ã€å‚æ•°æ˜ å°„ã€æœåŠ¡æ‰§è¡ŒçŠ¶æ€åˆ¤æ–­ã€å¼‚å¸¸æ•è·ç­‰åŠŸèƒ½ã€‚</li></ul><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/1460000038240949.png"></p><h2 id="4-4-Seata-XA-æ¨¡å¼"><a href="#4-4-Seata-XA-æ¨¡å¼" class="headerlink" title="4.4 Seata XA æ¨¡å¼"></a>4.4 Seata XA æ¨¡å¼</h2><p>åˆ©ç”¨äº‹åŠ¡èµ„æºï¼ˆæ•°æ®åº“ã€æ¶ˆæ¯æœåŠ¡ç­‰ï¼‰å¯¹ XA åè®®çš„æ”¯æŒï¼Œä»¥ XA åè®®çš„æœºåˆ¶æ¥ç®¡ç†åˆ†æ”¯äº‹åŠ¡çš„ä¸€ç§ äº‹åŠ¡æ¨¡å¼ã€‚</p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/TB1hSpccIVl614jSZKPXXaGjpXa-1330-924.png"></p><p><strong>æ‰§è¡Œé˜¶æ®µ</strong>ï¼š</p><ul><li>å¯å›æ»šï¼šä¸šåŠ¡ SQL æ“ä½œæ”¾åœ¨ XA åˆ†æ”¯ä¸­è¿›è¡Œï¼Œç”±èµ„æºå¯¹ XA åè®®çš„æ”¯æŒæ¥ä¿è¯ å¯å›æ»šã€‚</li><li>æŒä¹…åŒ–ï¼šXA åˆ†æ”¯å®Œæˆåï¼Œæ‰§è¡Œ XA prepareï¼ŒåŒæ ·ï¼Œç”±èµ„æºå¯¹ XA åè®®çš„æ”¯æŒæ¥ä¿è¯æŒä¹…åŒ–ï¼ˆå³ï¼Œä¹‹åä»»ä½•æ„å¤–éƒ½ä¸ä¼šé€ æˆæ— æ³•å›æ»šçš„æƒ…å†µï¼‰ã€‚</li></ul><p><strong>å®Œæˆé˜¶æ®µ</strong>ï¼š</p><ul><li>åˆ†æ”¯æäº¤ï¼šæ‰§è¡Œ XA åˆ†æ”¯çš„ commit</li><li>åˆ†æ”¯å›æ»šï¼šæ‰§è¡Œ XA åˆ†æ”¯çš„ rollback</li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;1-Seataæ˜¯ä»€ä¹ˆ&quot;&gt;&lt;a href=&quot;#1-Seataæ˜¯ä»€ä¹ˆ&quot; class=&quot;headerlink&quot; title=&quot;1.Seataæ˜¯ä»€ä¹ˆ&quot;&gt;&lt;/a&gt;1.Seataæ˜¯ä»€ä¹ˆ&lt;/h1&gt;&lt;p&gt;Seata æ˜¯ä¸€æ¬¾å¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œè‡´åŠ›äºæä¾›é«˜æ€§èƒ½å’Œç®€å•æ˜“ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ã€‚Seata å°†ä¸ºç”¨æˆ·æä¾›äº† ATã€TCCã€SAGA å’Œ XA äº‹åŠ¡æ¨¡å¼ï¼Œä¸ºç”¨æˆ·æ‰“é€ ä¸€ç«™å¼çš„åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆã€‚&lt;/p&gt;
&lt;h1 id=&quot;2-Seataä½“ç³»ä¸­çš„ä¸‰ä¸ªç»„ä»¶&quot;&gt;&lt;a href=&quot;#2-Seataä½“ç³»ä¸­çš„ä¸‰ä¸ªç»„ä»¶&quot; class=&quot;headerlink&quot; title=&quot;2.Seataä½“ç³»ä¸­çš„ä¸‰ä¸ªç»„ä»¶&quot;&gt;&lt;/a&gt;2.Seataä½“ç³»ä¸­çš„ä¸‰ä¸ªç»„ä»¶&lt;/h1&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://xssdpgy.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="seata" scheme="https://xssdpgy.github.io/tags/seata/"/>
    
    <category term="åˆ†å¸ƒå¼äº‹åŠ¡" scheme="https://xssdpgy.github.io/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>Seata ATæ¨¡å¼æºç è§£æ</title>
    <link href="https://xssdpgy.github.io/2022/11/27/Seata-AT%E6%A8%A1%E5%BC%8F%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <id>https://xssdpgy.github.io/2022/11/27/Seata-AT%E6%A8%A1%E5%BC%8F%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</id>
    <published>2022-11-27T10:00:36.000Z</published>
    <updated>2023-02-07T16:26:00.598Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-ATæ¨¡å¼çš„ç‰¹æ€§"><a href="#1-ATæ¨¡å¼çš„ç‰¹æ€§" class="headerlink" title="1.ATæ¨¡å¼çš„ç‰¹æ€§"></a>1.ATæ¨¡å¼çš„ç‰¹æ€§</h1><h2 id="1-1-å‰æ"><a href="#1-1-å‰æ" class="headerlink" title="1.1 å‰æ"></a>1.1 å‰æ</h2><p>ATæ¨¡å¼ç”Ÿæ•ˆéœ€è¦ä¸¤ä¸ªå‰æï¼š</p><ul><li>åŸºäºæ”¯æŒæœ¬åœ°ACIDäº‹åŠ¡çš„å…³ç³»å‹æ•°æ®åº“</li><li>Javaåº”ç”¨ï¼Œé€šè¿‡JDBCè®¿é—®æ•°æ®åº“</li></ul><h2 id="1-2-æ•´ä½“æœºåˆ¶"><a href="#1-2-æ•´ä½“æœºåˆ¶" class="headerlink" title="1.2 æ•´ä½“æœºåˆ¶"></a>1.2 æ•´ä½“æœºåˆ¶</h2><p>ä¸¤é˜¶æ®µæäº¤åè®®çš„æ¼”å˜ï¼š</p><ul><li>ä¸€é˜¶æ®µï¼šä¸šåŠ¡æ•°æ®å’Œå›æ»šæ—¥å¿—è®°å½•åœ¨åŒä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ä¸­æäº¤ï¼Œé‡Šæ”¾æœ¬åœ°é”å’Œè¿æ¥èµ„æºã€‚</li><li>äºŒé˜¶æ®µï¼š<ul><li>æäº¤å¼‚æ­¥åŒ–ï¼Œéå¸¸å¿«é€Ÿåœ°å®Œæˆã€‚</li><li>å›æ»šé€šè¿‡ä¸€é˜¶æ®µçš„å›æ»šæ—¥å¿—è¿›è¡Œåå‘è¡¥å¿ã€‚</li></ul></li></ul><h2 id="1-3-å†™éš”ç¦»"><a href="#1-3-å†™éš”ç¦»" class="headerlink" title="1.3 å†™éš”ç¦»"></a>1.3 å†™éš”ç¦»</h2><ul><li>ä¸€é˜¶æ®µæœ¬åœ°äº‹åŠ¡æäº¤å‰ï¼Œéœ€è¦ç¡®ä¿å…ˆæ‹¿åˆ° <strong>å…¨å±€é”</strong> ã€‚</li><li>æ‹¿ä¸åˆ° <strong>å…¨å±€é”</strong> ï¼Œä¸èƒ½æäº¤æœ¬åœ°äº‹åŠ¡ã€‚</li><li>æ‹¿ <strong>å…¨å±€é”</strong> çš„å°è¯•è¢«é™åˆ¶åœ¨ä¸€å®šèŒƒå›´å†…ï¼Œè¶…å‡ºèŒƒå›´å°†æ”¾å¼ƒï¼Œå¹¶å›æ»šæœ¬åœ°äº‹åŠ¡ï¼Œé‡Šæ”¾æœ¬åœ°é”ã€‚</li></ul><h2 id="1-4-è¯»éš”ç¦»"><a href="#1-4-è¯»éš”ç¦»" class="headerlink" title="1.4 è¯»éš”ç¦»"></a>1.4 è¯»éš”ç¦»</h2><p>åœ¨æ•°æ®åº“æœ¬åœ°äº‹åŠ¡éš”ç¦»çº§åˆ« <strong>è¯»å·²æäº¤ï¼ˆRead Committedï¼‰</strong> æˆ–ä»¥ä¸Šçš„åŸºç¡€ä¸Šï¼ŒSeataï¼ˆAT æ¨¡å¼ï¼‰çš„é»˜è®¤å…¨å±€éš”ç¦»çº§åˆ«æ˜¯ <strong>è¯»æœªæäº¤ï¼ˆRead Uncommittedï¼‰</strong> ã€‚</p><p>å¦‚æœåº”ç”¨åœ¨ç‰¹å®šåœºæ™¯ä¸‹ï¼Œå¿…éœ€è¦æ±‚å…¨å±€çš„ <strong>è¯»å·²æäº¤</strong> ï¼Œç›®å‰ Seata çš„æ–¹å¼æ˜¯é€šè¿‡ SELECT FOR UPDATE è¯­å¥çš„ä»£ç†ã€‚</p><h1 id="2-æºç æ¢³ç†"><a href="#2-æºç æ¢³ç†" class="headerlink" title="2. æºç æ¢³ç†"></a>2. æºç æ¢³ç†</h1><blockquote><p>æºç ç‰ˆæœ¬ 1.5.2</p></blockquote><h2 id="2-1-TMåŠRMåˆå§‹åŒ–"><a href="#2-1-TMåŠRMåˆå§‹åŒ–" class="headerlink" title="2.1 TMåŠRMåˆå§‹åŒ–"></a>2.1 TMåŠRMåˆå§‹åŒ–</h2><p>TMå’ŒRMï¼ˆClientç«¯ï¼‰ç”±ä¸šåŠ¡ç³»ç»Ÿé›†æˆï¼ŒATæ¨¡å¼ä¸‹ï¼Œåœ¨å¤„ç†TCï¼ˆServerç«¯ï¼‰å‘è¿‡æ¥çš„è¯·æ±‚æ—¶ï¼Œè¿™ä¿©è§’è‰²å‘æŒ¥ç€ä¸»è¦ä½œç”¨ã€‚æ‰€ä»¥ä»GlobalTransactionScannerä¸­ä¸¤è€…çš„åˆå§‹åŒ–å¼€å§‹è¯´èµ·ã€‚</p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20221127212033165.png" alt="image-20221127212033165"></p><p>å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨GlobalTransactionScanner#initClient()æ–¹æ³•ï¼Œåœ¨initClient()ä¸­åˆå§‹åŒ–TMå’ŒRMã€‚</p><p>TMå’ŒRMåˆå§‹åŒ–ï¼Œä¸»è¦æ˜¯æ³¨å†Œå„ç§å¤„ç†å™¨ï¼Œæœ€ç»ˆæ„é€ ä¸€ä¸ªå¤„ç†å™¨æ˜ å°„è¡¨ï¼š</p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20221127213129581.png" alt="image-20221127213129581"></p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20221127213354445.png" alt="image-20221127213354445"></p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20221127213428347.png" alt="image-20221127213428347"></p><p>RMæ³¨å†Œå¤„ç†å™¨é€»è¾‘ç›¸åŒï¼Œè¿™é‡Œä¸å¤šå±•ç¤ºã€‚</p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20221127213557337.png" alt="image-20221127213557337"></p><p>éœ€è¦å…³æ³¨çš„æ˜¯RMåˆå§‹åŒ–æ—¶ï¼Œåœ¨æ³¨å†Œå„ç§å¤„ç†å™¨ä¹‹å‰è¿˜æœ‰ä¸¤ä¸ªæ“ä½œï¼š</p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20221127214227198.png" alt="image-20221127214227198"></p><p>RMåˆå§‹åŒ–æ—¶ï¼Œå…ˆæ˜¯è®¾ç½®äº† ResourceManager å’Œ TransactionMessageHandlerï¼Œä¹‹åä¹Ÿæ˜¯å¦‚TMåˆå§‹åŒ–ä¸€æ ·æ³¨å†Œå„ç§å¤„ç†å™¨ï¼Œæœ‰åŒºåˆ«çš„æ˜¯æ³¨å†Œå¤„ç†å™¨æµç¨‹ä¸­ï¼ŒRMæ˜¯æ³¨å†Œå®Œä¸‰ä¸ªç‰¹æœ‰çš„å®¢æˆ·ç«¯ä¹‹åï¼Œæ‰æ‰§è¡Œä¸TMç±»ä¼¼çš„æ³¨å†Œæµç¨‹ã€‚</p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20221127222604783.png" alt="image-20221127222604783"></p><p>çœŸæ­£å¤„ç†è¯·æ±‚çš„è¿˜æ˜¯é è°ƒç”¨å„ä¸ªå¤„ç†å™¨ä¸­çš„handler.onRequest()æ–¹æ³•ï¼Œäºæ˜¯é—®é¢˜çš„å…³é”®å°±å¾ˆæ˜æ˜¾äº†ï¼Œå°±åœ¨äºhandlerã€‚</p><h2 id="2-2-ResourceManager"><a href="#2-2-ResourceManager" class="headerlink" title="2.2 ResourceManager"></a>2.2 ResourceManager</h2><p>åœ¨äº†è§£ResourceManagerä¹‹å‰ï¼Œéœ€è¦å…ˆäº†è§£ä¸‹ResourceManagerInboundå’ŒResourceManagerOutboundã€‚</p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20221129230253020.png" alt="image-20221129230253020"></p><p>ResourceManagerInboundæ˜¯å¤„ç†æ¥æ”¶åˆ°TCçš„è¯·æ±‚çš„ï¼Œæ˜¯TCå‘RMå‘è¯·æ±‚</p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20221129230822733.png" alt="image-20221129230822733"></p><p>ResourceManagerOutboundæ˜¯å¤„ç†æµå‡ºçš„æ¶ˆæ¯çš„ï¼Œæ˜¯RMå‘TCå‘è¯·æ±‚</p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20221129232244968.png" alt="image-20221129232244968"></p><p>ResourceManagerç»§æ‰¿äº†äºŒè€…ï¼Œæ‰€ä»¥æ—¢è´Ÿè´£å‘TCå‘è¯·æ±‚ï¼Œåˆè´Ÿè´£æ¥æ”¶ä»TCæ¥çš„è¯·æ±‚ã€‚</p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20221129234706090.png" alt="image-20221129234706090"></p><p>DefaultResourceManager.get()å¾—åˆ°çš„æ˜¯ä¸€ä¸ªå•ä¾‹DefaultResourceManagerï¼Œåˆ›å»ºDefaultResourceManagerçš„æ—¶å€™ä¼šæ„å»ºä¸€ä¸ªåˆ†æ”¯ç±»å‹ä¸ºResourceManagerçš„ä¸€ä¸ªMapã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;1-ATæ¨¡å¼çš„ç‰¹æ€§&quot;&gt;&lt;a href=&quot;#1-ATæ¨¡å¼çš„ç‰¹æ€§&quot; class=&quot;headerlink&quot; title=&quot;1.ATæ¨¡å¼çš„ç‰¹æ€§&quot;&gt;&lt;/a&gt;1.ATæ¨¡å¼çš„ç‰¹æ€§&lt;/h1&gt;&lt;h2 id=&quot;1-1-å‰æ&quot;&gt;&lt;a href=&quot;#1-1-å‰æ&quot; class=&quot;headerlink&quot; title=&quot;1.1 å‰æ&quot;&gt;&lt;/a&gt;1.1 å‰æ&lt;/h2&gt;&lt;p&gt;ATæ¨¡å¼ç”Ÿæ•ˆéœ€è¦ä¸¤ä¸ªå‰æï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;åŸºäºæ”¯æŒæœ¬åœ°ACIDäº‹åŠ¡çš„å…³ç³»å‹æ•°æ®åº“&lt;/li&gt;
&lt;li&gt;Javaåº”ç”¨ï¼Œé€šè¿‡JDBCè®¿é—®æ•°æ®åº“&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;1-2-æ•´ä½“æœºåˆ¶&quot;&gt;&lt;a href=&quot;#1-2-æ•´ä½“æœºåˆ¶&quot; class=&quot;headerlink&quot; title=&quot;1.2 æ•´ä½“æœºåˆ¶&quot;&gt;&lt;/a&gt;1.2 æ•´ä½“æœºåˆ¶&lt;/h2&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://xssdpgy.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="seata" scheme="https://xssdpgy.github.io/tags/seata/"/>
    
    <category term="åˆ†å¸ƒå¼äº‹åŠ¡" scheme="https://xssdpgy.github.io/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>ä»£ç†æ¨¡å¼â€”â€”JDKåŠ¨æ€ä»£ç†ä¸CGLibåŸç†åŠå¯¹æ¯”åˆ†æ</title>
    <link href="https://xssdpgy.github.io/2022/10/13/%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F%E2%80%94%E2%80%94JDK%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E4%B8%8ECGLib%E5%8E%9F%E7%90%86%E5%8F%8A%E5%AF%B9%E6%AF%94%E5%88%86%E6%9E%90/"/>
    <id>https://xssdpgy.github.io/2022/10/13/%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F%E2%80%94%E2%80%94JDK%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E4%B8%8ECGLib%E5%8E%9F%E7%90%86%E5%8F%8A%E5%AF%B9%E6%AF%94%E5%88%86%E6%9E%90/</id>
    <published>2022-10-12T16:05:28.000Z</published>
    <updated>2022-10-25T15:10:58.613Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-å‰è¨€"><a href="#1-å‰è¨€" class="headerlink" title="1.å‰è¨€"></a>1.å‰è¨€</h1><p>é¦–å…ˆå›é¡¾ä¸‹ä»£ç†æ¨¡å¼ï¼ˆProxy Patternï¼‰çš„å®šä¹‰ï¼šä»£ç†æ¨¡å¼æŒ‡ä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ç§ä»£ç†ï¼Œä»¥æ§åˆ¶è¿™ä¸ªå¯¹è±¡çš„è®¿é—®ï¼Œå±äºç»“æ„å‹è®¾è®¡æ¨¡å¼ã€‚å…¶é€‚ç”¨äºåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¸€ä¸ªå¯¹è±¡ä¸é€‚åˆæˆ–è€…ä¸èƒ½ç›´æ¥å¼•ç”¨å¦ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œä»£ç†å¯¹è±¡å¯ä»¥åœ¨å®¢æˆ·ç«¯äºç›®æ ‡å¯¹è±¡ä¹‹é—´èµ·åˆ°ä¸­ä»‹çš„ä½œç”¨ã€‚</p><span id="more"></span><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/1085268-20170409105440082-1652546649-1665673852198.jpg"></p><p>ä»£ç†æ¨¡å¼ä¸»è¦åˆ†ä¸ºé™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†ä¸¤ç§æ–¹å¼ï¼Œé™æ€ä»£ç†éœ€è¦æ‰‹åŠ¨åˆ›å»ºä»£ç†ç±»ï¼Œä»£ç†çš„ç›®æ ‡å¯¹è±¡æ˜¯å›ºå®šçš„ï¼›åŠ¨æ€ä»£ç†ä½¿ç”¨åå°„æœºåˆ¶ï¼Œä»£ç†çš„ç›®æ ‡å¯¹è±¡æ˜¯æ´»åŠ¨çš„ï¼Œä¸éœ€è¦åˆ›å»ºä»£ç†ç±»å³å¯ç»™ä¸åŒçš„ç›®æ ‡éšæ—¶åˆ›å»ºä»£ç†ã€‚æœ¬ç¯‡é‡ç‚¹æ¢ç©¶åŠ¨æ€ä»£ç†çš„å®ç°ã€‚</p><h1 id="2-JDKåŠ¨æ€ä»£ç†"><a href="#2-JDKåŠ¨æ€ä»£ç†" class="headerlink" title="2.JDKåŠ¨æ€ä»£ç†"></a>2.JDKåŠ¨æ€ä»£ç†</h1><p>JDKåŠ¨æ€ä»£ç†é‡‡ç”¨å­—èŠ‚é‡ç»„ï¼Œé‡æ–°ç”Ÿæˆå¯¹è±¡æ¥æ›¿ä»£åŸå§‹å¯¹è±¡ï¼Œä»¥è¾¾åˆ°åŠ¨æ€ä»£ç†çš„ç›®çš„ã€‚JDKåŠ¨æ€ä»£ç†ç”Ÿæˆå¯¹è±¡çš„æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>è·å–è¢«ä»£ç†å¯¹è±¡çš„å¼•ç”¨ï¼Œå¹¶ä¸”è·å–å®ƒçš„æ‰€æœ‰æ¥å£ï¼Œåå°„è·å–ã€‚</li><li>JDKåŠ¨æ€ä»£ç†ç±»é‡æ–°ç”Ÿæˆä¸€ä¸ªæ–°çš„ç±»ï¼ŒåŒæ—¶æ–°çš„ç±»è¦å®ç°è¢«ä»£ç†ç±»å®ç°çš„æ‰€æœ‰æ¥å£ã€‚</li><li>åŠ¨æ€ç”ŸæˆJavaä»£ç ï¼Œæ–°åŠ çš„ä¸šåŠ¡é€»è¾‘æ–¹æ³•ç”±ä¸€å®šçš„é€»è¾‘ä»£ç è°ƒç”¨ï¼ˆåœ¨ä»£ç ä¸­ä½“ç°ï¼‰ã€‚</li><li>ç¼–è¯‘æ–°ç”Ÿæˆçš„Javaä»£ç <code>.class</code>æ–‡ä»¶ã€‚</li><li>é‡æ–°åŠ è½½åˆ°JVMä¸­è¿è¡Œã€‚</li></ol><h2 id="2-1-JDKåŠ¨æ€ä»£ç†å®ç°åŠåŸç†æºç è§£æ"><a href="#2-1-JDKåŠ¨æ€ä»£ç†å®ç°åŠåŸç†æºç è§£æ" class="headerlink" title="2.1 JDKåŠ¨æ€ä»£ç†å®ç°åŠåŸç†æºç è§£æ"></a>2.1 JDKåŠ¨æ€ä»£ç†å®ç°åŠåŸç†æºç è§£æ</h2><p>å®ç°ä¸€ä¸ªJDKåŠ¨æ€ä»£ç†ï¼Œæ–¹å¼ä¸ºå®ç°<code>java.lang.reflect.InvocationHandler</code>æ¥å£ï¼Œå¹¶ä½¿ç”¨<code>java.lang.reflect.Proxy.newProxyInstance()</code>æ–¹æ³•ç”Ÿæˆä»£ç†å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* è¦ä»£ç†çš„æ¥å£</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IPerson</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">learn</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* çœŸå®è°ƒç”¨ç±»</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Zhangsan</span> <span class="keyword">implements</span> <span class="title class_">IPerson</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">learn</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;==å¼ ä¸‰å­¦ä¹ ä¸­é—´ä»¶==&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* JDKä»£ç†ç±»ç”Ÿæˆ</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdkInvocationHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> IPerson target;</span><br><span class="line">    <span class="keyword">public</span> IPerson <span class="title function_">getInstance</span><span class="params">(IPerson target)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.target = target;</span><br><span class="line">        Class&lt;?&gt; clazz =  target.getClass();</span><br><span class="line">        <span class="keyword">return</span> (IPerson) Proxy.newProxyInstance(clazz.getClassLoader(),clazz.getInterfaces(),<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        before();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> method.invoke(<span class="built_in">this</span>.target,args);</span><br><span class="line">        after();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;äº‹å‰åšå¥½è®¡åˆ’&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;äº‹åå›é¡¾æ¢³ç†&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* æµ‹è¯•</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestProxy</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//æŠŠç”Ÿæˆçš„å­—èŠ‚ç ä¿å­˜åˆ°æœ¬åœ°ç£ç›˜,åŠ¨æ€ç”Ÿæˆçš„ç±»ä¼šä¿å­˜åœ¨å·¥ç¨‹æ ¹ç›®å½•ä¸‹çš„ com/sun/proxy ç›®å½•é‡Œé¢</span></span><br><span class="line">            System.setProperty(<span class="string">&quot;sun.misc.ProxyGenerator.saveGeneratedFiles&quot;</span>,<span class="string">&quot;true&quot;</span>);</span><br><span class="line">            <span class="type">IPerson</span> <span class="variable">obj</span> <span class="operator">=</span> (IPerson) <span class="keyword">new</span> <span class="title class_">JdkInvocationHandler</span>().getInstance(<span class="keyword">new</span> <span class="title class_">Zhangsan</span>());</span><br><span class="line">            obj.learn();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹ä¸‹ <code>Proxy.newProxyInstance</code> é‡Œé¢ç©¶ç«Ÿå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/%E4%BB%A3%E7%90%86%E7%B1%BB%E7%94%9F%E6%88%90%E6%B5%81%E7%A8%8B.jpg"></p><p>ç»“åˆæµç¨‹å›¾ï¼Œåœ¨ç”Ÿæˆå­—èŠ‚ç çš„é‚£ä¸ªåœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯ <code>ProxyGenerator.generateProxyClass()</code> æ–¹æ³•é‡Œé¢ï¼Œé€šè¿‡ä»£ç å¯ä»¥çœ‹åˆ°ï¼ˆè‡ªè¡ŒæŸ¥é˜…ï¼Œç¯‡å¹…åŸå› ï¼Œè¿™é‡Œä¸è´´ä»£ç ï¼‰ï¼Œé‡Œé¢æ˜¯ç”¨å‚æ•°  <code>saveGeneratedFiles</code>  æ¥æ§åˆ¶æ˜¯å¦æŠŠç”Ÿæˆçš„å­—èŠ‚ç ä¿å­˜åˆ°æœ¬åœ°ç£ç›˜ã€‚ä»£ç ä¸­å·²ç»è®¾ç½®ä¿å­˜åˆ°æœ¬åœ°ï¼Œç°åœ¨æ‰¾åˆ°åˆšæ‰ç”Ÿæˆçš„<code> $Proxy0.class</code>ï¼Œåç¼–è¯‘æ‰“å¼€å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.zang.jdkproxy.IPerson;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.UndeclaredThrowableException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">$Proxy0</span> <span class="keyword">extends</span> <span class="title class_">Proxy</span> <span class="keyword">implements</span> <span class="title class_">IPerson</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m1;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m3;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m2;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m0;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $Proxy0(InvocationHandler var1) <span class="keyword">throws</span>  &#123;</span><br><span class="line">        <span class="built_in">super</span>(var1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object var1)</span> <span class="keyword">throws</span>  &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (Boolean)<span class="built_in">super</span>.h.invoke(<span class="built_in">this</span>, m1, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;var1&#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var3;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var4) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UndeclaredThrowableException</span>(var4);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">learn</span><span class="params">()</span> <span class="keyword">throws</span>  &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">// super.h å¯¹åº”çš„æ˜¯çˆ¶ç±»çš„hå˜é‡ï¼Œä¹Ÿå°±æ˜¯Proxy.newProxyInstanceæ–¹æ³•ä¸­çš„InvocationHandlerå‚æ•°</span></span><br><span class="line">           <span class="comment">// æ‰€ä»¥è¿™é‡Œå®é™…ä¸Šå°±æ˜¯ä½¿ç”¨äº†æˆ‘ä»¬è‡ªå·±å†™çš„InvocationHandlerå®ç°ç±»çš„invokeæ–¹æ³•</span></span><br><span class="line">            <span class="built_in">super</span>.h.invoke(<span class="built_in">this</span>, m3, (Object[])<span class="literal">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var2;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UndeclaredThrowableException</span>(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">toString</span><span class="params">()</span> <span class="keyword">throws</span>  &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (String)<span class="built_in">super</span>.h.invoke(<span class="built_in">this</span>, m2, (Object[])<span class="literal">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var2;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UndeclaredThrowableException</span>(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> <span class="keyword">throws</span>  &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (Integer)<span class="built_in">super</span>.h.invoke(<span class="built_in">this</span>, m0, (Object[])<span class="literal">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var2;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UndeclaredThrowableException</span>(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            m1 = Class.forName(<span class="string">&quot;java.lang.Object&quot;</span>).getMethod(<span class="string">&quot;equals&quot;</span>, Class.forName(<span class="string">&quot;java.lang.Object&quot;</span>));</span><br><span class="line">            m3 = Class.forName(<span class="string">&quot;com.zang.jdkproxy.IPerson&quot;</span>).getMethod(<span class="string">&quot;learn&quot;</span>);</span><br><span class="line">            m2 = Class.forName(<span class="string">&quot;java.lang.Object&quot;</span>).getMethod(<span class="string">&quot;toString&quot;</span>);</span><br><span class="line">            m0 = Class.forName(<span class="string">&quot;java.lang.Object&quot;</span>).getMethod(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchMethodError</span>(var2.getMessage());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoClassDefFoundError</span>(var3.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° <code>$Proxy0</code>ç±»ç»§æ‰¿äº†<code>Proxy</code>ç±»ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªè·Ÿ<code>IPerson</code>ä¸€æ ·ç­¾åçš„ <code>learn</code> æ–¹æ³•ï¼Œæ–¹æ³•å®ç°ä¸­çš„<code>super.h.invoke(this, m3, (Object[])null);</code>ï¼Œsuper.h å¯¹åº”çš„æ˜¯çˆ¶ç±»çš„hå˜é‡ï¼Œä¹Ÿå°±æ˜¯<code>Proxy.newProxyInstance</code>æ–¹æ³•ä¸­çš„<code>InvocationHandler</code>å‚æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> java.lang.reflect;</span><br><span class="line"><span class="comment">//importç•¥</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Proxy</span> <span class="keyword">implements</span> <span class="title class_">java</span>.io.Serializable &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> InvocationHandler h;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">Proxy</span><span class="params">(InvocationHandler h)</span> &#123;</span><br><span class="line">        Objects.requireNonNull(h);</span><br><span class="line">        <span class="built_in">this</span>.h = h;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@CallerSensitive</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">newProxyInstance</span><span class="params">(ClassLoader loader,</span></span><br><span class="line"><span class="params">                                          Class&lt;?&gt;[] interfaces,</span></span><br><span class="line"><span class="params">                                          InvocationHandler h)</span></span><br><span class="line">        <span class="keyword">throws</span> IllegalArgumentException</span><br><span class="line">    &#123;</span><br><span class="line">        Objects.requireNonNull(h);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Class&lt;?&gt;[] intfs = interfaces.clone();</span><br><span class="line">        <span class="comment">//</span></span><br></pre></td></tr></table></figure><p>æ‰€ä»¥è¿™é‡Œå®é™…ä¸Šå°±æ˜¯ä½¿ç”¨äº†æˆ‘è‡ªå·±å†™çš„<code>InvocationHandler</code>å®ç°ç±»<code>JdkInvocationHandler</code>çš„<code>invoke</code>æ–¹æ³•ï¼Œå½“è°ƒç”¨ <code>IPerson.learn</code>çš„æ—¶å€™ï¼Œå…¶å®å®ƒæ˜¯è¢«è½¬å‘åˆ°äº†<code> JdkInvocationHandler.invoke</code>ã€‚è‡³æ­¤ï¼Œæ•´ä¸ªé­”æœ¯è¿‡ç¨‹å°±é€æ˜äº†ã€‚</p><h2 id="2-2-æ‰‹å†™JDKåŠ¨æ€ä»£ç†"><a href="#2-2-æ‰‹å†™JDKåŠ¨æ€ä»£ç†" class="headerlink" title="2.2 æ‰‹å†™JDKåŠ¨æ€ä»£ç†"></a>2.2 æ‰‹å†™JDKåŠ¨æ€ä»£ç†</h2><p>ä½¿ç”¨JDKåŠ¨æ€ä»£ç†çš„ç±»åå’Œæ–¹æ³•åå®šä¹‰ä»¥åŠæ‰§è¡Œæ€è·¯ï¼Œä¸‹é¢æ¥è¿›è¡Œæ‰‹å†™å®ç°ã€‚</p><h3 id="åˆ›å»ºMyInvocationHandleræ¥å£ï¼š"><a href="#åˆ›å»ºMyInvocationHandleræ¥å£ï¼š" class="headerlink" title="åˆ›å»ºMyInvocationHandleræ¥å£ï¼š"></a>åˆ›å»º<code>MyInvocationHandler</code>æ¥å£ï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyInvocationHandler</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span></span><br><span class="line">            <span class="keyword">throws</span> Throwable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åˆ›å»ºMyProxyç±»ï¼š"><a href="#åˆ›å»ºMyProxyç±»ï¼š" class="headerlink" title="åˆ›å»ºMyProxyç±»ï¼š"></a>åˆ›å»ºMyProxyç±»ï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.tools.JavaCompiler;</span><br><span class="line"><span class="keyword">import</span> javax.tools.StandardJavaFileManager;</span><br><span class="line"><span class="keyword">import</span> javax.tools.ToolProvider;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileWriter;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è‡ªå·±å®ç°çš„ä»£ç†ç±»ï¼Œç”¨æ¥ç”Ÿæˆå­—èŠ‚ç æ–‡ä»¶ï¼Œå¹¶åŠ¨æ€åŠ è½½åˆ°JVMä¸­</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyProxy</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ln</span> <span class="operator">=</span> <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”Ÿæˆä»£ç†å¯¹è±¡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> classLoader ç±»åŠ è½½å™¨ï¼Œç”¨äºåŠ è½½è¢«ä»£ç†ç±»çš„ç±»æ–‡ä»¶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> interfaces è¢«ä»£ç†ç±»çš„æ¥å£</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> h è‡ªå®šä¹‰çš„InvocationHandleræ¥å£,ç”¨äºå…·ä½“ä»£ç†æ–¹æ³•çš„æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> è¿”å›è¢«ä»£ç†åçš„ä»£ç†å¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">newProxyInstance</span><span class="params">(MyClassLoader classLoader, Class&lt;?&gt;[] interfaces, MyInvocationHandler h)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//1ã€åŠ¨æ€ç”Ÿæˆæºä»£ç .javaæ–‡ä»¶</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">src</span> <span class="operator">=</span> generateSrc(interfaces);</span><br><span class="line">        <span class="comment">//2ã€Javaæ–‡ä»¶è¾“å‡ºç£ç›˜</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> MyProxy.class.getResource(<span class="string">&quot;&quot;</span>).getPath();</span><br><span class="line"></span><br><span class="line">            <span class="type">File</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(filePath + <span class="string">&quot;$Proxy0.java&quot;</span>);</span><br><span class="line">            <span class="type">FileWriter</span> <span class="variable">fw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(f);</span><br><span class="line">            fw.write(src);</span><br><span class="line">            fw.flush();</span><br><span class="line">            fw.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3ã€æŠŠç”Ÿæˆçš„.javaæ–‡ä»¶ç¼–è¯‘æˆ.classæ–‡ä»¶</span></span><br><span class="line">            <span class="comment">//è·å–Javaç¼–è¯‘å™¨</span></span><br><span class="line">            <span class="type">JavaCompiler</span> <span class="variable">compiler</span> <span class="operator">=</span> ToolProvider.getSystemJavaCompiler();</span><br><span class="line">            <span class="comment">//æ ‡æ³¨Javaæ–‡ä»¶ç®¡ç†å™¨ï¼Œç”¨æ¥è·å–Javaå­—èŠ‚ç æ–‡ä»¶</span></span><br><span class="line">            <span class="type">StandardJavaFileManager</span> <span class="variable">manage</span> <span class="operator">=</span> compiler.getStandardFileManager(<span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            <span class="type">Iterable</span> <span class="variable">iterable</span> <span class="operator">=</span> manage.getJavaFileObjects(f);</span><br><span class="line">            <span class="comment">//åˆ›å»ºtaskï¼Œé€šè¿‡javaå­—èŠ‚ç æ–‡ä»¶å°†ç±»ä¿¡æ¯åŠ è½½åˆ°JVMä¸­</span></span><br><span class="line">            JavaCompiler.<span class="type">CompilationTask</span> <span class="variable">task</span> <span class="operator">=</span> compiler.getTask(<span class="literal">null</span>, manage, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, iterable);</span><br><span class="line">            <span class="comment">//å¼€å§‹æ‰§è¡Œtask</span></span><br><span class="line">            task.call();</span><br><span class="line">            <span class="comment">//å…³é—­ç®¡ç†å™¨</span></span><br><span class="line">            manage.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4ã€ç¼–è¯‘ç”Ÿæˆçš„.classæ–‡ä»¶åŠ è½½åˆ°JVMä¸­æ¥</span></span><br><span class="line">            <span class="type">Class</span> <span class="variable">proxyClass</span> <span class="operator">=</span> classLoader.findClass(<span class="string">&quot;$Proxy0&quot;</span>);</span><br><span class="line">            <span class="type">Constructor</span> <span class="variable">c</span> <span class="operator">=</span> proxyClass.getConstructor(MyInvocationHandler.class);</span><br><span class="line">            f.delete();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5ã€è¿”å›å­—èŠ‚ç é‡ç»„ä»¥åçš„æ–°çš„ä»£ç†å¯¹è±¡</span></span><br><span class="line">            <span class="keyword">return</span> c.newInstance(h);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”Ÿæˆä»£ç†ç±»çš„æºä»£ç </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">generateSrc</span><span class="params">(Class&lt;?&gt;[] interfaces)</span> &#123;</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        sb.append(MyProxy.class.getPackage() + <span class="string">&quot;;&quot;</span> + ln);</span><br><span class="line">        sb.append(<span class="string">&quot;import &quot;</span> + interfaces[<span class="number">0</span>].getName() + <span class="string">&quot;;&quot;</span> + ln);</span><br><span class="line">        sb.append(<span class="string">&quot;import java.lang.reflect.*;&quot;</span> + ln);</span><br><span class="line">        sb.append(<span class="string">&quot;public class $Proxy0 implements &quot;</span> + interfaces[<span class="number">0</span>].getName() + <span class="string">&quot;&#123;&quot;</span> + ln);</span><br><span class="line">        sb.append(<span class="string">&quot;GPInvocationHandler h;&quot;</span> + ln);</span><br><span class="line">        sb.append(<span class="string">&quot;public $Proxy0(GPInvocationHandler h) &#123; &quot;</span> + ln);</span><br><span class="line">        sb.append(<span class="string">&quot;this.h = h;&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;&#125;&quot;</span> + ln);</span><br><span class="line">        <span class="keyword">for</span> (Method m : interfaces[<span class="number">0</span>].getMethods()) &#123;</span><br><span class="line">            Class&lt;?&gt;[] params = m.getParameterTypes();</span><br><span class="line"></span><br><span class="line">            <span class="type">StringBuffer</span> <span class="variable">paramNames</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">            <span class="type">StringBuffer</span> <span class="variable">paramValues</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">            <span class="type">StringBuffer</span> <span class="variable">paramClasses</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; params.length; i++) &#123;</span><br><span class="line">                <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> params[i];</span><br><span class="line">                <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> clazz.getName();</span><br><span class="line">                <span class="type">String</span> <span class="variable">paramName</span> <span class="operator">=</span> toLowerFirstCase(clazz.getSimpleName());</span><br><span class="line">                paramNames.append(type + <span class="string">&quot; &quot;</span> + paramName);</span><br><span class="line">                paramValues.append(paramName);</span><br><span class="line">                paramClasses.append(clazz.getName() + <span class="string">&quot;.class&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (i &gt; <span class="number">0</span> &amp;&amp; i &lt; params.length - <span class="number">1</span>) &#123;</span><br><span class="line">                    paramNames.append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                    paramClasses.append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                    paramValues.append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            sb.append(<span class="string">&quot;public &quot;</span> + m.getReturnType().getName() + <span class="string">&quot; &quot;</span> + m.getName() + <span class="string">&quot;(&quot;</span> + paramNames.toString() + <span class="string">&quot;) &#123;&quot;</span> + ln);</span><br><span class="line">            sb.append(<span class="string">&quot;try&#123;&quot;</span> + ln);</span><br><span class="line">            sb.append(<span class="string">&quot;Method m = &quot;</span> + interfaces[<span class="number">0</span>].getName() + <span class="string">&quot;.class.getMethod(\&quot;&quot;</span> + m.getName() + <span class="string">&quot;\&quot;,new Class[]&#123;&quot;</span> + paramClasses.toString() + <span class="string">&quot;&#125;);&quot;</span> + ln);</span><br><span class="line">            sb.append((hasReturnValue(m.getReturnType()) ? <span class="string">&quot;return &quot;</span> : <span class="string">&quot;&quot;</span>) + getCaseCode(<span class="string">&quot;this.h.invoke(this,m,new Object[]&#123;&quot;</span> + paramValues + <span class="string">&quot;&#125;)&quot;</span>, m.getReturnType()) + <span class="string">&quot;;&quot;</span> + ln);</span><br><span class="line">            sb.append(<span class="string">&quot;&#125;catch(Error _ex) &#123; &#125;&quot;</span>);</span><br><span class="line">            sb.append(<span class="string">&quot;catch(Throwable e)&#123;&quot;</span> + ln);</span><br><span class="line">            sb.append(<span class="string">&quot;throw new UndeclaredThrowableException(e);&quot;</span> + ln);</span><br><span class="line">            sb.append(<span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">            sb.append(getReturnEmptyCode(m.getReturnType()));</span><br><span class="line">            sb.append(<span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        sb.append(<span class="string">&quot;&#125;&quot;</span> + ln);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Class, Class&gt; mappings = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Class, Class&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        mappings.put(<span class="type">int</span>.class, Integer.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">getReturnEmptyCode</span><span class="params">(Class&lt;?&gt; returnClass)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mappings.containsKey(returnClass)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;return 0;&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (returnClass == <span class="keyword">void</span>.class) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;return null;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">getCaseCode</span><span class="params">(String code, Class&lt;?&gt; returnClass)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mappings.containsKey(returnClass)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;((&quot;</span> + mappings.get(returnClass).getName() + <span class="string">&quot;)&quot;</span> + code + <span class="string">&quot;).&quot;</span> + returnClass.getSimpleName() + <span class="string">&quot;Value()&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">hasReturnValue</span><span class="params">(Class&lt;?&gt; clazz)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> clazz != <span class="keyword">void</span>.class;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">toLowerFirstCase</span><span class="params">(String src)</span> &#123;</span><br><span class="line">        <span class="type">char</span>[] chars = src.toCharArray();</span><br><span class="line">        chars[<span class="number">0</span>] += <span class="number">32</span>;</span><br><span class="line">        <span class="keyword">return</span> String.valueOf(chars);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åˆ›å»ºç±»åŠ è½½å™¨MyClassLoaderï¼š"><a href="#åˆ›å»ºç±»åŠ è½½å™¨MyClassLoaderï¼š" class="headerlink" title="åˆ›å»ºç±»åŠ è½½å™¨MyClassLoaderï¼š"></a>åˆ›å»ºç±»åŠ è½½å™¨MyClassLoaderï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyClassLoader</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> File classPathFile;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyClassLoader</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">classPath</span> <span class="operator">=</span> MyClassLoader.class.getResource(<span class="string">&quot;&quot;</span>).getPath();</span><br><span class="line">        <span class="built_in">this</span>.classPathFile = <span class="keyword">new</span> <span class="title class_">File</span>(classPath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é€šè¿‡ç±»åç§°åŠ è½½ç±»å­—èŠ‚ç æ–‡ä»¶åˆ°JVMä¸­</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name ç±»å</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ç±»çš„Classç‹¬äº«</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ClassNotFoundException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">//è·å–ç±»å</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> MyClassLoader.class.getPackage().getName() + <span class="string">&quot;.&quot;</span> + name;</span><br><span class="line">        <span class="keyword">if</span>(classPathFile  != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//è·å–ç±»æ–‡ä»¶</span></span><br><span class="line">            <span class="type">File</span> <span class="variable">classFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(classPathFile,name.replaceAll(<span class="string">&quot;\\.&quot;</span>,<span class="string">&quot;/&quot;</span>) + <span class="string">&quot;.class&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(classFile.exists())&#123;</span><br><span class="line">                <span class="comment">//å°†ç±»æ–‡ä»¶è½¬åŒ–ä¸ºå­—èŠ‚æ•°ç»„</span></span><br><span class="line">                <span class="type">FileInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="type">ByteArrayOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    in = <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(classFile);</span><br><span class="line">                    out = <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">                    <span class="type">byte</span> [] buff = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                    <span class="type">int</span> len;</span><br><span class="line">                    <span class="keyword">while</span> ((len = in.read(buff)) != -<span class="number">1</span>)&#123;</span><br><span class="line">                        out.write(buff,<span class="number">0</span>,len);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//è°ƒç”¨çˆ¶ç±»æ–¹æ³•ç”Ÿæˆclasså®ä¾‹</span></span><br><span class="line">                    <span class="keyword">return</span> defineClass(className,out.toByteArray(),<span class="number">0</span>,out.size());</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å®ç°å¹¶æµ‹è¯•"><a href="#å®ç°å¹¶æµ‹è¯•" class="headerlink" title="å®ç°å¹¶æµ‹è¯•"></a>å®ç°å¹¶æµ‹è¯•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* è¦ä»£ç†çš„æ¥å£</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IPerson</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">learn</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* çœŸå®è°ƒç”¨ç±»</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Zhangsan</span> <span class="keyword">implements</span> <span class="title class_">IPerson</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">learn</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;==å¼ ä¸‰å­¦ä¹ ä¸­é—´ä»¶==&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* JDKä»£ç†ç±»ç”Ÿæˆ</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomInvocationHandler</span> <span class="keyword">implements</span> <span class="title class_">MyInvocationHandler</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> IPerson target;</span><br><span class="line">    <span class="keyword">public</span> IPerson <span class="title function_">getInstance</span><span class="params">(IPerson target)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.target = target;</span><br><span class="line">        Class&lt;?&gt; clazz =  target.getClass();</span><br><span class="line">        <span class="keyword">return</span> (IPerson) MyProxy.newProxyInstance(<span class="keyword">new</span> <span class="title class_">MyClassLoader</span>(),clazz.getInterfaces(),<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        before();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> method.invoke(<span class="built_in">this</span>.target,args);</span><br><span class="line">        after();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;äº‹å‰åšå¥½è®¡åˆ’&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;äº‹åå›é¡¾æ¢³ç†&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* æµ‹è¯•</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">CustomInvocationHandler</span> <span class="variable">custom</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomInvocationHandler</span>();</span><br><span class="line">        <span class="type">IPerson</span> <span class="variable">zhangsan</span> <span class="operator">=</span> custom.getInstance(<span class="keyword">new</span> <span class="title class_">Zhangsan</span>());</span><br><span class="line">        zhangsan.learn();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œæ‰‹å†™å®Œæˆï¼Œè¯»è€…ä¹Ÿå¯è‡ªè¡Œå‚ç…§å®ç°ã€‚</p><h1 id="3-CGLibåŠ¨æ€ä»£ç†APIåŸç†åˆ†æ"><a href="#3-CGLibåŠ¨æ€ä»£ç†APIåŸç†åˆ†æ" class="headerlink" title="3.CGLibåŠ¨æ€ä»£ç†APIåŸç†åˆ†æ"></a>3.CGLibåŠ¨æ€ä»£ç†APIåŸç†åˆ†æ</h1><h2 id="3-1-CGLibåŠ¨æ€ä»£ç†çš„ä½¿ç”¨"><a href="#3-1-CGLibåŠ¨æ€ä»£ç†çš„ä½¿ç”¨" class="headerlink" title="3.1 CGLibåŠ¨æ€ä»£ç†çš„ä½¿ç”¨"></a>3.1 CGLibåŠ¨æ€ä»£ç†çš„ä½¿ç”¨</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> net.sf.cglib.proxy.Enhancer;</span><br><span class="line"><span class="keyword">import</span> net.sf.cglib.proxy.MethodInterceptor;</span><br><span class="line"><span class="keyword">import</span> net.sf.cglib.proxy.MethodProxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomCGlib</span> <span class="keyword">implements</span> <span class="title class_">MethodInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getInstance</span><span class="params">(Class&lt;?&gt; clazz)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">//ç›¸å½“äºProxyï¼Œä»£ç†çš„å·¥å…·ç±»</span></span><br><span class="line">        <span class="type">Enhancer</span> <span class="variable">enhancer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Enhancer</span>();</span><br><span class="line">        enhancer.setSuperclass(clazz);</span><br><span class="line">        enhancer.setCallback(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">return</span> enhancer.create();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Object o, Method method, Object[] objects, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        before();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> methodProxy.invokeSuper(o,objects);</span><br><span class="line">        after();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;äº‹å‰åšå¥½è®¡åˆ’&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;äº‹åå›é¡¾æ¢³ç†&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸€ä¸ªå°ç»†èŠ‚ï¼ŒCGLibåŠ¨æ€ä»£ç†çš„ç›®æ ‡å¯¹è±¡ä¸éœ€è¦å®ç°ä»»ä½•æ¥å£ï¼Œå®ƒæ˜¯é€šè¿‡åŠ¨æ€ç»§æ‰¿ç›®æ ‡å¯¹è±¡å®ç°åŠ¨æ€ä»£ç†çš„ï¼Œå®¢æˆ·ç«¯æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CglibTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Zhangsan</span> <span class="variable">obj</span> <span class="operator">=</span> (Zhangsan) <span class="keyword">new</span> <span class="title class_">CustomCGlib</span>().getInstance(Zhangsan.class);</span><br><span class="line">            obj.learn();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-2-CGLibåŠ¨æ€ä»£ç†çš„å®ç°åŸç†"><a href="#3-2-CGLibåŠ¨æ€ä»£ç†çš„å®ç°åŸç†" class="headerlink" title="3.2 CGLibåŠ¨æ€ä»£ç†çš„å®ç°åŸç†"></a>3.2 CGLibåŠ¨æ€ä»£ç†çš„å®ç°åŸç†</h2><p>CGLibåŠ¨æ€ä»£ç†çš„å®ç°åŸç†åˆæ˜¯æ€æ ·çš„å‘¢ï¼Ÿå¯ä»¥åœ¨å®¢æˆ·ç«¯æµ‹è¯•ä»£ç ä¸­åŠ ä¸Šä¸€å¥ä»£ç ï¼Œå°†CGLibåŠ¨æ€ä»£ç†åçš„<code>.class</code>æ–‡ä»¶å†™å…¥ç£ç›˜ï¼Œç„¶ååç¼–è¯‘æ¥ä¸€æ¢ç©¶ç«Ÿï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//import net.sf.cglib.core.DebuggingClassWriter;</span></span><br><span class="line"><span class="comment">//ä½¿ç”¨CGLibçš„ä»£ç†ç±»å¯ä»¥å°†å†…å­˜ä¸­çš„.classæ–‡ä»¶å†™å…¥æœ¬åœ°ç£ç›˜</span></span><br><span class="line">System.setProperty(DebuggingClassWriter.DEBUG_LOCATION_PROPERTY,<span class="string">&quot;E://cglib_proxy_classes&quot;</span>);</span><br><span class="line"><span class="type">Zhangsan</span> <span class="variable">obj</span> <span class="operator">=</span> Â·Â·Â·</span><br><span class="line"><span class="comment">//Â·Â·Â·</span></span><br></pre></td></tr></table></figure><p>é‡æ–°æ‰§è¡Œä»£ç ï¼Œåœ¨è¾“å‡ºç›®å½•ä¸‹ä¼šå‡ºç°ä¸‰ä¸ª<code>.class</code>æ–‡ä»¶ï¼Œä¸€ä¸ªæ˜¯ç›®æ ‡ï¼ˆè¢«ä»£ç†ï¼‰ç±»çš„FastClassï¼Œä¸€ä¸ªæ˜¯ä»£ç†ç±»ï¼Œä¸€ä¸ªæ˜¯ä»£ç†ç±»çš„FastClassã€‚å¦‚å›¾ï¼š</p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20221015172429971.png"></p><p>å…¶ä¸­ï¼Œ<code>Zhangsan$$EnhancerByCGLIB$$3d23e0ea.class</code>å°±æ˜¯CGLibåŠ¨æ€ä»£ç†ç”Ÿæˆçš„ä»£ç†ç±»ï¼Œç»§æ‰¿äº†<code>Zhangsan</code>ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zang.cglibproxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> net.sf.cglib.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Zhangsan$$EnhancerByCGLIB$$3d23e0ea</span> <span class="keyword">extends</span> <span class="title class_">Zhangsan</span> <span class="keyword">implements</span> <span class="title class_">Factory</span> &#123;</span><br><span class="line"><span class="comment">//Â·Â·Â·</span></span><br><span class="line">   <span class="comment">//ä¼ å…¥çš„MethodInterceptorå¯¹è±¡      </span></span><br><span class="line">   <span class="keyword">private</span> MethodInterceptor CGLIB$CALLBACK_0;</span><br><span class="line">   <span class="comment">//ç›®æ ‡ç±»çš„learnæ–¹æ³•å¯¹è±¡  </span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Method CGLIB$learn$<span class="number">0</span>$Method;</span><br><span class="line">   <span class="comment">//ä»£ç†ç±»çš„learnæ–¹æ³•å¯¹è±¡  </span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> MethodProxy CGLIB$learn$<span class="number">0</span>$Proxy;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object[] CGLIB$emptyArgs;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//åˆå§‹åŒ–æ–¹æ³•ï¼Œå…¶ä¸­éƒ¨åˆ†ä»£ç ç•¥  </span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> CGLIB$STATICHOOK1() &#123;</span><br><span class="line">        CGLIB$THREAD_CALLBACKS = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>();</span><br><span class="line">        CGLIB$emptyArgs = <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>];</span><br><span class="line">        <span class="type">Class</span> <span class="variable">var0</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.zang.cglibproxy.Zhangsan$$EnhancerByCGLIB$$78b38660&quot;</span>);</span><br><span class="line">        Class var1;</span><br><span class="line">        Method[] var10000 = ReflectUtils.findMethods(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;equals&quot;</span>, <span class="string">&quot;(Ljava/lang/Object;)Z&quot;</span>, <span class="string">&quot;toString&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>, <span class="string">&quot;hashCode&quot;</span>, <span class="string">&quot;()I&quot;</span>, <span class="string">&quot;clone&quot;</span>, <span class="string">&quot;()Ljava/lang/Object;&quot;</span>&#125;, (var1 = Class.forName(<span class="string">&quot;java.lang.Object&quot;</span>)).getDeclaredMethods());</span><br><span class="line">        <span class="comment">//Â·Â·Â·</span></span><br><span class="line">        <span class="comment">//åˆå§‹åŒ–ç›®æ ‡ç±»çš„learnæ–¹æ³•å¯¹è±¡</span></span><br><span class="line">        CGLIB$learn$<span class="number">0</span>$Method = ReflectUtils.findMethods(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;learn&quot;</span>, <span class="string">&quot;()V&quot;</span>&#125;, (var1 = Class.forName(<span class="string">&quot;com.zang.cglibproxy.Zhangsan&quot;</span>)).getDeclaredMethods())[<span class="number">0</span>];</span><br><span class="line">        <span class="comment">//åˆå§‹åŒ–ä»£ç†ç±»çš„learnæ–¹æ³•å¯¹è±¡</span></span><br><span class="line">        CGLIB$learn$<span class="number">0</span>$Proxy = MethodProxy.create(var1, var0, <span class="string">&quot;()V&quot;</span>, <span class="string">&quot;learn&quot;</span>, <span class="string">&quot;CGLIB$learn$0&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è¿™é‡Œç›´æ¥è°ƒç”¨Zhangsan#learn</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">void</span> CGLIB$learn$<span class="number">0</span>() &#123;</span><br><span class="line">        <span class="built_in">super</span>.learn();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">learn</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MethodInterceptor</span> <span class="variable">var10000</span> <span class="operator">=</span> <span class="built_in">this</span>.CGLIB$CALLBACK_0;</span><br><span class="line">        <span class="keyword">if</span> (var10000 == <span class="literal">null</span>) &#123;</span><br><span class="line">            CGLIB$BIND_CALLBACKS(<span class="built_in">this</span>);</span><br><span class="line">            var10000 = <span class="built_in">this</span>.CGLIB$CALLBACK_0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (var10000 != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//è¿™é‡Œæ‰§è¡Œæ‹¦æˆªå™¨å®šä¹‰é€»è¾‘</span></span><br><span class="line">            var10000.intercept(<span class="built_in">this</span>, CGLIB$learn$<span class="number">0</span>$Method, CGLIB$emptyArgs, CGLIB$learn$<span class="number">0</span>$Proxy);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.learn();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//Â·Â·Â·</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨è¿‡ç¨‹ä¸ºï¼šä»£ç†å¯¹è±¡è°ƒç”¨<code>this.learn</code>æ–¹æ³•â†’è°ƒç”¨æ‹¦æˆªå™¨â†’<code>methodProxy.invokeSuper()</code>â†’<code>CGLIB$learn$0</code>â†’è¢«ä»£ç†å¯¹è±¡<code>learn</code>æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> net.sf.cglib.proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MethodInterceptor</span> <span class="keyword">extends</span> <span class="title class_">Callback</span> &#123;</span><br><span class="line">    Object <span class="title function_">intercept</span><span class="params">(Object var1, Method var2, Object[] var3, MethodProxy var4)</span> <span class="keyword">throws</span> Throwable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomCGlib</span> <span class="keyword">implements</span> <span class="title class_">MethodInterceptor</span> &#123;</span><br><span class="line"><span class="comment">//Â·Â·Â·</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Object o, Method method, Object[] objects, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        before();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> methodProxy.invokeSuper(o,objects);</span><br><span class="line">        after();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//Â·Â·Â·</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>MethodInterceptor</code>æ‹¦æˆªå™¨å°±æ˜¯ç”±<code>MethodProxy</code>çš„<code>invokeSuper</code>æ–¹æ³•è°ƒç”¨ä»£ç†æ–¹æ³•çš„ï¼Œå› æ­¤ï¼Œ<code>MethodProxy</code>ç±»ä¸­çš„ä»£ç éå¸¸å…³é”®ï¼Œä¸‹é¢åˆ†æå®ƒå…·ä½“åšäº†ä»€ä¹ˆï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> net.sf.cglib.proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> net.sf.cglib.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MethodProxy</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Signature sig1;</span><br><span class="line">    <span class="keyword">private</span> Signature sig2;</span><br><span class="line">    <span class="keyword">private</span> MethodProxy.CreateInfo createInfo;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">initLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> MethodProxy.FastClassInfo fastClassInfo;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.fastClassInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(<span class="built_in">this</span>.initLock) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.fastClassInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">                    MethodProxy.<span class="type">CreateInfo</span> <span class="variable">ci</span> <span class="operator">=</span> <span class="built_in">this</span>.createInfo;</span><br><span class="line">                    MethodProxy.<span class="type">FastClassInfo</span> <span class="variable">fci</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MethodProxy</span>.FastClassInfo();</span><br><span class="line">                    <span class="comment">//åˆ›å»ºç›®æ ‡ç±»çš„FastClasså¯¹è±¡(åœ¨ç¼“å­˜ä¸­ï¼Œåˆ™å–å‡ºï¼›æ²¡åœ¨ï¼Œåˆ™é‡æ–°ç”Ÿæˆ)</span></span><br><span class="line">                    fci.f1 = helper(ci, ci.c1);</span><br><span class="line">                    <span class="comment">//åˆ›å»ºä»£ç†ç±»çš„FastClasså¯¹è±¡</span></span><br><span class="line">                    fci.f2 = helper(ci, ci.c2);</span><br><span class="line">                    <span class="comment">//è·å–learnæ–¹æ³•çš„ç´¢å¼•</span></span><br><span class="line">                    fci.i1 = fci.f1.getIndex(<span class="built_in">this</span>.sig1);</span><br><span class="line">                    <span class="comment">//è·å–CGLIB$learn$0æ–¹æ³•çš„ç´¢å¼•</span></span><br><span class="line">                    fci.i2 = fci.f2.getIndex(<span class="built_in">this</span>.sig2);</span><br><span class="line">                    <span class="built_in">this</span>.fastClassInfo = fci;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invokeSuper</span><span class="params">(Object obj, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//åˆå§‹åŒ–ï¼Œåˆ›å»ºäº†ä¸¤ä¸ªFastClassç±»å¯¹è±¡</span></span><br><span class="line">            <span class="built_in">this</span>.init();</span><br><span class="line">            MethodProxy.<span class="type">FastClassInfo</span> <span class="variable">fci</span> <span class="operator">=</span> <span class="built_in">this</span>.fastClassInfo;</span><br><span class="line">            <span class="comment">//è¿™é‡Œå°†ç›´æ¥è°ƒç”¨ä»£ç†ç±»çš„CGLIB$learn$0æ–¹æ³•ï¼Œè€Œä¸æ˜¯é€šè¿‡åå°„è°ƒç”¨</span></span><br><span class="line">            <span class="comment">//fci.f2ï¼šä»£ç†ç±»çš„FastClasså¯¹è±¡ï¼Œfci.i2ä¸ºCGLIB$learn$0æ–¹æ³•å¯¹åº”çš„ç´¢å¼•ï¼Œobjä¸ºå½“å‰çš„ä»£ç†ç±»å¯¹è±¡ï¼Œargsä¸ºlearnæ–¹æ³•çš„å‚æ•°åˆ—è¡¨</span></span><br><span class="line">            <span class="keyword">return</span> fci.f2.invoke(fci.i2, obj, args);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException var4) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var4.getTargetException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç è°ƒç”¨è·å–ä»£ç†ç±»å¯¹åº”çš„FastClassï¼Œå¹¶æ‰§è¡Œä»£ç†æ–¹æ³•ã€‚è¿˜è®°å¾—ä¹‹å‰ç”Ÿæˆçš„ä¸‰ä¸ª<code>.class</code>æ–‡ä»¶å—ï¼Ÿ<code>Zhangsan$$EnhancerByCGLIB$$78b38660$$FastClassByCGLIB$$a8f9873c.class</code>å°±æ˜¯ä»£ç†ç±»çš„FastClassï¼Œ<code>Zhangsan$$FastClassByCGLIB$$bcf7b1f4.class</code>å°±æ˜¯è¢«ä»£ç†ç±»çš„FastClassã€‚</p><p>CGLibåŠ¨æ€ä»£ç†æ‰§è¡Œä»£ç†æ–¹æ³•çš„æ•ˆç‡ä¹‹æ‰€ä»¥æ¯”JDKé«˜ï¼Œæ˜¯å› ä¸ºCGlibé‡‡ç”¨äº†FastClassæœºåˆ¶ï¼Œå®ƒçš„åŸç†ç®€å•æ¥è¯´å°±æ˜¯ï¼šä¸ºä»£ç†ç±»å’Œè¢«ä»£ç†ç±»å„ç”Ÿæˆä¸€ä¸ªç±»ï¼Œè¿™ä¸ªç±»ä¼šä¸ºä»£ç†ç±»æˆ–è¢«ä»£ç†ç±»çš„æ–¹æ³•åˆ†é…ä¸€ä¸ªindexï¼ˆintç±»å‹ï¼‰ï¼›è¿™ä¸ªindexè¢«å½“ä½œä¸€ä¸ªå…¥å‚ï¼ŒFastClasså¯ä»¥ç›´æ¥å®šä½è¦è°ƒç”¨çš„æ–¹æ³•å¹¶ç›´æ¥è¿›è¡Œè°ƒç”¨ï¼Œçœå»äº†åå°„è°ƒç”¨ï¼Œå› æ­¤è°ƒç”¨æ•ˆç‡æ¯”JDKåŠ¨æ€ä»£ç†é€šè¿‡åå°„è°ƒç”¨é«˜ï¼ˆå¹¶ä¸ç»å¯¹ï¼Œè¿˜éœ€å‚è€ƒJDKç‰ˆæœ¬åŠä½¿ç”¨åœºæ™¯æ¥è¯´ï¼‰ã€‚ä¸‹é¢æ¥åç¼–è¯‘ä¸€ä¸ªFastClassã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Zhangsan$$FastClassByCGLIB$$bcf7b1f4</span> <span class="keyword">extends</span> <span class="title class_">FastClass</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Zhangsan$$FastClassByCGLIB$$bcf7b1f4(Class var1) &#123;</span><br><span class="line">        <span class="built_in">super</span>(var1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getIndex</span><span class="params">(Signature var1)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">var10000</span> <span class="operator">=</span> var1.toString();</span><br><span class="line">        <span class="keyword">switch</span>(var10000.hashCode()) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1574139569</span>:</span><br><span class="line">            <span class="keyword">if</span> (var10000.equals(<span class="string">&quot;learn()V&quot;</span>)) &#123;</span><br><span class="line">                <span class="comment">//learnæ–¹æ³•è¿”å›0</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1826985398</span>:</span><br><span class="line">            <span class="keyword">if</span> (var10000.equals(<span class="string">&quot;equals(Ljava/lang/Object;)Z&quot;</span>)) &#123;</span><br><span class="line">   <span class="comment">//Â·Â·Â·</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æ ¹æ®indexè·å–æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(<span class="type">int</span> var1, Object var2, Object[] var3)</span> <span class="keyword">throws</span> InvocationTargetException &#123;</span><br><span class="line">        <span class="type">Zhangsan</span> <span class="variable">var10000</span> <span class="operator">=</span> (Zhangsan)var2;</span><br><span class="line">        <span class="type">int</span> <span class="variable">var10001</span> <span class="operator">=</span> var1;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span>(var10001) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="comment">//ä¼ å…¥indexä¸º0åˆ™æ‰§è¡Œlearnæ–¹æ³•</span></span><br><span class="line">                var10000.learn();</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Boolean</span>(var10000.equals(var3[<span class="number">0</span>]));</span><br><span class="line">   <span class="comment">//Â·Â·Â·           </span></span><br><span class="line">                    </span><br></pre></td></tr></table></figure><p>FastClasså¹¶ä¸æ˜¯è·Ÿä»£ç†ç±»ä¸€èµ·ç”Ÿæˆçš„ï¼Œè€Œæ˜¯åœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œ<code>MethodProxy</code>çš„<code>invoke</code>æˆ–<code>invokeSuper</code>æ–¹æ³•æ—¶ç”Ÿæˆçš„ï¼Œå¹¶è¢«æ”¾åœ¨äº†ç¼“å­˜ä¸­ã€‚</p><h1 id="4-æ€»ç»“"><a href="#4-æ€»ç»“" class="headerlink" title="4.æ€»ç»“"></a>4.æ€»ç»“</h1><p>é€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œç›¸ä¿¡ä¼šå¯¹ä¸¤ç§åŠ¨æ€ä»£ç†çš„å®ç°åŸç†æœ‰ä¸€ä¸ªæ·±å…¥çš„è®¤è¯†ï¼Œæ€»ç»“æ€§æ¯”è¾ƒä¸¤è€…çš„åŒºåˆ«å¦‚ä¸‹ï¼š</p><ol><li>JDKåŠ¨æ€ä»£ç†å®ç°äº†è¢«ä»£ç†å¯¹è±¡çš„æ¥å£ï¼ŒCGLibåŠ¨æ€ä»£ç†ç»§æ‰¿äº†è¢«ä»£ç†å¯¹è±¡ã€‚</li><li>JDKåŠ¨æ€ä»£ç†å’ŒCGLibåŠ¨æ€ä»£ç†éƒ½åœ¨è¿è¡ŒæœŸç”Ÿæˆå­—èŠ‚ç ï¼ŒJDKåŠ¨æ€ä»£ç†ç›´æ¥å†™Classå­—èŠ‚ç ï¼ŒCGLibåŠ¨æ€ä»£ç†ä½¿ç”¨ASMæ¡†æ¶å†™Classå­—èŠ‚ç ã€‚CGLibåŠ¨æ€ä»£ç†å®ç°æ›´å¤æ‚ï¼Œç”Ÿæˆä»£ç†ç±»æ¯”JDKåŠ¨æ€ä»£ç†æ•ˆç‡ä½ã€‚</li><li>JDKåŠ¨æ€ä»£ç†è°ƒç”¨ä»£ç†æ–¹æ³•æ˜¯é€šè¿‡åå°„æœºåˆ¶è°ƒç”¨çš„ï¼ŒCGLibåŠ¨æ€ä»£ç†æ˜¯é€šè¿‡FastClassæœºåˆ¶ç›´æ¥è°ƒç”¨æ–¹æ³•çš„ï¼ŒCGLibåŠ¨æ€ä»£ç†çš„æ‰§è¡Œæ•ˆç‡æ›´é«˜ã€‚</li></ol>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;1-å‰è¨€&quot;&gt;&lt;a href=&quot;#1-å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;1.å‰è¨€&quot;&gt;&lt;/a&gt;1.å‰è¨€&lt;/h1&gt;&lt;p&gt;é¦–å…ˆå›é¡¾ä¸‹ä»£ç†æ¨¡å¼ï¼ˆProxy Patternï¼‰çš„å®šä¹‰ï¼šä»£ç†æ¨¡å¼æŒ‡ä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ç§ä»£ç†ï¼Œä»¥æ§åˆ¶è¿™ä¸ªå¯¹è±¡çš„è®¿é—®ï¼Œå±äºç»“æ„å‹è®¾è®¡æ¨¡å¼ã€‚å…¶é€‚ç”¨äºåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¸€ä¸ªå¯¹è±¡ä¸é€‚åˆæˆ–è€…ä¸èƒ½ç›´æ¥å¼•ç”¨å¦ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œä»£ç†å¯¹è±¡å¯ä»¥åœ¨å®¢æˆ·ç«¯äºç›®æ ‡å¯¹è±¡ä¹‹é—´èµ·åˆ°ä¸­ä»‹çš„ä½œç”¨ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://xssdpgy.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="æºç åˆ†æ" scheme="https://xssdpgy.github.io/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
    <category term="è®¾è®¡æ¨¡å¼" scheme="https://xssdpgy.github.io/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
    <category term="åŠ¨æ€ä»£ç†" scheme="https://xssdpgy.github.io/tags/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>SpringBootå¼‚æ­¥æ–¹æ³•ä¼˜åŒ–å¤„ç†æé«˜å“åº”é€Ÿåº¦</title>
    <link href="https://xssdpgy.github.io/2022/04/21/SpringBoot%E5%BC%82%E6%AD%A5%E6%96%B9%E6%B3%95%E4%BC%98%E5%8C%96%E5%A4%84%E7%90%86%E6%8F%90%E9%AB%98%E5%93%8D%E5%BA%94%E9%80%9F%E5%BA%A6/"/>
    <id>https://xssdpgy.github.io/2022/04/21/SpringBoot%E5%BC%82%E6%AD%A5%E6%96%B9%E6%B3%95%E4%BC%98%E5%8C%96%E5%A4%84%E7%90%86%E6%8F%90%E9%AB%98%E5%93%8D%E5%BA%94%E9%80%9F%E5%BA%A6/</id>
    <published>2022-04-21T02:48:24.000Z</published>
    <updated>2022-09-11T15:43:16.281Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-å‰è¨€"><a href="#1-å‰è¨€" class="headerlink" title="1.å‰è¨€"></a>1.å‰è¨€</h1><p>æ—¥å¸¸å¼€å‘ä¸­ï¼Œå¯¹äºä¸²è¡ŒåŒ–çš„ä»»åŠ¡é€‚å½“è§£è€¦è€—æ—¶æ“ä½œå’Œä¸šåŠ¡é€»è¾‘ï¼Œåœ¨ä¿è¯ç»“æœå‡†ç¡®æ€§çš„å‰æä¸‹ï¼Œä½¿ç”¨å¼‚æ­¥æ–¹æ³•é€‚å½“è¿›è¡Œå¹¶è¡ŒåŒ–æ”¹é€ ï¼Œå¯ä»¥æé«˜æ¥å£å“åº”é€Ÿåº¦ï¼Œæå‡ä½¿ç”¨ä½“éªŒã€‚</p><p>å¦‚ä¸‹æŠ½è±¡çš„ä¸²è¡ŒåŒ–å·¥ä½œæµç¨‹ï¼š</p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20220421132246323.png"></p><p>ä¸šåŠ¡æŸ¥è¯¢ï¼Œé¦–å…ˆç™»è®°è®°å½•<code>record</code>[cost 3s]ï¼Œä¹‹åä¾æ¬¡æ‰§è¡Œ<code>searchA</code>[cost 1s]ã€<code>searchB</code>[cost 2s]ã€<code>searchC</code>[cost 2s]åˆ†åˆ«å¾—åˆ°å˜é‡aã€bã€cï¼Œè¿”å›ç»“æœ<code>fx(a,b,c)</code>[è®¡ç®—è€—æ—¶å¯å¿½ç•¥ä¸è®°]ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.zang.async.service.AsyncCaseService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"><span class="keyword">import</span> java.time.Instant;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncCaseController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AsyncCaseService asyncCaseService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/search/sync-test&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">syncSearch</span><span class="params">()</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;========test start=========&quot;</span>);</span><br><span class="line">        <span class="type">Instant</span> <span class="variable">start</span> <span class="operator">=</span> Instant.now();</span><br><span class="line">        asyncCaseService.record();</span><br><span class="line">        <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> asyncCaseService.searchA();</span><br><span class="line">        <span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> asyncCaseService.searchB();</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> asyncCaseService.searchC();</span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> a+b+c;</span><br><span class="line">        <span class="type">Instant</span> <span class="variable">end</span> <span class="operator">=</span> Instant.now();</span><br><span class="line">        log.info(<span class="string">&quot;========test end=========cost time is &#123;&#125; seconds&quot;</span>, Duration.between(start,end).getSeconds());</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    Â·Â·Â·</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncCaseServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AsyncCaseService</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">searchA</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);<span class="comment">//æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†è€—æ—¶</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">searchB</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="comment">//å…¶ä»–æ–¹æ³•ç±»ä¼¼</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2022-04-21 13:32:47.739  INFO 22764 --- [nio-8089-exec-2] com.zang.async.web.AsyncCaseController   : ========test start=========</span><br><span class="line">2022-04-21 13:32:55.762  INFO 22764 --- [nio-8089-exec-2] com.zang.async.web.AsyncCaseController   : ========test end=========cost time is 8 seconds</span><br></pre></td></tr></table></figure><p>ç»è¿‡åˆ†æï¼Œå¯ä»¥çœ‹åˆ°ä¸‰ä¸ªæŸ¥è¯¢æ–¹æ³•å¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼Œç­‰å¾…éƒ½äº§ç”Ÿç»“æœæ‰§è¡Œ<code>fx(a,b,c)</code>ï¼Œ<code>record</code>æ–¹æ³•æ‰§è¡Œçš„é¡ºåºå’Œå®Œæˆåº¦ä¸å½±å“ç»“æœçš„è¿”å›ï¼Œå¯ä»¥ä½¿ç”¨å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œã€‚æ”¹é€ é€»è¾‘æŠ½è±¡å¦‚ä¸‹ï¼š</p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20220421134151311.png"></p><p>ä¹‹åå°±ä»£ç å®ç°å±•å¼€é˜è¿°ã€‚</p><h1 id="2-SpringBootä¸­çš„å¼‚æ­¥æ–¹æ³•æ”¯æŒ"><a href="#2-SpringBootä¸­çš„å¼‚æ­¥æ–¹æ³•æ”¯æŒ" class="headerlink" title="2.SpringBootä¸­çš„å¼‚æ­¥æ–¹æ³•æ”¯æŒ"></a>2.SpringBootä¸­çš„å¼‚æ­¥æ–¹æ³•æ”¯æŒ</h1><p>SpringBootå·²ç»æä¾›äº†å¼‚æ­¥æ–¹æ³•æ”¯æŒæ³¨è§£ï¼Œå› æ­¤ä¸éœ€è¦æˆ‘ä»¬è‡ªå·±å»åˆ›å»ºç»´æŠ¤çº¿ç¨‹æˆ–è€…çº¿ç¨‹æ± æ¥å¼‚æ­¥çš„æ‰§è¡Œæ–¹æ³•ã€‚</p><p>ä¸»è¦ä¾é ä¸¤ä¸ªæ³¨è§£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableAsync</span> <span class="comment">// ä½¿ç”¨å¼‚æ­¥æ–¹æ³•æ—¶éœ€è¦æå‰å¼€å¯(åœ¨å¯åŠ¨ç±»ä¸Šæˆ–é…ç½®ç±»ä¸Š)</span></span><br><span class="line"><span class="meta">@Async</span> <span class="comment">// è¢«asyncæ³¨è§£ä¿®é¥°çš„æ–¹æ³•ç”±SpringBooté»˜è®¤çº¿ç¨‹æ± (SimpleAsyncTaskExecutor)æ‰§è¡Œ</span></span><br></pre></td></tr></table></figure><h2 id="2-1-è·å–-æœ‰è¿”å›å€¼-å¼‚æ­¥æ–¹æ³•çš„è¿”å›å€¼"><a href="#2-1-è·å–-æœ‰è¿”å›å€¼-å¼‚æ­¥æ–¹æ³•çš„è¿”å›å€¼" class="headerlink" title="2.1 è·å–(æœ‰è¿”å›å€¼)å¼‚æ­¥æ–¹æ³•çš„è¿”å›å€¼"></a>2.1 è·å–(æœ‰è¿”å›å€¼)å¼‚æ­¥æ–¹æ³•çš„è¿”å›å€¼</h2><p>å¯¹äºæœ‰è¿”å›å€¼çš„å¼‚æ­¥æ–¹æ³•ï¼Œå¯ä½¿ç”¨<code>java.util.concurrent.Future</code>ç±»åŠå…¶å­ç±»æ¥æ¥æ”¶å¼‚æ­¥æ–¹æ³•è¿”å›å€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Async;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.AsyncResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Future;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncCaseServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AsyncCaseService</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Future&lt;Integer&gt; <span class="title function_">searchA</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AsyncResult</span>&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ç•¥</span></span><br></pre></td></tr></table></figure><blockquote><p>æ— è¿”å›å€¼å¼‚æ­¥æ–¹æ³•çš„å¼‚å¸¸æ•è·è§3.3ã€‚</p></blockquote><h2 id="2-2-å¼‚æ­¥ä»»åŠ¡å¹¶è¡Œæ§åˆ¶"><a href="#2-2-å¼‚æ­¥ä»»åŠ¡å¹¶è¡Œæ§åˆ¶" class="headerlink" title="2.2 å¼‚æ­¥ä»»åŠ¡å¹¶è¡Œæ§åˆ¶"></a>2.2 å¼‚æ­¥ä»»åŠ¡å¹¶è¡Œæ§åˆ¶</h2><p>æ¥ä¸ŠèŠ‚ï¼Œåœ¨å¯¹Serviceä¸­æœ‰è¿”å›å€¼çš„æ–¹æ³•è¿›è¡Œå¼‚æ­¥æ”¹é€ çš„åŒæ—¶ï¼Œä¸šåŠ¡å¤„ç†ä¾§éœ€è¦æ·»åŠ å¹¶è¡Œæ§åˆ¶ï¼Œä½¿å¹¶è¡Œçš„å¼‚æ­¥éƒ½è¿”å›ç»“æœæ‰è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">import com.zang.async.service.AsyncCaseService;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line">import javax.annotation.Resource;</span><br><span class="line">import java.time.Duration;</span><br><span class="line">import java.time.Instant;</span><br><span class="line">import java.util.concurrent.Future;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@RestController</span><br><span class="line">public class AsyncCaseController &#123;</span><br><span class="line"></span><br><span class="line">    @Resource</span><br><span class="line">    private AsyncCaseService asyncCaseService;</span><br><span class="line"></span><br><span class="line">    @PostMapping(&quot;/search/async-test&quot;)</span><br><span class="line">    public int asyncSearch() &#123;</span><br><span class="line">        log.info(&quot;========test start=========&quot;);</span><br><span class="line">        Instant start = Instant.now();</span><br><span class="line">        asyncCaseService.record();</span><br><span class="line">        Future&lt;Integer&gt; searchAFuture = asyncCaseService.searchA();</span><br><span class="line">        Future&lt;Integer&gt; searchBFuture = asyncCaseService.searchB();</span><br><span class="line">        Future&lt;Integer&gt; searchCFuture = asyncCaseService.searchC();</span><br><span class="line">        while (true) &#123;</span><br><span class="line">            if (searchAFuture.isDone() &amp;&amp; searchBFuture.isDone() &amp;&amp; searchCFuture.isDone()) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            if (searchAFuture.isCancelled() || searchBFuture.isCancelled() || searchCFuture.isCancelled()) &#123;</span><br><span class="line">                log.info(&quot;async work has cancelled , break&quot;);</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            try &#123;</span><br><span class="line">                Thread.sleep(100);</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        int a = 0, b = 0, c = 0;</span><br><span class="line">        try &#123;</span><br><span class="line">            a = searchAFuture.get();</span><br><span class="line">            b = searchBFuture.get();</span><br><span class="line">            c = searchCFuture.get();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        int result = a + b + c;</span><br><span class="line">        Instant end = Instant.now();</span><br><span class="line">        log.info(&quot;========test end=========cost time is &#123;&#125; seconds&quot;, Duration.between(start, end).getSeconds());</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2022-04-21 14:23:35.486  INFO 19912 --- [nio-8089-exec-4] com.zang.async.web.AsyncCaseController   : ========test start=========</span><br><span class="line">2022-04-21 14:23:37.516  INFO 19912 --- [nio-8089-exec-4] com.zang.async.web.AsyncCaseController   : ========test end=========cost time is 2 seconds</span><br></pre></td></tr></table></figure><h1 id="3-è‡ªå®šä¹‰çº¿ç¨‹æ± æ‰§è¡Œå¼‚æ­¥æ–¹æ³•"><a href="#3-è‡ªå®šä¹‰çº¿ç¨‹æ± æ‰§è¡Œå¼‚æ­¥æ–¹æ³•" class="headerlink" title="3.è‡ªå®šä¹‰çº¿ç¨‹æ± æ‰§è¡Œå¼‚æ­¥æ–¹æ³•"></a>3.è‡ªå®šä¹‰çº¿ç¨‹æ± æ‰§è¡Œå¼‚æ­¥æ–¹æ³•</h1><p><code>@Async</code>ä½¿ç”¨äº†çº¿ç¨‹æ± <code>org.springframework.core.task.SimpleAsyncTaskExecutor</code>æ¥æ‰§è¡Œæˆ‘ä»¬çš„å¼‚æ­¥æ–¹æ³•ï¼Œå®é™…å¼€å‘ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå®šä¹‰è‡ªå·±çš„çº¿ç¨‹æ± ï¼Œä¾¿äºå¯¹çº¿ç¨‹æ± è¿›è¡Œåˆç†é…ç½®ã€‚</p><h2 id="3-1-è‡ªå®šä¹‰çº¿ç¨‹æ± "><a href="#3-1-è‡ªå®šä¹‰çº¿ç¨‹æ± " class="headerlink" title="3.1 è‡ªå®šä¹‰çº¿ç¨‹æ± "></a>3.1 è‡ªå®šä¹‰çº¿ç¨‹æ± </h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.EnableAsync;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executor;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadPoolExecutor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncThreadPoolConfigure</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;asyncThreadPoolTaskExecutor&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Executor <span class="title function_">asyncThreadPoolTaskExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolTaskExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskExecutor</span>();</span><br><span class="line">        executor.setCorePoolSize(<span class="number">4</span>);</span><br><span class="line">        executor.setMaxPoolSize(<span class="number">4</span>);</span><br><span class="line">        executor.setQueueCapacity(<span class="number">10</span>);</span><br><span class="line">        executor.setKeepAliveSeconds(<span class="number">60</span>);</span><br><span class="line">        executor.setThreadNamePrefix(<span class="string">&quot;async-task-executor&quot;</span>);</span><br><span class="line">        executor.setThreadGroupName(<span class="string">&quot;async-task-executor-group&quot;</span>);</span><br><span class="line">        executor.setRejectedExecutionHandler(<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy());</span><br><span class="line">        <span class="comment">// æ‰€æœ‰ä»»åŠ¡ç»“æŸåå…³é—­çº¿ç¨‹æ± </span></span><br><span class="line">        <span class="comment">//executor.setWaitForTasksToCompleteOnShutdown(true);</span></span><br><span class="line">        executor.initialize();</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-2-åœ¨-Asyncæ³¨è§£ä¸ŠæŒ‡å®šæ‰§è¡Œçš„çº¿ç¨‹æ± "><a href="#3-2-åœ¨-Asyncæ³¨è§£ä¸ŠæŒ‡å®šæ‰§è¡Œçš„çº¿ç¨‹æ± " class="headerlink" title="3.2 åœ¨@Asyncæ³¨è§£ä¸ŠæŒ‡å®šæ‰§è¡Œçš„çº¿ç¨‹æ± "></a>3.2 åœ¨@Asyncæ³¨è§£ä¸ŠæŒ‡å®šæ‰§è¡Œçš„çº¿ç¨‹æ± </h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Async(&quot;asyncThreadPoolTaskExecutor&quot;)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Future&lt;Integer&gt; <span class="title function_">searchA</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//ç•¥</span></span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šï¼Œè‡ªå®šä¹‰çº¿ç¨‹æ± æ‰§è¡Œå¼‚æ­¥æ–¹æ³•å³å®Œæˆã€‚</p><h2 id="3-3-è‡ªå®šä¹‰çº¿ç¨‹æ± ç›‘æ§"><a href="#3-3-è‡ªå®šä¹‰çº¿ç¨‹æ± ç›‘æ§" class="headerlink" title="3.3 è‡ªå®šä¹‰çº¿ç¨‹æ± ç›‘æ§"></a>3.3 è‡ªå®šä¹‰çº¿ç¨‹æ± ç›‘æ§</h2><p>è‡ªå®šä¹‰çš„çº¿ç¨‹æ± é…ç½®çš„å‚æ•°æ˜¯å¦åˆç†å¾€å¾€ä½¿äººæ‘¸ä¸ç€å¤´è„‘ï¼Œå®é™…ä¸Šï¼Œçº¿ç¨‹æ± æ‰§è¡Œå™¨<code>org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor</code>ä¸ºSpringè‡ªå¸¦çš„ï¼Œåœ¨æµ‹è¯•ä¸­å¯ä»¥åˆ›å»ºæ–°æ‰§è¡Œå™¨ï¼Œç»§æ‰¿è¯¥æ‰§è¡Œå™¨ï¼Œé‡å†™<code>submit</code>æ–¹æ³•ï¼Œå¯¹å…¶å¢åŠ ç›‘æ§ï¼Œä»è€ŒæŸ¥çœ‹çº¿ç¨‹æ± çŠ¶æ€ï¼Œå¾—åˆ°åˆé€‚çš„çº¿ç¨‹æ± é…ç½®ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MonitorThreadPoolExecutor</span> <span class="keyword">extends</span> <span class="title class_">ThreadPoolTaskExecutor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">monitor</span><span class="params">()</span>&#123;</span><br><span class="line">       log.info(<span class="string">&quot;**** getActiveCount==&#123;&#125;,getPoolSize==&#123;&#125;,getLargestPoolSize==&#123;&#125;,getTaskCount==&#123;&#125;,getCompletedTaskCount==&#123;&#125;,getQueue==&#123;&#125; ***&quot;</span>,<span class="built_in">this</span>.getThreadPoolExecutor().getActiveCount(),<span class="built_in">this</span>.getThreadPoolExecutor().getPoolSize(),<span class="built_in">this</span>.getThreadPoolExecutor().getLargestPoolSize(),<span class="built_in">this</span>.getThreadPoolExecutor().getTaskCount(),<span class="built_in">this</span>.getThreadPoolExecutor().getCompletedTaskCount(),<span class="built_in">this</span>.getThreadPoolExecutor().getQueue().size());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; Future&lt;T&gt; <span class="title function_">submit</span><span class="params">(Callable&lt;T&gt; task)</span> &#123;</span><br><span class="line">        monitor();</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.submit(task);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨3.1è‡ªå®šä¹‰çº¿ç¨‹æ± æ—¶åˆ›å»ºè¯¥ç›‘æ§æ‰§è¡Œå™¨å³å¯ã€‚</p><h2 id="3-3-æ— è¿”å›å€¼å¼‚æ­¥æ–¹æ³•çš„å¼‚å¸¸æ•è·"><a href="#3-3-æ— è¿”å›å€¼å¼‚æ­¥æ–¹æ³•çš„å¼‚å¸¸æ•è·" class="headerlink" title="3.3 æ— è¿”å›å€¼å¼‚æ­¥æ–¹æ³•çš„å¼‚å¸¸æ•è·"></a>3.3 æ— è¿”å›å€¼å¼‚æ­¥æ–¹æ³•çš„å¼‚å¸¸æ•è·</h2><p>ä»¥å®ç°<code>org.springframework.scheduling.annotation.AsyncConfigurer</code>æ¥å£çš„<code>getAsyncExecutor</code>æ–¹æ³•å’Œ<code>getAsyncUncaughtExceptionHandler</code>æ–¹æ³•æ”¹é€ é…ç½®ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.interceptor.AsyncUncaughtExceptionHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.AsyncConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.EnableAsync;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executor;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadPoolExecutor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncThreadPoolConfigure</span> <span class="keyword">implements</span> <span class="title class_">AsyncConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//çº¿ç¨‹æ± åˆ›å»ºæ–¹æ³•ä¸ºé‡å†™ getAsyncExecutor</span></span><br><span class="line">    <span class="meta">@Bean(&quot;asyncThreadPoolTaskExecutor&quot;)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Executor <span class="title function_">getAsyncExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolTaskExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskExecutor</span>();</span><br><span class="line">        executor.setCorePoolSize(<span class="number">4</span>);</span><br><span class="line">        executor.setMaxPoolSize(<span class="number">4</span>);</span><br><span class="line">        executor.setQueueCapacity(<span class="number">10</span>);</span><br><span class="line">        executor.setKeepAliveSeconds(<span class="number">60</span>);</span><br><span class="line">        executor.setThreadNamePrefix(<span class="string">&quot;async-task-executor&quot;</span>);</span><br><span class="line">        executor.setThreadGroupName(<span class="string">&quot;async-task-executor-group&quot;</span>);</span><br><span class="line">        executor.setRejectedExecutionHandler(<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy());</span><br><span class="line">        <span class="comment">// æ‰€æœ‰ä»»åŠ¡ç»“æŸåå…³é—­çº¿ç¨‹æ± </span></span><br><span class="line">        executor.setWaitForTasksToCompleteOnShutdown(<span class="literal">true</span>);</span><br><span class="line">        executor.initialize();</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> AsyncUncaughtExceptionHandler <span class="title function_">getAsyncUncaughtExceptionHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AsyncExceptionHandler</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncExceptionHandler</span> <span class="keyword">implements</span> <span class="title class_">AsyncUncaughtExceptionHandler</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleUncaughtException</span><span class="params">(Throwable throwable, Method method, Object... obj)</span> &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Exception message is &#123;&#125;&quot;</span>, throwable.getMessage());</span><br><span class="line">            log.error(<span class="string">&quot;Method name is &#123;&#125; &quot;</span>, method.getName());</span><br><span class="line">            <span class="keyword">for</span> (Object param : obj) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;Parameter value - &#123;&#125;&quot;</span>, param);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¡¨ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Async(&quot;asyncThreadPoolTaskExecutor&quot;)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">record</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">            log.info(<span class="string">&quot;current thread name is &#123;&#125;&quot;</span>,Thread.currentThread().getName());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;network not connect &quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ§åˆ¶å°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2022-04-21 15:34:14.931  INFO 16596 --- [nio-8089-exec-1] com.zang.async.web.AsyncCaseController   : ========test start=========</span><br><span class="line">2022-04-21 15:34:16.965  INFO 16596 --- [nio-8089-exec-1] com.zang.async.web.AsyncCaseController   : ========test end=========cost time is 2 seconds</span><br><span class="line">2022-04-21 15:34:17.939  INFO 16596 --- [-task-executor1] c.z.async.service.AsyncCaseServiceImpl   : current thread name is async-task-executor1</span><br><span class="line">2022-04-21 15:34:17.940 ERROR 16596 --- [-task-executor1] c.z.a.c.AsyncThreadPoolConfigure         : Exception message is network not connect </span><br><span class="line">2022-04-21 15:34:17.941 ERROR 16596 --- [-task-executor1] c.z.a.c.AsyncThreadPoolConfigure         : Method name is record </span><br></pre></td></tr></table></figure><h1 id="4-ä¸€äº›æ€è€ƒ"><a href="#4-ä¸€äº›æ€è€ƒ" class="headerlink" title="4.ä¸€äº›æ€è€ƒ"></a>4.ä¸€äº›æ€è€ƒ</h1><p>å¼‚æ­¥æ–¹æ³•çš„é›†æˆæä¸ºæ–¹ä¾¿ï¼Œå¯ä»¥æœ‰æ•ˆæé«˜æ¥å£å“åº”é€Ÿåº¦ï¼Œä½†æ˜¯ä½¿ç”¨è¿‡ç¨‹ä¸­è¦æ³¨æ„åˆç†çš„åˆ†æä¸šåŠ¡é€»è¾‘åŠæœåŠ¡å™¨èµ„æºæ‰¿è½½èƒ½åŠ›ï¼Œä¸å¯æ»¥ç”¨ã€‚</p><p>å¯¹äºå¼ºä¸€è‡´æ€§çš„ä¸šåŠ¡ï¼Œéœ€è¦æ³¨æ„ï¼Œå¼‚æ­¥æ–¹æ³•æ‰§è¡Œå¤±è´¥å¯¹äºå‰éƒ¨åˆ†çš„å·²æ‰§è¡Œçš„éå¼‚æ­¥æ“ä½œæ˜¯æ— å½±å“çš„ï¼Œå› æ­¤åœ¨è¯¥åœºæ™¯å¼‚æ­¥å¹¶ä¸å¯é ï¼›</p><p>æ­¤å¤–ï¼Œå¯¹äºå¹¶å‘é‡è¿‡å¤§çš„ä»»åŠ¡ï¼Œå¼‚æ­¥çº¿ç¨‹æ± çš„é˜Ÿåˆ—ç¼“å­˜ä¹Ÿè¾ƒä¸ºæ¶ˆè€—æœåŠ¡å™¨èµ„æºï¼Œéœ€è¦åˆç†è§„åˆ’ï¼Œå¿…è¦æ—¶å»ºè®®é‡‡ç”¨æ›´ä¸ºå¯é çš„æ¶ˆæ¯é˜Ÿåˆ—ç­‰ä¸­é—´ä»¶ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;1-å‰è¨€&quot;&gt;&lt;a href=&quot;#1-å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;1.å‰è¨€&quot;&gt;&lt;/a&gt;1.å‰è¨€&lt;/h1&gt;&lt;p&gt;æ—¥å¸¸å¼€å‘ä¸­ï¼Œå¯¹äºä¸²è¡ŒåŒ–çš„ä»»åŠ¡é€‚å½“è§£è€¦è€—æ—¶æ“ä½œå’Œä¸šåŠ¡é€»è¾‘ï¼Œåœ¨ä¿è¯ç»“æœå‡†ç¡®æ€§çš„å‰æä¸‹ï¼Œä½¿ç”¨å¼‚æ­¥æ–¹æ³•é€‚å½“è¿›è¡Œå¹¶è¡ŒåŒ–æ”¹é€ ï¼Œå¯ä»¥æé«˜æ¥å£å“åº”é€Ÿåº¦ï¼Œæå‡ä½¿ç”¨ä½“éªŒã€‚&lt;/p&gt;
&lt;p&gt;å¦‚ä¸‹æŠ½è±¡çš„ä¸²è¡ŒåŒ–å·¥ä½œæµç¨‹ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20220421132246323.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;ä¸šåŠ¡æŸ¥è¯¢ï¼Œé¦–å…ˆç™»è®°è®°å½•&lt;code&gt;record&lt;/code&gt;[cost 3s]ï¼Œä¹‹åä¾æ¬¡æ‰§è¡Œ&lt;code&gt;searchA&lt;/code&gt;[cost 1s]ã€&lt;code&gt;searchB&lt;/code&gt;[cost 2s]ã€&lt;code&gt;searchC&lt;/code&gt;[cost 2s]åˆ†åˆ«å¾—åˆ°å˜é‡aã€bã€cï¼Œè¿”å›ç»“æœ&lt;code&gt;fx(a,b,c)&lt;/code&gt;[è®¡ç®—è€—æ—¶å¯å¿½ç•¥ä¸è®°]ã€‚ä»£ç å¦‚ä¸‹ï¼š&lt;/p&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://xssdpgy.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="å¼‚æ­¥" scheme="https://xssdpgy.github.io/tags/%E5%BC%82%E6%AD%A5/"/>
    
    <category term="ä¼˜åŒ–" scheme="https://xssdpgy.github.io/tags/%E4%BC%98%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>äºŒè¿›åˆ¶æ–¹å¼å®‰è£…k8sé›†ç¾¤</title>
    <link href="https://xssdpgy.github.io/2022/03/30/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%B9%E5%BC%8F%E5%AE%89%E8%A3%85k8s%E9%9B%86%E7%BE%A4/"/>
    <id>https://xssdpgy.github.io/2022/03/30/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%B9%E5%BC%8F%E5%AE%89%E8%A3%85k8s%E9%9B%86%E7%BE%A4/</id>
    <published>2022-03-30T07:51:45.000Z</published>
    <updated>2022-09-11T15:43:16.282Z</updated>
    
    <content type="html"><![CDATA[<p>ä½¿ç”¨ä¸‰å°æœåŠ¡å™¨æ­å»ºk8sé›†ç¾¤ï¼Œé›†ç¾¤æœåŠ¡å™¨åœ°å€è§„åˆ’å¦‚ä¸‹ï¼š</p><span id="more"></span><table><thead><tr><th>IP</th><th>hostname</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td>192.168.206.128</td><td>master</td><td>ä¸»èŠ‚ç‚¹</td></tr><tr><td>192.168.206.129</td><td>node1</td><td>ä»èŠ‚ç‚¹</td></tr><tr><td>192.168.206.130</td><td>node2</td><td>ä»èŠ‚ç‚¹</td></tr></tbody></table><h1 id="1-ç¯å¢ƒé…ç½®"><a href="#1-ç¯å¢ƒé…ç½®" class="headerlink" title="1.ç¯å¢ƒé…ç½®"></a>1.ç¯å¢ƒé…ç½®</h1><h2 id="1-1-ä¿®æ”¹ä¸»æœºå"><a href="#1-1-ä¿®æ”¹ä¸»æœºå" class="headerlink" title="1.1 ä¿®æ”¹ä¸»æœºå"></a>1.1 ä¿®æ”¹ä¸»æœºå</h2><p>master:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname master</span><br></pre></td></tr></table></figure><p>node1:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname node1</span><br></pre></td></tr></table></figure><p>node2:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname</span><br></pre></td></tr></table></figure><h2 id="1-2-å…³é—­é˜²ç«å¢™ï¼ˆallï¼‰"><a href="#1-2-å…³é—­é˜²ç«å¢™ï¼ˆallï¼‰" class="headerlink" title="1.2 å…³é—­é˜²ç«å¢™ï¼ˆallï¼‰"></a>1.2 å…³é—­é˜²ç«å¢™ï¼ˆallï¼‰</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br></pre></td></tr></table></figure><h2 id="1-3-å…³é—­selinuxï¼ˆallï¼‰"><a href="#1-3-å…³é—­selinuxï¼ˆallï¼‰" class="headerlink" title="1.3 å…³é—­selinuxï¼ˆallï¼‰"></a>1.3 å…³é—­selinuxï¼ˆallï¼‰</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0 # ä¸´æ—¶å…³é—­</span><br><span class="line">sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config # æ°¸ä¹…å…³é—­</span><br></pre></td></tr></table></figure><h2 id="1-4-å…³é—­swapï¼ˆallï¼‰"><a href="#1-4-å…³é—­swapï¼ˆallï¼‰" class="headerlink" title="1.4 å…³é—­swapï¼ˆallï¼‰"></a>1.4 å…³é—­swapï¼ˆallï¼‰</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a <span class="comment"># ä¸´æ—¶å…³é—­ï¼›å…³é—­swapä¸»è¦æ˜¯ä¸ºäº†æ€§èƒ½è€ƒè™‘</span></span><br><span class="line">sed -ri <span class="string">&#x27;s/.*swap.*/#&amp;/&#x27;</span> /etc/fstab</span><br><span class="line">free <span class="comment"># æŸ¥çœ‹å†…å­˜ï¼Œswapä¸º0åˆ™ä¸ºå…³é—­</span></span><br></pre></td></tr></table></figure><h2 id="1-5-å°†æ¡¥æ¥çš„IPv4æµé‡ä¼ é€’åˆ°iptablesçš„é“¾ï¼ˆallï¼‰"><a href="#1-5-å°†æ¡¥æ¥çš„IPv4æµé‡ä¼ é€’åˆ°iptablesçš„é“¾ï¼ˆallï¼‰" class="headerlink" title="1.5 å°†æ¡¥æ¥çš„IPv4æµé‡ä¼ é€’åˆ°iptablesçš„é“¾ï¼ˆallï¼‰"></a>1.5 å°†æ¡¥æ¥çš„IPv4æµé‡ä¼ é€’åˆ°iptablesçš„é“¾ï¼ˆallï¼‰</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl --system</span><br></pre></td></tr></table></figure><h2 id="1-6-æ·»åŠ ä¸»æœºåä¸IPå¯¹åº”çš„å…³ç³»-master"><a href="#1-6-æ·»åŠ ä¸»æœºåä¸IPå¯¹åº”çš„å…³ç³»-master" class="headerlink" title="1.6 æ·»åŠ ä¸»æœºåä¸IPå¯¹åº”çš„å…³ç³» ( master )"></a>1.6 æ·»åŠ ä¸»æœºåä¸IPå¯¹åº”çš„å…³ç³» ( master )</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; EOF </span><br><span class="line">192.168.206.128 master</span><br><span class="line">192.168.206.129 node1</span><br><span class="line">192.168.206.130 node2</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h1 id="2-å‡†å¤‡-cfssl-è¯ä¹¦ç”Ÿæˆå·¥å…·-master"><a href="#2-å‡†å¤‡-cfssl-è¯ä¹¦ç”Ÿæˆå·¥å…·-master" class="headerlink" title="2.å‡†å¤‡ cfssl è¯ä¹¦ç”Ÿæˆå·¥å…· ( master )"></a>2.å‡†å¤‡ cfssl è¯ä¹¦ç”Ÿæˆå·¥å…· ( master )</h1><p>cfssl æ˜¯ä¸€ä¸ªå¼€æºçš„è¯ä¹¦ç®¡ç†å·¥å…·ï¼Œä½¿ç”¨ json æ–‡ä»¶ç”Ÿæˆè¯ä¹¦ï¼Œç›¸æ¯” openssl æ›´æ–¹ä¾¿ä½¿ç”¨ã€‚ æ‰¾ä»»æ„ä¸€å°æœåŠ¡å™¨æ“ä½œï¼Œè¿™é‡Œç”¨ Master èŠ‚ç‚¹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span><br><span class="line">chmod +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64</span><br><span class="line">mv cfssl_linux-amd64 /usr/local/bin/cfssl</span><br><span class="line">mv cfssljson_linux-amd64 /usr/local/bin/cfssljson</span><br><span class="line">mv cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo</span><br><span class="line">chmod +x /usr/bin/cfssl*</span><br></pre></td></tr></table></figure><h2 id="2-1-ç”Ÿæˆ-Etcd-è¯ä¹¦-ï¼ˆ1ï¼‰è‡ªç­¾è¯ä¹¦é¢å‘æœºæ„ï¼ˆCAï¼‰-åˆ›å»ºå·¥ä½œç›®å½•"><a href="#2-1-ç”Ÿæˆ-Etcd-è¯ä¹¦-ï¼ˆ1ï¼‰è‡ªç­¾è¯ä¹¦é¢å‘æœºæ„ï¼ˆCAï¼‰-åˆ›å»ºå·¥ä½œç›®å½•" class="headerlink" title="2.1 ç”Ÿæˆ Etcd è¯ä¹¦ ï¼ˆ1ï¼‰è‡ªç­¾è¯ä¹¦é¢å‘æœºæ„ï¼ˆCAï¼‰ åˆ›å»ºå·¥ä½œç›®å½•"></a>2.1 ç”Ÿæˆ Etcd è¯ä¹¦ ï¼ˆ1ï¼‰è‡ªç­¾è¯ä¹¦é¢å‘æœºæ„ï¼ˆCAï¼‰ åˆ›å»ºå·¥ä½œç›®å½•</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ~/TLS/&#123;etcd,k8s&#125;</span><br><span class="line"></span><br><span class="line">cd TLS/etcd</span><br></pre></td></tr></table></figure><h2 id="2-2-è‡ªç­¾CA"><a href="#2-2-è‡ªç­¾CA" class="headerlink" title="2.2 è‡ªç­¾CA"></a>2.2 è‡ªç­¾CA</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ca-config.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;signing&quot;: &#123;</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">      &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;profiles&quot;: &#123;</span><br><span class="line">      &quot;www&quot;: &#123;</span><br><span class="line">         &quot;expiry&quot;: &quot;87600h&quot;,</span><br><span class="line">         &quot;usages&quot;: [</span><br><span class="line">            &quot;signing&quot;,</span><br><span class="line">            &quot;key encipherment&quot;,</span><br><span class="line">            &quot;server auth&quot;,</span><br><span class="line">            &quot;client auth&quot;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ca-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;etcd CA&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Beijing&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="2-3-ç”ŸæˆCAè¯ä¹¦"><a href="#2-3-ç”ŸæˆCAè¯ä¹¦" class="headerlink" title="2.3 ç”ŸæˆCAè¯ä¹¦"></a>2.3 ç”ŸæˆCAè¯ä¹¦</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master etcd]# ls ca*pem  #æŸ¥çœ‹</span><br><span class="line">ca-key.pem  ca.pem</span><br></pre></td></tr></table></figure><h2 id="2-4-ä½¿ç”¨è‡ªç­¾-CA-ç­¾å‘-Etcd-HTTPS-è¯ä¹¦-åˆ›å»ºè¯ä¹¦ç”³è¯·æ–‡ä»¶ï¼š-ä¿®æ”¹å¯¹åº”çš„masterå’Œnodeçš„IPåœ°å€"><a href="#2-4-ä½¿ç”¨è‡ªç­¾-CA-ç­¾å‘-Etcd-HTTPS-è¯ä¹¦-åˆ›å»ºè¯ä¹¦ç”³è¯·æ–‡ä»¶ï¼š-ä¿®æ”¹å¯¹åº”çš„masterå’Œnodeçš„IPåœ°å€" class="headerlink" title="2.4 ä½¿ç”¨è‡ªç­¾ CA ç­¾å‘ Etcd HTTPS è¯ä¹¦ åˆ›å»ºè¯ä¹¦ç”³è¯·æ–‡ä»¶ï¼š(ä¿®æ”¹å¯¹åº”çš„masterå’Œnodeçš„IPåœ°å€)"></a>2.4 ä½¿ç”¨è‡ªç­¾ CA ç­¾å‘ Etcd HTTPS è¯ä¹¦ åˆ›å»ºè¯ä¹¦ç”³è¯·æ–‡ä»¶ï¼š(ä¿®æ”¹å¯¹åº”çš„masterå’Œnodeçš„IPåœ°å€)</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; server-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;etcd&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">    &quot;192.168.206.128&quot;,</span><br><span class="line">    &quot;192.168.206.129&quot;,</span><br><span class="line">    &quot;192.168.206.130&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;BeiJing&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="2-5-ç”ŸæˆSERVERè¯ä¹¦"><a href="#2-5-ç”ŸæˆSERVERè¯ä¹¦" class="headerlink" title="2.5 ç”ŸæˆSERVERè¯ä¹¦"></a>2.5 ç”ŸæˆSERVERè¯ä¹¦</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www server-csr.json | cfssljson -bare server</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master etcd]# ls server*pem  #æŸ¥çœ‹</span><br><span class="line">server-key.pem  server.pem</span><br></pre></td></tr></table></figure><h1 id="3-éƒ¨ç½²etcdé›†ç¾¤"><a href="#3-éƒ¨ç½²etcdé›†ç¾¤" class="headerlink" title="3.éƒ¨ç½²etcdé›†ç¾¤"></a>3.éƒ¨ç½²etcdé›†ç¾¤</h1><h2 id="3-1-ä¸‹è½½"><a href="#3-1-ä¸‹è½½" class="headerlink" title="3.1 ä¸‹è½½"></a>3.1 ä¸‹è½½</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ä¸‹è½½åœ°å€ï¼šhttps://github.com/etcd-io/etcd/releases</span><br><span class="line">ç‰ˆæœ¬ï¼š3.4.14</span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹åœ¨master ä¸Šæ“ä½œï¼Œä¸ºç®€åŒ–æ“ä½œï¼Œå®Œæˆåå°†master ç”Ÿæˆçš„æ‰€æœ‰æ–‡ä»¶æ‹·è´åˆ°node1 å’Œnode2ã€‚</p><h2 id="3-2-åˆ›å»ºå·¥ä½œç›®å½•å¹¶è§£å‹äºŒè¿›åˆ¶åŒ…"><a href="#3-2-åˆ›å»ºå·¥ä½œç›®å½•å¹¶è§£å‹äºŒè¿›åˆ¶åŒ…" class="headerlink" title="3.2 åˆ›å»ºå·¥ä½œç›®å½•å¹¶è§£å‹äºŒè¿›åˆ¶åŒ…"></a>3.2 åˆ›å»ºå·¥ä½œç›®å½•å¹¶è§£å‹äºŒè¿›åˆ¶åŒ…</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir /opt/etcd/&#123;bin,cfg,ssl&#125; -p</span><br><span class="line">tar zxvf etcd-v3.4.14-linux-amd64.tar.gz</span><br><span class="line">mv etcd-v3.4.14-linux-amd64/&#123;etcd,etcdctl&#125; /opt/etcd/bin/</span><br></pre></td></tr></table></figure><h2 id="3-3-åˆ›å»ºetcd-conf"><a href="#3-3-åˆ›å»ºetcd-conf" class="headerlink" title="3.3 åˆ›å»ºetcd.conf"></a>3.3 åˆ›å»ºetcd.conf</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/etcd/cfg/etcd.conf &lt;&lt; EOF</span><br><span class="line">#[Member]</span><br><span class="line">ETCD_NAME=&quot;etcd-1&quot;</span><br><span class="line">ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;</span><br><span class="line">ETCD_LISTEN_PEER_URLS=&quot;https://192.168.206.128:2380&quot;</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.206.128:2379&quot;</span><br><span class="line">#[Clustering]</span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.206.128:2380&quot;</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.206.128:2379&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER=&quot;etcd-1=https://192.168.206.128:2380,etcd-2=https://192.168.206.129:2380,etcd-3=https://192.168.206.130:2380&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li>ETCD_NAMEï¼šèŠ‚ç‚¹åç§°ï¼Œé›†ç¾¤ä¸­å”¯ä¸€</li><li>ETCD_DATA_DIRï¼šæ•°æ®ç›®å½•</li><li>ETCD_LISTEN_PEER_URLSï¼šé›†ç¾¤é€šä¿¡ç›‘å¬åœ°å€</li><li>ETCD_LISTEN_CLIENT_URLSï¼šå®¢æˆ·ç«¯è®¿é—®ç›‘å¬åœ°å€</li><li>ETCD_INITIAL_ADVERTISE_PEER_URLSï¼šé›†ç¾¤é€šå‘Šåœ°å€</li><li>ETCD_ADVERTISE_CLIENT_URLSï¼šå®¢æˆ·ç«¯é€šå‘Šåœ°å€</li><li>ETCD_INITIAL_CLUSTERï¼šé›†ç¾¤èŠ‚ç‚¹åœ°å€</li><li>ETCD_INITIAL_CLUSTER_TOKENï¼šé›†ç¾¤ Token</li><li>ETCD_INITIAL_CLUSTER_STATEï¼šåŠ å…¥é›†ç¾¤çš„å½“å‰çŠ¶æ€ï¼Œnew æ˜¯æ–°é›†ç¾¤ï¼Œexisting è¡¨ç¤ºåŠ å…¥ å·²æœ‰é›†ç¾¤</li></ul><h2 id="3-4-åˆ›å»ºetcd-service"><a href="#3-4-åˆ›å»ºetcd-service" class="headerlink" title="3.4 åˆ›å»ºetcd.service"></a>3.4 åˆ›å»ºetcd.service</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/etcd.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/opt/etcd/cfg/etcd.conf</span><br><span class="line">ExecStart=/opt/etcd/bin/etcd \</span><br><span class="line">--cert-file=/opt/etcd/ssl/server.pem \</span><br><span class="line">--key-file=/opt/etcd/ssl/server-key.pem \</span><br><span class="line">--peer-cert-file=/opt/etcd/ssl/server.pem \</span><br><span class="line">--peer-key-file=/opt/etcd/ssl/server-key.pem \</span><br><span class="line">--trusted-ca-file=/opt/etcd/ssl/ca.pem \</span><br><span class="line">--peer-trusted-ca-file=/opt/etcd/ssl/ca.pem \</span><br><span class="line">--logger=zap</span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="3-5-æ‹·è´ä¸Šä¸€æ­¥ç”Ÿæˆçš„è¯ä¹¦åˆ°é…ç½®è·¯å¾„"><a href="#3-5-æ‹·è´ä¸Šä¸€æ­¥ç”Ÿæˆçš„è¯ä¹¦åˆ°é…ç½®è·¯å¾„" class="headerlink" title="3.5 æ‹·è´ä¸Šä¸€æ­¥ç”Ÿæˆçš„è¯ä¹¦åˆ°é…ç½®è·¯å¾„"></a>3.5 æ‹·è´ä¸Šä¸€æ­¥ç”Ÿæˆçš„è¯ä¹¦åˆ°é…ç½®è·¯å¾„</h2> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp ~/TLS/etcd/ca*pem ~/TLS/etcd/server*pem /opt/etcd/ssl/</span><br></pre></td></tr></table></figure><h2 id="3-6-å°†master-ç”Ÿæˆçš„æ‰€æœ‰æ–‡ä»¶æ‹·è´åˆ°node1-å’Œnode2"><a href="#3-6-å°†master-ç”Ÿæˆçš„æ‰€æœ‰æ–‡ä»¶æ‹·è´åˆ°node1-å’Œnode2" class="headerlink" title="3.6 å°†master ç”Ÿæˆçš„æ‰€æœ‰æ–‡ä»¶æ‹·è´åˆ°node1 å’Œnode2"></a>3.6 å°†master ç”Ÿæˆçš„æ‰€æœ‰æ–‡ä»¶æ‹·è´åˆ°node1 å’Œnode2</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">scp -r /opt/etcd/ root@192.168.206.129:/opt/</span><br><span class="line">scp /usr/lib/systemd/system/etcd.service root@192.168.206.129:/usr/lib/systemd/system/</span><br><span class="line"></span><br><span class="line">scp -r /opt/etcd/ root@192.168.206.130:/opt/</span><br><span class="line">scp /usr/lib/systemd/system/etcd.service root@192.168.206.130:/usr/lib/systemd/system/</span><br></pre></td></tr></table></figure><p>åˆ†åˆ«ä¿®æ”¹ etcd.conf é…ç½®æ–‡ä»¶ä¸­çš„èŠ‚ç‚¹åç§°å’Œå½“å‰æœåŠ¡å™¨ IPï¼š(node1æ”¹ä¸º <code>etcd-2</code>ï¼Œnode2 æ”¹ä¸º <code>etcd-3</code>)</p><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20220308200928926.png"></p><h2 id="3-7-å¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨"><a href="#3-7-å¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨" class="headerlink" title="3.7 å¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨"></a>3.7 å¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># ä¸‰å°åŒæ—¶æ‰§è¡Œ</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start etcd</span><br><span class="line">systemctl enable etcd</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹çŠ¶æ€ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/opt/etcd/bin/etcdctl --cacert=/opt/etcd/ssl/ca.pem --cert=/opt/etcd/ssl/server.pem --key=/opt/etcd/ssl/server-key.pem --endpoints=&quot;https://192.168.206.128:2379,https://192.168.206.129:2379,https://192.168.206.130:2379&quot; endpoint health</span><br><span class="line">#å¯è§†åŒ–å±•ç¤º</span><br><span class="line">/opt/etcd/bin/etcdctl --cacert=/opt/etcd/ssl/ca.pem --cert=/opt/etcd/ssl/server.pem --key=/opt/etcd/ssl/server-key.pem --endpoints=&quot;https://192.168.206.128:2379,https://192.168.206.129:2379,https://192.168.206.130:2379&quot; endpoint status --write-out=table</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20220308201633156.png"></p><h1 id="4-å®‰è£…dockerï¼ˆallï¼‰"><a href="#4-å®‰è£…dockerï¼ˆallï¼‰" class="headerlink" title="4.å®‰è£…dockerï¼ˆallï¼‰"></a>4.å®‰è£…dockerï¼ˆallï¼‰</h1><h2 id="4-1-ä¸‹è½½"><a href="#4-1-ä¸‹è½½" class="headerlink" title="4.1 ä¸‹è½½"></a>4.1 ä¸‹è½½</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ä¸‹è½½åœ°å€ï¼šhttps://download.docker.com/linux/static/stable/x86_64/</span><br><span class="line">ç‰ˆæœ¬ï¼š19.03.9</span><br></pre></td></tr></table></figure><h2 id="4-2-è§£å‹åŠå®‰è£…"><a href="#4-2-è§£å‹åŠå®‰è£…" class="headerlink" title="4.2 è§£å‹åŠå®‰è£…"></a>4.2 è§£å‹åŠå®‰è£…</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf docker-19.03.9.tgz </span><br><span class="line">mv docker/* /usr/bin</span><br></pre></td></tr></table></figure><h2 id="4-3-systemd-ç®¡ç†-docker"><a href="#4-3-systemd-ç®¡ç†-docker" class="headerlink" title="4.3 systemd ç®¡ç† docker"></a>4.3 systemd ç®¡ç† docker</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/docker.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">After=network-online.target firewalld.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/bin/dockerd</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=on-failure</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="4-4-é…ç½®é˜¿é‡Œäº‘åŠ é€Ÿ"><a href="#4-4-é…ç½®é˜¿é‡Œäº‘åŠ é€Ÿ" class="headerlink" title="4.4 é…ç½®é˜¿é‡Œäº‘åŠ é€Ÿ"></a>4.4 é…ç½®é˜¿é‡Œäº‘åŠ é€Ÿ</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/docker</span><br><span class="line">cat &gt; /etc/docker/daemon.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://b9pmyelo.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="4-5-å¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨"><a href="#4-5-å¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨" class="headerlink" title="4.5 å¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨"></a>4.5 å¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl enable docker</span><br></pre></td></tr></table></figure><h2 id="4-6-æŸ¥è¯¢æ˜¯å¦å®‰è£…æˆåŠŸ"><a href="#4-6-æŸ¥è¯¢æ˜¯å¦å®‰è£…æˆåŠŸ" class="headerlink" title="4.6 æŸ¥è¯¢æ˜¯å¦å®‰è£…æˆåŠŸ"></a>4.6 æŸ¥è¯¢æ˜¯å¦å®‰è£…æˆåŠŸ</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master etcd]# docker -v</span><br><span class="line">Docker version 19.03.9, build 9d988398e7</span><br></pre></td></tr></table></figure><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20220308202432364.png"></p><h1 id="5-éƒ¨ç½²Master-Nodeï¼ˆmasterï¼‰"><a href="#5-éƒ¨ç½²Master-Nodeï¼ˆmasterï¼‰" class="headerlink" title="5.éƒ¨ç½²Master Nodeï¼ˆmasterï¼‰"></a>5.éƒ¨ç½²Master Nodeï¼ˆmasterï¼‰</h1><h2 id="5-1-ç”Ÿæˆ-kube-apiserver-è¯ä¹¦-è‡ªç­¾è¯ä¹¦é¢å‘æœºæ„ï¼ˆCAï¼‰"><a href="#5-1-ç”Ÿæˆ-kube-apiserver-è¯ä¹¦-è‡ªç­¾è¯ä¹¦é¢å‘æœºæ„ï¼ˆCAï¼‰" class="headerlink" title="5.1 ç”Ÿæˆ kube-apiserver è¯ä¹¦ è‡ªç­¾è¯ä¹¦é¢å‘æœºæ„ï¼ˆCAï¼‰"></a>5.1 ç”Ÿæˆ kube-apiserver è¯ä¹¦ è‡ªç­¾è¯ä¹¦é¢å‘æœºæ„ï¼ˆCAï¼‰</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd TLS/k8s</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ca-config.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;signing&quot;: &#123;</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">      &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;profiles&quot;: &#123;</span><br><span class="line">      &quot;kubernetes&quot;: &#123;</span><br><span class="line">         &quot;expiry&quot;: &quot;87600h&quot;,</span><br><span class="line">         &quot;usages&quot;: [</span><br><span class="line">            &quot;signing&quot;,</span><br><span class="line">            &quot;key encipherment&quot;,</span><br><span class="line">            &quot;server auth&quot;,</span><br><span class="line">            &quot;client auth&quot;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ca-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="5-2-ç”ŸæˆCAè¯ä¹¦"><a href="#5-2-ç”ŸæˆCAè¯ä¹¦" class="headerlink" title="5.2 ç”ŸæˆCAè¯ä¹¦"></a>5.2 ç”ŸæˆCAè¯ä¹¦</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master k8s]# ls ca*pem  #æŸ¥çœ‹</span><br><span class="line">ca-key.pem  ca.pem</span><br></pre></td></tr></table></figure><h2 id="5-3-ä½¿ç”¨è‡ªç­¾-CA-ç­¾å‘-kube-apiserver-HTTPS-è¯ä¹¦-åˆ›å»ºè¯ä¹¦ç”³è¯·æ–‡ä»¶"><a href="#5-3-ä½¿ç”¨è‡ªç­¾-CA-ç­¾å‘-kube-apiserver-HTTPS-è¯ä¹¦-åˆ›å»ºè¯ä¹¦ç”³è¯·æ–‡ä»¶" class="headerlink" title="5.3 ä½¿ç”¨è‡ªç­¾ CA ç­¾å‘ kube-apiserver HTTPS è¯ä¹¦ åˆ›å»ºè¯ä¹¦ç”³è¯·æ–‡ä»¶"></a>5.3 ä½¿ç”¨è‡ªç­¾ CA ç­¾å‘ kube-apiserver HTTPS è¯ä¹¦ åˆ›å»ºè¯ä¹¦ç”³è¯·æ–‡ä»¶</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; server-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">      &quot;10.0.0.1&quot;,</span><br><span class="line">      &quot;127.0.0.1&quot;,</span><br><span class="line">      &quot;192.168.206.128&quot;,</span><br><span class="line">      &quot;192.168.206.129&quot;,</span><br><span class="line">      &quot;192.168.206.130&quot;,</span><br><span class="line">      &quot;192.168.206.131&quot;,</span><br><span class="line">      &quot;kubernetes&quot;,</span><br><span class="line">      &quot;kubernetes.default&quot;,</span><br><span class="line">      &quot;kubernetes.default.svc&quot;,</span><br><span class="line">      &quot;kubernetes.default.svc.cluster&quot;,</span><br><span class="line">      &quot;kubernetes.default.svc.cluster.local&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>æ³¨ï¼š192.168.206.131ä¸ºé¢„ç•™å‡ºçš„IPã€‚</p><h2 id="5-4-ç”ŸæˆSERVERè¯ä¹¦"><a href="#5-4-ç”ŸæˆSERVERè¯ä¹¦" class="headerlink" title="5.4 ç”ŸæˆSERVERè¯ä¹¦"></a>5.4 ç”ŸæˆSERVERè¯ä¹¦</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes server-csr.json | cfssljson -bare server</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master k8s]# ls server*pem  #æŸ¥çœ‹</span><br><span class="line">server-key.pem  server.pem</span><br></pre></td></tr></table></figure><h2 id="5-5-ä¸‹è½½k8så®‰è£…åŒ…å¹¶è§£å‹"><a href="#5-5-ä¸‹è½½k8så®‰è£…åŒ…å¹¶è§£å‹" class="headerlink" title="5.5 ä¸‹è½½k8så®‰è£…åŒ…å¹¶è§£å‹"></a>5.5 ä¸‹è½½k8så®‰è£…åŒ…å¹¶è§£å‹</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ä¸‹è½½åœ°å€ï¼šhttps://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.18.md#server-binaries</span><br><span class="line">ç‰ˆæœ¬ï¼š1.18.20 (å‹ç¼©åŒ…åï¼škubernetes-server-linux-amd64.tar.gz)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/kubernetes/&#123;bin,cfg,ssl,logs&#125;</span><br><span class="line">tar zxvf kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">cd kubernetes/server/bin</span><br><span class="line">cp kube-apiserver kube-scheduler kube-controller-manager /opt/kubernetes/bin</span><br><span class="line">cp kubectl /usr/bin/</span><br></pre></td></tr></table></figure><h2 id="5-6-éƒ¨ç½²kube-apiserver"><a href="#5-6-éƒ¨ç½²kube-apiserver" class="headerlink" title="5.6 éƒ¨ç½²kube-apiserver"></a>5.6 éƒ¨ç½²kube-apiserver</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/kube-apiserver.conf &lt;&lt; EOF</span><br><span class="line">KUBE_APISERVER_OPTS=&quot;--logtostderr=false \\</span><br><span class="line">--v=2 \\</span><br><span class="line">--log-dir=/opt/kubernetes/logs \\</span><br><span class="line">--etcd-servers=https://192.168.206.128:2379,https://192.168.206.129:2379,https://192.168.206.130:2379 \\</span><br><span class="line">--bind-address=192.168.206.128 \\</span><br><span class="line">--secure-port=6443 \\</span><br><span class="line">--advertise-address=192.168.206.128 \\</span><br><span class="line">--allow-privileged=true \\</span><br><span class="line">--service-cluster-ip-range=10.0.0.0/24 \\</span><br><span class="line">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \\</span><br><span class="line">--authorization-mode=RBAC,Node \\</span><br><span class="line">--enable-bootstrap-token-auth=true \\</span><br><span class="line">--token-auth-file=/opt/kubernetes/cfg/token.csv \\</span><br><span class="line">--service-node-port-range=30000-32767 \\</span><br><span class="line">--kubelet-client-certificate=/opt/kubernetes/ssl/server.pem \\</span><br><span class="line">--kubelet-client-key=/opt/kubernetes/ssl/server-key.pem \\</span><br><span class="line">--tls-cert-file=/opt/kubernetes/ssl/server.pem  \\</span><br><span class="line">--tls-private-key-file=/opt/kubernetes/ssl/server-key.pem \\</span><br><span class="line">--client-ca-file=/opt/kubernetes/ssl/ca.pem \\</span><br><span class="line">--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \\</span><br><span class="line">--etcd-cafile=/opt/etcd/ssl/ca.pem \\</span><br><span class="line">--etcd-certfile=/opt/etcd/ssl/server.pem \\</span><br><span class="line">--etcd-keyfile=/opt/etcd/ssl/server-key.pem \\</span><br><span class="line">--audit-log-maxage=30 \\</span><br><span class="line">--audit-log-maxbackup=3 \\</span><br><span class="line">--audit-log-maxsize=100 \\</span><br><span class="line">--audit-log-path=/opt/kubernetes/logs/k8s-audit.log&quot;</span><br><span class="line">EOF</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä¸¤ä¸ª\ \ ç¬¬ä¸€ä¸ªæ˜¯è½¬ä¹‰ç¬¦ï¼Œç¬¬äºŒä¸ªæ˜¯æ¢è¡Œç¬¦ï¼Œä½¿ç”¨è½¬ä¹‰ç¬¦æ˜¯ä¸ºäº†ä½¿ç”¨ EOF ä¿ç•™æ¢è¡Œç¬¦ã€‚</p><ul><li>â€“logtostderrï¼šå¯ç”¨æ—¥å¿—</li><li>â€”vï¼šæ—¥å¿—ç­‰çº§</li><li>â€“log-dirï¼šæ—¥å¿—ç›®å½•</li><li>â€“etcd-serversï¼šetcd é›†ç¾¤åœ°å€</li><li>â€“bind-addressï¼šç›‘å¬åœ°å€</li><li>â€“secure-portï¼šhttps å®‰å…¨ç«¯å£</li><li>â€“advertise-addressï¼šé›†ç¾¤é€šå‘Šåœ°å€</li><li>â€“allow-privilegedï¼šå¯ç”¨æˆæƒ</li><li>â€“service-cluster-ip-rangeï¼šService è™šæ‹Ÿ IP åœ°å€æ®µ</li><li>â€“enable-admission-pluginsï¼šå‡†å…¥æ§åˆ¶æ¨¡å—</li><li>â€“authorization-modeï¼šè®¤è¯æˆæƒï¼Œå¯ç”¨ RBAC æˆæƒå’ŒèŠ‚ç‚¹è‡ªç®¡ç†</li><li>â€“enable-bootstrap-token-authï¼šå¯ç”¨ TLS bootstrap æœºåˆ¶</li><li>â€“token-auth-fileï¼šbootstrap token æ–‡ä»¶</li><li>â€“service-node-port-rangeï¼šService nodeport ç±»å‹é»˜è®¤åˆ†é…ç«¯å£èŒƒå›´</li><li>â€“kubelet-client-xxxï¼šapiserver è®¿é—® kubelet å®¢æˆ·ç«¯è¯ä¹¦</li><li>â€“tls-xxx-fileï¼šapiserver https è¯ä¹¦</li><li>â€“etcd-xxxfileï¼šè¿æ¥ Etcd é›†ç¾¤è¯ä¹¦</li><li>â€“audit-log-xxxï¼šå®¡è®¡æ—¥å¿—</li></ul><h2 id="5-7-æŠŠç”Ÿæˆçš„è¯ä¹¦æ‹·è´åˆ°é…ç½®æ–‡ä»¶ä¸­çš„è·¯å¾„"><a href="#5-7-æŠŠç”Ÿæˆçš„è¯ä¹¦æ‹·è´åˆ°é…ç½®æ–‡ä»¶ä¸­çš„è·¯å¾„" class="headerlink" title="5.7 æŠŠç”Ÿæˆçš„è¯ä¹¦æ‹·è´åˆ°é…ç½®æ–‡ä»¶ä¸­çš„è·¯å¾„"></a>5.7 æŠŠç”Ÿæˆçš„è¯ä¹¦æ‹·è´åˆ°é…ç½®æ–‡ä»¶ä¸­çš„è·¯å¾„</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp ~/TLS/k8s/ca*pem ~/TLS/k8s/server*pem /opt/kubernetes/ssl/</span><br></pre></td></tr></table></figure><h2 id="5-8-åˆ›å»ºä¸Šè¿°é…ç½®æ–‡ä»¶ä¸­-token-æ–‡ä»¶"><a href="#5-8-åˆ›å»ºä¸Šè¿°é…ç½®æ–‡ä»¶ä¸­-token-æ–‡ä»¶" class="headerlink" title="5.8 åˆ›å»ºä¸Šè¿°é…ç½®æ–‡ä»¶ä¸­ token æ–‡ä»¶"></a>5.8 åˆ›å»ºä¸Šè¿°é…ç½®æ–‡ä»¶ä¸­ token æ–‡ä»¶</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/token.csv &lt;&lt; EOF</span><br><span class="line">c47ffb939f5ca36231d9e3121a252940,kubelet-bootstrap,10001,&quot;system:node-bootstrapper&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>æ ¼å¼ï¼štokenï¼Œç”¨æˆ·åï¼ŒUIDï¼Œç”¨æˆ·ç»„ token ä¹Ÿå¯è‡ªè¡Œç”Ÿæˆæ›¿æ¢ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">head -c 16 /dev/urandom | od -An -t x | tr -d &#x27; &#x27;</span><br></pre></td></tr></table></figure><h2 id="5-9-systemd-ç®¡ç†-apiserver"><a href="#5-9-systemd-ç®¡ç†-apiserver" class="headerlink" title="5.9 systemd ç®¡ç† apiserver"></a>5.9 systemd ç®¡ç† apiserver</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-apiserver.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/kube-apiserver.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-apiserver \$KUBE_APISERVER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>å¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kube-apiserver</span><br><span class="line">systemctl enable kube-apiserver</span><br></pre></td></tr></table></figure><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20220308204749514.png"></p><h2 id="5-10-æˆæƒ-kubelet-bootstrap-ç”¨æˆ·å…è®¸è¯·æ±‚è¯ä¹¦"><a href="#5-10-æˆæƒ-kubelet-bootstrap-ç”¨æˆ·å…è®¸è¯·æ±‚è¯ä¹¦" class="headerlink" title="5.10 æˆæƒ kubelet-bootstrap ç”¨æˆ·å…è®¸è¯·æ±‚è¯ä¹¦"></a>5.10 æˆæƒ kubelet-bootstrap ç”¨æˆ·å…è®¸è¯·æ±‚è¯ä¹¦</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding kubelet-bootstrap \</span><br><span class="line">--clusterrole=system:node-bootstrapper \</span><br><span class="line">--user=kubelet-bootstrap</span><br></pre></td></tr></table></figure><h2 id="5-11-éƒ¨ç½²-kube-controller-manager"><a href="#5-11-éƒ¨ç½²-kube-controller-manager" class="headerlink" title="5.11 éƒ¨ç½² kube-controller-manager"></a>5.11 éƒ¨ç½² kube-controller-manager</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/kube-controller-manager.conf &lt;&lt; EOF</span><br><span class="line">KUBE_CONTROLLER_MANAGER_OPTS=&quot;--logtostderr=false \\</span><br><span class="line">--v=2 \\</span><br><span class="line">--log-dir=/opt/kubernetes/logs \\</span><br><span class="line">--leader-elect=true \\</span><br><span class="line">--master=127.0.0.1:8080 \\</span><br><span class="line">--bind-address=127.0.0.1 \\</span><br><span class="line">--allocate-node-cidrs=true \\</span><br><span class="line">--cluster-cidr=10.244.0.0/16 \\</span><br><span class="line">--service-cluster-ip-range=10.0.0.0/24 \\</span><br><span class="line">--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \\</span><br><span class="line">--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem  \\</span><br><span class="line">--root-ca-file=/opt/kubernetes/ssl/ca.pem \\</span><br><span class="line">--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem \\</span><br><span class="line">--experimental-cluster-signing-duration=87600h0m0s&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li><p>â€“masterï¼šé€šè¿‡æœ¬åœ°éå®‰å…¨æœ¬åœ°ç«¯å£ 8080 è¿æ¥ apiserver</p></li><li><p>â€“leader-electï¼šå½“è¯¥ç»„ä»¶å¯åŠ¨å¤šä¸ªæ—¶ï¼Œè‡ªåŠ¨é€‰ä¸¾ï¼ˆHAï¼‰</p></li><li><p>â€“cluster-signing-cert-file&#x2F;â€“cluster-signing-key-fileï¼šè‡ªåŠ¨ä¸º kubelet é¢å‘è¯ä¹¦çš„ CAï¼Œä¸ apiserver ä¿æŒä¸€è‡´</p></li></ul><h2 id="5-12-systemd-ç®¡ç†-controller-manager"><a href="#5-12-systemd-ç®¡ç†-controller-manager" class="headerlink" title="5.12 systemd ç®¡ç† controller-manager"></a>5.12 systemd ç®¡ç† controller-manager</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-controller-manager.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/kube-controller-manager.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-controller-manager \$KUBE_CONTROLLER_MANAGER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>å¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kube-controller-manager</span><br><span class="line">systemctl enable kube-controller-manager</span><br></pre></td></tr></table></figure><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20220308205307195.png"></p><h2 id="5-13-éƒ¨ç½²-kube-scheduler"><a href="#5-13-éƒ¨ç½²-kube-scheduler" class="headerlink" title="5.13 éƒ¨ç½² kube-scheduler"></a>5.13 éƒ¨ç½² kube-scheduler</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/kube-scheduler.conf &lt;&lt; EOF</span><br><span class="line">KUBE_SCHEDULER_OPTS=&quot;--logtostderr=false \</span><br><span class="line">--v=2 \</span><br><span class="line">--log-dir=/opt/kubernetes/logs \</span><br><span class="line">--leader-elect \</span><br><span class="line">--master=127.0.0.1:8080 \</span><br><span class="line">--bind-address=127.0.0.1&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>â€“masterï¼šé€šè¿‡æœ¬åœ°éå®‰å…¨æœ¬åœ°ç«¯å£ 8080 è¿æ¥ apiserver</p><p>â€“leader-electï¼šå½“è¯¥ç»„ä»¶å¯åŠ¨å¤šä¸ªæ—¶ï¼Œè‡ªåŠ¨é€‰ä¸¾ï¼ˆHAï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-scheduler.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/kube-scheduler.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-scheduler \$KUBE_SCHEDULER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>å¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kube-scheduler</span><br><span class="line">systemctl enable kube-scheduler</span><br></pre></td></tr></table></figure><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20220308205540390.png"></p><h2 id="5-14-æŸ¥çœ‹é›†ç¾¤çŠ¶æ€"><a href="#5-14-æŸ¥çœ‹é›†ç¾¤çŠ¶æ€" class="headerlink" title="5.14 æŸ¥çœ‹é›†ç¾¤çŠ¶æ€"></a>5.14 æŸ¥çœ‹é›†ç¾¤çŠ¶æ€</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get cs</span><br></pre></td></tr></table></figure><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20220308205714311.png"></p><h1 id="6-éƒ¨ç½²Worker-Nodeï¼ˆä¸¤ä¸ªnodeåŒæ­¥æ‰§è¡Œï¼‰"><a href="#6-éƒ¨ç½²Worker-Nodeï¼ˆä¸¤ä¸ªnodeåŒæ­¥æ‰§è¡Œï¼‰" class="headerlink" title="6.éƒ¨ç½²Worker Nodeï¼ˆä¸¤ä¸ªnodeåŒæ­¥æ‰§è¡Œï¼‰"></a>6.éƒ¨ç½²Worker Nodeï¼ˆä¸¤ä¸ªnodeåŒæ­¥æ‰§è¡Œï¼‰</h1><h2 id="6-1k8så®‰è£…åŒ…è§£å‹å®‰è£…"><a href="#6-1k8så®‰è£…åŒ…è§£å‹å®‰è£…" class="headerlink" title="6.1k8så®‰è£…åŒ…è§£å‹å®‰è£…"></a>6.1k8så®‰è£…åŒ…è§£å‹å®‰è£…</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/kubernetes/&#123;bin,cfg,ssl,logs&#125;</span><br><span class="line">tar zxvf kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">cd kubernetes/server/bin</span><br><span class="line">cp kubelet kube-proxy /opt/kubernetes/bin</span><br><span class="line">cp kubectl /usr/bin/</span><br></pre></td></tr></table></figure><h2 id="6-2-é…ç½®kubelet"><a href="#6-2-é…ç½®kubelet" class="headerlink" title="6.2 é…ç½®kubelet"></a>6.2 é…ç½®kubelet</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/kubelet.conf &lt;&lt; EOF</span><br><span class="line">KUBELET_OPTS=&quot;--logtostderr=false \\</span><br><span class="line">--v=2 \\</span><br><span class="line">--log-dir=/opt/kubernetes/logs \\</span><br><span class="line">--hostname-override=m1 \\</span><br><span class="line">--network-plugin=cni \\</span><br><span class="line">--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \\</span><br><span class="line">--bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \\</span><br><span class="line">--config=/opt/kubernetes/cfg/kubelet-config.yml \\</span><br><span class="line">--cert-dir=/opt/kubernetes/ssl \\</span><br><span class="line">--pod-infra-container-image=lizhenliang/pause-amd64:3.0&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><ul><li>â€“hostname-overrideï¼šæ˜¾ç¤ºåç§°ï¼Œé›†ç¾¤ä¸­å”¯ä¸€</li><li>â€“network-pluginï¼šå¯ç”¨CNI</li><li>â€“kubeconfigï¼šç©ºè·¯å¾„ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆï¼Œåé¢ç”¨äºè¿æ¥apiserver</li><li>â€“bootstrap-kubeconfigï¼šé¦–æ¬¡å¯åŠ¨å‘apiserverç”³è¯·è¯ä¹¦</li><li>â€“configï¼šé…ç½®å‚æ•°æ–‡ä»¶</li><li>â€“cert-dirï¼škubeletè¯ä¹¦ç”Ÿæˆç›®å½•</li><li>â€“pod-infra-container-imageï¼šç®¡ç†Podç½‘ç»œå®¹å™¨çš„é•œåƒ</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/kubelet-config.yml &lt;&lt; EOF</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">address: 0.0.0.0</span><br><span class="line">port: 10250</span><br><span class="line">readOnlyPort: 10255</span><br><span class="line">cgroupDriver: cgroupfs</span><br><span class="line">clusterDNS:</span><br><span class="line">- 10.0.0.2</span><br><span class="line">clusterDomain: cluster.local </span><br><span class="line">failSwapOn: false</span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: false</span><br><span class="line">  webhook:</span><br><span class="line">    cacheTTL: 2m0s</span><br><span class="line">    enabled: true</span><br><span class="line">  x509:</span><br><span class="line">    clientCAFile: /opt/kubernetes/ssl/ca.pem </span><br><span class="line">authorization:</span><br><span class="line">  mode: Webhook</span><br><span class="line">  webhook:</span><br><span class="line">    cacheAuthorizedTTL: 5m0s</span><br><span class="line">    cacheUnauthorizedTTL: 30s</span><br><span class="line">evictionHard:</span><br><span class="line">  imagefs.available: 15%</span><br><span class="line">  memory.available: 100Mi</span><br><span class="line">  nodefs.available: 10%</span><br><span class="line">  nodefs.inodesFree: 5%</span><br><span class="line">maxOpenFiles: 1000000</span><br><span class="line">maxPods: 110</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="6-3-å°†masterä¸€äº›é…ç½®æ–‡ä»¶æ‹·è´åˆ°nodeèŠ‚ç‚¹ä¸Š"><a href="#6-3-å°†masterä¸€äº›é…ç½®æ–‡ä»¶æ‹·è´åˆ°nodeèŠ‚ç‚¹ä¸Š" class="headerlink" title="6.3 å°†masterä¸€äº›é…ç½®æ–‡ä»¶æ‹·è´åˆ°nodeèŠ‚ç‚¹ä¸Š"></a>6.3 å°†masterä¸€äº›é…ç½®æ–‡ä»¶æ‹·è´åˆ°nodeèŠ‚ç‚¹ä¸Š</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp -r /opt/kubernetes/ssl root@192.168.206.129:/opt/kubernetes</span><br><span class="line">scp -r /opt/kubernetes/ssl root@192.168.206.130:/opt/kubernetes</span><br></pre></td></tr></table></figure><h2 id="6-4-ç”Ÿæˆbootstrap-kubeconfigæ–‡ä»¶"><a href="#6-4-ç”Ÿæˆbootstrap-kubeconfigæ–‡ä»¶" class="headerlink" title="6.4 ç”Ÿæˆbootstrap.kubeconfigæ–‡ä»¶"></a>6.4 ç”Ÿæˆbootstrap.kubeconfigæ–‡ä»¶</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">KUBE_APISERVER=&quot;https://192.168.206.128:6443&quot;  # apiserver IP:PORT</span><br><span class="line">TOKEN=&quot;c47ffb939f5ca36231d9e3121a252940&quot;  # ä¸token.csvé‡Œä¿æŒä¸€è‡´</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä¸¤ä¸ªå˜é‡éœ€è¦æ ¹æ®è‡ªå·±æƒ…å†µè®¾ç½®ï¼Œèµ‹åˆ°è„šæœ¬å¯¹åº”ä½ç½®æ‰§è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line">kubectl config set-credentials &quot;kubelet-bootstrap&quot; \</span><br><span class="line">  --token=$&#123;TOKEN&#125; \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=&quot;kubelet-bootstrap&quot; \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line">kubectl config use-context default --kubeconfig=bootstrap.kubeconfig</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv bootstrap.kubeconfig /opt/kubernetes/cfg</span><br></pre></td></tr></table></figure><h2 id="6-5-systemdç®¡ç†kubelet"><a href="#6-5-systemdç®¡ç†kubelet" class="headerlink" title="6.5 systemdç®¡ç†kubelet"></a>6.5 systemdç®¡ç†kubelet</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">After=docker.service</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/kubelet.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kubelet \$KUBELET_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>å¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kubelet</span><br><span class="line">systemctl enable kubelet</span><br></pre></td></tr></table></figure><h2 id="6-7-æ‰¹å‡†kubeletè¯ä¹¦ç”³è¯·å¹¶åŠ å…¥é›†ç¾¤ï¼ˆmasteræ‰§è¡Œï¼‰"><a href="#6-7-æ‰¹å‡†kubeletè¯ä¹¦ç”³è¯·å¹¶åŠ å…¥é›†ç¾¤ï¼ˆmasteræ‰§è¡Œï¼‰" class="headerlink" title="6.7 æ‰¹å‡†kubeletè¯ä¹¦ç”³è¯·å¹¶åŠ å…¥é›†ç¾¤ï¼ˆmasteræ‰§è¡Œï¼‰"></a>6.7 æ‰¹å‡†kubeletè¯ä¹¦ç”³è¯·å¹¶åŠ å…¥é›†ç¾¤ï¼ˆmasteræ‰§è¡Œï¼‰</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># æŸ¥çœ‹kubeletè¯ä¹¦è¯·æ±‚</span><br><span class="line">kubectl get csr</span><br><span class="line">NAME                                                   AGE    SIGNERNAME                                    REQUESTOR           CONDITION</span><br><span class="line">node-csr-uCEGPOIiDdlLODKts8J658HrFq9CZ--K6M4G7bjhk8A   6m3s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span><br><span class="line">node-csr-***</span><br><span class="line"># æ‰¹å‡†ç”³è¯·</span><br><span class="line">kubectl certificate approve node-csr-uCEGPOIiDdlLODKts8J658HrFq9CZ--K6M4G7bjhk8A</span><br><span class="line">kubectl certificate approve node-csr-***</span><br><span class="line"># æŸ¥çœ‹èŠ‚ç‚¹</span><br><span class="line">kubectl get node</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://pictures-jike.oss-cn-beijing.aliyuncs.com/pic_bed/1001990-20220308163707727-1298105212.png"></p><p> ç”±äºç½‘ç»œæ’ä»¶è¿˜æ²¡æœ‰éƒ¨ç½²ï¼ŒèŠ‚ç‚¹ä¼šæ²¡æœ‰å‡†å¤‡å°±ç»ª NotReadyã€‚</p><h2 id="6-8-éƒ¨ç½²kube-proxy"><a href="#6-8-éƒ¨ç½²kube-proxy" class="headerlink" title="6.8 éƒ¨ç½²kube-proxy"></a>6.8 éƒ¨ç½²kube-proxy</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/kube-proxy.conf &lt;&lt; EOF</span><br><span class="line">KUBE_PROXY_OPTS=&quot;--logtostderr=false \\</span><br><span class="line">--v=2 \\</span><br><span class="line">--log-dir=/opt/kubernetes/logs \\</span><br><span class="line">--config=/opt/kubernetes/cfg/kube-proxy-config.yml&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/kube-proxy-config.yml &lt;&lt; EOF</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">bindAddress: 0.0.0.0</span><br><span class="line">metricsBindAddress: 0.0.0.0:10249</span><br><span class="line">clientConnection:</span><br><span class="line">  kubeconfig: /opt/kubernetes/cfg/kube-proxy.kubeconfig</span><br><span class="line">hostnameOverride: node1</span><br><span class="line">clusterCIDR: 10.0.0.0/24</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>hostnameOverrideè®¾ç½®å¯¹åº”nodeæœºå™¨çš„hostnameã€‚</p><h2 id="6-9-ç”Ÿæˆkube-proxy-kubeconfigæ–‡ä»¶ï¼ˆmasterç”Ÿæˆä¼ åˆ°nodeï¼‰"><a href="#6-9-ç”Ÿæˆkube-proxy-kubeconfigæ–‡ä»¶ï¼ˆmasterç”Ÿæˆä¼ åˆ°nodeï¼‰" class="headerlink" title="6.9 ç”Ÿæˆkube-proxy.kubeconfigæ–‡ä»¶ï¼ˆmasterç”Ÿæˆä¼ åˆ°nodeï¼‰"></a>6.9 ç”Ÿæˆkube-proxy.kubeconfigæ–‡ä»¶ï¼ˆmasterç”Ÿæˆä¼ åˆ°nodeï¼‰</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># åˆ‡æ¢å·¥ä½œç›®å½•</span><br><span class="line">cd TLS/k8s</span><br><span class="line"></span><br><span class="line"># åˆ›å»ºè¯ä¹¦è¯·æ±‚æ–‡ä»¶</span><br><span class="line">cat &gt; kube-proxy-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;system:kube-proxy&quot;,</span><br><span class="line">  &quot;hosts&quot;: [],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># ç”Ÿæˆè¯ä¹¦</span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master k8s]# ls kube-proxy*pem</span><br><span class="line">kube-proxy-key.pem  kube-proxy.pem</span><br></pre></td></tr></table></figure><p>å°†masterç”Ÿæˆçš„è¯ä¹¦ä¼ è¾“åˆ°node</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp /root/TLS/k8s/kube-proxy*pem root@192.168.206.129:/opt/kubernetes/ssl</span><br><span class="line">scp /root/TLS/k8s/kube-proxy*pem root@192.168.206.130:/opt/kubernetes/ssl</span><br></pre></td></tr></table></figure><h2 id="6-10-ç”Ÿæˆkubeconfigæ–‡ä»¶"><a href="#6-10-ç”Ÿæˆkubeconfigæ–‡ä»¶" class="headerlink" title="6.10 ç”Ÿæˆkubeconfigæ–‡ä»¶"></a>6.10 ç”Ÿæˆkubeconfigæ–‡ä»¶</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">KUBE_APISERVER=&quot;https://192.168.206.128:6443&quot;  # apiserver IP:PORT</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">kubectl config set-credentials kube-proxy \</span><br><span class="line">  --client-certificate=/opt/kubernetes/ssl/kube-proxy.pem \</span><br><span class="line">  --client-key=/opt/kubernetes/ssl/kube-proxy-key.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kube-proxy \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure><h2 id="6-11-systemdç®¡ç†kube-proxy"><a href="#6-11-systemdç®¡ç†kube-proxy" class="headerlink" title="6.11 systemdç®¡ç†kube-proxy"></a>6.11 systemdç®¡ç†kube-proxy</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-proxy.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Proxy</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/kube-proxy.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-proxy \$KUBE_PROXY_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>å¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kube-proxy</span><br><span class="line">systemctl enable kube-proxy</span><br></pre></td></tr></table></figure><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20220309161608043.png"></p><h1 id="7-éƒ¨ç½²CNIç½‘ç»œ"><a href="#7-éƒ¨ç½²CNIç½‘ç»œ" class="headerlink" title="7.éƒ¨ç½²CNIç½‘ç»œ"></a>7.éƒ¨ç½²CNIç½‘ç»œ</h1><p>ä¸‹è½½å®‰è£…</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ä¸‹è½½åœ°å€ï¼šhttps://github.com/containernetworking/plugins/releases</span><br><span class="line">ç‰ˆæœ¬ï¼šv0.8.6ï¼ˆå®‰è£…åŒ…åï¼šcni-plugins-linux-amd64-v0.8.6.tgzï¼‰</span><br></pre></td></tr></table></figure><p>nodeèŠ‚ç‚¹æ“ä½œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir /opt/cni/bin</span><br><span class="line">tar zxvf cni-plugins-linux-amd64-v0.8.6.tgz -C /opt/cni/bin</span><br></pre></td></tr></table></figure><p>masterèŠ‚ç‚¹æ“ä½œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget --no-check-certificate https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line">kubectl apply -f kube-flannel.yml</span><br></pre></td></tr></table></figure><p><img src="https://pictures-blog.oss-cn-beijing.aliyuncs.com/pic_bed/image-20220309162718255.png"></p><p>å‚è€ƒï¼š</p><ol><li><p><a href="https://www.bilibili.com/video/BV1GT4y1A756/?spm_id_from=333.788.recommend_more_video.0">ã€å°šç¡…è°·ã€‘Kubernetesï¼ˆk8sï¼‰å…¥é—¨åˆ°å®æˆ˜æ•™ç¨‹ä¸¨å…¨æ–°å‡çº§å®Œæ•´ç‰ˆ</a></p></li><li><p><a href="https://blog.csdn.net/qq_40942490/article/details/114022294">k8sé›†ç¾¤ (äºŒè¿›åˆ¶å®‰è£…æ–¹å¼)</a></p></li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä½¿ç”¨ä¸‰å°æœåŠ¡å™¨æ­å»ºk8sé›†ç¾¤ï¼Œé›†ç¾¤æœåŠ¡å™¨åœ°å€è§„åˆ’å¦‚ä¸‹ï¼š&lt;/p&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://xssdpgy.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="k8s" scheme="https://xssdpgy.github.io/tags/k8s/"/>
    
    <category term="å®‰è£…" scheme="https://xssdpgy.github.io/tags/%E5%AE%89%E8%A3%85/"/>
    
  </entry>
  
</feed>
