{"meta":{"title":"é›ªå±±ä¸Šçš„è’²å…¬è‹±","subtitle":"JinFeng's Blog","description":"Stay hungry, Stay foolish.","author":"Zang JinFeng","url":"https://xssdpgy.github.io","root":"/"},"pages":[{"title":"å…³äº","date":"2022-04-07T06:04:21.000Z","updated":"2022-09-11T15:43:16.282Z","comments":false,"path":"about/index.html","permalink":"https://xssdpgy.github.io/about/index.html","excerpt":"","text":"ç¨‹åºå‘˜ä¸€æšï¼Œä¸“å‘äº’é‡‘å·¥ç¨‹é¢†åŸŸã€‚"},{"title":"åˆ†ç±»","date":"2022-04-06T15:33:39.000Z","updated":"2022-09-11T15:43:16.282Z","comments":false,"path":"categories/index.html","permalink":"https://xssdpgy.github.io/categories/index.html","excerpt":"","text":""},{"title":"æ ‡ç­¾","date":"2022-04-06T15:31:49.000Z","updated":"2022-09-11T15:43:16.283Z","comments":false,"path":"tags/index.html","permalink":"https://xssdpgy.github.io/tags/index.html","excerpt":"","text":""}],"posts":[{"title":"ç®—æ³•è®°å½•ï¼ˆä¸€ï¼‰â€”â€”å•é“¾è¡¨è§£é¢˜æŠ€å·§","slug":"ç®—æ³•è®°å½•ï¼ˆä¸€ï¼‰â€”â€”å•é“¾è¡¨è§£é¢˜æŠ€å·§","date":"2023-03-02T14:40:02.000Z","updated":"2023-03-02T15:42:52.612Z","comments":true,"path":"2023/03/02/ç®—æ³•è®°å½•ï¼ˆä¸€ï¼‰â€”â€”å•é“¾è¡¨è§£é¢˜æŠ€å·§/","link":"","permalink":"https://xssdpgy.github.io/2023/03/02/%E7%AE%97%E6%B3%95%E8%AE%B0%E5%BD%95%EF%BC%88%E4%B8%80%EF%BC%89%E2%80%94%E2%80%94%E5%8D%95%E9%93%BE%E8%A1%A8%E8%A7%A3%E9%A2%98%E6%8A%80%E5%B7%A7/","excerpt":"ç›®å½• 141. ç¯å½¢é“¾è¡¨ ğŸŸ¢ 142. ç¯å½¢é“¾è¡¨ IIğŸŸ  160. ç›¸äº¤é“¾è¡¨ ğŸŸ¢ 19. åˆ é™¤é“¾è¡¨çš„å€’æ•°ç¬¬ N ä¸ªç»“ç‚¹ ğŸŸ  21. åˆå¹¶ä¸¤ä¸ªæœ‰åºé“¾è¡¨ ğŸŸ¢ 23. åˆå¹¶Kä¸ªå‡åºé“¾è¡¨ ğŸ”´ 86. åˆ†éš”é“¾è¡¨ ğŸŸ  876. é“¾è¡¨çš„ä¸­é—´ç»“ç‚¹ ğŸŸ¢ å‰‘æŒ‡ Offer 22. é“¾è¡¨ä¸­å€’æ•°ç¬¬kä¸ªèŠ‚ç‚¹ ğŸŸ¢ å‰‘æŒ‡ Offer 25. åˆå¹¶ä¸¤ä¸ªæ’åºçš„é“¾è¡¨ ğŸŸ¢ å‰‘æŒ‡ Offer 52. ä¸¤ä¸ªé“¾è¡¨çš„ç¬¬ä¸€ä¸ªå…¬å…±èŠ‚ç‚¹ ğŸŸ¢ å‰‘æŒ‡ Offer II 021. åˆ é™¤é“¾è¡¨çš„å€’æ•°ç¬¬ n ä¸ªç»“ç‚¹ ğŸŸ  å‰‘æŒ‡ Offer II 022. é“¾è¡¨ä¸­ç¯çš„å…¥å£èŠ‚ç‚¹ ğŸŸ  å‰‘æŒ‡ Offer II 023. ä¸¤ä¸ªé“¾è¡¨çš„ç¬¬ä¸€ä¸ªé‡åˆèŠ‚ç‚¹ ğŸŸ¢ å‰‘æŒ‡ Offer II 078. åˆå¹¶æ’åºé“¾è¡¨ ğŸ”´ å•é“¾è¡¨çš„æ•°æ®ç»“æ„123456789// Definition for singly-linked list. class ListNode &#123; int val; ListNode next; ListNode(int x) &#123; val = x; next = null; &#125; &#125; 141 ç¯å½¢é“¾è¡¨","text":"ç›®å½• 141. ç¯å½¢é“¾è¡¨ ğŸŸ¢ 142. ç¯å½¢é“¾è¡¨ IIğŸŸ  160. ç›¸äº¤é“¾è¡¨ ğŸŸ¢ 19. åˆ é™¤é“¾è¡¨çš„å€’æ•°ç¬¬ N ä¸ªç»“ç‚¹ ğŸŸ  21. åˆå¹¶ä¸¤ä¸ªæœ‰åºé“¾è¡¨ ğŸŸ¢ 23. åˆå¹¶Kä¸ªå‡åºé“¾è¡¨ ğŸ”´ 86. åˆ†éš”é“¾è¡¨ ğŸŸ  876. é“¾è¡¨çš„ä¸­é—´ç»“ç‚¹ ğŸŸ¢ å‰‘æŒ‡ Offer 22. é“¾è¡¨ä¸­å€’æ•°ç¬¬kä¸ªèŠ‚ç‚¹ ğŸŸ¢ å‰‘æŒ‡ Offer 25. åˆå¹¶ä¸¤ä¸ªæ’åºçš„é“¾è¡¨ ğŸŸ¢ å‰‘æŒ‡ Offer 52. ä¸¤ä¸ªé“¾è¡¨çš„ç¬¬ä¸€ä¸ªå…¬å…±èŠ‚ç‚¹ ğŸŸ¢ å‰‘æŒ‡ Offer II 021. åˆ é™¤é“¾è¡¨çš„å€’æ•°ç¬¬ n ä¸ªç»“ç‚¹ ğŸŸ  å‰‘æŒ‡ Offer II 022. é“¾è¡¨ä¸­ç¯çš„å…¥å£èŠ‚ç‚¹ ğŸŸ  å‰‘æŒ‡ Offer II 023. ä¸¤ä¸ªé“¾è¡¨çš„ç¬¬ä¸€ä¸ªé‡åˆèŠ‚ç‚¹ ğŸŸ¢ å‰‘æŒ‡ Offer II 078. åˆå¹¶æ’åºé“¾è¡¨ ğŸ”´ å•é“¾è¡¨çš„æ•°æ®ç»“æ„123456789// Definition for singly-linked list. class ListNode &#123; int val; ListNode next; ListNode(int x) &#123; val = x; next = null; &#125; &#125; 141 ç¯å½¢é“¾è¡¨é¢˜ç›®ï¼š141. ç¯å½¢é“¾è¡¨ ğŸŸ¢ æ€è·¯ï¼šåˆ¤æ–­é“¾è¡¨ä¸­æ˜¯å¦å­˜åœ¨ç¯ï¼Œä½¿ç”¨åŒæŒ‡é’ˆï¼Œå¿«æ…¢æŒ‡é’ˆï¼Œç›¸äº¤å³ä¸ºå­˜åœ¨ç¯ã€‚ 1234567891011121314public boolean hasCycle(ListNode head) &#123; ListNode slow,fast; slow = head; fast = head; while(fast!=null&amp;&amp;fast.next!=null)&#123; slow = slow.next; fast = fast.next.next; //å¿«æ…¢æŒ‡é’ˆç›¸äº¤å³ä¸ºå­˜åœ¨ç¯ if(slow==fast)&#123; return true; &#125; &#125; return false;&#125; 142 ç¯å½¢é“¾è¡¨äºŒé¢˜ç›®ï¼š142. ç¯å½¢é“¾è¡¨ IIğŸŸ  æ€è·¯ï¼šåŸºäº 141. ç¯å½¢é“¾è¡¨ çš„è§£æ³•ï¼Œç›´è§‚åœ°æ¥è¯´å°±æ˜¯å½“å¿«æ…¢æŒ‡é’ˆç›¸é‡æ—¶ï¼Œè®©å…¶ä¸­ä»»ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘å¤´èŠ‚ç‚¹ï¼Œç„¶åè®©å®ƒä¿©ä»¥ç›¸åŒé€Ÿåº¦å‰è¿›ï¼Œå†æ¬¡ç›¸é‡æ—¶æ‰€åœ¨çš„èŠ‚ç‚¹ä½ç½®å°±æ˜¯ç¯å¼€å§‹çš„ä½ç½®ã€‚ 12345678910111213141516171819202122232425public ListNode detectCycle(ListNode head) &#123; ListNode fast,slow; fast = head; slow = head; while(fast !=null&amp;&amp;fast.next!=null)&#123; slow = slow.next; fast = fast.next.next; //å¿«æ…¢æŒ‡é’ˆç›¸äº¤ï¼Œä¸­æ–­å‰è¿› if(slow == fast)&#123; break; &#125; &#125; //å¿«æŒ‡é’ˆnextèŠ‚ç‚¹ä¸ºç©ºçš„è¯ï¼Œè¯´æ˜é“¾è¡¨æ— ç¯ if(fast==null||fast.next==null)&#123; return null; &#125; //æ­¤æ—¶æ…¢æŒ‡é’ˆé‡æ–°æŒ‡å‘å¤´èŠ‚ç‚¹ slow = head; //å¿«æ…¢æŒ‡é’ˆåŒæ­¥å‰è¿›ï¼Œç­‰å¾…ç›¸äº¤ç‚¹å³ä¸ºç¯çš„å…¥å£ while(slow!=fast)&#123; slow = slow.next; fast = fast.next; &#125; return slow; &#125; 160 ç›¸äº¤é“¾è¡¨é¢˜ç›®ï¼š160. ç›¸äº¤é“¾è¡¨ ğŸŸ¢ æ€è·¯ï¼šéš¾ç‚¹åœ¨äºé“¾è¡¨é•¿åº¦ä¸åŒï¼Œå› æ­¤åˆ°è¾¾ç›¸äº¤èŠ‚ç‚¹çš„æ­¥æ•°ä¹Ÿä¸åŒï¼Œå› æ­¤é€šè¿‡æ‹¼æ¥ï¼Œè®© p1 éå†å®Œé“¾è¡¨ A ä¹‹åå¼€å§‹éå†é“¾è¡¨ Bï¼Œè®© p2 éå†å®Œé“¾è¡¨ B ä¹‹åå¼€å§‹éå†é“¾è¡¨ Aï¼Œè¿™æ ·ç›¸å½“äºã€Œé€»è¾‘ä¸Šã€ä¸¤æ¡é“¾è¡¨æ¥åœ¨äº†ä¸€èµ·ï¼Œä»¥è®© p1 å’Œ p2 åŒæ—¶è¿›å…¥ç›¸äº¤èŠ‚ç‚¹ã€‚ 12345678910111213141516171819public ListNode getIntersectionNode(ListNode headA, ListNode headB) &#123; ListNode p1 = headA,p2 = headB; while(p1!=p2)&#123; if(p1==null)&#123; //p1åˆ°å°½å¤´ï¼ŒæŒ‡é’ˆè½¬å‘headB p1 = headB; &#125;else&#123; p1 = p1.next; &#125; if(p2==null)&#123; //p2åˆ°å°½å¤´ï¼ŒæŒ‡é’ˆè½¬å‘headA p2 = headA; &#125;else&#123; p2 = p2.next; &#125; &#125; //p1==p2å³ä¸ºç›¸äº¤èŠ‚ç‚¹ return p1;&#125;","categories":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"https://xssdpgy.github.io/categories/%E6%8A%80%E6%9C%AF/"}],"tags":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://xssdpgy.github.io/tags/%E7%AE%97%E6%B3%95/"},{"name":"é“¾è¡¨","slug":"é“¾è¡¨","permalink":"https://xssdpgy.github.io/tags/%E9%93%BE%E8%A1%A8/"}]},{"title":"Javaçš„7ç§é˜»å¡é˜Ÿåˆ—åŠå…¶å®ç°åŸç†","slug":"Javaçš„7ç§é˜»å¡é˜Ÿåˆ—åŠå…¶å®ç°åŸç†","date":"2023-02-27T14:50:55.000Z","updated":"2023-02-28T14:16:22.373Z","comments":true,"path":"2023/02/27/Javaçš„7ç§é˜»å¡é˜Ÿåˆ—åŠå…¶å®ç°åŸç†/","link":"","permalink":"https://xssdpgy.github.io/2023/02/27/Java%E7%9A%847%E7%A7%8D%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97%E5%8F%8A%E5%85%B6%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/","excerpt":"é˜Ÿåˆ—å’Œé˜»å¡é˜Ÿåˆ—é˜Ÿåˆ—é˜Ÿåˆ—ï¼ˆQueueï¼‰æ˜¯ä¸€ç§ç»å¸¸ä½¿ç”¨çš„é›†åˆã€‚Queue å®é™…ä¸Šæ˜¯å®ç°äº†ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼šFirst In First Outï¼‰çš„æœ‰åºè¡¨ã€‚å’Œ Listã€Set ä¸€æ ·éƒ½ç»§æ‰¿è‡ª Collectionã€‚å®ƒå’Œ List çš„åŒºåˆ«åœ¨äºï¼ŒListå¯ä»¥åœ¨ä»»æ„ä½ç½®æ·»åŠ å’Œåˆ é™¤å…ƒç´ ï¼Œè€ŒQueue åªæœ‰ä¸¤ä¸ªæ“ä½œï¼š æŠŠå…ƒç´ æ·»åŠ åˆ°é˜Ÿåˆ—æœ«å°¾ï¼› ä»é˜Ÿåˆ—å¤´éƒ¨å–å‡ºå…ƒç´ ã€‚","text":"é˜Ÿåˆ—å’Œé˜»å¡é˜Ÿåˆ—é˜Ÿåˆ—é˜Ÿåˆ—ï¼ˆQueueï¼‰æ˜¯ä¸€ç§ç»å¸¸ä½¿ç”¨çš„é›†åˆã€‚Queue å®é™…ä¸Šæ˜¯å®ç°äº†ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼šFirst In First Outï¼‰çš„æœ‰åºè¡¨ã€‚å’Œ Listã€Set ä¸€æ ·éƒ½ç»§æ‰¿è‡ª Collectionã€‚å®ƒå’Œ List çš„åŒºåˆ«åœ¨äºï¼ŒListå¯ä»¥åœ¨ä»»æ„ä½ç½®æ·»åŠ å’Œåˆ é™¤å…ƒç´ ï¼Œè€ŒQueue åªæœ‰ä¸¤ä¸ªæ“ä½œï¼š æŠŠå…ƒç´ æ·»åŠ åˆ°é˜Ÿåˆ—æœ«å°¾ï¼› ä»é˜Ÿåˆ—å¤´éƒ¨å–å‡ºå…ƒç´ ã€‚ è¶…å¸‚çš„æ”¶é“¶å°å°±æ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼š æˆ‘ä»¬å¸¸ç”¨çš„ LinkedList å°±å¯ä»¥å½“é˜Ÿåˆ—ä½¿ç”¨ï¼Œå®ç°äº† Dequeue æ¥å£ï¼Œè¿˜æœ‰ ConcurrentLinkedQueueï¼Œä»–ä»¬éƒ½å±äºéé˜»å¡é˜Ÿåˆ—ã€‚ é˜»å¡é˜Ÿåˆ—é˜»å¡é˜Ÿåˆ—ï¼Œé¡¾åæ€ä¹‰ï¼Œé¦–å…ˆå®ƒæ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œè€Œä¸€ä¸ªé˜»å¡é˜Ÿåˆ—åœ¨æ•°æ®ç»“æ„ä¸­æ‰€èµ·çš„ä½œç”¨å¤§è‡´å¦‚ä¸‹ï¼š çº¿ç¨‹ 1 å¾€é˜»å¡é˜Ÿåˆ—ä¸­æ·»åŠ å…ƒç´ ï¼Œè€Œçº¿ç¨‹ 2 ä»é˜»å¡é˜Ÿåˆ—ä¸­ç§»é™¤å…ƒç´  å½“é˜»å¡é˜Ÿåˆ—æ˜¯ç©ºæ—¶ï¼Œä»é˜Ÿåˆ—ä¸­è·å–å…ƒç´ çš„æ“ä½œå°†ä¼šè¢«é˜»å¡ã€‚ å½“é˜»å¡é˜Ÿåˆ—æ˜¯æ»¡æ—¶ï¼Œä»é˜Ÿåˆ—ä¸­æ·»åŠ å…ƒç´ çš„æ“ä½œå°†ä¼šè¢«é˜»å¡ã€‚ è¯•å›¾ä»ç©ºçš„é˜»å¡é˜Ÿåˆ—ä¸­è·å–å…ƒç´ çš„çº¿ç¨‹å°†ä¼šé˜»å¡ï¼Œç›´åˆ°å…¶ä»–çš„çº¿ç¨‹å¾€ç©ºçš„é˜Ÿåˆ—æ’å…¥æ–°çš„å…ƒç´ ï¼ŒåŒæ ·ï¼Œè¯•å›¾å¾€å·²æ»¡çš„é˜»å¡é˜Ÿåˆ—æ·»åŠ æ–°å…ƒç´ çš„çº¿ç¨‹åŒæ ·ä¹Ÿä¼šé˜»å¡ï¼Œç›´åˆ°å…¶ä»–çš„çº¿ç¨‹ä»åˆ—ä¸­ç§»é™¤ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ æˆ–è€…å®Œå…¨æ¸…ç©ºé˜Ÿåˆ—åç»§ç»­æ–°å¢ã€‚ ç±»ä¼¼æˆ‘ä»¬å»æµ·åº•ææ’é˜Ÿï¼Œæµ·åº•æçˆ†æ»¡æƒ…å†µä¸‹ï¼Œé˜»å¡é˜Ÿåˆ—ç›¸å½“äºç”¨é¤åŒºï¼Œç”¨é¤åŒºæ»¡äº†çš„è¯ï¼Œå°±é˜»å¡åœ¨å€™å®¢åŒºç­‰ç€ï¼Œå¯ä»¥ç”¨é¤çš„è¯ put ä¸€æ³¢å»ç”¨é¤ï¼Œåƒå®Œå°± take å‡ºå»ã€‚ ä¸ºä»€ä¹ˆè¦ç”¨é˜»å¡é˜Ÿåˆ—åœ¨å¤šçº¿ç¨‹é¢†åŸŸï¼šæ‰€è°“é˜»å¡ï¼Œæ˜¯æŒ‡åœ¨æŸäº›æƒ…å†µä¸‹ä¼šæŒ‚èµ·çº¿ç¨‹ï¼ˆå³é˜»å¡ï¼‰ï¼Œä¸€æ—¦æ¡ä»¶æ»¡è¶³ï¼Œè¢«æŒ‚èµ·çš„çº¿ç¨‹åˆä¼šè‡ªåŠ¨è¢«å”¤é†’ã€‚ é‚£ä¸ºä»€ä¹ˆéœ€è¦ BlockingQueue å‘¢ å¥½å¤„æ˜¯æˆ‘ä»¬ä¸éœ€è¦å…³å¿ƒä»€ä¹ˆæ—¶å€™éœ€è¦é˜»å¡çº¿ç¨‹ï¼Œä»€ä¹ˆæ—¶å€™éœ€è¦å”¤é†’çº¿ç¨‹ï¼Œå› ä¸ºè¿™äº› BlockingQueue éƒ½åŒ…åŠäº†ã€‚ åœ¨ concurrent åŒ…å‘å¸ƒä»¥å‰ï¼Œå¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬æ¯ä¸ªç¨‹åºå‘˜éƒ½å¿…é¡»è‡ªå·±å»å®ç°è¿™äº›ç»†èŠ‚ï¼Œå°¤å…¶è¿˜è¦å…¼é¡¾æ•ˆç‡å’Œçº¿ç¨‹å®‰å…¨ï¼Œè¿™ä¼šç»™æˆ‘ä»¬çš„ç¨‹åºå¸¦æ¥ä¸å°çš„å¤æ‚æ€§ã€‚ç°åœ¨æœ‰äº†é˜»å¡é˜Ÿåˆ—ï¼Œæˆ‘ä»¬çš„æ“ä½œå°±ä»æ‰‹åŠ¨æŒ¡æ¢æˆäº†è‡ªåŠ¨æŒ¡ã€‚ Javaé‡Œçš„é˜»å¡é˜Ÿåˆ— Collectionçš„å­ç±»é™¤äº†æˆ‘ä»¬ç†Ÿæ‚‰çš„ List å’Œ Setï¼Œè¿˜æœ‰ä¸€ä¸ª Queueï¼Œé˜»å¡é˜Ÿåˆ— BlockingQueue ç»§æ‰¿è‡ª Queueã€‚ BlockingQueue æ˜¯ä¸ªæ¥å£ï¼Œéœ€è¦ä½¿ç”¨å®ƒçš„å®ç°ä¹‹ä¸€æ¥ä½¿ç”¨ BlockingQueueï¼Œjava.util.concurrent åŒ…ä¸‹å…·æœ‰ä»¥ä¸‹ BlockingQueue æ¥å£çš„å®ç°ç±»ï¼š JDK æä¾›äº† 7 ä¸ªé˜»å¡é˜Ÿåˆ—ã€‚åˆ†åˆ«æ˜¯ï¼š ArrayBlockingQueue ï¼šä¸€ä¸ªç”±æ•°ç»„ç»“æ„ç»„æˆçš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ— LinkedBlockingQueue ï¼šä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ— PriorityBlockingQueue ï¼šä¸€ä¸ªæ”¯æŒä¼˜å…ˆçº§æ’åºçš„æ— ç•Œé˜»å¡é˜Ÿåˆ— DelayQueueï¼šä¸€ä¸ªä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°çš„æ— ç•Œé˜»å¡é˜Ÿåˆ— SynchronousQueueï¼šä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ— LinkedTransferQueueï¼šä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ï¼ˆå®ç°äº†ç»§æ‰¿äº BlockingQueue çš„ TransferQueueï¼‰ LinkedBlockingDequeï¼šä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„åŒå‘é˜»å¡é˜Ÿåˆ— BlockingQueueæ ¸å¿ƒæ–¹æ³•ç›¸æ¯” Queue æ¥å£ï¼ŒBlockingQueue æœ‰å››ç§å½¢å¼çš„ APIã€‚ æ–¹æ³•ç±»å‹ æŠ›å‡ºå¼‚å¸¸ è¿”å›ç‰¹æ®Šå€¼ ä¸€ç›´é˜»å¡ è¶…æ—¶é€€å‡º æ’å…¥ add(e) offer(e) put(e) offer(e,time,unit) ç§»é™¤ï¼ˆå–å‡ºï¼‰ remove() poll() take() poll(time,unit) æ£€æŸ¥ element() peek() ä¸å¯ç”¨ ä¸å¯ç”¨ ä»¥ ArrayBlockingQueue ä¸ºä¾‹æ¥çœ‹ä¸‹ Java é˜»å¡é˜Ÿåˆ—æä¾›çš„å¸¸ç”¨æ–¹æ³• æŠ›å‡ºå¼‚å¸¸ï¼š å½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œå†å¾€é˜Ÿåˆ—é‡Œ add æ’å…¥å…ƒç´ ä¼šæŠ›å‡º java.lang.IllegalStateException: Queue full å¼‚å¸¸ï¼› å½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œä»é˜Ÿåˆ—é‡Œ remove ç§»é™¤å…ƒç´ æ—¶ä¼šæŠ›å‡º NoSuchElementException å¼‚å¸¸ ã€‚ element()ï¼Œè¿”å›é˜Ÿåˆ—å¤´éƒ¨çš„å…ƒç´ ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™æŠ›å‡ºä¸€ä¸ª NoSuchElementException å¼‚å¸¸ è¿”å›ç‰¹æ®Šå€¼ï¼š offer()ï¼Œæ’å…¥æ–¹æ³•ï¼ŒæˆåŠŸè¿”å› trueï¼Œå¤±è´¥è¿”å› falseï¼› poll()ï¼Œç§»é™¤æ–¹æ³•ï¼ŒæˆåŠŸè¿”å›å‡ºé˜Ÿåˆ—çš„å…ƒç´ ï¼Œé˜Ÿåˆ—é‡Œæ²¡æœ‰åˆ™è¿”å› null peek() ï¼Œè¿”å›é˜Ÿåˆ—å¤´éƒ¨çš„å…ƒç´ ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™è¿”å› null ä¸€ç›´é˜»å¡ï¼š å½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œå¦‚æœç”Ÿäº§çº¿ç¨‹ç»§ç»­å¾€é˜Ÿåˆ—é‡Œ put å…ƒç´ ï¼Œé˜Ÿåˆ—ä¼šä¸€ç›´é˜»å¡ç”Ÿäº§çº¿ç¨‹ï¼Œç›´åˆ°æ‹¿åˆ°æ•°æ®ï¼Œæˆ–è€…å“åº”ä¸­æ–­é€€å‡ºï¼› å½“é˜»å¡é˜Ÿåˆ—ç©ºæ—¶ï¼Œæ¶ˆè´¹çº¿ç¨‹è¯•å›¾ä»é˜Ÿåˆ—é‡Œ take å…ƒç´ ï¼Œé˜Ÿåˆ—ä¹Ÿä¼šä¸€ç›´é˜»å¡æ¶ˆè´¹çº¿ç¨‹ï¼Œç›´åˆ°é˜Ÿåˆ—å¯ç”¨ã€‚ è¶…æ—¶é€€å‡ºï¼š å½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œé˜Ÿåˆ—ä¼šé˜»å¡ç”Ÿäº§çº¿ç¨‹ä¸€å®šæ—¶é—´ï¼Œå¦‚æœè¶…è¿‡ä¸€å®šçš„æ—¶é—´ï¼Œç”Ÿäº§çº¿ç¨‹å°±ä¼šé€€å‡ºï¼Œè¿”å› false å½“é˜»å¡é˜Ÿåˆ—ç©ºæ—¶ï¼Œé˜Ÿåˆ—ä¼šé˜»å¡æ¶ˆè´¹çº¿ç¨‹ä¸€å®šæ—¶é—´ï¼Œå¦‚æœè¶…è¿‡ä¸€å®šçš„æ—¶é—´ï¼Œæ¶ˆè´¹çº¿ç¨‹ä¼šé€€å‡ºï¼Œè¿”å› null BlockingQueue å®ç°ç±»é€ä¸ªåˆ†æä¸‹è¿™ 7 ä¸ªé˜»å¡é˜Ÿåˆ—ï¼Œå¸¸ç”¨çš„å‡ ä¸ªé¡ºä¾¿æ¢ç©¶ä¸‹æºç ã€‚ ArrayBlockingQueueArrayBlockingQueueï¼Œä¸€ä¸ªç”±æ•°ç»„å®ç°çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚è¯¥é˜Ÿåˆ—é‡‡ç”¨å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„åŸåˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åºæ·»åŠ çš„ã€‚ ArrayBlockingQueue ä¸ºæœ‰ç•Œä¸”å›ºå®šï¼Œå…¶å¤§å°åœ¨æ„é€ æ—¶ç”±æ„é€ å‡½æ•°æ¥å†³å®šï¼Œç¡®è®¤ä¹‹åå°±ä¸èƒ½å†æ”¹å˜äº†ã€‚ ArrayBlockingQueue æ”¯æŒå¯¹ç­‰å¾…çš„ç”Ÿäº§è€…çº¿ç¨‹å’Œä½¿ç”¨è€…çº¿ç¨‹è¿›è¡Œæ’åºçš„å¯é€‰å…¬å¹³ç­–ç•¥ï¼Œä½†æ˜¯åœ¨é»˜è®¤æƒ…å†µä¸‹ä¸ä¿è¯çº¿ç¨‹å…¬å¹³çš„è®¿é—®ï¼Œåœ¨æ„é€ æ—¶å¯ä»¥é€‰æ‹©å…¬å¹³ç­–ç•¥ï¼ˆfair = trueï¼‰ã€‚å…¬å¹³æ€§é€šå¸¸ä¼šé™ä½ååé‡ï¼Œä½†æ˜¯å‡å°‘äº†å¯å˜æ€§å’Œé¿å…äº†â€œä¸å¹³è¡¡æ€§â€ã€‚ï¼ˆArrayBlockingQueue å†…éƒ¨çš„é˜»å¡é˜Ÿåˆ—æ˜¯é€šè¿‡ ReentrantLock å’Œ Condition æ¡ä»¶é˜Ÿåˆ—å®ç°çš„ï¼Œ æ‰€ä»¥ ArrayBlockingQueue ä¸­çš„å…ƒç´ å­˜åœ¨å…¬å¹³å’Œéå…¬å¹³è®¿é—®çš„åŒºåˆ«ï¼‰ æ‰€è°“å…¬å¹³è®¿é—®é˜Ÿåˆ—æ˜¯æŒ‡é˜»å¡çš„æ‰€æœ‰ç”Ÿäº§è€…çº¿ç¨‹æˆ–æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œå½“é˜Ÿåˆ—å¯ç”¨æ—¶ï¼Œå¯ä»¥æŒ‰ç…§é˜»å¡çš„å…ˆåé¡ºåºè®¿é—®é˜Ÿåˆ—ï¼Œå³å…ˆé˜»å¡çš„ç”Ÿäº§è€…çº¿ç¨‹ï¼Œå¯ä»¥å…ˆå¾€é˜Ÿåˆ—é‡Œæ’å…¥å…ƒç´ ï¼Œå…ˆé˜»å¡çš„æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œå¯ä»¥å…ˆä»é˜Ÿåˆ—é‡Œè·å–å…ƒç´ ï¼Œå¯ä»¥ä¿è¯å…ˆè¿›å…ˆå‡ºï¼Œé¿å…é¥¥é¥¿ç°è±¡ã€‚ æºç è§£è¯» 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208public class ArrayBlockingQueue&lt;E&gt; extends AbstractQueue&lt;E&gt; implements BlockingQueue&lt;E&gt;, java.io.Serializable &#123; // é€šè¿‡æ•°ç»„æ¥å®ç°çš„é˜Ÿåˆ— final Object[] items; //è®°å½•é˜Ÿé¦–å…ƒç´ çš„ä¸‹æ ‡ int takeIndex; //è®°å½•é˜Ÿå°¾å…ƒç´ çš„ä¸‹æ ‡ int putIndex; //é˜Ÿåˆ—ä¸­çš„å…ƒç´ ä¸ªæ•° int count; //é€šè¿‡ReentrantLockæ¥å®ç°åŒæ­¥ final ReentrantLock lock; //æœ‰2ä¸ªæ¡ä»¶å¯¹è±¡ï¼Œåˆ†åˆ«è¡¨ç¤ºé˜Ÿåˆ—ä¸ä¸ºç©ºå’Œé˜Ÿåˆ—ä¸æ»¡çš„æƒ…å†µ private final Condition notEmpty; private final Condition notFull; //è¿­ä»£å™¨ transient Itrs itrs; //offeræ–¹æ³•ç”¨äºå‘é˜Ÿåˆ—ä¸­æ·»åŠ æ•°æ® public boolean offer(E e) &#123; // å¯ä»¥çœ‹å‡ºæ·»åŠ çš„æ•°æ®ä¸æ”¯æŒnullå€¼ checkNotNull(e); final ReentrantLock lock = this.lock; //é€šè¿‡é‡å…¥é”æ¥å®ç°åŒæ­¥ lock.lock(); try &#123; //å¦‚æœé˜Ÿåˆ—å·²ç»æ»¡äº†çš„è¯ç›´æ¥å°±è¿”å›falseï¼Œä¸ä¼šé˜»å¡è°ƒç”¨è¿™ä¸ªofferæ–¹æ³•çš„çº¿ç¨‹ if (count == items.length) return false; else &#123; //å¦‚æœé˜Ÿåˆ—æ²¡æœ‰æ»¡ï¼Œå°±è°ƒç”¨enqueueæ–¹æ³•å°†å…ƒç´ æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ enqueue(e); return true; &#125; &#125; finally &#123; lock.unlock(); &#125; &#125; //å¤šäº†ä¸ªç­‰å¾…æ—¶é—´çš„ offeræ–¹æ³• public boolean offer(E e, long timeout, TimeUnit unit) throws InterruptedException &#123; checkNotNull(e); long nanos = unit.toNanos(timeout); final ReentrantLock lock = this.lock; //è·å–å¯ä¸­æ–­é” lock.lockInterruptibly(); try &#123; while (count == items.length) &#123; if (nanos &lt;= 0) return false; //ç­‰å¾…è®¾ç½®çš„æ—¶é—´ nanos = notFull.awaitNanos(nanos); &#125; //å¦‚æœç­‰å¾…æ—¶é—´è¿‡äº†ï¼Œé˜Ÿåˆ—æœ‰ç©ºé—´çš„è¯å°±ä¼šè°ƒç”¨enqueueæ–¹æ³•å°†å…ƒç´ æ·»åŠ åˆ°é˜Ÿåˆ— enqueue(e); return true; &#125; finally &#123; lock.unlock(); &#125; &#125; //å°†æ•°æ®æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­çš„å…·ä½“æ–¹æ³• private void enqueue(E x) &#123; // assert lock.getHoldCount() == 1; // assert items[putIndex] == null; final Object[] items = this.items; items[putIndex] = x; //é€šè¿‡å¾ªç¯æ•°ç»„å®ç°çš„é˜Ÿåˆ—ï¼Œå½“æ•°ç»„æ»¡äº†æ—¶ä¸‹æ ‡å°±å˜æˆ0äº† if (++putIndex == items.length) putIndex = 0; count++; //æ¿€æ´»å› ä¸ºnotEmptyæ¡ä»¶è€Œé˜»å¡çš„çº¿ç¨‹ï¼Œæ¯”å¦‚è°ƒç”¨takeæ–¹æ³•çš„çº¿ç¨‹ notEmpty.signal(); &#125; //å°†æ•°æ®ä»é˜Ÿåˆ—ä¸­å–å‡ºçš„æ–¹æ³• private E dequeue() &#123; // assert lock.getHoldCount() == 1; // assert items[takeIndex] != null; final Object[] items = this.items; @SuppressWarnings(&quot;unchecked&quot;) E x = (E) items[takeIndex]; //å°†å¯¹åº”çš„æ•°ç»„ä¸‹æ ‡ä½ç½®è®¾ç½®ä¸ºnullé‡Šæ”¾èµ„æº items[takeIndex] = null; if (++takeIndex == items.length) takeIndex = 0; count--; if (itrs != null) itrs.elementDequeued(); //æ¿€æ´»å› ä¸ºnotFullæ¡ä»¶è€Œé˜»å¡çš„çº¿ç¨‹ï¼Œæ¯”å¦‚è°ƒç”¨putæ–¹æ³•çš„çº¿ç¨‹ notFull.signal(); return x; &#125; //putæ–¹æ³•å’Œofferæ–¹æ³•ä¸ä¸€æ ·çš„åœ°æ–¹åœ¨äºï¼Œå¦‚æœé˜Ÿåˆ—æ˜¯æ»¡çš„è¯ï¼Œå®ƒå°±ä¼šæŠŠè°ƒç”¨putæ–¹æ³•çš„çº¿ç¨‹é˜»å¡ï¼Œç›´åˆ°é˜Ÿåˆ—é‡Œæœ‰ç©ºé—´ public void put(E e) throws InterruptedException &#123; checkNotNull(e); final ReentrantLock lock = this.lock; //å› ä¸ºåé¢è°ƒç”¨äº†æ¡ä»¶å˜é‡çš„await()æ–¹æ³•ï¼Œè€Œawait()æ–¹æ³•ä¼šåœ¨ä¸­æ–­æ ‡å¿—è®¾ç½®åæŠ›å‡ºInterruptedExceptionå¼‚å¸¸åé€€å‡ºï¼Œ // æ‰€ä»¥åœ¨åŠ é”æ—¶å€™å…ˆçœ‹ä¸­æ–­æ ‡å¿—æ˜¯ä¸æ˜¯è¢«è®¾ç½®äº†ï¼Œå¦‚æœè®¾ç½®äº†ç›´æ¥æŠ›å‡ºInterruptedExceptionå¼‚å¸¸ï¼Œå°±ä¸ç”¨å†å»è·å–é”äº† lock.lockInterruptibly(); try &#123; while (count == items.length) //å¦‚æœé˜Ÿåˆ—æ»¡çš„è¯å°±é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°notFullçš„signalæ–¹æ³•è¢«è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯é˜Ÿåˆ—é‡Œæœ‰ç©ºé—´äº† notFull.await(); //é˜Ÿåˆ—é‡Œæœ‰ç©ºé—´äº†æ‰§è¡Œæ·»åŠ æ“ä½œ enqueue(e); &#125; finally &#123; lock.unlock(); &#125; &#125; //pollæ–¹æ³•ç”¨äºä»é˜Ÿåˆ—ä¸­å–æ•°æ®ï¼Œä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹ public E poll() &#123; final ReentrantLock lock = this.lock; lock.lock(); try &#123; //å¦‚æœé˜Ÿåˆ—ä¸ºç©ºçš„è¯ä¼šç›´æ¥è¿”å›nullï¼Œå¦åˆ™è°ƒç”¨dequeueæ–¹æ³•å–æ•°æ® return (count == 0) ? null : dequeue(); &#125; finally &#123; lock.unlock(); &#125; &#125; //æœ‰ç­‰å¾…æ—¶é—´çš„ poll é‡è½½æ–¹æ³• public E poll(long timeout, TimeUnit unit) throws InterruptedException &#123; long nanos = unit.toNanos(timeout); final ReentrantLock lock = this.lock; lock.lockInterruptibly(); try &#123; while (count == 0) &#123; if (nanos &lt;= 0) return null; nanos = notEmpty.awaitNanos(nanos); &#125; return dequeue(); &#125; finally &#123; lock.unlock(); &#125; &#125; //takeæ–¹æ³•ä¹Ÿæ˜¯ç”¨äºå–é˜Ÿåˆ—ä¸­çš„æ•°æ®ï¼Œä½†æ˜¯å’Œpollæ–¹æ³•ä¸åŒçš„æ˜¯å®ƒæœ‰å¯èƒ½ä¼šé˜»å¡å½“å‰çš„çº¿ç¨‹ public E take() throws InterruptedException &#123; final ReentrantLock lock = this.lock; lock.lockInterruptibly(); try &#123; //å½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œå°±ä¼šé˜»å¡å½“å‰çº¿ç¨‹ while (count == 0) notEmpty.await(); //ç›´åˆ°é˜Ÿåˆ—ä¸­æœ‰æ•°æ®äº†ï¼Œè°ƒç”¨dequeueæ–¹æ³•å°†æ•°æ®è¿”å› return dequeue(); &#125; finally &#123; lock.unlock(); &#125; &#125; //è¿”å›é˜Ÿé¦–å…ƒç´  public E peek() &#123; final ReentrantLock lock = this.lock; lock.lock(); try &#123; return itemAt(takeIndex); // null when queue is empty &#125; finally &#123; lock.unlock(); &#125; &#125; //è·å–é˜Ÿåˆ—çš„å…ƒç´ ä¸ªæ•°ï¼ŒåŠ äº†é”ï¼Œæ‰€ä»¥ç»“æœæ˜¯å‡†ç¡®çš„ public int size() &#123; final ReentrantLock lock = this.lock; lock.lock(); try &#123; return count; &#125; finally &#123; lock.unlock(); &#125; &#125; // æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–æ–¹æ³• //è¿”å›é˜Ÿåˆ—å‰©ä½™ç©ºé—´ï¼Œè¿˜èƒ½åŠ å‡ ä¸ªå…ƒç´  public int remainingCapacity() &#123; final ReentrantLock lock = this.lock; lock.lock(); try &#123; return items.length - count; &#125; finally &#123; lock.unlock(); &#125; &#125; // åˆ¤æ–­é˜Ÿåˆ—ä¸­æ˜¯å¦å­˜åœ¨å½“å‰å…ƒç´ o public boolean contains(Object o)&#123;&#125; // è¿”å›ä¸€ä¸ªæŒ‰æ­£ç¡®é¡ºåºï¼ŒåŒ…å«é˜Ÿåˆ—ä¸­æ‰€æœ‰å…ƒç´ çš„æ•°ç»„ public Object[] toArray()&#123;&#125; // è‡ªåŠ¨æ¸…ç©ºé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å…ƒç´  public void clear()&#123;&#125; // ç§»é™¤é˜Ÿåˆ—ä¸­æ‰€æœ‰å¯ç”¨å…ƒç´ ï¼Œå¹¶å°†ä»–ä»¬åŠ å…¥åˆ°ç»™å®šçš„ Collection ä¸­ public int drainTo(Collection&lt;? super E&gt; c)&#123;&#125; // è¿”å›æ­¤é˜Ÿåˆ—ä¸­æŒ‰æ­£ç¡®é¡ºåºè¿›è¡Œè¿­ä»£çš„ï¼ŒåŒ…å«æ‰€æœ‰å…ƒç´ çš„è¿­ä»£å™¨ public Iterator&lt;E&gt; iterator()&#125; LinkedBlockingQueueLinkedBlockingQueue æ˜¯ä¸€ä¸ªç”¨å•å‘é“¾è¡¨å®ç°çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚æ­¤é˜Ÿåˆ—çš„é»˜è®¤å’Œæœ€å¤§é•¿åº¦ä¸º Integer.MAX_VALUEã€‚æ­¤é˜Ÿåˆ—æŒ‰ç…§å…ˆè¿›å…ˆå‡ºçš„åŸåˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚ å¦‚æœä¸æ˜¯ç‰¹æ®Šä¸šåŠ¡ï¼ŒLinkedBlockingQueue ä½¿ç”¨æ—¶ï¼Œåˆ‡è®°è¦å®šä¹‰å®¹é‡ new LinkedBlockingQueue(capacity) ï¼Œé˜²æ­¢è¿‡åº¦è†¨èƒ€ã€‚ æºç è§£è¯» 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290public class LinkedBlockingQueue&lt;E&gt; extends AbstractQueue&lt;E&gt; implements BlockingQueue&lt;E&gt;, java.io.Serializable &#123; private static final long serialVersionUID = -6903933977591709194L; // åŸºäºé“¾è¡¨å®ç°ï¼Œè‚¯å®šè¦æœ‰ç»“ç‚¹ç±»ï¼Œå…¸å‹çš„å•é“¾è¡¨ç»“æ„ static class Node&lt;E&gt; &#123; E item; Node&lt;E&gt; next; Node(E x) &#123; item = x; &#125; &#125; //å®¹é‡ private final int capacity; //å½“å‰é˜Ÿåˆ—å…ƒç´ æ•°é‡ private final AtomicInteger count = new AtomicInteger(); // å¤´èŠ‚ç‚¹ï¼Œä¸å­˜æ•°æ® transient Node&lt;E&gt; head; // å°¾èŠ‚ç‚¹ï¼Œä¾¿äºå…¥é˜Ÿ private transient Node&lt;E&gt; last; // takeé”ï¼Œå‡ºé˜Ÿé”ï¼Œåªæœ‰takeï¼Œpollæ–¹æ³•ä¼šæŒæœ‰ private final ReentrantLock takeLock = new ReentrantLock(); // å‡ºé˜Ÿç­‰å¾…æ¡ä»¶ // å½“é˜Ÿåˆ—æ— å…ƒç´ æ—¶ï¼Œtakeé”ä¼šé˜»å¡åœ¨notEmptyæ¡ä»¶ä¸Šï¼Œç­‰å¾…å…¶å®ƒçº¿ç¨‹å”¤é†’ private final Condition notEmpty = takeLock.newCondition(); // å…¥é˜Ÿé”ï¼Œåªæœ‰putï¼Œofferä¼šæŒæœ‰ private final ReentrantLock putLock = new ReentrantLock(); // å…¥é˜Ÿç­‰å¾…æ¡ä»¶ // å½“é˜Ÿåˆ—æ»¡äº†æ—¶ï¼Œputé”ä¼šä¼šé˜»å¡åœ¨notFullä¸Šï¼Œç­‰å¾…å…¶å®ƒçº¿ç¨‹å”¤é†’ private final Condition notFull = putLock.newCondition(); //åŒæ ·æä¾›ä¸‰ä¸ªæ„é€ å™¨ public LinkedBlockingQueue(int capacity) &#123; if (capacity &lt;= 0) throw new IllegalArgumentException(); // åˆå§‹åŒ–headå’ŒlastæŒ‡é’ˆä¸ºç©ºå€¼èŠ‚ç‚¹ this.capacity = capacity; last = head = new Node&lt;E&gt;(null); &#125; public LinkedBlockingQueue() &#123; // å¦‚æœæ²¡ä¼ å®¹é‡ï¼Œå°±ä½¿ç”¨æœ€å¤§intå€¼åˆå§‹åŒ–å…¶å®¹é‡ this(Integer.MAX_VALUE); &#125; public LinkedBlockingQueue(Collection&lt;? extends E&gt; c) &#123;&#125; //å…¥é˜Ÿ public void put(E e) throws InterruptedException &#123; // ä¸å…è®¸nullå…ƒç´  if (e == null) throw new NullPointerException(); //è§„å®šç»™å½“å‰putæ–¹æ³•é¢„ç•™ä¸€ä¸ªæœ¬åœ°å˜é‡ int c = -1; // æ–°å»ºä¸€ä¸ªèŠ‚ç‚¹ Node&lt;E&gt; node = new Node&lt;E&gt;(e); final ReentrantLock putLock = this.putLock; final AtomicInteger count = this.count; // ä½¿ç”¨puté”åŠ é” putLock.lockInterruptibly(); try &#123; // å¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œå°±é˜»å¡åœ¨notFullæ¡ä»¶ä¸Š // ç­‰å¾…è¢«å…¶å®ƒçº¿ç¨‹å”¤é†’ while (count.get() == capacity) &#123; notFull.await(); &#125; // é˜Ÿåˆ—ä¸æ»¡äº†ï¼Œå°±å…¥é˜Ÿ enqueue(node); // é˜Ÿåˆ—é•¿åº¦åŠ 1 c = count.getAndIncrement(); // å¦‚æœç°é˜Ÿåˆ—é•¿åº¦å°äºå®¹é‡ // å°±å†å”¤é†’ä¸€ä¸ªé˜»å¡åœ¨notFullæ¡ä»¶ä¸Šçš„çº¿ç¨‹ // è¿™é‡Œä¸ºå•¥è¦å”¤é†’ä¸€ä¸‹å‘¢ï¼Ÿ // å› ä¸ºå¯èƒ½æœ‰å¾ˆå¤šçº¿ç¨‹é˜»å¡åœ¨notFullè¿™ä¸ªæ¡ä»¶ä¸Šçš„ // è€Œå–å…ƒç´ æ—¶åªæœ‰å–ä¹‹å‰é˜Ÿåˆ—æ˜¯æ»¡çš„æ‰ä¼šå”¤é†’notFull // ä¸ºä»€ä¹ˆé˜Ÿåˆ—æ»¡çš„æ‰å”¤é†’notFullå‘¢ï¼Ÿ // å› ä¸ºå”¤é†’æ˜¯éœ€è¦åŠ putLockçš„ï¼Œè¿™æ˜¯ä¸ºäº†å‡å°‘é”çš„æ¬¡æ•° // æ‰€ä»¥ï¼Œè¿™é‡Œç´¢æ€§åœ¨æ”¾å®Œå…ƒç´ å°±æ£€æµ‹ä¸€ä¸‹ï¼Œæœªæ»¡å°±å”¤é†’å…¶å®ƒnotFullä¸Šçš„çº¿ç¨‹ // è¯´ç™½äº†ï¼Œè¿™ä¹Ÿæ˜¯é”åˆ†ç¦»å¸¦æ¥çš„ä»£ä»· if (c + 1 &lt; capacity) notFull.signal(); &#125; finally &#123; // é‡Šæ”¾é” putLock.unlock(); &#125; // å¦‚æœåŸé˜Ÿåˆ—é•¿åº¦ä¸º0ï¼Œç°åœ¨åŠ äº†ä¸€ä¸ªå…ƒç´ åç«‹å³å”¤é†’notEmptyæ¡ä»¶ if (c == 0) signalNotEmpty(); &#125; private void signalNotEmpty() &#123; final ReentrantLock takeLock = this.takeLock; // åŠ takeé” takeLock.lock(); try &#123; // å”¤é†’notEmptyæ¡ä»¶ notEmpty.signal(); &#125; finally &#123; takeLock.unlock(); &#125; &#125; private void signalNotFull() &#123; final ReentrantLock putLock = this.putLock; putLock.lock(); try &#123; notFull.signal(); &#125; finally &#123; putLock.unlock(); &#125; &#125; private void enqueue(Node&lt;E&gt; node) &#123; // ç›´æ¥åŠ åˆ°laståé¢ last = last.next = node; &#125; public boolean offer(E e) &#123; //ç”¨å¸¦è¿‡æœŸæ—¶é—´çš„è¯´æ˜ &#125; public boolean offer(E e, long timeout, TimeUnit unit) throws InterruptedException &#123; if (e == null) throw new NullPointerException(); //è½¬æ¢ä¸ºçº³ç§’ long nanos = unit.toNanos(timeout); int c = -1; final ReentrantLock putLock = this.putLock; final AtomicInteger count = this.count; //è·å–å…¥é˜Ÿé”ï¼Œæ”¯æŒç­‰å¾…é”çš„è¿‡ç¨‹ä¸­è¢«ä¸­æ–­ putLock.lockInterruptibly(); try &#123; //é˜Ÿåˆ—æ»¡äº†ï¼Œå†çœ‹çœ‹æœ‰æ²¡æœ‰è¶…æ—¶ while (count.get() == capacity) &#123; if (nanos &lt;= 0) //ç­‰å¾…æ—¶é—´è¶…æ—¶ return false; //è¿›è¡Œç­‰å¾…ï¼ŒawaitNanos(long nanos)æ˜¯AQSä¸­çš„æ–¹æ³• //åœ¨ç­‰å¾…è¿‡ç¨‹ä¸­ï¼Œå¦‚æœè¢«å”¤é†’æˆ–è¶…æ—¶ï¼Œåˆ™ç»§ç»­å½“å‰å¾ªç¯ //å¦‚æœè¢«ä¸­æ–­ï¼Œåˆ™æŠ›å‡ºä¸­æ–­å¼‚å¸¸ nanos = notFull.awaitNanos(nanos); &#125; //è¿›å…¥é˜Ÿå°¾ enqueue(new Node&lt;E&gt;(e)); c = count.getAndIncrement(); //è¯´æ˜å½“å‰å…ƒç´ åé¢è¿˜èƒ½å†æ’å…¥ä¸€ä¸ª //å°±å”¤é†’ä¸€ä¸ªå…¥é˜Ÿæ¡ä»¶é˜Ÿåˆ—ä¸­é˜»å¡çš„çº¿ç¨‹ if (c + 1 &lt; capacity) notFull.signal(); &#125; finally &#123; putLock.unlock(); &#125; //èŠ‚ç‚¹æ•°é‡ä¸º0ï¼Œè¯´æ˜é˜Ÿåˆ—æ˜¯ç©ºçš„ if (c == 0) //å”¤é†’ä¸€ä¸ªå‡ºé˜Ÿæ¡ä»¶é˜Ÿåˆ—é˜»å¡çš„çº¿ç¨‹ signalNotEmpty(); return true; &#125; public E take() throws InterruptedException &#123; E x; int c = -1; final AtomicInteger count = this.count; final ReentrantLock takeLock = this.takeLock; takeLock.lockInterruptibly(); try &#123; // å¦‚æœé˜Ÿåˆ—æ— å…ƒç´ ï¼Œåˆ™é˜»å¡åœ¨notEmptyæ¡ä»¶ä¸Š while (count.get() == 0) &#123; notEmpty.await(); &#125; // å¦åˆ™ï¼Œå‡ºé˜Ÿ x = dequeue(); // è·å–å‡ºé˜Ÿå‰é˜Ÿåˆ—çš„é•¿åº¦ c = count.getAndDecrement(); // å¦‚æœå–ä¹‹å‰é˜Ÿåˆ—é•¿åº¦å¤§äº1ï¼Œåˆ™å”¤é†’notEmpty if (c &gt; 1) notEmpty.signal(); &#125; finally &#123; takeLock.unlock(); &#125; // å¦‚æœå–ä¹‹å‰é˜Ÿåˆ—é•¿åº¦ç­‰äºå®¹é‡ // åˆ™å”¤é†’notFull if (c == capacity) signalNotFull(); return x; &#125; private E dequeue() &#123; Node&lt;E&gt; h = head; Node&lt;E&gt; first = h.next; h.next = h; // help GC head = first; E x = first.item; first.item = null; return x; &#125; public E poll(long timeout, TimeUnit unit) throws InterruptedException &#123; E x = null; int c = -1; long nanos = unit.toNanos(timeout); final AtomicInteger count = this.count; final ReentrantLock takeLock = this.takeLock; takeLock.lockInterruptibly(); try &#123; while (count.get() == 0) &#123; //é˜Ÿåˆ—ä¸ºç©ºä¸”å·²ç»è¶…æ—¶ï¼Œç›´æ¥è¿”å›ç©º if (nanos &lt;= 0) return null; //ç­‰å¾…è¿‡ç¨‹ä¸­å¯èƒ½è¢«å”¤é†’ï¼Œè¶…æ—¶ï¼Œä¸­æ–­ nanos = notEmpty.awaitNanos(nanos); &#125; //è¿›è¡Œå‡ºé˜Ÿæ“ä½œ x = dequeue(); c = count.getAndDecrement(); if (c &gt; 1) notEmpty.signal(); &#125; finally &#123; takeLock.unlock(); &#125; //å¦‚æœå‡ºé˜Ÿå‰ï¼Œé˜Ÿåˆ—æ˜¯æ»¡çš„ï¼Œåˆ™å”¤é†’ä¸€ä¸ªè¢«take()é˜»å¡çš„çº¿ç¨‹ if (c == capacity) signalNotFull(); return x; &#125; public E poll() &#123; // &#125; public E peek() &#123; if (count.get() == 0) return null; final ReentrantLock takeLock = this.takeLock; takeLock.lock(); try &#123; Node&lt;E&gt; first = head.next; if (first == null) return null; else return first.item; &#125; finally &#123; takeLock.unlock(); &#125; &#125; void unlink(Node&lt;E&gt; p, Node&lt;E&gt; trail) &#123; // assert isFullyLocked(); // p.next is not changed, to allow iterators that are // traversing p to maintain their weak-consistency guarantee. p.item = null; trail.next = p.next; if (last == p) last = trail; if (count.getAndDecrement() == capacity) notFull.signal(); &#125; public boolean remove(Object o) &#123; if (o == null) return false; fullyLock(); try &#123; for (Node&lt;E&gt; trail = head, p = trail.next; p != null; trail = p, p = p.next) &#123; if (o.equals(p.item)) &#123; unlink(p, trail); return true; &#125; &#125; return false; &#125; finally &#123; fullyUnlock(); &#125; &#125; public boolean contains(Object o) &#123; &#125; static final class LBQSpliterator&lt;E&gt; implements Spliterator&lt;E&gt; &#123; &#125;&#125; LinkedBlockingQueue ä¸ ArrayBlockingQueueå¯¹æ¯” ArrayBlockingQueue å…¥é˜Ÿå‡ºé˜Ÿé‡‡ç”¨ä¸€æŠŠé”ï¼Œå¯¼è‡´å…¥é˜Ÿå‡ºé˜Ÿç›¸äº’é˜»å¡ï¼Œæ•ˆç‡ä½ä¸‹ï¼› LinkedBlockingQueue å…¥é˜Ÿå‡ºé˜Ÿé‡‡ç”¨ä¸¤æŠŠé”ï¼Œå…¥é˜Ÿå‡ºé˜Ÿäº’ä¸å¹²æ‰°ï¼Œæ•ˆç‡è¾ƒé«˜ï¼› äºŒè€…éƒ½æ˜¯æœ‰ç•Œé˜Ÿåˆ—ï¼Œå¦‚æœé•¿åº¦ç›¸ç­‰ä¸”å‡ºé˜Ÿé€Ÿåº¦è·Ÿä¸ä¸Šå…¥é˜Ÿé€Ÿåº¦ï¼Œéƒ½ä¼šå¯¼è‡´å¤§é‡çº¿ç¨‹é˜»å¡ï¼› LinkedBlockingQueue å¦‚æœåˆå§‹åŒ–ä¸ä¼ å…¥åˆå§‹å®¹é‡ï¼Œåˆ™ä½¿ç”¨æœ€å¤§ int å€¼ï¼Œå¦‚æœå‡ºé˜Ÿé€Ÿåº¦è·Ÿä¸ä¸Šå…¥é˜Ÿé€Ÿåº¦ï¼Œä¼šå¯¼è‡´é˜Ÿåˆ—ç‰¹åˆ«é•¿ï¼Œå ç”¨å¤§é‡å†…å­˜ï¼› PriorityBlockingQueuePriorityBlockingQueue æ˜¯ä¸€ä¸ªæ”¯æŒä¼˜å…ˆçº§çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚(è™½è¯´æ˜¯æ— ç•Œé˜Ÿåˆ—ï¼Œä½†æ˜¯ç”±äºèµ„æºè€—å°½çš„è¯ï¼Œä¹Ÿä¼šOutOfMemoryErrorï¼Œæ— æ³•æ·»åŠ å…ƒç´ ) é»˜è®¤æƒ…å†µä¸‹å…ƒç´ é‡‡ç”¨è‡ªç„¶é¡ºåºå‡åºæ’åˆ—ã€‚ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ç±»å®ç° compareTo() æ–¹æ³•æ¥æŒ‡å®šå…ƒç´ æ’åºè§„åˆ™ï¼Œæˆ–è€…åˆå§‹åŒ– PriorityBlockingQueue æ—¶ï¼ŒæŒ‡å®šæ„é€ å‚æ•° Comparator æ¥å¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚ä½†éœ€è¦æ³¨æ„çš„æ˜¯ä¸èƒ½ä¿è¯åŒä¼˜å…ˆçº§å…ƒç´ çš„é¡ºåºã€‚PriorityBlockingQueue æ˜¯åŸºäºæœ€å°äºŒå‰å †å®ç°ï¼Œä½¿ç”¨åŸºäº CAS å®ç°çš„è‡ªæ—‹é”æ¥æ§åˆ¶é˜Ÿåˆ—çš„åŠ¨æ€æ‰©å®¹ï¼Œä¿è¯äº†æ‰©å®¹æ“ä½œä¸ä¼šé˜»å¡ take æ“ä½œçš„æ‰§è¡Œã€‚ DelayQueueDelayQueue æ˜¯ä¸€ä¸ªä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°çš„å»¶è¿Ÿæ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚ é˜Ÿåˆ—ä½¿ç”¨ PriorityQueue æ¥å®ç°ã€‚é˜Ÿåˆ—ä¸­çš„å…ƒç´ å¿…é¡»å®ç° Delayed æ¥å£ï¼Œåœ¨åˆ›å»ºå…ƒç´ æ—¶å¯ä»¥æŒ‡å®šå¤šä¹…æ‰èƒ½ä»é˜Ÿåˆ—ä¸­è·å–å½“å‰å…ƒç´ ã€‚åªæœ‰åœ¨å»¶è¿ŸæœŸæ»¡æ—¶æ‰èƒ½ä»é˜Ÿåˆ—ä¸­æå–å…ƒç´ ã€‚æˆ‘ä»¬å¯ä»¥å°† DelayQueue è¿ç”¨åœ¨ä»¥ä¸‹åº”ç”¨åœºæ™¯ï¼š ç¼“å­˜ç³»ç»Ÿçš„è®¾è®¡ï¼šå¯ä»¥ç”¨ DelayQueue ä¿å­˜ç¼“å­˜å…ƒç´ çš„æœ‰æ•ˆæœŸï¼Œä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹å¾ªç¯æŸ¥è¯¢ DelayQueueï¼Œä¸€æ—¦èƒ½ä» DelayQueue ä¸­è·å–å…ƒç´ æ—¶ï¼Œè¡¨ç¤ºç¼“å­˜æœ‰æ•ˆæœŸåˆ°äº†ã€‚ å®šæ—¶ä»»åŠ¡è°ƒåº¦ã€‚ä½¿ç”¨ DelayQueue ä¿å­˜å½“å¤©å°†ä¼šæ‰§è¡Œçš„ä»»åŠ¡å’Œæ‰§è¡Œæ—¶é—´ï¼Œä¸€æ—¦ä» DelayQueue ä¸­è·å–åˆ°ä»»åŠ¡å°±å¼€å§‹æ‰§è¡Œï¼Œä»æ¯”å¦‚ Timer å°±æ˜¯ä½¿ç”¨ DelayQueue å®ç°çš„ã€‚ SynchronousQueueSynchronousQueue æ˜¯ä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ï¼Œä¹Ÿå³æ˜¯å•ä¸ªå…ƒç´ çš„é˜Ÿåˆ—ã€‚ æ¯ä¸€ä¸ª put æ“ä½œå¿…é¡»ç­‰å¾…ä¸€ä¸ª take æ“ä½œï¼Œå¦åˆ™ä¸èƒ½ç»§ç»­æ·»åŠ å…ƒç´ ã€‚SynchronousQueue å¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªä¼ çƒæ‰‹ï¼Œè´Ÿè´£æŠŠç”Ÿäº§è€…çº¿ç¨‹å¤„ç†çš„æ•°æ®ç›´æ¥ä¼ é€’ç»™æ¶ˆè´¹è€…çº¿ç¨‹ã€‚é˜Ÿåˆ—æœ¬èº«å¹¶ä¸å­˜å‚¨ä»»ä½•å…ƒç´ ï¼Œéå¸¸é€‚åˆäºä¼ é€’æ€§åœºæ™¯, æ¯”å¦‚åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ä½¿ç”¨çš„æ•°æ®ï¼Œä¼ é€’ç»™å¦å¤–ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼ŒSynchronousQueue çš„ååé‡é«˜äº LinkedBlockingQueue å’Œ ArrayBlockingQueueã€‚ Coding synchronousQueue æ˜¯ä¸€ä¸ªæ²¡æœ‰æ•°æ®ç¼“å†²çš„é˜»å¡é˜Ÿåˆ—ï¼Œç”Ÿäº§è€…çº¿ç¨‹å¯¹å…¶çš„æ’å…¥æ“ä½œ put() å¿…é¡»ç­‰å¾…æ¶ˆè´¹è€…çš„ç§»é™¤æ“ä½œ take()ï¼Œåè¿‡æ¥ä¹Ÿä¸€æ ·ã€‚ å¯¹åº” peek, contains, clear, isEmpty â€¦ ç­‰æ–¹æ³•å…¶å®æ˜¯æ— æ•ˆçš„ã€‚ ä½†æ˜¯ poll() å’Œ offer() å°±ä¸ä¼šé˜»å¡ï¼Œä¸¾ä¾‹æ¥è¯´å°±æ˜¯ offer çš„æ—¶å€™å¦‚æœæœ‰æ¶ˆè´¹è€…åœ¨ç­‰å¾…é‚£ä¹ˆå°±ä¼šç«‹é©¬æ»¡è¶³è¿”å› trueï¼Œå¦‚æœæ²¡æœ‰å°±ä¼šè¿”å› falseï¼Œä¸ä¼šç­‰å¾…æ¶ˆè´¹è€…åˆ°æ¥ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940public class SynchronousQueueDemo &#123; public static void main(String[] args) &#123; BlockingQueue&lt;String&gt; queue = new SynchronousQueue&lt;&gt;(); //System.out.println(queue.offer(&quot;aaa&quot;)); //false //System.out.println(queue.poll()); //null System.out.println(queue.add(&quot;bbb&quot;)); //IllegalStateException: Queue full new Thread(()-&gt;&#123; try &#123; System.out.println(&quot;Thread 1 put a&quot;); queue.put(&quot;a&quot;); System.out.println(&quot;Thread 1 put b&quot;); queue.put(&quot;b&quot;); System.out.println(&quot;Thread 1 put c&quot;); queue.put(&quot;c&quot;); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125;).start(); new Thread(()-&gt;&#123; try &#123; TimeUnit.SECONDS.sleep(2); System.out.println(&quot;Thread 2 get:&quot;+queue.take()); TimeUnit.SECONDS.sleep(2); System.out.println(&quot;Thread 2 get:&quot;+queue.take()); TimeUnit.SECONDS.sleep(2); System.out.println(&quot;Thread 2 get:&quot;+queue.take()); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125;).start(); &#125;&#125; 123456Thread 1 put aThread 2 get:aThread 1 put bThread 2 get:bThread 1 put cThread 2 get:c æºç è§£è¯» ä¸åƒArrayBlockingQueueã€LinkedBlockingDequeä¹‹ç±»çš„é˜»å¡é˜Ÿåˆ—ä¾èµ–AQSå®ç°å¹¶å‘æ“ä½œï¼ŒSynchronousQueueç›´æ¥ä½¿ç”¨CASå®ç°çº¿ç¨‹çš„å®‰å…¨è®¿é—®ã€‚ synchronousQueue æä¾›äº†ä¸¤ä¸ªæ„é€ å™¨ï¼ˆå…¬å¹³ä¸å¦ï¼‰ï¼Œå†…éƒ¨æ˜¯é€šè¿‡ Transferer æ¥å®ç°çš„ï¼Œå…·ä½“åˆ†ä¸ºä¸¤ä¸ªTransfererï¼Œåˆ†åˆ«æ˜¯ TransferStack å’Œ TransferQueueã€‚ TransferStackï¼šéå…¬å¹³ç«äº‰æ¨¡å¼ä½¿ç”¨çš„æ•°æ®ç»“æ„æ˜¯åè¿›å…ˆå‡ºæ ˆ(LIFO Stack) TransferQueueï¼šå…¬å¹³ç«äº‰æ¨¡å¼åˆ™ä½¿ç”¨å…ˆè¿›å…ˆå‡ºé˜Ÿåˆ—ï¼ˆFIFO Queueï¼‰ æ€§èƒ½ä¸Šä¸¤è€…æ˜¯ç›¸å½“çš„ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒFIFO é€šå¸¸å¯ä»¥æ”¯æŒæ›´å¤§çš„ååé‡ï¼Œä½† LIFO å¯ä»¥æ›´å¤§ç¨‹åº¦çš„ä¿æŒçº¿ç¨‹çš„æœ¬åœ°åŒ–ã€‚ 123456789private transient volatile Transferer&lt;E&gt; transferer;public SynchronousQueue() &#123; this(false);&#125;public SynchronousQueue(boolean fair) &#123; transferer = fair ? new TransferQueue&lt;E&gt;() : new TransferStack&lt;E&gt;();&#125; åˆ†æ TransferQueue çš„å®ç° 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758//æ„é€ å‡½æ•°ä¸­ä¼šåˆå§‹åŒ–ä¸€ä¸ªå‡ºé˜Ÿçš„èŠ‚ç‚¹ï¼Œå¹¶ä¸”é¦–å°¾éƒ½æŒ‡å‘è¿™ä¸ªèŠ‚ç‚¹TransferQueue() &#123; QNode h = new QNode(null, false); // initialize to dummy node. head = h; tail = h;&#125;//é˜Ÿåˆ—èŠ‚ç‚¹,static final class QNode &#123; volatile QNode next; // next node in queue volatile Object item; // CAS&#x27;ed to or from null volatile Thread waiter; // to control park/unpark final boolean isData; QNode(Object item, boolean isData) &#123; this.item = item; this.isData = isData; &#125; // è®¾ç½®nextå’Œitemçš„å€¼ï¼Œç”¨äºè¿›è¡Œå¹¶å‘æ›´æ–°, cas æ— é”æ“ä½œ boolean casNext(QNode cmp, QNode val) &#123; return next == cmp &amp;&amp; UNSAFE.compareAndSwapObject(this, nextOffset, cmp, val); &#125; boolean casItem(Object cmp, Object val) &#123; return item == cmp &amp;&amp; UNSAFE.compareAndSwapObject(this, itemOffset, cmp, val); &#125; void tryCancel(Object cmp) &#123; UNSAFE.compareAndSwapObject(this, itemOffset, cmp, this); &#125; boolean isCancelled() &#123; return item == this; &#125; boolean isOffList() &#123; return next == this; &#125; // Unsafe mechanics private static final sun.misc.Unsafe UNSAFE; private static final long itemOffset; private static final long nextOffset; static &#123; try &#123; UNSAFE = sun.misc.Unsafe.getUnsafe(); Class&lt;?&gt; k = QNode.class; itemOffset = UNSAFE.objectFieldOffset (k.getDeclaredField(&quot;item&quot;)); nextOffset = UNSAFE.objectFieldOffset (k.getDeclaredField(&quot;next&quot;)); &#125; catch (Exception e) &#123; throw new Error(e); &#125; &#125;&#125; ä» put() æ–¹æ³•å’Œ take() æ–¹æ³•å¯ä»¥çœ‹å‡ºæœ€ç»ˆè°ƒç”¨çš„éƒ½æ˜¯ TransferQueue çš„ transfer() æ–¹æ³•ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283public void put(E e) throws InterruptedException &#123; if (e == null) throw new NullPointerException(); if (transferer.transfer(e, false, 0) == null) &#123; Thread.interrupted(); throw new InterruptedException(); &#125;&#125;public E take() throws InterruptedException &#123; E e = transferer.transfer(null, false, 0); if (e != null) return e; Thread.interrupted(); throw new InterruptedException();&#125;//transferæ–¹æ³•ç”¨äºæäº¤æ•°æ®æˆ–è€…æ˜¯è·å–æ•°æ®E transfer(E e, boolean timed, long nanos) &#123; QNode s = null; // constructed/reused as needed //å¦‚æœeä¸ä¸ºnullï¼Œå°±è¯´æ˜æ˜¯æ·»åŠ æ•°æ®çš„å…¥é˜Ÿæ“ä½œ boolean isData = (e != null); for (;;) &#123; QNode t = tail; QNode h = head; if (t == null || h == null) // saw uninitialized value continue; // spin //å¦‚æœå½“å‰æ“ä½œå’Œ tail èŠ‚ç‚¹çš„æ“ä½œæ˜¯ä¸€æ ·çš„ï¼›æˆ–è€…å¤´å°¾ç›¸åŒï¼ˆè¡¨æ˜é˜Ÿåˆ—ä¸­å•¥éƒ½æ²¡æœ‰ï¼‰ã€‚ if (h == t || t.isData == isData) &#123; // empty or same-mode QNode tn = t.next; // å¦‚æœ t å’Œ tail ä¸ä¸€æ ·ï¼Œè¯´æ˜ï¼Œtail è¢«å…¶ä»–çš„çº¿ç¨‹æ”¹äº†ï¼Œé‡æ¥ if (t != tail) // inconsistent read continue; // å¦‚æœ tail çš„ next ä¸æ˜¯ç©ºã€‚å°±éœ€è¦å°† next è¿½åŠ åˆ° tail åé¢äº† if (tn != null) &#123; // lagging tail // ä½¿ç”¨ CAS å°† tail.next å˜æˆ tail, advanceTail(t, tn); continue; &#125; // æ—¶é—´åˆ°äº†ï¼Œä¸ç­‰å¾…ï¼Œè¿”å› nullï¼Œæ’å…¥å¤±è´¥ï¼Œè·å–ä¹Ÿæ˜¯å¤±è´¥çš„ if (timed &amp;&amp; nanos &lt;= 0) // can&#x27;t wait return null; if (s == null) s = new QNode(e, isData); if (!t.casNext(null, s)) // failed to link in continue; advanceTail(t, s); // swing tail and wait Object x = awaitFulfill(s, e, timed, nanos); if (x == s) &#123; // wait was cancelled clean(t, s); return null; &#125; if (!s.isOffList()) &#123; // not already unlinked advanceHead(t, s); // unlink if head if (x != null) // and forget fields s.item = s; s.waiter = null; &#125; return (x != null) ? (E)x : e; &#125; else &#123; // complementary-mode QNode m = h.next; // node to fulfill if (t != tail || m == null || h != head) continue; // inconsistent read Object x = m.item; if (isData == (x != null) || // m already fulfilled x == m || // m cancelled !m.casItem(x, e)) &#123; // lost CAS advanceHead(h, m); // dequeue and retry continue; &#125; advanceHead(h, m); // successfully fulfilled LockSupport.unpark(m.waiter); return (x != null) ? (E)x : e; &#125; &#125;&#125; LinkedTransferQueueLinkedTransferQueue æ˜¯ä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æ— ç•Œé˜»å¡ TransferQueue é˜Ÿåˆ—ã€‚ LinkedTransferQueueé‡‡ç”¨ä¸€ç§é¢„å æ¨¡å¼ã€‚æ„æ€å°±æ˜¯æ¶ˆè´¹è€…çº¿ç¨‹å–å…ƒç´ æ—¶ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œåˆ™ç›´æ¥å–èµ°æ•°æ®ï¼Œè‹¥é˜Ÿåˆ—ä¸ºç©ºï¼Œé‚£å°±ç”Ÿæˆä¸€ä¸ªèŠ‚ç‚¹ï¼ˆèŠ‚ç‚¹å…ƒç´ ä¸ºnullï¼‰å…¥é˜Ÿï¼Œç„¶åæ¶ˆè´¹è€…çº¿ç¨‹è¢«ç­‰å¾…åœ¨è¿™ä¸ªèŠ‚ç‚¹ä¸Šï¼Œåé¢ç”Ÿäº§è€…çº¿ç¨‹å…¥é˜Ÿæ—¶å‘ç°æœ‰ä¸€ä¸ªå…ƒç´ ä¸ºnullçš„èŠ‚ç‚¹ï¼Œç”Ÿäº§è€…çº¿ç¨‹å°±ä¸å…¥é˜Ÿäº†ï¼Œç›´æ¥å°±å°†å…ƒç´ å¡«å……åˆ°è¯¥èŠ‚ç‚¹ï¼Œå¹¶å”¤é†’è¯¥èŠ‚ç‚¹ç­‰å¾…çš„çº¿ç¨‹ï¼Œè¢«å”¤é†’çš„æ¶ˆè´¹è€…çº¿ç¨‹å–èµ°å…ƒç´ ï¼Œä»è°ƒç”¨çš„æ–¹æ³•è¿”å›ã€‚æˆ‘ä»¬ç§°è¿™ç§èŠ‚ç‚¹æ“ä½œä¸ºâ€œåŒ¹é…â€æ–¹å¼ã€‚ é˜Ÿåˆ—å®ç°äº† TransferQueue æ¥å£é‡å†™äº† tryTransfer å’Œ transfer æ–¹æ³•ï¼Œè¿™ç»„æ–¹æ³•å’Œ SynchronousQueue å…¬å¹³æ¨¡å¼çš„é˜Ÿåˆ—ç±»ä¼¼ï¼Œå…·æœ‰åŒ¹é…çš„åŠŸèƒ½ LinkedBlockingDequeLinkedBlockingDeque æ˜¯ä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„åŒå‘é˜»å¡é˜Ÿåˆ—ã€‚ æ‰€è°“åŒå‘é˜Ÿåˆ—æŒ‡çš„ä½ å¯ä»¥ä»é˜Ÿåˆ—çš„ä¸¤ç«¯æ’å…¥å’Œç§»å‡ºå…ƒç´ ã€‚åŒç«¯é˜Ÿåˆ—å› ä¸ºå¤šäº†ä¸€ä¸ªæ“ä½œé˜Ÿåˆ—çš„å…¥å£ï¼Œåœ¨å¤šçº¿ç¨‹åŒæ—¶å…¥é˜Ÿæ—¶ï¼Œä¹Ÿå°±å‡å°‘äº†ä¸€åŠçš„ç«äº‰ã€‚ç›¸æ¯”å…¶ä»–çš„é˜»å¡é˜Ÿåˆ—ï¼ŒLinkedBlockingDeque å¤šäº† addFirstï¼ŒaddLastï¼ŒofferFirstï¼ŒofferLastï¼ŒpeekFirstï¼ŒpeekLast ç­‰æ–¹æ³•ï¼Œä»¥ First å•è¯ç»“å°¾çš„æ–¹æ³•ï¼Œè¡¨ç¤ºæ’å…¥ï¼Œè·å–ï¼ˆpeekï¼‰æˆ–ç§»é™¤åŒç«¯é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚ä»¥ Last å•è¯ç»“å°¾çš„æ–¹æ³•ï¼Œè¡¨ç¤ºæ’å…¥ï¼Œè·å–æˆ–ç§»é™¤åŒç«¯é˜Ÿåˆ—çš„æœ€åä¸€ä¸ªå…ƒç´ ã€‚å¦å¤–æ’å…¥æ–¹æ³• add ç­‰åŒäº addLastï¼Œç§»é™¤æ–¹æ³• remove ç­‰æ•ˆäº removeFirstã€‚ åœ¨åˆå§‹åŒ– LinkedBlockingDeque æ—¶å¯ä»¥è®¾ç½®å®¹é‡é˜²æ­¢å…¶è¿‡æ¸¡è†¨èƒ€ï¼Œé»˜è®¤å®¹é‡ä¹Ÿæ˜¯ Integer.MAX_VALUEã€‚å¦å¤–åŒå‘é˜»å¡é˜Ÿåˆ—å¯ä»¥è¿ç”¨åœ¨â€œå·¥ä½œçªƒå–â€æ¨¡å¼ä¸­ã€‚ é˜»å¡é˜Ÿåˆ—ä½¿ç”¨åœºæ™¯æˆ‘ä»¬å¸¸ç”¨çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼å°±å¯ä»¥åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ï¼› çº¿ç¨‹æ± ä¸­æ´»è·ƒçº¿ç¨‹æ•°è¾¾åˆ° corePoolSize æ—¶ï¼Œçº¿ç¨‹æ± å°†ä¼šå°†åç»­çš„ task æäº¤åˆ° BlockingQueue ä¸­ï¼› ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼JDK APIæ–‡æ¡£çš„ BlockingQueue ç»™å‡ºäº†ä¸€ä¸ªå…¸å‹çš„åº”ç”¨ é¢è¯•é¢˜ï¼šä¸€ä¸ªåˆå§‹å€¼ä¸º 0 çš„å˜é‡ï¼Œä¸¤ä¸ªçº¿ç¨‹å¯¹é½äº¤æ›¿æ“ä½œï¼Œä¸€ä¸ª+1ï¼Œä¸€ä¸ª-1ï¼Œ5 è½® 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869public class ProdCounsume_TraditionDemo &#123; public static void main(String[] args) &#123; ShareData shareData = new ShareData(); new Thread(() -&gt; &#123; for (int i = 0; i &lt;= 5; i++) &#123; shareData.increment(); &#125; &#125;, &quot;T1&quot;).start(); new Thread(() -&gt; &#123; for (int i = 0; i &lt;= 5; i++) &#123; shareData.decrement(); &#125; &#125;, &quot;T1&quot;).start(); &#125;&#125;//çº¿ç¨‹æ“ä½œèµ„æºç±»class ShareData &#123; private int num = 0; private Lock lock = new ReentrantLock(); private Condition condition = lock.newCondition(); public void increment() &#123; lock.lock(); try &#123; while (num != 0) &#123; //ç­‰å¾…ï¼Œä¸èƒ½ç”Ÿäº§ condition.await(); &#125; //å¹²æ´» num++; System.out.println(Thread.currentThread().getName() + &quot;\\t&quot; + num); //å”¤é†’ condition.signal(); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; finally &#123; lock.unlock(); &#125; &#125; public void decrement() &#123; lock.lock(); try &#123; while (num == 0) &#123; //ç­‰å¾…ï¼Œä¸èƒ½ç”Ÿäº§ condition.await(); &#125; //å¹²æ´» num--; System.out.println(Thread.currentThread().getName() + &quot;\\t&quot; + num); //å”¤é†’ condition.signal(); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; finally &#123; lock.unlock(); &#125; &#125;&#125; çº¿ç¨‹æ± çº¿ç¨‹æ± çš„æ ¸å¿ƒæ–¹æ³• ThreadPoolExecutorï¼Œç”¨ BlockingQueue å­˜æ”¾ä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ—ï¼Œè¢«æäº¤ä½†å°šæœªè¢«æ‰§è¡Œçš„ä»»åŠ¡ 1234567public ThreadPoolExecutor(int corePoolSize, int maximumPoolSize, long keepAliveTime, TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue, ThreadFactory threadFactory, RejectedExecutionHandler handler) çº¿ç¨‹æ± åœ¨å†…éƒ¨å®é™…ä¹Ÿæ˜¯æ„å»ºäº†ä¸€ä¸ªç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼Œå°†çº¿ç¨‹å’Œä»»åŠ¡ä¸¤è€…è§£è€¦ï¼Œå¹¶ä¸ç›´æ¥å…³è”ï¼Œä»è€Œè‰¯å¥½çš„ç¼“å†²ä»»åŠ¡ï¼Œå¤ç”¨çº¿ç¨‹ã€‚ ä¸åŒçš„çº¿ç¨‹æ± å®ç°ç”¨çš„æ˜¯ä¸åŒçš„é˜»å¡é˜Ÿåˆ—ï¼ŒnewFixedThreadPool å’Œ newSingleThreadExecutor ç”¨çš„æ˜¯LinkedBlockingQueueï¼ŒnewCachedThreadPool ç”¨çš„æ˜¯ SynchronousQueueã€‚ å‚è€ƒï¼š Java 7 ç§é˜»å¡é˜Ÿåˆ—è¯¦è§£ - è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒº-è…¾è®¯äº‘ (tencent.com)","categories":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"https://xssdpgy.github.io/categories/%E6%8A%80%E6%9C%AF/"}],"tags":[{"name":"é˜Ÿåˆ—","slug":"é˜Ÿåˆ—","permalink":"https://xssdpgy.github.io/tags/%E9%98%9F%E5%88%97/"}]},{"title":"TimeLimiteræ¥å£è¶…æ—¶ä¸­æ–­å®ç°åˆ†æ","slug":"TimeLimiteræ¥å£è¶…æ—¶ä¸­æ–­å®ç°åˆ†æ","date":"2023-01-31T10:04:32.000Z","updated":"2023-02-07T16:26:00.599Z","comments":true,"path":"2023/01/31/TimeLimiteræ¥å£è¶…æ—¶ä¸­æ–­å®ç°åˆ†æ/","link":"","permalink":"https://xssdpgy.github.io/2023/01/31/TimeLimiter%E6%8E%A5%E5%8F%A3%E8%B6%85%E6%97%B6%E4%B8%AD%E6%96%AD%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90/","excerpt":"0.èƒŒæ™¯","text":"0.èƒŒæ™¯ å‰æ®µæ—¶é—´ï¼Œå…¶ä»–ç»„åŒäº‹æ‰¾åˆ°æˆ‘ï¼Œè¯´è®©æˆ‘ååŠ©çœ‹ä¸€ä¸ªäº‹åŠ¡æœªå›æ»šé—®é¢˜ï¼Œåˆšå¼€å§‹ä»¥ä¸ºæ˜¯äº‹åŠ¡éš”ç¦»è®¾ç½®æ–¹é¢çš„åŸå› ï¼Œç»“æœåŸå› å¾ˆç®€å•ï¼Œå› ä¸ºè¦ç»™æ¥å£æ·»åŠ è¶…æ—¶ä¸­æ–­çš„åŠŸèƒ½ï¼Œä»–æ ¹æ®ç½‘ä¸Šæ–‡ç« ä½¿ç”¨java.util.concurrent.Future#get(long, java.util.concurrent.TimeUnit)æ¥å®ç°è¶…æ—¶ä¸­æ–­åŠŸèƒ½ï¼Œç»“æœè¶…æ—¶åŠŸèƒ½å®ç°äº†ï¼Œä½†æ˜¯è¶…æ—¶æŠ›å‡ºå¼‚å¸¸åæ¥å£äº‹åŠ¡æ²¡æœ‰å›æ»šï¼Œæˆ‘çœ‹äº†ä¸‹ä»£ç ï¼Œä¸»è¦åŸå› æ˜¯æ–¹æ³•ä¸­ä½¿ç”¨çš„æ˜¯å£°æ˜å¼äº‹åŠ¡ï¼Œå¯¹äºæ–°å¼•å…¥çš„å¼‚æ­¥ä»»åŠ¡æ¥è¯´äº‹åŠ¡ç®¡ç†ç²’åº¦å¤ªç²—ç³™ï¼Œä¸”æ•è·è¶…æ—¶å¼‚å¸¸åï¼Œä»»åŠ¡æœªæ‰‹åŠ¨å–æ¶ˆã€‚ä¸‹æ„è¯†å‡†å¤‡è°ƒæ•´ä¸ºç¼–ç¨‹å¼äº‹åŠ¡æ¥ä½¿äº‹åŠ¡ç®¡ç†ç»†åŒ–ï¼Œç»“æœåˆšè¦ä¸‹æ‰‹æ—¶æƒ³åˆ°ä¸æ˜¯æœ‰ç°æˆçš„è½®å­å˜›ï¼Œä¸‹é¢å°±è¯¥è½®å­â€”â€”guavaçš„TimeLimiterè¿›è¡Œç®€è¦ä»‹ç»ã€‚ 1.ä½¿ç”¨åœºæ™¯æè¿°ç½‘ä¸Šæ‰¾äº†æ®µè¯æè¿°æ¥å£è¶…æ—¶ä¸­æ–­çš„éœ€æ±‚åœºæ™¯ï¼š å¦‚æœè°ƒç”¨æ–¹æ³•è¶…è¿‡1ç§’ï¼Œå°±åº”è¯¥åœæ­¢è°ƒç”¨ï¼Œä¸è¦ä¸€ç›´é˜»å¡ä¸‹å»ï¼Œé˜²æ­¢æŠŠæœ¬èº«çš„æœåŠ¡èµ„æºææŒ‚ã€‚ åœ¨ä¸å¯é¢„çŸ¥å¯èƒ½å‡ºç°æ­»é”&#x2F;æ­»å¾ªç¯çš„ä»£ç ï¼Œè¦åŠ ä¸Šæ—¶é—´çš„é˜€å€¼ï¼Œé¿å…é˜»å¡ã€‚ 2.TimeLimiterå®ç°æ¥å£è¶…æ—¶ä¸­æ–­guavaå·¥å…·åŒ…é‡Œé¢åŒ…å«äº†è¶…æ—¶çš„æ§åˆ¶æ–¹æ³•ã€‚å³TimeLimiter æ¥å£ï¼Œå…¶æœ‰ä¸¤ä¸ªå®ç°ç±»ã€‚ FakeTimeLimiter, å¸¸ç”¨äºdebugè°ƒè¯•æ—¶ï¼Œé™åˆ¶æ—¶é—´è¶…æ—¶è°ƒè¯•ã€‚ SimpleTimeLimiter å¸¸ç”¨äºæ­£å¼æ–¹æ³•ä¸­ï¼Œè°ƒç”¨æ–¹æ³•è¶…æ—¶ï¼Œå³æŠ›å‡ºå¼‚å¸¸ã€‚ æˆ‘ä»¬åœ¨å®é™…å¼€å‘ä¸­ä¹Ÿæ˜¯ä½¿ç”¨SimpleTimeLimiteræ¥å®ç°è¶…æ—¶æ§åˆ¶åŠŸèƒ½ï¼Œå…¶æœ‰ä¸¤ç§å®ç°æ¨¡å¼ï¼šä»£ç†æ¨¡å¼ï¼Œå›è°ƒæ¨¡å¼ã€‚å®ç°å¾ˆç®€å•ï¼Œçœ‹ä»£ç å³å¯äº†è§£ã€‚ 3.SimpleTimeLimiter çš„æºç å®ç°3.1 ä»£ç†æ¨¡å¼ com.google.common.util.concurrent.SimpleTimeLimiter#newProxy 12345678910111213141516171819202122232425262728293031323334@Override public &lt;T&gt; T newProxy(final T target, Class&lt;T&gt; interfaceType, final long timeoutDuration, final TimeUnit timeoutUnit) &#123; checkNotNull(target); checkNotNull(interfaceType); checkNotNull(timeoutUnit); checkArgument(timeoutDuration &gt; 0, &quot;bad timeout: %s&quot;, timeoutDuration); checkArgument(interfaceType.isInterface(), &quot;interfaceType must be an interface type&quot;); final Set&lt;Method&gt; interruptibleMethods = findInterruptibleMethods(interfaceType); InvocationHandler handler = new InvocationHandler() &#123; @Override public Object invoke(Object obj, final Method method, final Object[] args) throws Throwable &#123; Callable&lt;Object&gt; callable = new Callable&lt;Object&gt;() &#123; @Override public Object call() throws Exception &#123; try &#123; return method.invoke(target, args); &#125; catch (InvocationTargetException e) &#123; throwCause(e, false); throw new AssertionError(&quot;can&#x27;t get here&quot;); &#125; &#125; &#125;; return callWithTimeout(callable, timeoutDuration, timeoutUnit, interruptibleMethods.contains(method)); &#125; &#125;; return newProxy(interfaceType, handler); &#125; 3.2 å›è°ƒæ¨¡å¼ com.google.common.util.concurrent.SimpleTimeLimiter#callWithTimeout 1234567891011121314151617181920212223242526272829@Override public &lt;T&gt; T callWithTimeout(Callable&lt;T&gt; callable, long timeoutDuration, TimeUnit timeoutUnit, boolean amInterruptible) throws Exception &#123; checkNotNull(callable); checkNotNull(timeoutUnit); checkArgument(timeoutDuration &gt; 0, &quot;timeout must be positive: %s&quot;, timeoutDuration); Future&lt;T&gt; future = executor.submit(callable); try &#123; if (amInterruptible) &#123; try &#123; //å®é™…ä¹Ÿæ˜¯é€šè¿‡Future#get(long, java.util.concurrent.TimeUnit)å®ç°è¶…æ—¶ return future.get(timeoutDuration, timeoutUnit); &#125; catch (InterruptedException e) &#123; future.cancel(true); throw e; &#125; &#125; else &#123; return Uninterruptibles.getUninterruptibly(future, timeoutDuration, timeoutUnit); &#125; &#125; catch (ExecutionException e) &#123; throw throwCause(e, true); &#125; catch (TimeoutException e) &#123; //è¶…æ—¶å¼‚å¸¸å–æ¶ˆä»»åŠ¡å¹¶æŠ›å‡ºUncheckedTimeoutExceptionå¼‚å¸¸ future.cancel(true); throw new UncheckedTimeoutException(e); &#125; &#125; ä»£ç†æ¨¡å¼ä¸»è¦é’ˆå¯¹ç±»ï¼Œå›è°ƒæ¨¡å¼å¯ä»¥é’ˆå¯¹æŸéƒ¨åˆ†ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°ä»£ç†æ¨¡å¼ä¹Ÿæ˜¯åŸºäºå›è°ƒæ¨¡å¼æ–¹æ³•åšäº†å±‚ä»£ç å°è£…ï¼Œè¶…æ—¶æ§åˆ¶çš„åº•å±‚å®ç°è¿˜æ˜¯åœ¨SimpleTimeLimiter#callWithTimeoutï¼Œå…¶åŸºäºFuture#get(long, java.util.concurrent.TimeUnit)å®ç°è¶…æ—¶ï¼Œå› æ­¤SimpleTimeLimiteræœ¬è´¨ä¸Šä¹Ÿæ˜¯ä½¿ç”¨äº†JDKä¸­çš„Futureå¯¹è±¡å®ç°äº†è¶…æ—¶ä¸­æ–­æ§åˆ¶ã€‚ ç»“åˆä»£ç†æ¨¡å¼è°ƒç”¨è¶…æ—¶é“¾è·¯å³å¾ˆæ¸…æ™°çš„å±•ç¤ºè¶…æ—¶ä¸­æ–­æ§åˆ¶å®ç°ï¼Œæ­¤æ—¶æ¥å£ä»æ—§ä½¿ç”¨å£°æ˜å¼äº‹åŠ¡ï¼Œè¶…æ—¶åäº‹åŠ¡æ­£å¸¸å›æ»šã€‚","categories":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"https://xssdpgy.github.io/categories/%E6%8A%80%E6%9C%AF/"}],"tags":[{"name":"timeLimit","slug":"timeLimit","permalink":"https://xssdpgy.github.io/tags/timeLimit/"},{"name":"æºç åˆ†æ","slug":"æºç åˆ†æ","permalink":"https://xssdpgy.github.io/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"}]},{"title":"Seataå®¢æˆ·ç«¯é›†æˆåŠAT&TCCäº‹åŠ¡æ¨¡å¼æ¼”ç¤º","slug":"Seataå®¢æˆ·ç«¯é›†æˆåŠAT&TCCäº‹åŠ¡æ¨¡å¼æ¼”ç¤º","date":"2023-01-30T02:54:43.000Z","updated":"2023-02-07T16:26:00.598Z","comments":true,"path":"2023/01/30/Seataå®¢æˆ·ç«¯é›†æˆåŠAT&TCCäº‹åŠ¡æ¨¡å¼æ¼”ç¤º/","link":"","permalink":"https://xssdpgy.github.io/2023/01/30/Seata%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%9B%86%E6%88%90%E5%8F%8AAT&TCC%E4%BA%8B%E5%8A%A1%E6%A8%A1%E5%BC%8F%E6%BC%94%E7%A4%BA/","excerpt":"0.å‰è¨€ç®€è¦è¯´ä¸‹èƒŒæ™¯ï¼Œå½“å‰ä½¿ç”¨seataæ˜¯åŸºäºå®˜æ–¹1.5.2ç‰ˆæœ¬å¼€å‘çš„ï¼Œæ‰€ä»¥é›†æˆè¿‡ç¨‹å¯ä¾›1.5.2åŠä¹‹åç‰ˆæœ¬çš„ä½¿ç”¨è€…å‚è€ƒï¼Œä¸ºåŒºåˆ«äºå®˜æ–¹ç‰ˆæœ¬ï¼Œå†…éƒ¨ç‰ˆæœ¬å·è®¾ç½®ä¸º1.5.2.2ã€‚è®¾è®¡demoæ¼”ç¤ºå…¨å±€äº‹åŠ¡ï¼Œæ‰§è¡Œæµç¨‹å¦‚ä¸‹ã€‚ demoä¸šåŠ¡æµç¨‹è®¾è®¡","text":"0.å‰è¨€ç®€è¦è¯´ä¸‹èƒŒæ™¯ï¼Œå½“å‰ä½¿ç”¨seataæ˜¯åŸºäºå®˜æ–¹1.5.2ç‰ˆæœ¬å¼€å‘çš„ï¼Œæ‰€ä»¥é›†æˆè¿‡ç¨‹å¯ä¾›1.5.2åŠä¹‹åç‰ˆæœ¬çš„ä½¿ç”¨è€…å‚è€ƒï¼Œä¸ºåŒºåˆ«äºå®˜æ–¹ç‰ˆæœ¬ï¼Œå†…éƒ¨ç‰ˆæœ¬å·è®¾ç½®ä¸º1.5.2.2ã€‚è®¾è®¡demoæ¼”ç¤ºå…¨å±€äº‹åŠ¡ï¼Œæ‰§è¡Œæµç¨‹å¦‚ä¸‹ã€‚ demoä¸šåŠ¡æµç¨‹è®¾è®¡ 1.Seataå®¢æˆ·ç«¯é›†æˆ1.1 å¼•å…¥ä¾èµ–12345678910111213141516171819202122&lt;!-- springbooté¡¹ç›®ï¼Œå¼•å…¥seata-spring-boot-starterä¾èµ– --&gt;&lt;dependency&gt; &lt;groupId&gt;io.seata&lt;/groupId&gt; &lt;artifactId&gt;seata-spring-boot-starter&lt;/artifactId&gt; &lt;version&gt;1.5.2.2&lt;/version&gt;&lt;/dependency&gt; &lt;!-- ä¸ºä¿è¯å¾®æœåŠ¡é—´xidé€ä¼ ï¼Œå¼•å…¥æ­¤ä¾èµ–ï¼ˆæ³¨æ„ï¼Œéœ€æ’é™¤å¼•å…¥å…¶ä»–ç‰ˆæœ¬seataä¾èµ–çš„å½±å“ï¼‰ --&gt;&lt;dependency&gt; &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-alibaba-seata&lt;/artifactId&gt; &lt;version&gt;1.5.1.RELEASE&lt;/version&gt; &lt;exclusions&gt; &lt;exclusion&gt; &lt;groupId&gt;io.seata&lt;/groupId&gt; &lt;artifactId&gt;seata-spring-boot-starter&lt;/artifactId&gt; &lt;/exclusion&gt; &lt;exclusion&gt; &lt;groupId&gt;io.seata&lt;/groupId&gt; &lt;artifactId&gt;seata-all&lt;/artifactId&gt; &lt;/exclusion&gt; &lt;/exclusions&gt;&lt;/dependency&gt; é¡¹ç›®seataç›¸å…³ä¾èµ–ç‰ˆæœ¬ç»Ÿä¸€å¦‚ä¸‹ï¼š 1.2 é…ç½®ä»¥fundpayæœåŠ¡ä¸ºä¾‹ï¼Œé…ç½®æ–‡ä»¶ä¸­æ–°å¢é…ç½®ï¼Œä¸»è¦ä¸ºseataå®¢æˆ·ç«¯æœåŠ¡é…ç½®æ³¨å†Œä¸­å¿ƒåŠvgroupMappingè®¾ç½®ã€‚ ä¹‹åå¯å¯åŠ¨seata-serveræœåŠ¡ç«¯ï¼Œå†å¯åŠ¨fundpayå®¢æˆ·ç«¯æœåŠ¡æŸ¥çœ‹æ˜¯å¦æ­£å¸¸å¯åŠ¨åŠæ³¨å†Œã€‚å¦‚ä¸‹æ—¥å¿—å³ä¸ºå®¢æˆ·ç«¯æœåŠ¡å¯åŠ¨æˆåŠŸå¹¶æˆåŠŸæ³¨å†Œåˆ°seata-serveræœåŠ¡ç«¯æ—¶ï¼Œseata-serveræœåŠ¡ç«¯çš„è¾“å‡ºï¼ˆæ‰“å°å‰ä¸¤è¡Œæ—¥å¿—å³å¯è§†ä¸ºæˆåŠŸï¼‰ã€‚ å…¶ä»–å¾®æœåŠ¡æŒ‰æ­¤æ–¹å¼é›†æˆæ³¨å†Œã€‚ é›†æˆæˆåŠŸåï¼ŒæœåŠ¡é—´æ‹“æ‰‘å¦‚ä¸‹ 2.ATäº‹åŠ¡æ¨¡å¼å¼€å‘é…ç½®ATäº‹åŠ¡æ¨¡å¼ä»£ç ä¾µå…¥æ€§ä½ï¼Œå¯ä»¥åŸºæœ¬ä¿æŒä¹‹å‰çš„ä»£ç ç»“æ„ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåªéœ€è¦åœ¨å…¥å£ä¸šåŠ¡æ–¹æ³•å®ç°ä¸Šæ·»åŠ @GlobalTransactionalæ³¨è§£å³å¯ã€‚ åŸå…ˆæ¥å£ä¸»è¦ä»£ç å®ç°å¦‚ä¸‹ï¼š åœ¨com.boss.fundpay.service.impl.PayServiceImpl#payä¸šåŠ¡å®ç°æ–¹æ³•ä¸Šæ·»åŠ å…¨å±€äº‹åŠ¡æ³¨è§£ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152 @Override @GlobalTransactional(rollbackFor = Exception.class,timeoutMills = 60000) public ApiResultDTO pay(PayInfoDto payInfo) throws Exception &#123; //1.è®°å½•å½“å‰æ“ä½œ PayLog payLog = new PayLog(); BeanUtil.copyProperties(payInfo,payLog); payLog.setBgtId(IdUtil.simpleUUID()); String curDate = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;).format(new Date()); payLog.setPayTime(curDate); payLogDao.insertPayLog(payLog); String orderNo = payInfo.getOrderNo(); String merchantId = payInfo.getMerchantId(); //2.è°ƒç”¨æµç¨‹å®¡æ ¸ RiskAuditReq riskAuditReq = new RiskAuditReq(); riskAuditReq.setMerchantId(merchantId); riskAuditReq.setOrderNo(orderNo); ApiResultDTO workflowResult = workflowFeignApi.riskAudit(riskAuditReq); if(Objects.isNull(workflowResult)||ApiResultDTO.hasError(workflowResult) ||(!PASS.equals(workflowResult.getResult())))&#123; throw new Exception(); &#125; //è·å–å•†æˆ·ä½™é¢ MerchantBanlanceRecord record = merchantBalanceRecordDao.selectBalanceRecordById(merchantId); BigDecimal balance = record.getTotalBalance().add(payInfo.getTotalAmount()); //3.è°ƒç”¨è®°è´¦ IncreaseBillReq increaseBillReq = new IncreaseBillReq(); increaseBillReq.setOrderNo(orderNo); increaseBillReq.setAccountAmount(balance); increaseBillReq.setMerchantId(merchantId); ApiResultDTO accountResult = accountFeignApi.increaseBill(increaseBillReq); if(Objects.isNull(accountResult)||ApiResultDTO.hasError(accountResult))&#123; throw new Exception(); &#125; //4.å›å†™æœ¬åœ°è¡¨ record.setPayType(payLog.getPayType()); record.setPayTime(payLog.getPayTime()); record.setOrderNo(payLog.getOrderNo()); record.setTotalAmount(payLog.getTotalAmount()); record.setTotalBalance(balance); merchantBalanceRecordDao.updateBalanceRecord(record);//åˆ›é€ å¼‚å¸¸è§¦å‘å›æ»š// int a = RandomUtil.randomInt(10);// if(a==5)&#123;// int b=1/0;// &#125; //å®Œæˆ return ApiResultDTO.success(&quot;æˆåŠŸäº† order=&quot;+orderNo+&quot; ,merchantId=&quot;+merchantId+&quot; ,balance=&quot;+balance); &#125; åœ¨ATæ¨¡å¼ä¸‹ï¼ŒworkflowæœåŠ¡å’ŒaccountæœåŠ¡çš„ä»£ç é€»è¾‘ä¸éœ€è¦è°ƒæ•´ã€‚ 3.TCCäº‹åŠ¡æ¨¡å¼å¼€å‘é…ç½®3.1 ä¸¤é˜¶æ®µæäº¤å›é¡¾å›é¡¾ä¸‹å®˜ç½‘æè¿°ï¼Œä¸€ä¸ªåˆ†å¸ƒå¼çš„å…¨å±€äº‹åŠ¡ï¼Œæ•´ä½“æ˜¯ ä¸¤é˜¶æ®µæäº¤ çš„æ¨¡å‹ã€‚å…¨å±€äº‹åŠ¡æ˜¯ç”±è‹¥å¹²åˆ†æ”¯äº‹åŠ¡ç»„æˆçš„ï¼Œåˆ†æ”¯äº‹åŠ¡è¦æ»¡è¶³ ä¸¤é˜¶æ®µæäº¤ çš„æ¨¡å‹è¦æ±‚ï¼Œå³éœ€è¦æ¯ä¸ªåˆ†æ”¯äº‹åŠ¡éƒ½å…·å¤‡è‡ªå·±çš„ï¼š ä¸€é˜¶æ®µ prepare è¡Œä¸º äºŒé˜¶æ®µ commit æˆ– rollback è¡Œä¸º æ ¹æ®ä¸¤é˜¶æ®µè¡Œä¸ºæ¨¡å¼çš„ä¸åŒï¼Œå°†åˆ†æ”¯äº‹åŠ¡åˆ’åˆ†ä¸º Automatic (Branch) Transaction Mode å’Œ TCC (Branch) Transaction Modeã€‚ AT æ¨¡å¼åŸºäº æ”¯æŒæœ¬åœ° ACID äº‹åŠ¡ çš„ å…³ç³»å‹æ•°æ®åº“ï¼š ä¸€é˜¶æ®µ prepare è¡Œä¸ºï¼šåœ¨æœ¬åœ°äº‹åŠ¡ä¸­ï¼Œä¸€å¹¶æäº¤ä¸šåŠ¡æ•°æ®æ›´æ–°å’Œç›¸åº”å›æ»šæ—¥å¿—è®°å½•ã€‚ äºŒé˜¶æ®µ commit è¡Œä¸ºï¼šé©¬ä¸ŠæˆåŠŸç»“æŸï¼Œè‡ªåŠ¨ å¼‚æ­¥æ‰¹é‡æ¸…ç†å›æ»šæ—¥å¿—ã€‚ äºŒé˜¶æ®µ rollback è¡Œä¸ºï¼šé€šè¿‡å›æ»šæ—¥å¿—ï¼Œè‡ªåŠ¨ ç”Ÿæˆè¡¥å¿æ“ä½œï¼Œå®Œæˆæ•°æ®å›æ»šã€‚ ç›¸åº”çš„ï¼ŒTCC æ¨¡å¼ï¼Œä¸ä¾èµ–äºåº•å±‚æ•°æ®èµ„æºçš„äº‹åŠ¡æ”¯æŒï¼š ä¸€é˜¶æ®µ prepare è¡Œä¸ºï¼šè°ƒç”¨ è‡ªå®šä¹‰ çš„ prepare é€»è¾‘ã€‚ äºŒé˜¶æ®µ commit è¡Œä¸ºï¼šè°ƒç”¨ è‡ªå®šä¹‰ çš„ commit é€»è¾‘ã€‚ äºŒé˜¶æ®µ rollback è¡Œä¸ºï¼šè°ƒç”¨ è‡ªå®šä¹‰ çš„ rollback é€»è¾‘ã€‚ æ€»ä¹‹ï¼ŒTCCäº‹åŠ¡æ¨¡å¼éœ€è¦å¯¹ä»£ç é€»è¾‘è¿›è¡Œé‡æ–°è®¾è®¡ï¼Œä¸»è¦æ˜¯éœ€è¦æŒ‰ç…§ ä¸¤é˜¶æ®µæäº¤ çš„æ¨¡å‹è¦æ±‚ï¼Œå¼€å‘è‡ªå®šä¹‰çš„åˆ†æ”¯äº‹åŠ¡ï¼Œå°†å…¶çº³å…¥å…¨å±€äº‹åŠ¡çš„ç®¡ç†ä¸­ã€‚ 3.2 æ¥å£å®ç°æ–¹æ³•æ‹†åˆ†å¦‚ä¸‹é¢ç¤ºä¾‹ï¼Œpayæ–¹æ³•éœ€è¦åœ¨æ¥å£å±‚æ‹†åˆ†å‡ºprepareã€confirmã€rollbackä¸‰ä¸ªå­æ–¹æ³•ï¼Œå°†å¯¹åº”çš„ä»£ç é€»è¾‘æ‹†åˆ†åˆ°å¯¹åº”å­æ–¹æ³•å®ç°ä¸­ï¼Œå…¶ä»–æœåŠ¡ä¹ŸæŒ‰æ­¤æ¨¡å‹æ€æƒ³è¿›è¡Œä»£ç æ‹†åˆ†ã€‚ fundpayå®ç°æ‹†åˆ†ç¤ºä¾‹ï¼ˆä»…æ‹†åˆ†fundpayè‡ªèº«çš„ä¸šåŠ¡DBæ“ä½œï¼Œæ¶‰åŠè¿œç¨‹è°ƒç”¨çš„ä¸éœ€è€ƒè™‘ï¼Œè¯¦æƒ…è§ä¸‹èŠ‚ï¼‰ workflowå®ç°æ‹†åˆ†ç¤ºä¾‹ ä¸šåŠ¡å®ç°çš„ç²’åº¦æ‹†åˆ†éœ€è¦å¼€å‘äººå‘˜åˆç†æŠŠæ§ accountæœåŠ¡æ‹†åˆ†åŸºæœ¬ç›¸åŒï¼Œè¿™é‡Œçœç•¥ã€‚ 3.3 å…¥å£ä¸šåŠ¡æ–¹æ³•ç‹¬ç«‹ä¸ŠèŠ‚æ˜¯å°†å„ä¸ªå¾®æœåŠ¡çš„ä¸šåŠ¡å®ç°ä»£ç æŒ‰ç…§ äºŒé˜¶æ®µæäº¤ çš„æ€æƒ³è¿›è¡Œäº†æ‹†åˆ†ï¼Œå›åˆ°ä¸šåŠ¡å…¥å£æ–¹æ³•è¿™é‡Œï¼Œä¸å¯èƒ½ä¹Ÿä¸åº”è¯¥åœ¨fundpayæœåŠ¡æ‹†åˆ†åçš„äºŒé˜¶æ®µæ–¹æ³•ä¸­æ‰§è¡Œè¿œç¨‹è°ƒç”¨ï¼Œæ‰€ä»¥ç‹¬ç«‹å‡ºå•ç‹¬çš„å…¥å£æ–¹æ³•Actionï¼Œæ‰§è¡Œæ•´ä½“çš„ä¸šåŠ¡é€»è¾‘ï¼ˆå«æœåŠ¡é—´è¿œç¨‹è°ƒç”¨ï¼‰ï¼Œå°†å„åˆ†æ”¯äº‹åŠ¡çº³å…¥å…¨å±€äº‹åŠ¡çš„æ§åˆ¶ä¸­ã€‚","categories":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"https://xssdpgy.github.io/categories/%E6%8A%80%E6%9C%AF/"}],"tags":[{"name":"seata","slug":"seata","permalink":"https://xssdpgy.github.io/tags/seata/"},{"name":"åˆ†å¸ƒå¼äº‹åŠ¡","slug":"åˆ†å¸ƒå¼äº‹åŠ¡","permalink":"https://xssdpgy.github.io/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"}]},{"title":"Seataæºç ç»“æ„åŠäº‹åŠ¡æ¨¡å¼ä»‹ç»","slug":"Seataæºç ç»“æ„åŠäº‹åŠ¡æ¨¡å¼ä»‹ç»","date":"2023-01-30T02:06:29.000Z","updated":"2023-02-07T16:26:00.599Z","comments":true,"path":"2023/01/30/Seataæºç ç»“æ„åŠäº‹åŠ¡æ¨¡å¼ä»‹ç»/","link":"","permalink":"https://xssdpgy.github.io/2023/01/30/Seata%E6%BA%90%E7%A0%81%E7%BB%93%E6%9E%84%E5%8F%8A%E4%BA%8B%E5%8A%A1%E6%A8%A1%E5%BC%8F%E4%BB%8B%E7%BB%8D/","excerpt":"1.Seataæ˜¯ä»€ä¹ˆSeata æ˜¯ä¸€æ¬¾å¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œè‡´åŠ›äºæä¾›é«˜æ€§èƒ½å’Œç®€å•æ˜“ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ã€‚Seata å°†ä¸ºç”¨æˆ·æä¾›äº† ATã€TCCã€SAGA å’Œ XA äº‹åŠ¡æ¨¡å¼ï¼Œä¸ºç”¨æˆ·æ‰“é€ ä¸€ç«™å¼çš„åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆã€‚ 2.Seataä½“ç³»ä¸­çš„ä¸‰ä¸ªç»„ä»¶","text":"1.Seataæ˜¯ä»€ä¹ˆSeata æ˜¯ä¸€æ¬¾å¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œè‡´åŠ›äºæä¾›é«˜æ€§èƒ½å’Œç®€å•æ˜“ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ã€‚Seata å°†ä¸ºç”¨æˆ·æä¾›äº† ATã€TCCã€SAGA å’Œ XA äº‹åŠ¡æ¨¡å¼ï¼Œä¸ºç”¨æˆ·æ‰“é€ ä¸€ç«™å¼çš„åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆã€‚ 2.Seataä½“ç³»ä¸­çš„ä¸‰ä¸ªç»„ä»¶ 2.1 ä¸‰ä¸ªç»„ä»¶Seata å†…éƒ¨å®šä¹‰äº† 3ä¸ªæ¨¡å—æ¥å¤„ç†å…¨å±€äº‹åŠ¡å’Œåˆ†æ”¯äº‹åŠ¡çš„å…³ç³»å’Œå¤„ç†è¿‡ç¨‹ï¼Œè¿™ä¸‰ä¸ªç»„ä»¶åˆ†åˆ«æ˜¯ï¼š TC (Transaction Coordinator) - äº‹åŠ¡åè°ƒè€…ï¼šç»´æŠ¤å…¨å±€å’Œåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œé©±åŠ¨å…¨å±€äº‹åŠ¡æäº¤æˆ–å›æ»šã€‚ TM (Transaction Manager) - äº‹åŠ¡ç®¡ç†å™¨ï¼šå®šä¹‰å…¨å±€äº‹åŠ¡çš„èŒƒå›´ï¼šå¼€å§‹å…¨å±€äº‹åŠ¡ã€æäº¤æˆ–å›æ»šå…¨å±€äº‹åŠ¡ã€‚ RM (Resource Manager) - èµ„æºç®¡ç†å™¨ï¼šç®¡ç†åˆ†æ”¯äº‹åŠ¡å¤„ç†çš„èµ„æºï¼Œä¸TCäº¤è°ˆä»¥æ³¨å†Œåˆ†æ”¯äº‹åŠ¡å’ŒæŠ¥å‘Šåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œå¹¶é©±åŠ¨åˆ†æ”¯äº‹åŠ¡æäº¤æˆ–å›æ»šã€‚ 2.2 æ‰§è¡Œæ­¥éª¤æ•´ä¸ªå…¨å±€äº‹åŠ¡çš„æ‰§è¡Œæ­¥éª¤å¦‚ä¸‹ï¼š TM å‘ TC ç”³è¯·å¼€å¯ä¸€ä¸ªå…¨å±€äº‹åŠ¡ï¼ŒTC åˆ›å»ºå…¨å±€äº‹åŠ¡åè¿”å›å…¨å±€å”¯ä¸€çš„ XIDï¼ŒXID ä¼šåœ¨å…¨å±€äº‹åŠ¡çš„ä¸Šä¸‹æ–‡ä¸­ä¼ æ’­ï¼› RM å‘ TC æ³¨å†Œåˆ†æ”¯äº‹åŠ¡ï¼Œè¯¥åˆ†æ”¯äº‹åŠ¡å½’å±äºæ‹¥æœ‰ç›¸åŒ XID çš„å…¨å±€äº‹åŠ¡ï¼› TM å‘ TC å‘èµ·å…¨å±€æäº¤æˆ–å›æ»šï¼› TC è°ƒåº¦ XID ä¸‹çš„åˆ†æ”¯äº‹åŠ¡å®Œæˆæäº¤æˆ–è€…å›æ»šã€‚ 3.Seataæºç ä½“ç³»æ•´ä½“ç»“æ„ æºç åŸºæœ¬åŒå®˜æ–¹1.5.2-1.6.1ç‰ˆæœ¬ã€‚ 4.Seataäº‹åŠ¡æ¨¡å¼ä»‹ç»4.1 Seata AT æ¨¡å¼ ä¸¤é˜¶æ®µæäº¤åè®®çš„æ¼”å˜ï¼š ä¸€é˜¶æ®µï¼šä¸šåŠ¡æ•°æ®å’Œå›æ»šæ—¥å¿—è®°å½•åœ¨åŒä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ä¸­æäº¤ï¼Œé‡Šæ”¾æœ¬åœ°é”å’Œè¿æ¥èµ„æºã€‚ äºŒé˜¶æ®µï¼š æäº¤å¼‚æ­¥åŒ–ï¼Œéå¸¸å¿«é€Ÿåœ°å®Œæˆã€‚ å›æ»šé€šè¿‡ä¸€é˜¶æ®µçš„å›æ»šæ—¥å¿—è¿›è¡Œåå‘è¡¥å¿ã€‚ 4.2 Seata TCC æ¨¡å¼æ•´ä½“æ˜¯ä¸¤é˜¶æ®µæäº¤çš„æ¨¡å‹ã€‚ å…¨å±€äº‹åŠ¡æ˜¯ç”±è‹¥å¹²åˆ†æ”¯äº‹åŠ¡ç»„æˆçš„ï¼Œåˆ†æ”¯äº‹åŠ¡è¦æ»¡è¶³ä¸¤é˜¶æ®µæäº¤çš„æ¨¡å‹è¦æ±‚ï¼Œå³éœ€è¦æ¯ä¸ªåˆ†æ”¯äº‹åŠ¡éƒ½å…·å¤‡è‡ªå·±çš„ï¼š ä¸€é˜¶æ®µ prepare è¡Œä¸º äºŒé˜¶æ®µ commit æˆ– rollback è¡Œä¸º 4.3 Seata Saga æ¨¡å¼ç›®å‰Seataæä¾›çš„Sagaæ¨¡å¼æ˜¯åŸºäºçŠ¶æ€æœºå¼•æ“æ¥å®ç°çš„ï¼Œæœºåˆ¶æ˜¯ï¼š é€šè¿‡çŠ¶æ€å›¾æ¥å®šä¹‰æœåŠ¡è°ƒç”¨çš„æµç¨‹å¹¶ç”Ÿæˆ json çŠ¶æ€è¯­è¨€å®šä¹‰æ–‡ä»¶ã€‚ çŠ¶æ€å›¾ä¸­ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥æ˜¯è°ƒç”¨ä¸€ä¸ªæœåŠ¡ï¼ŒèŠ‚ç‚¹å¯ä»¥é…ç½®å®ƒçš„è¡¥å¿èŠ‚ç‚¹ã€‚ çŠ¶æ€å›¾ json ç”±çŠ¶æ€æœºå¼•æ“é©±åŠ¨æ‰§è¡Œï¼Œå½“å‡ºç°å¼‚å¸¸æ—¶çŠ¶æ€å¼•æ“åå‘æ‰§è¡Œå·²æˆåŠŸèŠ‚ç‚¹å¯¹åº”çš„è¡¥å¿èŠ‚ç‚¹å°†äº‹åŠ¡å›æ»šã€‚ å¯ä»¥å®ç°æœåŠ¡ç¼–æ’éœ€æ±‚ï¼Œæ”¯æŒå•é¡¹é€‰æ‹©ã€å¹¶å‘ã€å­æµç¨‹ã€å‚æ•°è½¬æ¢ã€å‚æ•°æ˜ å°„ã€æœåŠ¡æ‰§è¡ŒçŠ¶æ€åˆ¤æ–­ã€å¼‚å¸¸æ•è·ç­‰åŠŸèƒ½ã€‚ 4.4 Seata XA æ¨¡å¼åˆ©ç”¨äº‹åŠ¡èµ„æºï¼ˆæ•°æ®åº“ã€æ¶ˆæ¯æœåŠ¡ç­‰ï¼‰å¯¹ XA åè®®çš„æ”¯æŒï¼Œä»¥ XA åè®®çš„æœºåˆ¶æ¥ç®¡ç†åˆ†æ”¯äº‹åŠ¡çš„ä¸€ç§ äº‹åŠ¡æ¨¡å¼ã€‚ æ‰§è¡Œé˜¶æ®µï¼š å¯å›æ»šï¼šä¸šåŠ¡ SQL æ“ä½œæ”¾åœ¨ XA åˆ†æ”¯ä¸­è¿›è¡Œï¼Œç”±èµ„æºå¯¹ XA åè®®çš„æ”¯æŒæ¥ä¿è¯ å¯å›æ»šã€‚ æŒä¹…åŒ–ï¼šXA åˆ†æ”¯å®Œæˆåï¼Œæ‰§è¡Œ XA prepareï¼ŒåŒæ ·ï¼Œç”±èµ„æºå¯¹ XA åè®®çš„æ”¯æŒæ¥ä¿è¯æŒä¹…åŒ–ï¼ˆå³ï¼Œä¹‹åä»»ä½•æ„å¤–éƒ½ä¸ä¼šé€ æˆæ— æ³•å›æ»šçš„æƒ…å†µï¼‰ã€‚ å®Œæˆé˜¶æ®µï¼š åˆ†æ”¯æäº¤ï¼šæ‰§è¡Œ XA åˆ†æ”¯çš„ commit åˆ†æ”¯å›æ»šï¼šæ‰§è¡Œ XA åˆ†æ”¯çš„ rollback","categories":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"https://xssdpgy.github.io/categories/%E6%8A%80%E6%9C%AF/"}],"tags":[{"name":"seata","slug":"seata","permalink":"https://xssdpgy.github.io/tags/seata/"},{"name":"åˆ†å¸ƒå¼äº‹åŠ¡","slug":"åˆ†å¸ƒå¼äº‹åŠ¡","permalink":"https://xssdpgy.github.io/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"}]},{"title":"Seata ATæ¨¡å¼æºç è§£æ","slug":"Seata-ATæ¨¡å¼æºç è§£æ","date":"2022-11-27T10:00:36.000Z","updated":"2023-02-07T16:26:00.598Z","comments":true,"path":"2022/11/27/Seata-ATæ¨¡å¼æºç è§£æ/","link":"","permalink":"https://xssdpgy.github.io/2022/11/27/Seata-AT%E6%A8%A1%E5%BC%8F%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/","excerpt":"1.ATæ¨¡å¼çš„ç‰¹æ€§1.1 å‰æATæ¨¡å¼ç”Ÿæ•ˆéœ€è¦ä¸¤ä¸ªå‰æï¼š åŸºäºæ”¯æŒæœ¬åœ°ACIDäº‹åŠ¡çš„å…³ç³»å‹æ•°æ®åº“ Javaåº”ç”¨ï¼Œé€šè¿‡JDBCè®¿é—®æ•°æ®åº“ 1.2 æ•´ä½“æœºåˆ¶","text":"1.ATæ¨¡å¼çš„ç‰¹æ€§1.1 å‰æATæ¨¡å¼ç”Ÿæ•ˆéœ€è¦ä¸¤ä¸ªå‰æï¼š åŸºäºæ”¯æŒæœ¬åœ°ACIDäº‹åŠ¡çš„å…³ç³»å‹æ•°æ®åº“ Javaåº”ç”¨ï¼Œé€šè¿‡JDBCè®¿é—®æ•°æ®åº“ 1.2 æ•´ä½“æœºåˆ¶ä¸¤é˜¶æ®µæäº¤åè®®çš„æ¼”å˜ï¼š ä¸€é˜¶æ®µï¼šä¸šåŠ¡æ•°æ®å’Œå›æ»šæ—¥å¿—è®°å½•åœ¨åŒä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ä¸­æäº¤ï¼Œé‡Šæ”¾æœ¬åœ°é”å’Œè¿æ¥èµ„æºã€‚ äºŒé˜¶æ®µï¼š æäº¤å¼‚æ­¥åŒ–ï¼Œéå¸¸å¿«é€Ÿåœ°å®Œæˆã€‚ å›æ»šé€šè¿‡ä¸€é˜¶æ®µçš„å›æ»šæ—¥å¿—è¿›è¡Œåå‘è¡¥å¿ã€‚ 1.3 å†™éš”ç¦» ä¸€é˜¶æ®µæœ¬åœ°äº‹åŠ¡æäº¤å‰ï¼Œéœ€è¦ç¡®ä¿å…ˆæ‹¿åˆ° å…¨å±€é” ã€‚ æ‹¿ä¸åˆ° å…¨å±€é” ï¼Œä¸èƒ½æäº¤æœ¬åœ°äº‹åŠ¡ã€‚ æ‹¿ å…¨å±€é” çš„å°è¯•è¢«é™åˆ¶åœ¨ä¸€å®šèŒƒå›´å†…ï¼Œè¶…å‡ºèŒƒå›´å°†æ”¾å¼ƒï¼Œå¹¶å›æ»šæœ¬åœ°äº‹åŠ¡ï¼Œé‡Šæ”¾æœ¬åœ°é”ã€‚ 1.4 è¯»éš”ç¦»åœ¨æ•°æ®åº“æœ¬åœ°äº‹åŠ¡éš”ç¦»çº§åˆ« è¯»å·²æäº¤ï¼ˆRead Committedï¼‰ æˆ–ä»¥ä¸Šçš„åŸºç¡€ä¸Šï¼ŒSeataï¼ˆAT æ¨¡å¼ï¼‰çš„é»˜è®¤å…¨å±€éš”ç¦»çº§åˆ«æ˜¯ è¯»æœªæäº¤ï¼ˆRead Uncommittedï¼‰ ã€‚ å¦‚æœåº”ç”¨åœ¨ç‰¹å®šåœºæ™¯ä¸‹ï¼Œå¿…éœ€è¦æ±‚å…¨å±€çš„ è¯»å·²æäº¤ ï¼Œç›®å‰ Seata çš„æ–¹å¼æ˜¯é€šè¿‡ SELECT FOR UPDATE è¯­å¥çš„ä»£ç†ã€‚ 2. æºç æ¢³ç† æºç ç‰ˆæœ¬ 1.5.2 2.1 TMåŠRMåˆå§‹åŒ–TMå’ŒRMï¼ˆClientç«¯ï¼‰ç”±ä¸šåŠ¡ç³»ç»Ÿé›†æˆï¼ŒATæ¨¡å¼ä¸‹ï¼Œåœ¨å¤„ç†TCï¼ˆServerç«¯ï¼‰å‘è¿‡æ¥çš„è¯·æ±‚æ—¶ï¼Œè¿™ä¿©è§’è‰²å‘æŒ¥ç€ä¸»è¦ä½œç”¨ã€‚æ‰€ä»¥ä»GlobalTransactionScannerä¸­ä¸¤è€…çš„åˆå§‹åŒ–å¼€å§‹è¯´èµ·ã€‚ å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨GlobalTransactionScanner#initClient()æ–¹æ³•ï¼Œåœ¨initClient()ä¸­åˆå§‹åŒ–TMå’ŒRMã€‚ TMå’ŒRMåˆå§‹åŒ–ï¼Œä¸»è¦æ˜¯æ³¨å†Œå„ç§å¤„ç†å™¨ï¼Œæœ€ç»ˆæ„é€ ä¸€ä¸ªå¤„ç†å™¨æ˜ å°„è¡¨ï¼š RMæ³¨å†Œå¤„ç†å™¨é€»è¾‘ç›¸åŒï¼Œè¿™é‡Œä¸å¤šå±•ç¤ºã€‚ éœ€è¦å…³æ³¨çš„æ˜¯RMåˆå§‹åŒ–æ—¶ï¼Œåœ¨æ³¨å†Œå„ç§å¤„ç†å™¨ä¹‹å‰è¿˜æœ‰ä¸¤ä¸ªæ“ä½œï¼š RMåˆå§‹åŒ–æ—¶ï¼Œå…ˆæ˜¯è®¾ç½®äº† ResourceManager å’Œ TransactionMessageHandlerï¼Œä¹‹åä¹Ÿæ˜¯å¦‚TMåˆå§‹åŒ–ä¸€æ ·æ³¨å†Œå„ç§å¤„ç†å™¨ï¼Œæœ‰åŒºåˆ«çš„æ˜¯æ³¨å†Œå¤„ç†å™¨æµç¨‹ä¸­ï¼ŒRMæ˜¯æ³¨å†Œå®Œä¸‰ä¸ªç‰¹æœ‰çš„å®¢æˆ·ç«¯ä¹‹åï¼Œæ‰æ‰§è¡Œä¸TMç±»ä¼¼çš„æ³¨å†Œæµç¨‹ã€‚ çœŸæ­£å¤„ç†è¯·æ±‚çš„è¿˜æ˜¯é è°ƒç”¨å„ä¸ªå¤„ç†å™¨ä¸­çš„handler.onRequest()æ–¹æ³•ï¼Œäºæ˜¯é—®é¢˜çš„å…³é”®å°±å¾ˆæ˜æ˜¾äº†ï¼Œå°±åœ¨äºhandlerã€‚ 2.2 ResourceManageråœ¨äº†è§£ResourceManagerä¹‹å‰ï¼Œéœ€è¦å…ˆäº†è§£ä¸‹ResourceManagerInboundå’ŒResourceManagerOutboundã€‚ ResourceManagerInboundæ˜¯å¤„ç†æ¥æ”¶åˆ°TCçš„è¯·æ±‚çš„ï¼Œæ˜¯TCå‘RMå‘è¯·æ±‚ ResourceManagerOutboundæ˜¯å¤„ç†æµå‡ºçš„æ¶ˆæ¯çš„ï¼Œæ˜¯RMå‘TCå‘è¯·æ±‚ ResourceManagerç»§æ‰¿äº†äºŒè€…ï¼Œæ‰€ä»¥æ—¢è´Ÿè´£å‘TCå‘è¯·æ±‚ï¼Œåˆè´Ÿè´£æ¥æ”¶ä»TCæ¥çš„è¯·æ±‚ã€‚ DefaultResourceManager.get()å¾—åˆ°çš„æ˜¯ä¸€ä¸ªå•ä¾‹DefaultResourceManagerï¼Œåˆ›å»ºDefaultResourceManagerçš„æ—¶å€™ä¼šæ„å»ºä¸€ä¸ªåˆ†æ”¯ç±»å‹ä¸ºResourceManagerçš„ä¸€ä¸ªMapã€‚","categories":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"https://xssdpgy.github.io/categories/%E6%8A%80%E6%9C%AF/"}],"tags":[{"name":"seata","slug":"seata","permalink":"https://xssdpgy.github.io/tags/seata/"},{"name":"åˆ†å¸ƒå¼äº‹åŠ¡","slug":"åˆ†å¸ƒå¼äº‹åŠ¡","permalink":"https://xssdpgy.github.io/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"}]},{"title":"ä»£ç†æ¨¡å¼â€”â€”JDKåŠ¨æ€ä»£ç†ä¸CGLibåŸç†åŠå¯¹æ¯”åˆ†æ","slug":"ä»£ç†æ¨¡å¼â€”â€”JDKåŠ¨æ€ä»£ç†ä¸CGLibåŸç†åŠå¯¹æ¯”åˆ†æ","date":"2022-10-12T16:05:28.000Z","updated":"2022-10-25T15:10:58.613Z","comments":true,"path":"2022/10/13/ä»£ç†æ¨¡å¼â€”â€”JDKåŠ¨æ€ä»£ç†ä¸CGLibåŸç†åŠå¯¹æ¯”åˆ†æ/","link":"","permalink":"https://xssdpgy.github.io/2022/10/13/%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F%E2%80%94%E2%80%94JDK%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E4%B8%8ECGLib%E5%8E%9F%E7%90%86%E5%8F%8A%E5%AF%B9%E6%AF%94%E5%88%86%E6%9E%90/","excerpt":"1.å‰è¨€é¦–å…ˆå›é¡¾ä¸‹ä»£ç†æ¨¡å¼ï¼ˆProxy Patternï¼‰çš„å®šä¹‰ï¼šä»£ç†æ¨¡å¼æŒ‡ä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ç§ä»£ç†ï¼Œä»¥æ§åˆ¶è¿™ä¸ªå¯¹è±¡çš„è®¿é—®ï¼Œå±äºç»“æ„å‹è®¾è®¡æ¨¡å¼ã€‚å…¶é€‚ç”¨äºåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¸€ä¸ªå¯¹è±¡ä¸é€‚åˆæˆ–è€…ä¸èƒ½ç›´æ¥å¼•ç”¨å¦ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œä»£ç†å¯¹è±¡å¯ä»¥åœ¨å®¢æˆ·ç«¯äºç›®æ ‡å¯¹è±¡ä¹‹é—´èµ·åˆ°ä¸­ä»‹çš„ä½œç”¨ã€‚","text":"1.å‰è¨€é¦–å…ˆå›é¡¾ä¸‹ä»£ç†æ¨¡å¼ï¼ˆProxy Patternï¼‰çš„å®šä¹‰ï¼šä»£ç†æ¨¡å¼æŒ‡ä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ç§ä»£ç†ï¼Œä»¥æ§åˆ¶è¿™ä¸ªå¯¹è±¡çš„è®¿é—®ï¼Œå±äºç»“æ„å‹è®¾è®¡æ¨¡å¼ã€‚å…¶é€‚ç”¨äºåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¸€ä¸ªå¯¹è±¡ä¸é€‚åˆæˆ–è€…ä¸èƒ½ç›´æ¥å¼•ç”¨å¦ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œä»£ç†å¯¹è±¡å¯ä»¥åœ¨å®¢æˆ·ç«¯äºç›®æ ‡å¯¹è±¡ä¹‹é—´èµ·åˆ°ä¸­ä»‹çš„ä½œç”¨ã€‚ ä»£ç†æ¨¡å¼ä¸»è¦åˆ†ä¸ºé™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†ä¸¤ç§æ–¹å¼ï¼Œé™æ€ä»£ç†éœ€è¦æ‰‹åŠ¨åˆ›å»ºä»£ç†ç±»ï¼Œä»£ç†çš„ç›®æ ‡å¯¹è±¡æ˜¯å›ºå®šçš„ï¼›åŠ¨æ€ä»£ç†ä½¿ç”¨åå°„æœºåˆ¶ï¼Œä»£ç†çš„ç›®æ ‡å¯¹è±¡æ˜¯æ´»åŠ¨çš„ï¼Œä¸éœ€è¦åˆ›å»ºä»£ç†ç±»å³å¯ç»™ä¸åŒçš„ç›®æ ‡éšæ—¶åˆ›å»ºä»£ç†ã€‚æœ¬ç¯‡é‡ç‚¹æ¢ç©¶åŠ¨æ€ä»£ç†çš„å®ç°ã€‚ 2.JDKåŠ¨æ€ä»£ç†JDKåŠ¨æ€ä»£ç†é‡‡ç”¨å­—èŠ‚é‡ç»„ï¼Œé‡æ–°ç”Ÿæˆå¯¹è±¡æ¥æ›¿ä»£åŸå§‹å¯¹è±¡ï¼Œä»¥è¾¾åˆ°åŠ¨æ€ä»£ç†çš„ç›®çš„ã€‚JDKåŠ¨æ€ä»£ç†ç”Ÿæˆå¯¹è±¡çš„æ­¥éª¤å¦‚ä¸‹ï¼š è·å–è¢«ä»£ç†å¯¹è±¡çš„å¼•ç”¨ï¼Œå¹¶ä¸”è·å–å®ƒçš„æ‰€æœ‰æ¥å£ï¼Œåå°„è·å–ã€‚ JDKåŠ¨æ€ä»£ç†ç±»é‡æ–°ç”Ÿæˆä¸€ä¸ªæ–°çš„ç±»ï¼ŒåŒæ—¶æ–°çš„ç±»è¦å®ç°è¢«ä»£ç†ç±»å®ç°çš„æ‰€æœ‰æ¥å£ã€‚ åŠ¨æ€ç”ŸæˆJavaä»£ç ï¼Œæ–°åŠ çš„ä¸šåŠ¡é€»è¾‘æ–¹æ³•ç”±ä¸€å®šçš„é€»è¾‘ä»£ç è°ƒç”¨ï¼ˆåœ¨ä»£ç ä¸­ä½“ç°ï¼‰ã€‚ ç¼–è¯‘æ–°ç”Ÿæˆçš„Javaä»£ç .classæ–‡ä»¶ã€‚ é‡æ–°åŠ è½½åˆ°JVMä¸­è¿è¡Œã€‚ 2.1 JDKåŠ¨æ€ä»£ç†å®ç°åŠåŸç†æºç è§£æå®ç°ä¸€ä¸ªJDKåŠ¨æ€ä»£ç†ï¼Œæ–¹å¼ä¸ºå®ç°java.lang.reflect.InvocationHandleræ¥å£ï¼Œå¹¶ä½¿ç”¨java.lang.reflect.Proxy.newProxyInstance()æ–¹æ³•ç”Ÿæˆä»£ç†å¯¹è±¡ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859/*** è¦ä»£ç†çš„æ¥å£*/public interface IPerson &#123; void learn();&#125;/*** çœŸå®è°ƒç”¨ç±»*/public class Zhangsan implements IPerson &#123; public void learn() &#123; System.out.println(&quot;==å¼ ä¸‰å­¦ä¹ ä¸­é—´ä»¶==&quot;); &#125;&#125;/*** JDKä»£ç†ç±»ç”Ÿæˆ*/import java.lang.reflect.InvocationHandler;import java.lang.reflect.Method;import java.lang.reflect.Proxy;public class JdkInvocationHandler implements InvocationHandler &#123; private IPerson target; public IPerson getInstance(IPerson target)&#123; this.target = target; Class&lt;?&gt; clazz = target.getClass(); return (IPerson) Proxy.newProxyInstance(clazz.getClassLoader(),clazz.getInterfaces(),this); &#125; public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; before(); Object result = method.invoke(this.target,args); after(); return result; &#125; private void before() &#123; System.out.println(&quot;äº‹å‰åšå¥½è®¡åˆ’&quot;); &#125; private void after() &#123; System.out.println(&quot;äº‹åå›é¡¾æ¢³ç†&quot;); &#125;&#125;/*** æµ‹è¯•*/public class TestProxy &#123; public static void main(String[] args) &#123; try &#123; //æŠŠç”Ÿæˆçš„å­—èŠ‚ç ä¿å­˜åˆ°æœ¬åœ°ç£ç›˜,åŠ¨æ€ç”Ÿæˆçš„ç±»ä¼šä¿å­˜åœ¨å·¥ç¨‹æ ¹ç›®å½•ä¸‹çš„ com/sun/proxy ç›®å½•é‡Œé¢ System.setProperty(&quot;sun.misc.ProxyGenerator.saveGeneratedFiles&quot;,&quot;true&quot;); IPerson obj = (IPerson) new JdkInvocationHandler().getInstance(new Zhangsan()); obj.learn(); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125;&#125; çœ‹ä¸‹ Proxy.newProxyInstance é‡Œé¢ç©¶ç«Ÿå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ ç»“åˆæµç¨‹å›¾ï¼Œåœ¨ç”Ÿæˆå­—èŠ‚ç çš„é‚£ä¸ªåœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯ ProxyGenerator.generateProxyClass() æ–¹æ³•é‡Œé¢ï¼Œé€šè¿‡ä»£ç å¯ä»¥çœ‹åˆ°ï¼ˆè‡ªè¡ŒæŸ¥é˜…ï¼Œç¯‡å¹…åŸå› ï¼Œè¿™é‡Œä¸è´´ä»£ç ï¼‰ï¼Œé‡Œé¢æ˜¯ç”¨å‚æ•° saveGeneratedFiles æ¥æ§åˆ¶æ˜¯å¦æŠŠç”Ÿæˆçš„å­—èŠ‚ç ä¿å­˜åˆ°æœ¬åœ°ç£ç›˜ã€‚ä»£ç ä¸­å·²ç»è®¾ç½®ä¿å­˜åˆ°æœ¬åœ°ï¼Œç°åœ¨æ‰¾åˆ°åˆšæ‰ç”Ÿæˆçš„ $Proxy0.classï¼Œåç¼–è¯‘æ‰“å¼€å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071import com.zang.jdkproxy.IPerson;import java.lang.reflect.InvocationHandler;import java.lang.reflect.Method;import java.lang.reflect.Proxy;import java.lang.reflect.UndeclaredThrowableException;public final class $Proxy0 extends Proxy implements IPerson &#123; private static Method m1; private static Method m3; private static Method m2; private static Method m0; public $Proxy0(InvocationHandler var1) throws &#123; super(var1); &#125; public final boolean equals(Object var1) throws &#123; try &#123; return (Boolean)super.h.invoke(this, m1, new Object[]&#123;var1&#125;); &#125; catch (RuntimeException | Error var3) &#123; throw var3; &#125; catch (Throwable var4) &#123; throw new UndeclaredThrowableException(var4); &#125; &#125; public final void learn() throws &#123; try &#123; // super.h å¯¹åº”çš„æ˜¯çˆ¶ç±»çš„hå˜é‡ï¼Œä¹Ÿå°±æ˜¯Proxy.newProxyInstanceæ–¹æ³•ä¸­çš„InvocationHandlerå‚æ•° // æ‰€ä»¥è¿™é‡Œå®é™…ä¸Šå°±æ˜¯ä½¿ç”¨äº†æˆ‘ä»¬è‡ªå·±å†™çš„InvocationHandlerå®ç°ç±»çš„invokeæ–¹æ³• super.h.invoke(this, m3, (Object[])null); &#125; catch (RuntimeException | Error var2) &#123; throw var2; &#125; catch (Throwable var3) &#123; throw new UndeclaredThrowableException(var3); &#125; &#125; public final String toString() throws &#123; try &#123; return (String)super.h.invoke(this, m2, (Object[])null); &#125; catch (RuntimeException | Error var2) &#123; throw var2; &#125; catch (Throwable var3) &#123; throw new UndeclaredThrowableException(var3); &#125; &#125; public final int hashCode() throws &#123; try &#123; return (Integer)super.h.invoke(this, m0, (Object[])null); &#125; catch (RuntimeException | Error var2) &#123; throw var2; &#125; catch (Throwable var3) &#123; throw new UndeclaredThrowableException(var3); &#125; &#125; static &#123; try &#123; m1 = Class.forName(&quot;java.lang.Object&quot;).getMethod(&quot;equals&quot;, Class.forName(&quot;java.lang.Object&quot;)); m3 = Class.forName(&quot;com.zang.jdkproxy.IPerson&quot;).getMethod(&quot;learn&quot;); m2 = Class.forName(&quot;java.lang.Object&quot;).getMethod(&quot;toString&quot;); m0 = Class.forName(&quot;java.lang.Object&quot;).getMethod(&quot;hashCode&quot;); &#125; catch (NoSuchMethodException var2) &#123; throw new NoSuchMethodError(var2.getMessage()); &#125; catch (ClassNotFoundException var3) &#123; throw new NoClassDefFoundError(var3.getMessage()); &#125; &#125;&#125; å¯ä»¥çœ‹åˆ° $Proxy0ç±»ç»§æ‰¿äº†Proxyç±»ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªè·ŸIPersonä¸€æ ·ç­¾åçš„ learn æ–¹æ³•ï¼Œæ–¹æ³•å®ç°ä¸­çš„super.h.invoke(this, m3, (Object[])null);ï¼Œsuper.h å¯¹åº”çš„æ˜¯çˆ¶ç±»çš„hå˜é‡ï¼Œä¹Ÿå°±æ˜¯Proxy.newProxyInstanceæ–¹æ³•ä¸­çš„InvocationHandlerå‚æ•°ï¼š 12345678910111213141516171819202122package java.lang.reflect;//importç•¥public class Proxy implements java.io.Serializable &#123; protected InvocationHandler h; protected Proxy(InvocationHandler h) &#123; Objects.requireNonNull(h); this.h = h; &#125; @CallerSensitive public static Object newProxyInstance(ClassLoader loader, Class&lt;?&gt;[] interfaces, InvocationHandler h) throws IllegalArgumentException &#123; Objects.requireNonNull(h); final Class&lt;?&gt;[] intfs = interfaces.clone(); // æ‰€ä»¥è¿™é‡Œå®é™…ä¸Šå°±æ˜¯ä½¿ç”¨äº†æˆ‘è‡ªå·±å†™çš„InvocationHandlerå®ç°ç±»JdkInvocationHandlerçš„invokeæ–¹æ³•ï¼Œå½“è°ƒç”¨ IPerson.learnçš„æ—¶å€™ï¼Œå…¶å®å®ƒæ˜¯è¢«è½¬å‘åˆ°äº† JdkInvocationHandler.invokeã€‚è‡³æ­¤ï¼Œæ•´ä¸ªé­”æœ¯è¿‡ç¨‹å°±é€æ˜äº†ã€‚ 2.2 æ‰‹å†™JDKåŠ¨æ€ä»£ç†ä½¿ç”¨JDKåŠ¨æ€ä»£ç†çš„ç±»åå’Œæ–¹æ³•åå®šä¹‰ä»¥åŠæ‰§è¡Œæ€è·¯ï¼Œä¸‹é¢æ¥è¿›è¡Œæ‰‹å†™å®ç°ã€‚ åˆ›å»ºMyInvocationHandleræ¥å£ï¼š123456import java.lang.reflect.Method;public interface MyInvocationHandler &#123; public Object invoke(Object proxy, Method method, Object[] args) throws Throwable;&#125; åˆ›å»ºMyProxyç±»ï¼š123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147import javax.tools.JavaCompiler;import javax.tools.StandardJavaFileManager;import javax.tools.ToolProvider;import java.io.File;import java.io.FileWriter;import java.lang.reflect.Constructor;import java.lang.reflect.Method;import java.util.HashMap;import java.util.Map;/** * è‡ªå·±å®ç°çš„ä»£ç†ç±»ï¼Œç”¨æ¥ç”Ÿæˆå­—èŠ‚ç æ–‡ä»¶ï¼Œå¹¶åŠ¨æ€åŠ è½½åˆ°JVMä¸­ */public class MyProxy &#123; public static final String ln = &quot;\\r\\n&quot;; /** * ç”Ÿæˆä»£ç†å¯¹è±¡ * @param classLoader ç±»åŠ è½½å™¨ï¼Œç”¨äºåŠ è½½è¢«ä»£ç†ç±»çš„ç±»æ–‡ä»¶ * @param interfaces è¢«ä»£ç†ç±»çš„æ¥å£ * @param h è‡ªå®šä¹‰çš„InvocationHandleræ¥å£,ç”¨äºå…·ä½“ä»£ç†æ–¹æ³•çš„æ‰§è¡Œ * @return è¿”å›è¢«ä»£ç†åçš„ä»£ç†å¯¹è±¡ */ public static Object newProxyInstance(MyClassLoader classLoader, Class&lt;?&gt;[] interfaces, MyInvocationHandler h) &#123; try &#123; //1ã€åŠ¨æ€ç”Ÿæˆæºä»£ç .javaæ–‡ä»¶ String src = generateSrc(interfaces); //2ã€Javaæ–‡ä»¶è¾“å‡ºç£ç›˜ String filePath = MyProxy.class.getResource(&quot;&quot;).getPath(); File f = new File(filePath + &quot;$Proxy0.java&quot;); FileWriter fw = new FileWriter(f); fw.write(src); fw.flush(); fw.close(); //3ã€æŠŠç”Ÿæˆçš„.javaæ–‡ä»¶ç¼–è¯‘æˆ.classæ–‡ä»¶ //è·å–Javaç¼–è¯‘å™¨ JavaCompiler compiler = ToolProvider.getSystemJavaCompiler(); //æ ‡æ³¨Javaæ–‡ä»¶ç®¡ç†å™¨ï¼Œç”¨æ¥è·å–Javaå­—èŠ‚ç æ–‡ä»¶ StandardJavaFileManager manage = compiler.getStandardFileManager(null, null, null); Iterable iterable = manage.getJavaFileObjects(f); //åˆ›å»ºtaskï¼Œé€šè¿‡javaå­—èŠ‚ç æ–‡ä»¶å°†ç±»ä¿¡æ¯åŠ è½½åˆ°JVMä¸­ JavaCompiler.CompilationTask task = compiler.getTask(null, manage, null, null, null, iterable); //å¼€å§‹æ‰§è¡Œtask task.call(); //å…³é—­ç®¡ç†å™¨ manage.close(); //4ã€ç¼–è¯‘ç”Ÿæˆçš„.classæ–‡ä»¶åŠ è½½åˆ°JVMä¸­æ¥ Class proxyClass = classLoader.findClass(&quot;$Proxy0&quot;); Constructor c = proxyClass.getConstructor(MyInvocationHandler.class); f.delete(); //5ã€è¿”å›å­—èŠ‚ç é‡ç»„ä»¥åçš„æ–°çš„ä»£ç†å¯¹è±¡ return c.newInstance(h); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; return null; &#125; /** * ç”Ÿæˆä»£ç†ç±»çš„æºä»£ç  */ private static String generateSrc(Class&lt;?&gt;[] interfaces) &#123; StringBuffer sb = new StringBuffer(); sb.append(MyProxy.class.getPackage() + &quot;;&quot; + ln); sb.append(&quot;import &quot; + interfaces[0].getName() + &quot;;&quot; + ln); sb.append(&quot;import java.lang.reflect.*;&quot; + ln); sb.append(&quot;public class $Proxy0 implements &quot; + interfaces[0].getName() + &quot;&#123;&quot; + ln); sb.append(&quot;GPInvocationHandler h;&quot; + ln); sb.append(&quot;public $Proxy0(GPInvocationHandler h) &#123; &quot; + ln); sb.append(&quot;this.h = h;&quot;); sb.append(&quot;&#125;&quot; + ln); for (Method m : interfaces[0].getMethods()) &#123; Class&lt;?&gt;[] params = m.getParameterTypes(); StringBuffer paramNames = new StringBuffer(); StringBuffer paramValues = new StringBuffer(); StringBuffer paramClasses = new StringBuffer(); for (int i = 0; i &lt; params.length; i++) &#123; Class clazz = params[i]; String type = clazz.getName(); String paramName = toLowerFirstCase(clazz.getSimpleName()); paramNames.append(type + &quot; &quot; + paramName); paramValues.append(paramName); paramClasses.append(clazz.getName() + &quot;.class&quot;); if (i &gt; 0 &amp;&amp; i &lt; params.length - 1) &#123; paramNames.append(&quot;,&quot;); paramClasses.append(&quot;,&quot;); paramValues.append(&quot;,&quot;); &#125; &#125; sb.append(&quot;public &quot; + m.getReturnType().getName() + &quot; &quot; + m.getName() + &quot;(&quot; + paramNames.toString() + &quot;) &#123;&quot; + ln); sb.append(&quot;try&#123;&quot; + ln); sb.append(&quot;Method m = &quot; + interfaces[0].getName() + &quot;.class.getMethod(\\&quot;&quot; + m.getName() + &quot;\\&quot;,new Class[]&#123;&quot; + paramClasses.toString() + &quot;&#125;);&quot; + ln); sb.append((hasReturnValue(m.getReturnType()) ? &quot;return &quot; : &quot;&quot;) + getCaseCode(&quot;this.h.invoke(this,m,new Object[]&#123;&quot; + paramValues + &quot;&#125;)&quot;, m.getReturnType()) + &quot;;&quot; + ln); sb.append(&quot;&#125;catch(Error _ex) &#123; &#125;&quot;); sb.append(&quot;catch(Throwable e)&#123;&quot; + ln); sb.append(&quot;throw new UndeclaredThrowableException(e);&quot; + ln); sb.append(&quot;&#125;&quot;); sb.append(getReturnEmptyCode(m.getReturnType())); sb.append(&quot;&#125;&quot;); &#125; sb.append(&quot;&#125;&quot; + ln); return sb.toString(); &#125; private static Map&lt;Class, Class&gt; mappings = new HashMap&lt;Class, Class&gt;(); static &#123; mappings.put(int.class, Integer.class); &#125; private static String getReturnEmptyCode(Class&lt;?&gt; returnClass) &#123; if (mappings.containsKey(returnClass)) &#123; return &quot;return 0;&quot;; &#125; else if (returnClass == void.class) &#123; return &quot;&quot;; &#125; else &#123; return &quot;return null;&quot;; &#125; &#125; private static String getCaseCode(String code, Class&lt;?&gt; returnClass) &#123; if (mappings.containsKey(returnClass)) &#123; return &quot;((&quot; + mappings.get(returnClass).getName() + &quot;)&quot; + code + &quot;).&quot; + returnClass.getSimpleName() + &quot;Value()&quot;; &#125; return code; &#125; private static boolean hasReturnValue(Class&lt;?&gt; clazz) &#123; return clazz != void.class; &#125; private static String toLowerFirstCase(String src) &#123; char[] chars = src.toCharArray(); chars[0] += 32; return String.valueOf(chars); &#125;&#125; åˆ›å»ºç±»åŠ è½½å™¨MyClassLoaderï¼š1234567891011121314151617181920212223242526272829303132333435363738394041424344454647import java.io.ByteArrayOutputStream;import java.io.File;import java.io.FileInputStream;public class MyClassLoader extends ClassLoader &#123; private File classPathFile; public MyClassLoader()&#123; String classPath = MyClassLoader.class.getResource(&quot;&quot;).getPath(); this.classPathFile = new File(classPath); &#125; /** * é€šè¿‡ç±»åç§°åŠ è½½ç±»å­—èŠ‚ç æ–‡ä»¶åˆ°JVMä¸­ * @param name ç±»å * @return ç±»çš„Classç‹¬äº« * @throws ClassNotFoundException */ @Override protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException &#123; //è·å–ç±»å String className = MyClassLoader.class.getPackage().getName() + &quot;.&quot; + name; if(classPathFile != null)&#123; //è·å–ç±»æ–‡ä»¶ File classFile = new File(classPathFile,name.replaceAll(&quot;\\\\.&quot;,&quot;/&quot;) + &quot;.class&quot;); if(classFile.exists())&#123; //å°†ç±»æ–‡ä»¶è½¬åŒ–ä¸ºå­—èŠ‚æ•°ç»„ FileInputStream in = null; ByteArrayOutputStream out = null; try&#123; in = new FileInputStream(classFile); out = new ByteArrayOutputStream(); byte [] buff = new byte[1024]; int len; while ((len = in.read(buff)) != -1)&#123; out.write(buff,0,len); &#125; //è°ƒç”¨çˆ¶ç±»æ–¹æ³•ç”Ÿæˆclasså®ä¾‹ return defineClass(className,out.toByteArray(),0,out.size()); &#125;catch (Exception e)&#123; e.printStackTrace(); &#125; &#125; &#125; return null; &#125;&#125; å®ç°å¹¶æµ‹è¯•123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354/*** è¦ä»£ç†çš„æ¥å£*/public interface IPerson &#123; void learn();&#125;/*** çœŸå®è°ƒç”¨ç±»*/public class Zhangsan implements IPerson &#123; public void learn() &#123; System.out.println(&quot;==å¼ ä¸‰å­¦ä¹ ä¸­é—´ä»¶==&quot;); &#125;&#125;/*** JDKä»£ç†ç±»ç”Ÿæˆ*/public class CustomInvocationHandler implements MyInvocationHandler &#123; private IPerson target; public IPerson getInstance(IPerson target)&#123; this.target = target; Class&lt;?&gt; clazz = target.getClass(); return (IPerson) MyProxy.newProxyInstance(new MyClassLoader(),clazz.getInterfaces(),this); &#125; public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; before(); Object result = method.invoke(this.target,args); after(); return result; &#125; private void before() &#123; System.out.println(&quot;äº‹å‰åšå¥½è®¡åˆ’&quot;); &#125; private void after() &#123; System.out.println(&quot;äº‹åå›é¡¾æ¢³ç†&quot;); &#125;&#125;/*** æµ‹è¯•*/public class Test &#123; public static void main(String[] args) &#123; CustomInvocationHandler custom = new CustomInvocationHandler(); IPerson zhangsan = custom.getInstance(new Zhangsan()); zhangsan.learn(); &#125;&#125; è‡³æ­¤ï¼Œæ‰‹å†™å®Œæˆï¼Œè¯»è€…ä¹Ÿå¯è‡ªè¡Œå‚ç…§å®ç°ã€‚ 3.CGLibåŠ¨æ€ä»£ç†APIåŸç†åˆ†æ3.1 CGLibåŠ¨æ€ä»£ç†çš„ä½¿ç”¨1234567891011121314151617181920212223242526272829303132import net.sf.cglib.proxy.Enhancer;import net.sf.cglib.proxy.MethodInterceptor;import net.sf.cglib.proxy.MethodProxy;import java.lang.reflect.Method;public class CustomCGlib implements MethodInterceptor &#123; public Object getInstance(Class&lt;?&gt; clazz) throws Exception&#123; //ç›¸å½“äºProxyï¼Œä»£ç†çš„å·¥å…·ç±» Enhancer enhancer = new Enhancer(); enhancer.setSuperclass(clazz); enhancer.setCallback(this); return enhancer.create(); &#125; public Object intercept(Object o, Method method, Object[] objects, MethodProxy methodProxy) throws Throwable &#123; before(); Object obj = methodProxy.invokeSuper(o,objects); after(); return obj; &#125; private void before() &#123; System.out.println(&quot;äº‹å‰åšå¥½è®¡åˆ’&quot;); &#125; private void after() &#123; System.out.println(&quot;äº‹åå›é¡¾æ¢³ç†&quot;); &#125;&#125; è¿™é‡Œæœ‰ä¸€ä¸ªå°ç»†èŠ‚ï¼ŒCGLibåŠ¨æ€ä»£ç†çš„ç›®æ ‡å¯¹è±¡ä¸éœ€è¦å®ç°ä»»ä½•æ¥å£ï¼Œå®ƒæ˜¯é€šè¿‡åŠ¨æ€ç»§æ‰¿ç›®æ ‡å¯¹è±¡å®ç°åŠ¨æ€ä»£ç†çš„ï¼Œå®¢æˆ·ç«¯æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š 12345678910public class CglibTest &#123; public static void main(String[] args) &#123; try &#123; Zhangsan obj = (Zhangsan) new CustomCGlib().getInstance(Zhangsan.class); obj.learn(); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125;&#125; 3.2 CGLibåŠ¨æ€ä»£ç†çš„å®ç°åŸç†CGLibåŠ¨æ€ä»£ç†çš„å®ç°åŸç†åˆæ˜¯æ€æ ·çš„å‘¢ï¼Ÿå¯ä»¥åœ¨å®¢æˆ·ç«¯æµ‹è¯•ä»£ç ä¸­åŠ ä¸Šä¸€å¥ä»£ç ï¼Œå°†CGLibåŠ¨æ€ä»£ç†åçš„.classæ–‡ä»¶å†™å…¥ç£ç›˜ï¼Œç„¶ååç¼–è¯‘æ¥ä¸€æ¢ç©¶ç«Ÿï¼Œä»£ç å¦‚ä¸‹ï¼š 12345//import net.sf.cglib.core.DebuggingClassWriter;//ä½¿ç”¨CGLibçš„ä»£ç†ç±»å¯ä»¥å°†å†…å­˜ä¸­çš„.classæ–‡ä»¶å†™å…¥æœ¬åœ°ç£ç›˜System.setProperty(DebuggingClassWriter.DEBUG_LOCATION_PROPERTY,&quot;E://cglib_proxy_classes&quot;);Zhangsan obj = Â·Â·Â·//Â·Â·Â· é‡æ–°æ‰§è¡Œä»£ç ï¼Œåœ¨è¾“å‡ºç›®å½•ä¸‹ä¼šå‡ºç°ä¸‰ä¸ª.classæ–‡ä»¶ï¼Œä¸€ä¸ªæ˜¯ç›®æ ‡ï¼ˆè¢«ä»£ç†ï¼‰ç±»çš„FastClassï¼Œä¸€ä¸ªæ˜¯ä»£ç†ç±»ï¼Œä¸€ä¸ªæ˜¯ä»£ç†ç±»çš„FastClassã€‚å¦‚å›¾ï¼š å…¶ä¸­ï¼ŒZhangsan$$EnhancerByCGLIB$$3d23e0ea.classå°±æ˜¯CGLibåŠ¨æ€ä»£ç†ç”Ÿæˆçš„ä»£ç†ç±»ï¼Œç»§æ‰¿äº†Zhangsanç±»ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950package com.zang.cglibproxy;import java.lang.reflect.Method;import net.sf.cglib.*;public class Zhangsan$$EnhancerByCGLIB$$3d23e0ea extends Zhangsan implements Factory &#123; //Â·Â·Â· //ä¼ å…¥çš„MethodInterceptorå¯¹è±¡ private MethodInterceptor CGLIB$CALLBACK_0; //ç›®æ ‡ç±»çš„learnæ–¹æ³•å¯¹è±¡ private static final Method CGLIB$learn$0$Method; //ä»£ç†ç±»çš„learnæ–¹æ³•å¯¹è±¡ private static final MethodProxy CGLIB$learn$0$Proxy; private static final Object[] CGLIB$emptyArgs; //åˆå§‹åŒ–æ–¹æ³•ï¼Œå…¶ä¸­éƒ¨åˆ†ä»£ç ç•¥ static void CGLIB$STATICHOOK1() &#123; CGLIB$THREAD_CALLBACKS = new ThreadLocal(); CGLIB$emptyArgs = new Object[0]; Class var0 = Class.forName(&quot;com.zang.cglibproxy.Zhangsan$$EnhancerByCGLIB$$78b38660&quot;); Class var1; Method[] var10000 = ReflectUtils.findMethods(new String[]&#123;&quot;equals&quot;, &quot;(Ljava/lang/Object;)Z&quot;, &quot;toString&quot;, &quot;()Ljava/lang/String;&quot;, &quot;hashCode&quot;, &quot;()I&quot;, &quot;clone&quot;, &quot;()Ljava/lang/Object;&quot;&#125;, (var1 = Class.forName(&quot;java.lang.Object&quot;)).getDeclaredMethods()); //Â·Â·Â· //åˆå§‹åŒ–ç›®æ ‡ç±»çš„learnæ–¹æ³•å¯¹è±¡ CGLIB$learn$0$Method = ReflectUtils.findMethods(new String[]&#123;&quot;learn&quot;, &quot;()V&quot;&#125;, (var1 = Class.forName(&quot;com.zang.cglibproxy.Zhangsan&quot;)).getDeclaredMethods())[0]; //åˆå§‹åŒ–ä»£ç†ç±»çš„learnæ–¹æ³•å¯¹è±¡ CGLIB$learn$0$Proxy = MethodProxy.create(var1, var0, &quot;()V&quot;, &quot;learn&quot;, &quot;CGLIB$learn$0&quot;); &#125; //è¿™é‡Œç›´æ¥è°ƒç”¨Zhangsan#learn final void CGLIB$learn$0() &#123; super.learn(); &#125; public final void learn() &#123; MethodInterceptor var10000 = this.CGLIB$CALLBACK_0; if (var10000 == null) &#123; CGLIB$BIND_CALLBACKS(this); var10000 = this.CGLIB$CALLBACK_0; &#125; if (var10000 != null) &#123; //è¿™é‡Œæ‰§è¡Œæ‹¦æˆªå™¨å®šä¹‰é€»è¾‘ var10000.intercept(this, CGLIB$learn$0$Method, CGLIB$emptyArgs, CGLIB$learn$0$Proxy); &#125; else &#123; super.learn(); &#125; &#125; //Â·Â·Â·&#125; è°ƒç”¨è¿‡ç¨‹ä¸ºï¼šä»£ç†å¯¹è±¡è°ƒç”¨this.learnæ–¹æ³•â†’è°ƒç”¨æ‹¦æˆªå™¨â†’methodProxy.invokeSuper()â†’CGLIB$learn$0â†’è¢«ä»£ç†å¯¹è±¡learnæ–¹æ³•ã€‚ 1234567package net.sf.cglib.proxy;import java.lang.reflect.Method;public interface MethodInterceptor extends Callback &#123; Object intercept(Object var1, Method var2, Object[] var3, MethodProxy var4) throws Throwable;&#125; 12345678910public class CustomCGlib implements MethodInterceptor &#123; //Â·Â·Â· public Object intercept(Object o, Method method, Object[] objects, MethodProxy methodProxy) throws Throwable &#123; before(); Object obj = methodProxy.invokeSuper(o,objects); after(); return obj; &#125; //Â·Â·Â·&#125; MethodInterceptoræ‹¦æˆªå™¨å°±æ˜¯ç”±MethodProxyçš„invokeSuperæ–¹æ³•è°ƒç”¨ä»£ç†æ–¹æ³•çš„ï¼Œå› æ­¤ï¼ŒMethodProxyç±»ä¸­çš„ä»£ç éå¸¸å…³é”®ï¼Œä¸‹é¢åˆ†æå®ƒå…·ä½“åšäº†ä»€ä¹ˆï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546package net.sf.cglib.proxy;import java.lang.reflect.InvocationTargetException;import java.lang.reflect.Method;import net.sf.cglib.*;public class MethodProxy &#123; private Signature sig1; private Signature sig2; private MethodProxy.CreateInfo createInfo; private final Object initLock = new Object(); private volatile MethodProxy.FastClassInfo fastClassInfo; private void init() &#123; if (this.fastClassInfo == null) &#123; synchronized(this.initLock) &#123; if (this.fastClassInfo == null) &#123; MethodProxy.CreateInfo ci = this.createInfo; MethodProxy.FastClassInfo fci = new MethodProxy.FastClassInfo(); //åˆ›å»ºç›®æ ‡ç±»çš„FastClasså¯¹è±¡(åœ¨ç¼“å­˜ä¸­ï¼Œåˆ™å–å‡ºï¼›æ²¡åœ¨ï¼Œåˆ™é‡æ–°ç”Ÿæˆ) fci.f1 = helper(ci, ci.c1); //åˆ›å»ºä»£ç†ç±»çš„FastClasså¯¹è±¡ fci.f2 = helper(ci, ci.c2); //è·å–learnæ–¹æ³•çš„ç´¢å¼• fci.i1 = fci.f1.getIndex(this.sig1); //è·å–CGLIB$learn$0æ–¹æ³•çš„ç´¢å¼• fci.i2 = fci.f2.getIndex(this.sig2); this.fastClassInfo = fci; &#125; &#125; &#125; &#125; public Object invokeSuper(Object obj, Object[] args) throws Throwable &#123; try &#123; //åˆå§‹åŒ–ï¼Œåˆ›å»ºäº†ä¸¤ä¸ªFastClassç±»å¯¹è±¡ this.init(); MethodProxy.FastClassInfo fci = this.fastClassInfo; //è¿™é‡Œå°†ç›´æ¥è°ƒç”¨ä»£ç†ç±»çš„CGLIB$learn$0æ–¹æ³•ï¼Œè€Œä¸æ˜¯é€šè¿‡åå°„è°ƒç”¨ //fci.f2ï¼šä»£ç†ç±»çš„FastClasså¯¹è±¡ï¼Œfci.i2ä¸ºCGLIB$learn$0æ–¹æ³•å¯¹åº”çš„ç´¢å¼•ï¼Œobjä¸ºå½“å‰çš„ä»£ç†ç±»å¯¹è±¡ï¼Œargsä¸ºlearnæ–¹æ³•çš„å‚æ•°åˆ—è¡¨ return fci.f2.invoke(fci.i2, obj, args); &#125; catch (InvocationTargetException var4) &#123; throw var4.getTargetException(); &#125; &#125; ä¸Šé¢ä»£ç è°ƒç”¨è·å–ä»£ç†ç±»å¯¹åº”çš„FastClassï¼Œå¹¶æ‰§è¡Œä»£ç†æ–¹æ³•ã€‚è¿˜è®°å¾—ä¹‹å‰ç”Ÿæˆçš„ä¸‰ä¸ª.classæ–‡ä»¶å—ï¼ŸZhangsan$$EnhancerByCGLIB$$78b38660$$FastClassByCGLIB$$a8f9873c.classå°±æ˜¯ä»£ç†ç±»çš„FastClassï¼ŒZhangsan$$FastClassByCGLIB$$bcf7b1f4.classå°±æ˜¯è¢«ä»£ç†ç±»çš„FastClassã€‚ CGLibåŠ¨æ€ä»£ç†æ‰§è¡Œä»£ç†æ–¹æ³•çš„æ•ˆç‡ä¹‹æ‰€ä»¥æ¯”JDKé«˜ï¼Œæ˜¯å› ä¸ºCGlibé‡‡ç”¨äº†FastClassæœºåˆ¶ï¼Œå®ƒçš„åŸç†ç®€å•æ¥è¯´å°±æ˜¯ï¼šä¸ºä»£ç†ç±»å’Œè¢«ä»£ç†ç±»å„ç”Ÿæˆä¸€ä¸ªç±»ï¼Œè¿™ä¸ªç±»ä¼šä¸ºä»£ç†ç±»æˆ–è¢«ä»£ç†ç±»çš„æ–¹æ³•åˆ†é…ä¸€ä¸ªindexï¼ˆintç±»å‹ï¼‰ï¼›è¿™ä¸ªindexè¢«å½“ä½œä¸€ä¸ªå…¥å‚ï¼ŒFastClasså¯ä»¥ç›´æ¥å®šä½è¦è°ƒç”¨çš„æ–¹æ³•å¹¶ç›´æ¥è¿›è¡Œè°ƒç”¨ï¼Œçœå»äº†åå°„è°ƒç”¨ï¼Œå› æ­¤è°ƒç”¨æ•ˆç‡æ¯”JDKåŠ¨æ€ä»£ç†é€šè¿‡åå°„è°ƒç”¨é«˜ï¼ˆå¹¶ä¸ç»å¯¹ï¼Œè¿˜éœ€å‚è€ƒJDKç‰ˆæœ¬åŠä½¿ç”¨åœºæ™¯æ¥è¯´ï¼‰ã€‚ä¸‹é¢æ¥åç¼–è¯‘ä¸€ä¸ªFastClassã€‚ 123456789101112131415161718192021222324252627282930313233343536public class Zhangsan$$FastClassByCGLIB$$bcf7b1f4 extends FastClass &#123; public Zhangsan$$FastClassByCGLIB$$bcf7b1f4(Class var1) &#123; super(var1); &#125; public int getIndex(Signature var1) &#123; String var10000 = var1.toString(); switch(var10000.hashCode()) &#123; case 1574139569: if (var10000.equals(&quot;learn()V&quot;)) &#123; //learnæ–¹æ³•è¿”å›0 return 0; &#125; break; case 1826985398: if (var10000.equals(&quot;equals(Ljava/lang/Object;)Z&quot;)) &#123; //Â·Â·Â· &#125; &#125; &#125; //æ ¹æ®indexè·å–æ–¹æ³• public Object invoke(int var1, Object var2, Object[] var3) throws InvocationTargetException &#123; Zhangsan var10000 = (Zhangsan)var2; int var10001 = var1; try &#123; switch(var10001) &#123; case 0: //ä¼ å…¥indexä¸º0åˆ™æ‰§è¡Œlearnæ–¹æ³• var10000.learn(); return null; case 1: return new Boolean(var10000.equals(var3[0])); //Â·Â·Â· FastClasså¹¶ä¸æ˜¯è·Ÿä»£ç†ç±»ä¸€èµ·ç”Ÿæˆçš„ï¼Œè€Œæ˜¯åœ¨ç¬¬ä¸€æ¬¡æ‰§è¡ŒMethodProxyçš„invokeæˆ–invokeSuperæ–¹æ³•æ—¶ç”Ÿæˆçš„ï¼Œå¹¶è¢«æ”¾åœ¨äº†ç¼“å­˜ä¸­ã€‚ 4.æ€»ç»“é€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œç›¸ä¿¡ä¼šå¯¹ä¸¤ç§åŠ¨æ€ä»£ç†çš„å®ç°åŸç†æœ‰ä¸€ä¸ªæ·±å…¥çš„è®¤è¯†ï¼Œæ€»ç»“æ€§æ¯”è¾ƒä¸¤è€…çš„åŒºåˆ«å¦‚ä¸‹ï¼š JDKåŠ¨æ€ä»£ç†å®ç°äº†è¢«ä»£ç†å¯¹è±¡çš„æ¥å£ï¼ŒCGLibåŠ¨æ€ä»£ç†ç»§æ‰¿äº†è¢«ä»£ç†å¯¹è±¡ã€‚ JDKåŠ¨æ€ä»£ç†å’ŒCGLibåŠ¨æ€ä»£ç†éƒ½åœ¨è¿è¡ŒæœŸç”Ÿæˆå­—èŠ‚ç ï¼ŒJDKåŠ¨æ€ä»£ç†ç›´æ¥å†™Classå­—èŠ‚ç ï¼ŒCGLibåŠ¨æ€ä»£ç†ä½¿ç”¨ASMæ¡†æ¶å†™Classå­—èŠ‚ç ã€‚CGLibåŠ¨æ€ä»£ç†å®ç°æ›´å¤æ‚ï¼Œç”Ÿæˆä»£ç†ç±»æ¯”JDKåŠ¨æ€ä»£ç†æ•ˆç‡ä½ã€‚ JDKåŠ¨æ€ä»£ç†è°ƒç”¨ä»£ç†æ–¹æ³•æ˜¯é€šè¿‡åå°„æœºåˆ¶è°ƒç”¨çš„ï¼ŒCGLibåŠ¨æ€ä»£ç†æ˜¯é€šè¿‡FastClassæœºåˆ¶ç›´æ¥è°ƒç”¨æ–¹æ³•çš„ï¼ŒCGLibåŠ¨æ€ä»£ç†çš„æ‰§è¡Œæ•ˆç‡æ›´é«˜ã€‚","categories":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"https://xssdpgy.github.io/categories/%E6%8A%80%E6%9C%AF/"}],"tags":[{"name":"æºç åˆ†æ","slug":"æºç åˆ†æ","permalink":"https://xssdpgy.github.io/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://xssdpgy.github.io/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"},{"name":"åŠ¨æ€ä»£ç†","slug":"åŠ¨æ€ä»£ç†","permalink":"https://xssdpgy.github.io/tags/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/"}]},{"title":"SpringBootå¼‚æ­¥æ–¹æ³•ä¼˜åŒ–å¤„ç†æé«˜å“åº”é€Ÿåº¦","slug":"SpringBootå¼‚æ­¥æ–¹æ³•ä¼˜åŒ–å¤„ç†æé«˜å“åº”é€Ÿåº¦","date":"2022-04-21T02:48:24.000Z","updated":"2022-09-11T15:43:16.281Z","comments":true,"path":"2022/04/21/SpringBootå¼‚æ­¥æ–¹æ³•ä¼˜åŒ–å¤„ç†æé«˜å“åº”é€Ÿåº¦/","link":"","permalink":"https://xssdpgy.github.io/2022/04/21/SpringBoot%E5%BC%82%E6%AD%A5%E6%96%B9%E6%B3%95%E4%BC%98%E5%8C%96%E5%A4%84%E7%90%86%E6%8F%90%E9%AB%98%E5%93%8D%E5%BA%94%E9%80%9F%E5%BA%A6/","excerpt":"1.å‰è¨€æ—¥å¸¸å¼€å‘ä¸­ï¼Œå¯¹äºä¸²è¡ŒåŒ–çš„ä»»åŠ¡é€‚å½“è§£è€¦è€—æ—¶æ“ä½œå’Œä¸šåŠ¡é€»è¾‘ï¼Œåœ¨ä¿è¯ç»“æœå‡†ç¡®æ€§çš„å‰æä¸‹ï¼Œä½¿ç”¨å¼‚æ­¥æ–¹æ³•é€‚å½“è¿›è¡Œå¹¶è¡ŒåŒ–æ”¹é€ ï¼Œå¯ä»¥æé«˜æ¥å£å“åº”é€Ÿåº¦ï¼Œæå‡ä½¿ç”¨ä½“éªŒã€‚ å¦‚ä¸‹æŠ½è±¡çš„ä¸²è¡ŒåŒ–å·¥ä½œæµç¨‹ï¼š ä¸šåŠ¡æŸ¥è¯¢ï¼Œé¦–å…ˆç™»è®°è®°å½•record[cost 3s]ï¼Œä¹‹åä¾æ¬¡æ‰§è¡ŒsearchA[cost 1s]ã€searchB[cost 2s]ã€searchC[cost 2s]åˆ†åˆ«å¾—åˆ°å˜é‡aã€bã€cï¼Œè¿”å›ç»“æœfx(a,b,c)[è®¡ç®—è€—æ—¶å¯å¿½ç•¥ä¸è®°]ã€‚ä»£ç å¦‚ä¸‹ï¼š","text":"1.å‰è¨€æ—¥å¸¸å¼€å‘ä¸­ï¼Œå¯¹äºä¸²è¡ŒåŒ–çš„ä»»åŠ¡é€‚å½“è§£è€¦è€—æ—¶æ“ä½œå’Œä¸šåŠ¡é€»è¾‘ï¼Œåœ¨ä¿è¯ç»“æœå‡†ç¡®æ€§çš„å‰æä¸‹ï¼Œä½¿ç”¨å¼‚æ­¥æ–¹æ³•é€‚å½“è¿›è¡Œå¹¶è¡ŒåŒ–æ”¹é€ ï¼Œå¯ä»¥æé«˜æ¥å£å“åº”é€Ÿåº¦ï¼Œæå‡ä½¿ç”¨ä½“éªŒã€‚ å¦‚ä¸‹æŠ½è±¡çš„ä¸²è¡ŒåŒ–å·¥ä½œæµç¨‹ï¼š ä¸šåŠ¡æŸ¥è¯¢ï¼Œé¦–å…ˆç™»è®°è®°å½•record[cost 3s]ï¼Œä¹‹åä¾æ¬¡æ‰§è¡ŒsearchA[cost 1s]ã€searchB[cost 2s]ã€searchC[cost 2s]åˆ†åˆ«å¾—åˆ°å˜é‡aã€bã€cï¼Œè¿”å›ç»“æœfx(a,b,c)[è®¡ç®—è€—æ—¶å¯å¿½ç•¥ä¸è®°]ã€‚ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930import com.zang.async.service.AsyncCaseService;import lombok.extern.slf4j.Slf4j;import org.springframework.web.bind.annotation.PostMapping;import org.springframework.web.bind.annotation.RestController;import javax.annotation.Resource;import java.time.Duration;import java.time.Instant;@Slf4j@RestControllerpublic class AsyncCaseController &#123; @Resource private AsyncCaseService asyncCaseService; @PostMapping(&quot;/search/sync-test&quot;) public int syncSearch()&#123; log.info(&quot;========test start=========&quot;); Instant start = Instant.now(); asyncCaseService.record(); int a = asyncCaseService.searchA(); int b = asyncCaseService.searchB(); int c = asyncCaseService.searchC(); int result = a+b+c; Instant end = Instant.now(); log.info(&quot;========test end=========cost time is &#123;&#125; seconds&quot;, Duration.between(start,end).getSeconds()); return result; &#125; Â·Â·Â· 123456789101112131415161718import org.springframework.stereotype.Service;@Servicepublic class AsyncCaseServiceImpl implements AsyncCaseService&#123; @Override public int searchA() &#123; try &#123; Thread.sleep(1000);//æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†è€—æ—¶ &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; return 1; &#125; @Override public int searchB() &#123; //å…¶ä»–æ–¹æ³•ç±»ä¼¼ æ‰§è¡Œç»“æœï¼š 122022-04-21 13:32:47.739 INFO 22764 --- [nio-8089-exec-2] com.zang.async.web.AsyncCaseController : ========test start=========2022-04-21 13:32:55.762 INFO 22764 --- [nio-8089-exec-2] com.zang.async.web.AsyncCaseController : ========test end=========cost time is 8 seconds ç»è¿‡åˆ†æï¼Œå¯ä»¥çœ‹åˆ°ä¸‰ä¸ªæŸ¥è¯¢æ–¹æ³•å¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼Œç­‰å¾…éƒ½äº§ç”Ÿç»“æœæ‰§è¡Œfx(a,b,c)ï¼Œrecordæ–¹æ³•æ‰§è¡Œçš„é¡ºåºå’Œå®Œæˆåº¦ä¸å½±å“ç»“æœçš„è¿”å›ï¼Œå¯ä»¥ä½¿ç”¨å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œã€‚æ”¹é€ é€»è¾‘æŠ½è±¡å¦‚ä¸‹ï¼š ä¹‹åå°±ä»£ç å®ç°å±•å¼€é˜è¿°ã€‚ 2.SpringBootä¸­çš„å¼‚æ­¥æ–¹æ³•æ”¯æŒSpringBootå·²ç»æä¾›äº†å¼‚æ­¥æ–¹æ³•æ”¯æŒæ³¨è§£ï¼Œå› æ­¤ä¸éœ€è¦æˆ‘ä»¬è‡ªå·±å»åˆ›å»ºç»´æŠ¤çº¿ç¨‹æˆ–è€…çº¿ç¨‹æ± æ¥å¼‚æ­¥çš„æ‰§è¡Œæ–¹æ³•ã€‚ ä¸»è¦ä¾é ä¸¤ä¸ªæ³¨è§£ï¼š 12@EnableAsync // ä½¿ç”¨å¼‚æ­¥æ–¹æ³•æ—¶éœ€è¦æå‰å¼€å¯(åœ¨å¯åŠ¨ç±»ä¸Šæˆ–é…ç½®ç±»ä¸Š)@Async // è¢«asyncæ³¨è§£ä¿®é¥°çš„æ–¹æ³•ç”±SpringBooté»˜è®¤çº¿ç¨‹æ± (SimpleAsyncTaskExecutor)æ‰§è¡Œ 2.1 è·å–(æœ‰è¿”å›å€¼)å¼‚æ­¥æ–¹æ³•çš„è¿”å›å€¼å¯¹äºæœ‰è¿”å›å€¼çš„å¼‚æ­¥æ–¹æ³•ï¼Œå¯ä½¿ç”¨java.util.concurrent.Futureç±»åŠå…¶å­ç±»æ¥æ¥æ”¶å¼‚æ­¥æ–¹æ³•è¿”å›å€¼ã€‚ 1234567891011121314151617181920import org.springframework.scheduling.annotation.Async;import org.springframework.scheduling.annotation.AsyncResult;import org.springframework.stereotype.Service;import java.util.concurrent.Future;@Servicepublic class AsyncCaseServiceImpl implements AsyncCaseService&#123; @Async @Override public Future&lt;Integer&gt; searchA() &#123; try &#123; Thread.sleep(1000); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; return new AsyncResult&lt;&gt;(1); &#125; //ç•¥ æ— è¿”å›å€¼å¼‚æ­¥æ–¹æ³•çš„å¼‚å¸¸æ•è·è§3.3ã€‚ 2.2 å¼‚æ­¥ä»»åŠ¡å¹¶è¡Œæ§åˆ¶æ¥ä¸ŠèŠ‚ï¼Œåœ¨å¯¹Serviceä¸­æœ‰è¿”å›å€¼çš„æ–¹æ³•è¿›è¡Œå¼‚æ­¥æ”¹é€ çš„åŒæ—¶ï¼Œä¸šåŠ¡å¤„ç†ä¾§éœ€è¦æ·»åŠ å¹¶è¡Œæ§åˆ¶ï¼Œä½¿å¹¶è¡Œçš„å¼‚æ­¥éƒ½è¿”å›ç»“æœæ‰è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455import com.zang.async.service.AsyncCaseService;import lombok.extern.slf4j.Slf4j;import org.springframework.web.bind.annotation.PostMapping;import org.springframework.web.bind.annotation.RestController;import javax.annotation.Resource;import java.time.Duration;import java.time.Instant;import java.util.concurrent.Future;@Slf4j@RestControllerpublic class AsyncCaseController &#123; @Resource private AsyncCaseService asyncCaseService; @PostMapping(&quot;/search/async-test&quot;) public int asyncSearch() &#123; log.info(&quot;========test start=========&quot;); Instant start = Instant.now(); asyncCaseService.record(); Future&lt;Integer&gt; searchAFuture = asyncCaseService.searchA(); Future&lt;Integer&gt; searchBFuture = asyncCaseService.searchB(); Future&lt;Integer&gt; searchCFuture = asyncCaseService.searchC(); while (true) &#123; if (searchAFuture.isDone() &amp;&amp; searchBFuture.isDone() &amp;&amp; searchCFuture.isDone()) &#123; break; &#125; if (searchAFuture.isCancelled() || searchBFuture.isCancelled() || searchCFuture.isCancelled()) &#123; log.info(&quot;async work has cancelled , break&quot;); break; &#125; try &#123; Thread.sleep(100); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125; int a = 0, b = 0, c = 0; try &#123; a = searchAFuture.get(); b = searchBFuture.get(); c = searchCFuture.get(); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; int result = a + b + c; Instant end = Instant.now(); log.info(&quot;========test end=========cost time is &#123;&#125; seconds&quot;, Duration.between(start, end).getSeconds()); return result; &#125;&#125; ç»“æœï¼š 122022-04-21 14:23:35.486 INFO 19912 --- [nio-8089-exec-4] com.zang.async.web.AsyncCaseController : ========test start=========2022-04-21 14:23:37.516 INFO 19912 --- [nio-8089-exec-4] com.zang.async.web.AsyncCaseController : ========test end=========cost time is 2 seconds 3.è‡ªå®šä¹‰çº¿ç¨‹æ± æ‰§è¡Œå¼‚æ­¥æ–¹æ³•@Asyncä½¿ç”¨äº†çº¿ç¨‹æ± org.springframework.core.task.SimpleAsyncTaskExecutoræ¥æ‰§è¡Œæˆ‘ä»¬çš„å¼‚æ­¥æ–¹æ³•ï¼Œå®é™…å¼€å‘ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå®šä¹‰è‡ªå·±çš„çº¿ç¨‹æ± ï¼Œä¾¿äºå¯¹çº¿ç¨‹æ± è¿›è¡Œåˆç†é…ç½®ã€‚ 3.1 è‡ªå®šä¹‰çº¿ç¨‹æ± 12345678910111213141516171819202122232425262728import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.scheduling.annotation.EnableAsync;import org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;import java.util.concurrent.Executor;import java.util.concurrent.ThreadPoolExecutor;@EnableAsync@Configurationpublic class AsyncThreadPoolConfigure &#123; @Bean(&quot;asyncThreadPoolTaskExecutor&quot;) public Executor asyncThreadPoolTaskExecutor() &#123; ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor(); executor.setCorePoolSize(4); executor.setMaxPoolSize(4); executor.setQueueCapacity(10); executor.setKeepAliveSeconds(60); executor.setThreadNamePrefix(&quot;async-task-executor&quot;); executor.setThreadGroupName(&quot;async-task-executor-group&quot;); executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy()); // æ‰€æœ‰ä»»åŠ¡ç»“æŸåå…³é—­çº¿ç¨‹æ±  //executor.setWaitForTasksToCompleteOnShutdown(true); executor.initialize(); return executor; &#125;&#125; 3.2 åœ¨@Asyncæ³¨è§£ä¸ŠæŒ‡å®šæ‰§è¡Œçš„çº¿ç¨‹æ± 12345@Async(&quot;asyncThreadPoolTaskExecutor&quot;)@Overridepublic Future&lt;Integer&gt; searchA() &#123; try &#123; //ç•¥ ä»¥ä¸Šï¼Œè‡ªå®šä¹‰çº¿ç¨‹æ± æ‰§è¡Œå¼‚æ­¥æ–¹æ³•å³å®Œæˆã€‚ 3.3 è‡ªå®šä¹‰çº¿ç¨‹æ± ç›‘æ§è‡ªå®šä¹‰çš„çº¿ç¨‹æ± é…ç½®çš„å‚æ•°æ˜¯å¦åˆç†å¾€å¾€ä½¿äººæ‘¸ä¸ç€å¤´è„‘ï¼Œå®é™…ä¸Šï¼Œçº¿ç¨‹æ± æ‰§è¡Œå™¨org.springframework.scheduling.concurrent.ThreadPoolTaskExecutorä¸ºSpringè‡ªå¸¦çš„ï¼Œåœ¨æµ‹è¯•ä¸­å¯ä»¥åˆ›å»ºæ–°æ‰§è¡Œå™¨ï¼Œç»§æ‰¿è¯¥æ‰§è¡Œå™¨ï¼Œé‡å†™submitæ–¹æ³•ï¼Œå¯¹å…¶å¢åŠ ç›‘æ§ï¼Œä»è€ŒæŸ¥çœ‹çº¿ç¨‹æ± çŠ¶æ€ï¼Œå¾—åˆ°åˆé€‚çš„çº¿ç¨‹æ± é…ç½®ã€‚ 123456789101112public class MonitorThreadPoolExecutor extends ThreadPoolTaskExecutor &#123; public void monitor()&#123; log.info(&quot;**** getActiveCount==&#123;&#125;,getPoolSize==&#123;&#125;,getLargestPoolSize==&#123;&#125;,getTaskCount==&#123;&#125;,getCompletedTaskCount==&#123;&#125;,getQueue==&#123;&#125; ***&quot;,this.getThreadPoolExecutor().getActiveCount(),this.getThreadPoolExecutor().getPoolSize(),this.getThreadPoolExecutor().getLargestPoolSize(),this.getThreadPoolExecutor().getTaskCount(),this.getThreadPoolExecutor().getCompletedTaskCount(),this.getThreadPoolExecutor().getQueue().size()); &#125; @Override public &lt;T&gt; Future&lt;T&gt; submit(Callable&lt;T&gt; task) &#123; monitor(); return super.submit(task); &#125;&#125; åœ¨3.1è‡ªå®šä¹‰çº¿ç¨‹æ± æ—¶åˆ›å»ºè¯¥ç›‘æ§æ‰§è¡Œå™¨å³å¯ã€‚ 3.3 æ— è¿”å›å€¼å¼‚æ­¥æ–¹æ³•çš„å¼‚å¸¸æ•è·ä»¥å®ç°org.springframework.scheduling.annotation.AsyncConfigureræ¥å£çš„getAsyncExecutoræ–¹æ³•å’ŒgetAsyncUncaughtExceptionHandleræ–¹æ³•æ”¹é€ é…ç½®ç±»ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950import lombok.extern.slf4j.Slf4j;import org.springframework.aop.interceptor.AsyncUncaughtExceptionHandler;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.scheduling.annotation.AsyncConfigurer;import org.springframework.scheduling.annotation.EnableAsync;import org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;import java.lang.reflect.Method;import java.util.concurrent.Executor;import java.util.concurrent.ThreadPoolExecutor;@Slf4j@EnableAsync@Configurationpublic class AsyncThreadPoolConfigure implements AsyncConfigurer &#123; //çº¿ç¨‹æ± åˆ›å»ºæ–¹æ³•ä¸ºé‡å†™ getAsyncExecutor @Bean(&quot;asyncThreadPoolTaskExecutor&quot;) @Override public Executor getAsyncExecutor() &#123; ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor(); executor.setCorePoolSize(4); executor.setMaxPoolSize(4); executor.setQueueCapacity(10); executor.setKeepAliveSeconds(60); executor.setThreadNamePrefix(&quot;async-task-executor&quot;); executor.setThreadGroupName(&quot;async-task-executor-group&quot;); executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy()); // æ‰€æœ‰ä»»åŠ¡ç»“æŸåå…³é—­çº¿ç¨‹æ±  executor.setWaitForTasksToCompleteOnShutdown(true); executor.initialize(); return executor; &#125; @Override public AsyncUncaughtExceptionHandler getAsyncUncaughtExceptionHandler() &#123; return new AsyncExceptionHandler(); &#125; public class AsyncExceptionHandler implements AsyncUncaughtExceptionHandler &#123; @Override public void handleUncaughtException(Throwable throwable, Method method, Object... obj) &#123; log.error(&quot;Exception message is &#123;&#125;&quot;, throwable.getMessage()); log.error(&quot;Method name is &#123;&#125; &quot;, method.getName()); for (Object param : obj) &#123; log.error(&quot;Parameter value - &#123;&#125;&quot;, param); &#125; &#125; &#125; è¡¨ç°å¦‚ä¸‹ï¼š 1234567891011@Async(&quot;asyncThreadPoolTaskExecutor&quot;) @Override public void record() &#123; try &#123; Thread.sleep(3000); log.info(&quot;current thread name is &#123;&#125;&quot;,Thread.currentThread().getName()); throw new RuntimeException(&quot;network not connect &quot;); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125; æ§åˆ¶å°ï¼š 123452022-04-21 15:34:14.931 INFO 16596 --- [nio-8089-exec-1] com.zang.async.web.AsyncCaseController : ========test start=========2022-04-21 15:34:16.965 INFO 16596 --- [nio-8089-exec-1] com.zang.async.web.AsyncCaseController : ========test end=========cost time is 2 seconds2022-04-21 15:34:17.939 INFO 16596 --- [-task-executor1] c.z.async.service.AsyncCaseServiceImpl : current thread name is async-task-executor12022-04-21 15:34:17.940 ERROR 16596 --- [-task-executor1] c.z.a.c.AsyncThreadPoolConfigure : Exception message is network not connect 2022-04-21 15:34:17.941 ERROR 16596 --- [-task-executor1] c.z.a.c.AsyncThreadPoolConfigure : Method name is record 4.ä¸€äº›æ€è€ƒå¼‚æ­¥æ–¹æ³•çš„é›†æˆæä¸ºæ–¹ä¾¿ï¼Œå¯ä»¥æœ‰æ•ˆæé«˜æ¥å£å“åº”é€Ÿåº¦ï¼Œä½†æ˜¯ä½¿ç”¨è¿‡ç¨‹ä¸­è¦æ³¨æ„åˆç†çš„åˆ†æä¸šåŠ¡é€»è¾‘åŠæœåŠ¡å™¨èµ„æºæ‰¿è½½èƒ½åŠ›ï¼Œä¸å¯æ»¥ç”¨ã€‚ å¯¹äºå¼ºä¸€è‡´æ€§çš„ä¸šåŠ¡ï¼Œéœ€è¦æ³¨æ„ï¼Œå¼‚æ­¥æ–¹æ³•æ‰§è¡Œå¤±è´¥å¯¹äºå‰éƒ¨åˆ†çš„å·²æ‰§è¡Œçš„éå¼‚æ­¥æ“ä½œæ˜¯æ— å½±å“çš„ï¼Œå› æ­¤åœ¨è¯¥åœºæ™¯å¼‚æ­¥å¹¶ä¸å¯é ï¼› æ­¤å¤–ï¼Œå¯¹äºå¹¶å‘é‡è¿‡å¤§çš„ä»»åŠ¡ï¼Œå¼‚æ­¥çº¿ç¨‹æ± çš„é˜Ÿåˆ—ç¼“å­˜ä¹Ÿè¾ƒä¸ºæ¶ˆè€—æœåŠ¡å™¨èµ„æºï¼Œéœ€è¦åˆç†è§„åˆ’ï¼Œå¿…è¦æ—¶å»ºè®®é‡‡ç”¨æ›´ä¸ºå¯é çš„æ¶ˆæ¯é˜Ÿåˆ—ç­‰ä¸­é—´ä»¶ã€‚","categories":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"https://xssdpgy.github.io/categories/%E6%8A%80%E6%9C%AF/"}],"tags":[{"name":"å¼‚æ­¥","slug":"å¼‚æ­¥","permalink":"https://xssdpgy.github.io/tags/%E5%BC%82%E6%AD%A5/"},{"name":"ä¼˜åŒ–","slug":"ä¼˜åŒ–","permalink":"https://xssdpgy.github.io/tags/%E4%BC%98%E5%8C%96/"}]},{"title":"äºŒè¿›åˆ¶æ–¹å¼å®‰è£…k8sé›†ç¾¤","slug":"äºŒè¿›åˆ¶æ–¹å¼å®‰è£…k8sé›†ç¾¤","date":"2022-03-30T07:51:45.000Z","updated":"2022-09-11T15:43:16.282Z","comments":true,"path":"2022/03/30/äºŒè¿›åˆ¶æ–¹å¼å®‰è£…k8sé›†ç¾¤/","link":"","permalink":"https://xssdpgy.github.io/2022/03/30/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%B9%E5%BC%8F%E5%AE%89%E8%A3%85k8s%E9%9B%86%E7%BE%A4/","excerpt":"ä½¿ç”¨ä¸‰å°æœåŠ¡å™¨æ­å»ºk8sé›†ç¾¤ï¼Œé›†ç¾¤æœåŠ¡å™¨åœ°å€è§„åˆ’å¦‚ä¸‹ï¼š","text":"ä½¿ç”¨ä¸‰å°æœåŠ¡å™¨æ­å»ºk8sé›†ç¾¤ï¼Œé›†ç¾¤æœåŠ¡å™¨åœ°å€è§„åˆ’å¦‚ä¸‹ï¼š IP hostname å¤‡æ³¨ 192.168.206.128 master ä¸»èŠ‚ç‚¹ 192.168.206.129 node1 ä»èŠ‚ç‚¹ 192.168.206.130 node2 ä»èŠ‚ç‚¹ 1.ç¯å¢ƒé…ç½®1.1 ä¿®æ”¹ä¸»æœºåmaster: 1hostnamectl set-hostname master node1: 1hostnamectl set-hostname node1 node2: 1hostnamectl set-hostname 1.2 å…³é—­é˜²ç«å¢™ï¼ˆallï¼‰12systemctl stop firewalldsystemctl disable firewalld 1.3 å…³é—­selinuxï¼ˆallï¼‰12setenforce 0 # ä¸´æ—¶å…³é—­sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config # æ°¸ä¹…å…³é—­ 1.4 å…³é—­swapï¼ˆallï¼‰123swapoff -a # ä¸´æ—¶å…³é—­ï¼›å…³é—­swapä¸»è¦æ˜¯ä¸ºäº†æ€§èƒ½è€ƒè™‘sed -ri &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstabfree # æŸ¥çœ‹å†…å­˜ï¼Œswapä¸º0åˆ™ä¸ºå…³é—­ 1.5 å°†æ¡¥æ¥çš„IPv4æµé‡ä¼ é€’åˆ°iptablesçš„é“¾ï¼ˆallï¼‰1234cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOFnet.bridge.bridge-nf-call-ip6tables = 1net.bridge.bridge-nf-call-iptables = 1EOF 1sysctl --system 1.6 æ·»åŠ ä¸»æœºåä¸IPå¯¹åº”çš„å…³ç³» ( master )12345cat &gt;&gt; /etc/hosts &lt;&lt; EOF 192.168.206.128 master192.168.206.129 node1192.168.206.130 node2EOF 2.å‡†å¤‡ cfssl è¯ä¹¦ç”Ÿæˆå·¥å…· ( master )cfssl æ˜¯ä¸€ä¸ªå¼€æºçš„è¯ä¹¦ç®¡ç†å·¥å…·ï¼Œä½¿ç”¨ json æ–‡ä»¶ç”Ÿæˆè¯ä¹¦ï¼Œç›¸æ¯” openssl æ›´æ–¹ä¾¿ä½¿ç”¨ã€‚ æ‰¾ä»»æ„ä¸€å°æœåŠ¡å™¨æ“ä½œï¼Œè¿™é‡Œç”¨ Master èŠ‚ç‚¹ã€‚ 12345678wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64chmod +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64mv cfssl_linux-amd64 /usr/local/bin/cfsslmv cfssljson_linux-amd64 /usr/local/bin/cfssljsonmv cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfochmod +x /usr/bin/cfssl* 2.1 ç”Ÿæˆ Etcd è¯ä¹¦ ï¼ˆ1ï¼‰è‡ªç­¾è¯ä¹¦é¢å‘æœºæ„ï¼ˆCAï¼‰ åˆ›å»ºå·¥ä½œç›®å½•123mkdir -p ~/TLS/&#123;etcd,k8s&#125;cd TLS/etcd 2.2 è‡ªç­¾CA1234567891011121314151617181920cat &gt; ca-config.json &lt;&lt; EOF&#123; &quot;signing&quot;: &#123; &quot;default&quot;: &#123; &quot;expiry&quot;: &quot;87600h&quot; &#125;, &quot;profiles&quot;: &#123; &quot;www&quot;: &#123; &quot;expiry&quot;: &quot;87600h&quot;, &quot;usages&quot;: [ &quot;signing&quot;, &quot;key encipherment&quot;, &quot;server auth&quot;, &quot;client auth&quot; ] &#125; &#125; &#125;&#125;EOF 12345678910111213141516cat &gt; ca-csr.json &lt;&lt; EOF&#123; &quot;CN&quot;: &quot;etcd CA&quot;, &quot;key&quot;: &#123; &quot;algo&quot;: &quot;rsa&quot;, &quot;size&quot;: 2048 &#125;, &quot;names&quot;: [ &#123; &quot;C&quot;: &quot;CN&quot;, &quot;L&quot;: &quot;Beijing&quot;, &quot;ST&quot;: &quot;Beijing&quot; &#125; ]&#125;EOF 2.3 ç”ŸæˆCAè¯ä¹¦1cfssl gencert -initca ca-csr.json | cfssljson -bare ca - 12[root@master etcd]# ls ca*pem #æŸ¥çœ‹ca-key.pem ca.pem 2.4 ä½¿ç”¨è‡ªç­¾ CA ç­¾å‘ Etcd HTTPS è¯ä¹¦ åˆ›å»ºè¯ä¹¦ç”³è¯·æ–‡ä»¶ï¼š(ä¿®æ”¹å¯¹åº”çš„masterå’Œnodeçš„IPåœ°å€)123456789101112131415161718192021cat &gt; server-csr.json &lt;&lt; EOF&#123; &quot;CN&quot;: &quot;etcd&quot;, &quot;hosts&quot;: [ &quot;192.168.206.128&quot;, &quot;192.168.206.129&quot;, &quot;192.168.206.130&quot; ], &quot;key&quot;: &#123; &quot;algo&quot;: &quot;rsa&quot;, &quot;size&quot;: 2048 &#125;, &quot;names&quot;: [ &#123; &quot;C&quot;: &quot;CN&quot;, &quot;L&quot;: &quot;BeiJing&quot;, &quot;ST&quot;: &quot;BeiJing&quot; &#125; ]&#125;EOF 2.5 ç”ŸæˆSERVERè¯ä¹¦1cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www server-csr.json | cfssljson -bare server 12[root@master etcd]# ls server*pem #æŸ¥çœ‹server-key.pem server.pem 3.éƒ¨ç½²etcdé›†ç¾¤3.1 ä¸‹è½½12ä¸‹è½½åœ°å€ï¼šhttps://github.com/etcd-io/etcd/releasesç‰ˆæœ¬ï¼š3.4.14 ä»¥ä¸‹åœ¨master ä¸Šæ“ä½œï¼Œä¸ºç®€åŒ–æ“ä½œï¼Œå®Œæˆåå°†master ç”Ÿæˆçš„æ‰€æœ‰æ–‡ä»¶æ‹·è´åˆ°node1 å’Œnode2ã€‚ 3.2 åˆ›å»ºå·¥ä½œç›®å½•å¹¶è§£å‹äºŒè¿›åˆ¶åŒ…123mkdir /opt/etcd/&#123;bin,cfg,ssl&#125; -ptar zxvf etcd-v3.4.14-linux-amd64.tar.gzmv etcd-v3.4.14-linux-amd64/&#123;etcd,etcdctl&#125; /opt/etcd/bin/ 3.3 åˆ›å»ºetcd.conf12345678910111213cat &gt; /opt/etcd/cfg/etcd.conf &lt;&lt; EOF#[Member]ETCD_NAME=&quot;etcd-1&quot;ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;ETCD_LISTEN_PEER_URLS=&quot;https://192.168.206.128:2380&quot;ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.206.128:2379&quot;#[Clustering]ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.206.128:2380&quot;ETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.206.128:2379&quot;ETCD_INITIAL_CLUSTER=&quot;etcd-1=https://192.168.206.128:2380,etcd-2=https://192.168.206.129:2380,etcd-3=https://192.168.206.130:2380&quot;ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;EOF ETCD_NAMEï¼šèŠ‚ç‚¹åç§°ï¼Œé›†ç¾¤ä¸­å”¯ä¸€ ETCD_DATA_DIRï¼šæ•°æ®ç›®å½• ETCD_LISTEN_PEER_URLSï¼šé›†ç¾¤é€šä¿¡ç›‘å¬åœ°å€ ETCD_LISTEN_CLIENT_URLSï¼šå®¢æˆ·ç«¯è®¿é—®ç›‘å¬åœ°å€ ETCD_INITIAL_ADVERTISE_PEER_URLSï¼šé›†ç¾¤é€šå‘Šåœ°å€ ETCD_ADVERTISE_CLIENT_URLSï¼šå®¢æˆ·ç«¯é€šå‘Šåœ°å€ ETCD_INITIAL_CLUSTERï¼šé›†ç¾¤èŠ‚ç‚¹åœ°å€ ETCD_INITIAL_CLUSTER_TOKENï¼šé›†ç¾¤ Token ETCD_INITIAL_CLUSTER_STATEï¼šåŠ å…¥é›†ç¾¤çš„å½“å‰çŠ¶æ€ï¼Œnew æ˜¯æ–°é›†ç¾¤ï¼Œexisting è¡¨ç¤ºåŠ å…¥ å·²æœ‰é›†ç¾¤ 3.4 åˆ›å»ºetcd.service12345678910111213141516171819202122cat &gt; /usr/lib/systemd/system/etcd.service &lt;&lt; EOF[Unit]Description=Etcd ServerAfter=network.targetAfter=network-online.targetWants=network-online.target[Service]Type=notifyEnvironmentFile=/opt/etcd/cfg/etcd.confExecStart=/opt/etcd/bin/etcd \\--cert-file=/opt/etcd/ssl/server.pem \\--key-file=/opt/etcd/ssl/server-key.pem \\--peer-cert-file=/opt/etcd/ssl/server.pem \\--peer-key-file=/opt/etcd/ssl/server-key.pem \\--trusted-ca-file=/opt/etcd/ssl/ca.pem \\--peer-trusted-ca-file=/opt/etcd/ssl/ca.pem \\--logger=zapRestart=on-failureLimitNOFILE=65536[Install]WantedBy=multi-user.targetEOF 3.5 æ‹·è´ä¸Šä¸€æ­¥ç”Ÿæˆçš„è¯ä¹¦åˆ°é…ç½®è·¯å¾„ 1cp ~/TLS/etcd/ca*pem ~/TLS/etcd/server*pem /opt/etcd/ssl/ 3.6 å°†master ç”Ÿæˆçš„æ‰€æœ‰æ–‡ä»¶æ‹·è´åˆ°node1 å’Œnode212345scp -r /opt/etcd/ root@192.168.206.129:/opt/scp /usr/lib/systemd/system/etcd.service root@192.168.206.129:/usr/lib/systemd/system/scp -r /opt/etcd/ root@192.168.206.130:/opt/scp /usr/lib/systemd/system/etcd.service root@192.168.206.130:/usr/lib/systemd/system/ åˆ†åˆ«ä¿®æ”¹ etcd.conf é…ç½®æ–‡ä»¶ä¸­çš„èŠ‚ç‚¹åç§°å’Œå½“å‰æœåŠ¡å™¨ IPï¼š(node1æ”¹ä¸º etcd-2ï¼Œnode2 æ”¹ä¸º etcd-3) 3.7 å¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨1234# ä¸‰å°åŒæ—¶æ‰§è¡Œsystemctl daemon-reloadsystemctl start etcdsystemctl enable etcd æŸ¥çœ‹çŠ¶æ€ï¼š 1234/opt/etcd/bin/etcdctl --cacert=/opt/etcd/ssl/ca.pem --cert=/opt/etcd/ssl/server.pem --key=/opt/etcd/ssl/server-key.pem --endpoints=&quot;https://192.168.206.128:2379,https://192.168.206.129:2379,https://192.168.206.130:2379&quot; endpoint health#å¯è§†åŒ–å±•ç¤º/opt/etcd/bin/etcdctl --cacert=/opt/etcd/ssl/ca.pem --cert=/opt/etcd/ssl/server.pem --key=/opt/etcd/ssl/server-key.pem --endpoints=&quot;https://192.168.206.128:2379,https://192.168.206.129:2379,https://192.168.206.130:2379&quot; endpoint status --write-out=table 4.å®‰è£…dockerï¼ˆallï¼‰4.1 ä¸‹è½½12ä¸‹è½½åœ°å€ï¼šhttps://download.docker.com/linux/static/stable/x86_64/ç‰ˆæœ¬ï¼š19.03.9 4.2 è§£å‹åŠå®‰è£…12tar zxvf docker-19.03.9.tgz mv docker/* /usr/bin 4.3 systemd ç®¡ç† docker12345678910111213141516171819202122cat &gt; /usr/lib/systemd/system/docker.service &lt;&lt; EOF[Unit]Description=Docker Application Container EngineDocumentation=https://docs.docker.comAfter=network-online.target firewalld.serviceWants=network-online.target[Service]Type=notifyExecStart=/usr/bin/dockerdExecReload=/bin/kill -s HUP $MAINPIDLimitNOFILE=infinityLimitNPROC=infinityLimitCORE=infinityTimeoutStartSec=0Delegate=yesKillMode=processRestart=on-failureStartLimitBurst=3StartLimitInterval=60s[Install]WantedBy=multi-user.targetEOF 4.4 é…ç½®é˜¿é‡Œäº‘åŠ é€Ÿ123456mkdir /etc/dockercat &gt; /etc/docker/daemon.json &lt;&lt; EOF&#123; &quot;registry-mirrors&quot;: [&quot;https://b9pmyelo.mirror.aliyuncs.com&quot;]&#125;EOF 4.5 å¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨123systemctl daemon-reloadsystemctl start dockersystemctl enable docker 4.6 æŸ¥è¯¢æ˜¯å¦å®‰è£…æˆåŠŸ12[root@master etcd]# docker -vDocker version 19.03.9, build 9d988398e7 5.éƒ¨ç½²Master Nodeï¼ˆmasterï¼‰5.1 ç”Ÿæˆ kube-apiserver è¯ä¹¦ è‡ªç­¾è¯ä¹¦é¢å‘æœºæ„ï¼ˆCAï¼‰1cd TLS/k8s 1234567891011121314151617181920cat &gt; ca-config.json &lt;&lt; EOF&#123; &quot;signing&quot;: &#123; &quot;default&quot;: &#123; &quot;expiry&quot;: &quot;87600h&quot; &#125;, &quot;profiles&quot;: &#123; &quot;kubernetes&quot;: &#123; &quot;expiry&quot;: &quot;87600h&quot;, &quot;usages&quot;: [ &quot;signing&quot;, &quot;key encipherment&quot;, &quot;server auth&quot;, &quot;client auth&quot; ] &#125; &#125; &#125;&#125;EOF 123456789101112131415161718cat &gt; ca-csr.json &lt;&lt; EOF&#123; &quot;CN&quot;: &quot;kubernetes&quot;, &quot;key&quot;: &#123; &quot;algo&quot;: &quot;rsa&quot;, &quot;size&quot;: 2048 &#125;, &quot;names&quot;: [ &#123; &quot;C&quot;: &quot;CN&quot;, &quot;L&quot;: &quot;Beijing&quot;, &quot;ST&quot;: &quot;Beijing&quot;, &quot;O&quot;: &quot;k8s&quot;, &quot;OU&quot;: &quot;System&quot; &#125; ]&#125;EOF 5.2 ç”ŸæˆCAè¯ä¹¦1cfssl gencert -initca ca-csr.json | cfssljson -bare ca - 12[root@master k8s]# ls ca*pem #æŸ¥çœ‹ca-key.pem ca.pem 5.3 ä½¿ç”¨è‡ªç­¾ CA ç­¾å‘ kube-apiserver HTTPS è¯ä¹¦ åˆ›å»ºè¯ä¹¦ç”³è¯·æ–‡ä»¶12345678910111213141516171819202122232425262728293031cat &gt; server-csr.json &lt;&lt; EOF&#123; &quot;CN&quot;: &quot;kubernetes&quot;, &quot;hosts&quot;: [ &quot;10.0.0.1&quot;, &quot;127.0.0.1&quot;, &quot;192.168.206.128&quot;, &quot;192.168.206.129&quot;, &quot;192.168.206.130&quot;, &quot;192.168.206.131&quot;, &quot;kubernetes&quot;, &quot;kubernetes.default&quot;, &quot;kubernetes.default.svc&quot;, &quot;kubernetes.default.svc.cluster&quot;, &quot;kubernetes.default.svc.cluster.local&quot; ], &quot;key&quot;: &#123; &quot;algo&quot;: &quot;rsa&quot;, &quot;size&quot;: 2048 &#125;, &quot;names&quot;: [ &#123; &quot;C&quot;: &quot;CN&quot;, &quot;L&quot;: &quot;BeiJing&quot;, &quot;ST&quot;: &quot;BeiJing&quot;, &quot;O&quot;: &quot;k8s&quot;, &quot;OU&quot;: &quot;System&quot; &#125; ]&#125;EOF æ³¨ï¼š192.168.206.131ä¸ºé¢„ç•™å‡ºçš„IPã€‚ 5.4 ç”ŸæˆSERVERè¯ä¹¦1cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes server-csr.json | cfssljson -bare server 12[root@master k8s]# ls server*pem #æŸ¥çœ‹server-key.pem server.pem 5.5 ä¸‹è½½k8så®‰è£…åŒ…å¹¶è§£å‹12ä¸‹è½½åœ°å€ï¼šhttps://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.18.md#server-binariesç‰ˆæœ¬ï¼š1.18.20 (å‹ç¼©åŒ…åï¼škubernetes-server-linux-amd64.tar.gz) 12345mkdir -p /opt/kubernetes/&#123;bin,cfg,ssl,logs&#125;tar zxvf kubernetes-server-linux-amd64.tar.gzcd kubernetes/server/bincp kube-apiserver kube-scheduler kube-controller-manager /opt/kubernetes/bincp kubectl /usr/bin/ 5.6 éƒ¨ç½²kube-apiserver123456789101112131415161718192021222324252627282930cat &gt; /opt/kubernetes/cfg/kube-apiserver.conf &lt;&lt; EOFKUBE_APISERVER_OPTS=&quot;--logtostderr=false \\\\--v=2 \\\\--log-dir=/opt/kubernetes/logs \\\\--etcd-servers=https://192.168.206.128:2379,https://192.168.206.129:2379,https://192.168.206.130:2379 \\\\--bind-address=192.168.206.128 \\\\--secure-port=6443 \\\\--advertise-address=192.168.206.128 \\\\--allow-privileged=true \\\\--service-cluster-ip-range=10.0.0.0/24 \\\\--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \\\\--authorization-mode=RBAC,Node \\\\--enable-bootstrap-token-auth=true \\\\--token-auth-file=/opt/kubernetes/cfg/token.csv \\\\--service-node-port-range=30000-32767 \\\\--kubelet-client-certificate=/opt/kubernetes/ssl/server.pem \\\\--kubelet-client-key=/opt/kubernetes/ssl/server-key.pem \\\\--tls-cert-file=/opt/kubernetes/ssl/server.pem \\\\--tls-private-key-file=/opt/kubernetes/ssl/server-key.pem \\\\--client-ca-file=/opt/kubernetes/ssl/ca.pem \\\\--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \\\\--etcd-cafile=/opt/etcd/ssl/ca.pem \\\\--etcd-certfile=/opt/etcd/ssl/server.pem \\\\--etcd-keyfile=/opt/etcd/ssl/server-key.pem \\\\--audit-log-maxage=30 \\\\--audit-log-maxbackup=3 \\\\--audit-log-maxsize=100 \\\\--audit-log-path=/opt/kubernetes/logs/k8s-audit.log&quot;EOF ä¸Šé¢ä¸¤ä¸ª\\ \\ ç¬¬ä¸€ä¸ªæ˜¯è½¬ä¹‰ç¬¦ï¼Œç¬¬äºŒä¸ªæ˜¯æ¢è¡Œç¬¦ï¼Œä½¿ç”¨è½¬ä¹‰ç¬¦æ˜¯ä¸ºäº†ä½¿ç”¨ EOF ä¿ç•™æ¢è¡Œç¬¦ã€‚ â€“logtostderrï¼šå¯ç”¨æ—¥å¿— â€”vï¼šæ—¥å¿—ç­‰çº§ â€“log-dirï¼šæ—¥å¿—ç›®å½• â€“etcd-serversï¼šetcd é›†ç¾¤åœ°å€ â€“bind-addressï¼šç›‘å¬åœ°å€ â€“secure-portï¼šhttps å®‰å…¨ç«¯å£ â€“advertise-addressï¼šé›†ç¾¤é€šå‘Šåœ°å€ â€“allow-privilegedï¼šå¯ç”¨æˆæƒ â€“service-cluster-ip-rangeï¼šService è™šæ‹Ÿ IP åœ°å€æ®µ â€“enable-admission-pluginsï¼šå‡†å…¥æ§åˆ¶æ¨¡å— â€“authorization-modeï¼šè®¤è¯æˆæƒï¼Œå¯ç”¨ RBAC æˆæƒå’ŒèŠ‚ç‚¹è‡ªç®¡ç† â€“enable-bootstrap-token-authï¼šå¯ç”¨ TLS bootstrap æœºåˆ¶ â€“token-auth-fileï¼šbootstrap token æ–‡ä»¶ â€“service-node-port-rangeï¼šService nodeport ç±»å‹é»˜è®¤åˆ†é…ç«¯å£èŒƒå›´ â€“kubelet-client-xxxï¼šapiserver è®¿é—® kubelet å®¢æˆ·ç«¯è¯ä¹¦ â€“tls-xxx-fileï¼šapiserver https è¯ä¹¦ â€“etcd-xxxfileï¼šè¿æ¥ Etcd é›†ç¾¤è¯ä¹¦ â€“audit-log-xxxï¼šå®¡è®¡æ—¥å¿— 5.7 æŠŠç”Ÿæˆçš„è¯ä¹¦æ‹·è´åˆ°é…ç½®æ–‡ä»¶ä¸­çš„è·¯å¾„1cp ~/TLS/k8s/ca*pem ~/TLS/k8s/server*pem /opt/kubernetes/ssl/ 5.8 åˆ›å»ºä¸Šè¿°é…ç½®æ–‡ä»¶ä¸­ token æ–‡ä»¶123cat &gt; /opt/kubernetes/cfg/token.csv &lt;&lt; EOFc47ffb939f5ca36231d9e3121a252940,kubelet-bootstrap,10001,&quot;system:node-bootstrapper&quot;EOF æ ¼å¼ï¼štokenï¼Œç”¨æˆ·åï¼ŒUIDï¼Œç”¨æˆ·ç»„ token ä¹Ÿå¯è‡ªè¡Œç”Ÿæˆæ›¿æ¢ï¼š 1head -c 16 /dev/urandom | od -An -t x | tr -d &#x27; &#x27; 5.9 systemd ç®¡ç† apiserver1234567891011cat &gt; /usr/lib/systemd/system/kube-apiserver.service &lt;&lt; EOF[Unit]Description=Kubernetes API ServerDocumentation=https://github.com/kubernetes/kubernetes[Service]EnvironmentFile=/opt/kubernetes/cfg/kube-apiserver.confExecStart=/opt/kubernetes/bin/kube-apiserver \\$KUBE_APISERVER_OPTSRestart=on-failure[Install]WantedBy=multi-user.targetEOF å¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨ 123systemctl daemon-reloadsystemctl start kube-apiserversystemctl enable kube-apiserver 5.10 æˆæƒ kubelet-bootstrap ç”¨æˆ·å…è®¸è¯·æ±‚è¯ä¹¦123kubectl create clusterrolebinding kubelet-bootstrap \\--clusterrole=system:node-bootstrapper \\--user=kubelet-bootstrap 5.11 éƒ¨ç½² kube-controller-manager12345678910111213141516cat &gt; /opt/kubernetes/cfg/kube-controller-manager.conf &lt;&lt; EOFKUBE_CONTROLLER_MANAGER_OPTS=&quot;--logtostderr=false \\\\--v=2 \\\\--log-dir=/opt/kubernetes/logs \\\\--leader-elect=true \\\\--master=127.0.0.1:8080 \\\\--bind-address=127.0.0.1 \\\\--allocate-node-cidrs=true \\\\--cluster-cidr=10.244.0.0/16 \\\\--service-cluster-ip-range=10.0.0.0/24 \\\\--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \\\\--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem \\\\--root-ca-file=/opt/kubernetes/ssl/ca.pem \\\\--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem \\\\--experimental-cluster-signing-duration=87600h0m0s&quot;EOF â€“masterï¼šé€šè¿‡æœ¬åœ°éå®‰å…¨æœ¬åœ°ç«¯å£ 8080 è¿æ¥ apiserver â€“leader-electï¼šå½“è¯¥ç»„ä»¶å¯åŠ¨å¤šä¸ªæ—¶ï¼Œè‡ªåŠ¨é€‰ä¸¾ï¼ˆHAï¼‰ â€“cluster-signing-cert-file&#x2F;â€“cluster-signing-key-fileï¼šè‡ªåŠ¨ä¸º kubelet é¢å‘è¯ä¹¦çš„ CAï¼Œä¸ apiserver ä¿æŒä¸€è‡´ 5.12 systemd ç®¡ç† controller-manager1234567891011cat &gt; /usr/lib/systemd/system/kube-controller-manager.service &lt;&lt; EOF[Unit]Description=Kubernetes Controller ManagerDocumentation=https://github.com/kubernetes/kubernetes[Service]EnvironmentFile=/opt/kubernetes/cfg/kube-controller-manager.confExecStart=/opt/kubernetes/bin/kube-controller-manager \\$KUBE_CONTROLLER_MANAGER_OPTSRestart=on-failure[Install]WantedBy=multi-user.targetEOF å¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨ 123systemctl daemon-reloadsystemctl start kube-controller-managersystemctl enable kube-controller-manager 5.13 éƒ¨ç½² kube-scheduler12345678cat &gt; /opt/kubernetes/cfg/kube-scheduler.conf &lt;&lt; EOFKUBE_SCHEDULER_OPTS=&quot;--logtostderr=false \\--v=2 \\--log-dir=/opt/kubernetes/logs \\--leader-elect \\--master=127.0.0.1:8080 \\--bind-address=127.0.0.1&quot;EOF â€“masterï¼šé€šè¿‡æœ¬åœ°éå®‰å…¨æœ¬åœ°ç«¯å£ 8080 è¿æ¥ apiserver â€“leader-electï¼šå½“è¯¥ç»„ä»¶å¯åŠ¨å¤šä¸ªæ—¶ï¼Œè‡ªåŠ¨é€‰ä¸¾ï¼ˆHAï¼‰ 1234567891011cat &gt; /usr/lib/systemd/system/kube-scheduler.service &lt;&lt; EOF[Unit]Description=Kubernetes SchedulerDocumentation=https://github.com/kubernetes/kubernetes[Service]EnvironmentFile=/opt/kubernetes/cfg/kube-scheduler.confExecStart=/opt/kubernetes/bin/kube-scheduler \\$KUBE_SCHEDULER_OPTSRestart=on-failure[Install]WantedBy=multi-user.targetEOF å¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨ 123systemctl daemon-reloadsystemctl start kube-schedulersystemctl enable kube-scheduler 5.14 æŸ¥çœ‹é›†ç¾¤çŠ¶æ€1kubectl get cs 6.éƒ¨ç½²Worker Nodeï¼ˆä¸¤ä¸ªnodeåŒæ­¥æ‰§è¡Œï¼‰6.1k8så®‰è£…åŒ…è§£å‹å®‰è£…12345mkdir -p /opt/kubernetes/&#123;bin,cfg,ssl,logs&#125;tar zxvf kubernetes-server-linux-amd64.tar.gzcd kubernetes/server/bincp kubelet kube-proxy /opt/kubernetes/bincp kubectl /usr/bin/ 6.2 é…ç½®kubelet123456789101112cat &gt; /opt/kubernetes/cfg/kubelet.conf &lt;&lt; EOFKUBELET_OPTS=&quot;--logtostderr=false \\\\--v=2 \\\\--log-dir=/opt/kubernetes/logs \\\\--hostname-override=m1 \\\\--network-plugin=cni \\\\--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \\\\--bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \\\\--config=/opt/kubernetes/cfg/kubelet-config.yml \\\\--cert-dir=/opt/kubernetes/ssl \\\\--pod-infra-container-image=lizhenliang/pause-amd64:3.0&quot;EOF â€“hostname-overrideï¼šæ˜¾ç¤ºåç§°ï¼Œé›†ç¾¤ä¸­å”¯ä¸€ â€“network-pluginï¼šå¯ç”¨CNI â€“kubeconfigï¼šç©ºè·¯å¾„ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆï¼Œåé¢ç”¨äºè¿æ¥apiserver â€“bootstrap-kubeconfigï¼šé¦–æ¬¡å¯åŠ¨å‘apiserverç”³è¯·è¯ä¹¦ â€“configï¼šé…ç½®å‚æ•°æ–‡ä»¶ â€“cert-dirï¼škubeletè¯ä¹¦ç”Ÿæˆç›®å½• â€“pod-infra-container-imageï¼šç®¡ç†Podç½‘ç»œå®¹å™¨çš„é•œåƒ 1234567891011121314151617181920212223242526272829303132cat &gt; /opt/kubernetes/cfg/kubelet-config.yml &lt;&lt; EOFkind: KubeletConfigurationapiVersion: kubelet.config.k8s.io/v1beta1address: 0.0.0.0port: 10250readOnlyPort: 10255cgroupDriver: cgroupfsclusterDNS:- 10.0.0.2clusterDomain: cluster.local failSwapOn: falseauthentication: anonymous: enabled: false webhook: cacheTTL: 2m0s enabled: true x509: clientCAFile: /opt/kubernetes/ssl/ca.pem authorization: mode: Webhook webhook: cacheAuthorizedTTL: 5m0s cacheUnauthorizedTTL: 30sevictionHard: imagefs.available: 15% memory.available: 100Mi nodefs.available: 10% nodefs.inodesFree: 5%maxOpenFiles: 1000000maxPods: 110EOF 6.3 å°†masterä¸€äº›é…ç½®æ–‡ä»¶æ‹·è´åˆ°nodeèŠ‚ç‚¹ä¸Š12scp -r /opt/kubernetes/ssl root@192.168.206.129:/opt/kubernetesscp -r /opt/kubernetes/ssl root@192.168.206.130:/opt/kubernetes 6.4 ç”Ÿæˆbootstrap.kubeconfigæ–‡ä»¶12KUBE_APISERVER=&quot;https://192.168.206.128:6443&quot; # apiserver IP:PORTTOKEN=&quot;c47ffb939f5ca36231d9e3121a252940&quot; # ä¸token.csvé‡Œä¿æŒä¸€è‡´ ä¸Šé¢ä¸¤ä¸ªå˜é‡éœ€è¦æ ¹æ®è‡ªå·±æƒ…å†µè®¾ç½®ï¼Œèµ‹åˆ°è„šæœ¬å¯¹åº”ä½ç½®æ‰§è¡Œï¼š 12345678910111213kubectl config set-cluster kubernetes \\ --certificate-authority=/opt/kubernetes/ssl/ca.pem \\ --embed-certs=true \\ --server=$&#123;KUBE_APISERVER&#125; \\ --kubeconfig=bootstrap.kubeconfigkubectl config set-credentials &quot;kubelet-bootstrap&quot; \\ --token=$&#123;TOKEN&#125; \\ --kubeconfig=bootstrap.kubeconfigkubectl config set-context default \\ --cluster=kubernetes \\ --user=&quot;kubelet-bootstrap&quot; \\ --kubeconfig=bootstrap.kubeconfigkubectl config use-context default --kubeconfig=bootstrap.kubeconfig 1mv bootstrap.kubeconfig /opt/kubernetes/cfg 6.5 systemdç®¡ç†kubelet123456789101112cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF[Unit]Description=Kubernetes KubeletAfter=docker.service[Service]EnvironmentFile=/opt/kubernetes/cfg/kubelet.confExecStart=/opt/kubernetes/bin/kubelet \\$KUBELET_OPTSRestart=on-failureLimitNOFILE=65536[Install]WantedBy=multi-user.targetEOF å¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨ 123systemctl daemon-reloadsystemctl start kubeletsystemctl enable kubelet 6.7 æ‰¹å‡†kubeletè¯ä¹¦ç”³è¯·å¹¶åŠ å…¥é›†ç¾¤ï¼ˆmasteræ‰§è¡Œï¼‰1234567891011# æŸ¥çœ‹kubeletè¯ä¹¦è¯·æ±‚kubectl get csrNAME AGE SIGNERNAME REQUESTOR CONDITIONnode-csr-uCEGPOIiDdlLODKts8J658HrFq9CZ--K6M4G7bjhk8A 6m3s kubernetes.io/kube-apiserver-client-kubelet kubelet-bootstrap Pendingnode-csr-***# æ‰¹å‡†ç”³è¯·kubectl certificate approve node-csr-uCEGPOIiDdlLODKts8J658HrFq9CZ--K6M4G7bjhk8Akubectl certificate approve node-csr-***# æŸ¥çœ‹èŠ‚ç‚¹kubectl get node ç”±äºç½‘ç»œæ’ä»¶è¿˜æ²¡æœ‰éƒ¨ç½²ï¼ŒèŠ‚ç‚¹ä¼šæ²¡æœ‰å‡†å¤‡å°±ç»ª NotReadyã€‚ 6.8 éƒ¨ç½²kube-proxy123456cat &gt; /opt/kubernetes/cfg/kube-proxy.conf &lt;&lt; EOFKUBE_PROXY_OPTS=&quot;--logtostderr=false \\\\--v=2 \\\\--log-dir=/opt/kubernetes/logs \\\\--config=/opt/kubernetes/cfg/kube-proxy-config.yml&quot;EOF 12345678910cat &gt; /opt/kubernetes/cfg/kube-proxy-config.yml &lt;&lt; EOFkind: KubeProxyConfigurationapiVersion: kubeproxy.config.k8s.io/v1alpha1bindAddress: 0.0.0.0metricsBindAddress: 0.0.0.0:10249clientConnection: kubeconfig: /opt/kubernetes/cfg/kube-proxy.kubeconfighostnameOverride: node1clusterCIDR: 10.0.0.0/24EOF hostnameOverrideè®¾ç½®å¯¹åº”nodeæœºå™¨çš„hostnameã€‚ 6.9 ç”Ÿæˆkube-proxy.kubeconfigæ–‡ä»¶ï¼ˆmasterç”Ÿæˆä¼ åˆ°nodeï¼‰1234567891011121314151617181920212223# åˆ‡æ¢å·¥ä½œç›®å½•cd TLS/k8s# åˆ›å»ºè¯ä¹¦è¯·æ±‚æ–‡ä»¶cat &gt; kube-proxy-csr.json &lt;&lt; EOF&#123; &quot;CN&quot;: &quot;system:kube-proxy&quot;, &quot;hosts&quot;: [], &quot;key&quot;: &#123; &quot;algo&quot;: &quot;rsa&quot;, &quot;size&quot;: 2048 &#125;, &quot;names&quot;: [ &#123; &quot;C&quot;: &quot;CN&quot;, &quot;L&quot;: &quot;BeiJing&quot;, &quot;ST&quot;: &quot;BeiJing&quot;, &quot;O&quot;: &quot;k8s&quot;, &quot;OU&quot;: &quot;System&quot; &#125; ]&#125;EOF 12# ç”Ÿæˆè¯ä¹¦cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy 12[root@master k8s]# ls kube-proxy*pemkube-proxy-key.pem kube-proxy.pem å°†masterç”Ÿæˆçš„è¯ä¹¦ä¼ è¾“åˆ°node 12scp /root/TLS/k8s/kube-proxy*pem root@192.168.206.129:/opt/kubernetes/sslscp /root/TLS/k8s/kube-proxy*pem root@192.168.206.130:/opt/kubernetes/ssl 6.10 ç”Ÿæˆkubeconfigæ–‡ä»¶1KUBE_APISERVER=&quot;https://192.168.206.128:6443&quot; # apiserver IP:PORT 123456789101112131415kubectl config set-cluster kubernetes \\ --certificate-authority=/opt/kubernetes/ssl/ca.pem \\ --embed-certs=true \\ --server=$&#123;KUBE_APISERVER&#125; \\ --kubeconfig=kube-proxy.kubeconfigkubectl config set-credentials kube-proxy \\ --client-certificate=/opt/kubernetes/ssl/kube-proxy.pem \\ --client-key=/opt/kubernetes/ssl/kube-proxy-key.pem \\ --embed-certs=true \\ --kubeconfig=kube-proxy.kubeconfigkubectl config set-context default \\ --cluster=kubernetes \\ --user=kube-proxy \\ --kubeconfig=kube-proxy.kubeconfigkubectl config use-context default --kubeconfig=kube-proxy.kubeconfig 6.11 systemdç®¡ç†kube-proxy123456789101112cat &gt; /usr/lib/systemd/system/kube-proxy.service &lt;&lt; EOF[Unit]Description=Kubernetes ProxyAfter=network.target[Service]EnvironmentFile=/opt/kubernetes/cfg/kube-proxy.confExecStart=/opt/kubernetes/bin/kube-proxy \\$KUBE_PROXY_OPTSRestart=on-failureLimitNOFILE=65536[Install]WantedBy=multi-user.targetEOF å¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨ï¼š 123systemctl daemon-reloadsystemctl start kube-proxysystemctl enable kube-proxy 7.éƒ¨ç½²CNIç½‘ç»œä¸‹è½½å®‰è£… 12ä¸‹è½½åœ°å€ï¼šhttps://github.com/containernetworking/plugins/releasesç‰ˆæœ¬ï¼šv0.8.6ï¼ˆå®‰è£…åŒ…åï¼šcni-plugins-linux-amd64-v0.8.6.tgzï¼‰ nodeèŠ‚ç‚¹æ“ä½œï¼š 12mkdir /opt/cni/bintar zxvf cni-plugins-linux-amd64-v0.8.6.tgz -C /opt/cni/bin masterèŠ‚ç‚¹æ“ä½œï¼š 12wget --no-check-certificate https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.ymlkubectl apply -f kube-flannel.yml å‚è€ƒï¼š ã€å°šç¡…è°·ã€‘Kubernetesï¼ˆk8sï¼‰å…¥é—¨åˆ°å®æˆ˜æ•™ç¨‹ä¸¨å…¨æ–°å‡çº§å®Œæ•´ç‰ˆ k8sé›†ç¾¤ (äºŒè¿›åˆ¶å®‰è£…æ–¹å¼)","categories":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"https://xssdpgy.github.io/categories/%E6%8A%80%E6%9C%AF/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"https://xssdpgy.github.io/tags/k8s/"},{"name":"å®‰è£…","slug":"å®‰è£…","permalink":"https://xssdpgy.github.io/tags/%E5%AE%89%E8%A3%85/"}]}],"categories":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"https://xssdpgy.github.io/categories/%E6%8A%80%E6%9C%AF/"}],"tags":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://xssdpgy.github.io/tags/%E7%AE%97%E6%B3%95/"},{"name":"é“¾è¡¨","slug":"é“¾è¡¨","permalink":"https://xssdpgy.github.io/tags/%E9%93%BE%E8%A1%A8/"},{"name":"é˜Ÿåˆ—","slug":"é˜Ÿåˆ—","permalink":"https://xssdpgy.github.io/tags/%E9%98%9F%E5%88%97/"},{"name":"timeLimit","slug":"timeLimit","permalink":"https://xssdpgy.github.io/tags/timeLimit/"},{"name":"æºç åˆ†æ","slug":"æºç åˆ†æ","permalink":"https://xssdpgy.github.io/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"name":"seata","slug":"seata","permalink":"https://xssdpgy.github.io/tags/seata/"},{"name":"åˆ†å¸ƒå¼äº‹åŠ¡","slug":"åˆ†å¸ƒå¼äº‹åŠ¡","permalink":"https://xssdpgy.github.io/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://xssdpgy.github.io/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"},{"name":"åŠ¨æ€ä»£ç†","slug":"åŠ¨æ€ä»£ç†","permalink":"https://xssdpgy.github.io/tags/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/"},{"name":"å¼‚æ­¥","slug":"å¼‚æ­¥","permalink":"https://xssdpgy.github.io/tags/%E5%BC%82%E6%AD%A5/"},{"name":"ä¼˜åŒ–","slug":"ä¼˜åŒ–","permalink":"https://xssdpgy.github.io/tags/%E4%BC%98%E5%8C%96/"},{"name":"k8s","slug":"k8s","permalink":"https://xssdpgy.github.io/tags/k8s/"},{"name":"å®‰è£…","slug":"å®‰è£…","permalink":"https://xssdpgy.github.io/tags/%E5%AE%89%E8%A3%85/"}]}